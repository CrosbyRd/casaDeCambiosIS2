<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Pagar Monto Dinámico</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background-color: #f6f9fc; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0;}
        .container { background-color: white; width: 400px; padding: 30px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #32325d; }
        .input-group { margin-bottom: 20px; }
        label { font-weight: 600; display: block; margin-bottom: 8px; }
        input[type="number"] { width: 100%; padding: 10px; border: 1px solid #dee2e6; border-radius: 4px; box-sizing: border-box; }
        #submit { background: #5469d4; color: #ffffff; border: 0; border-radius: 4px; padding: 12px 16px; font-size: 16px; font-weight: 600; cursor: pointer; display: block; width: 100%; }
        #submit:disabled { opacity: 0.5; }
        #payment-message { margin-top: 15px; color: #fa755a; text-align: center; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Pagar Monto Personalizado</h1>
        <div class="input-group">
            <label for="amount-input">Monto a pagar (USD):</label>
            <input type="number" id="amount-input" placeholder="Ej: 10.50" step="0.01" min="0.50">
        </div>
        <form id="payment-form">
            <div id="payment-element" style="display: none;"></div>
            <button id="submit" disabled><span id="button-text">Pagar</span></button>
            <div id="payment-message" role="alert"></div>
        </form>
    </div>
    <script src="https://js.stripe.com/v3/"></script>
    <script>
        const stripe = Stripe("{{ STRIPE_PUBLIC_KEY }}");
        const amountInput = document.querySelector("#amount-input");
        const paymentForm = document.querySelector("#payment-form");
        const paymentElementContainer = document.querySelector("#payment-element");
        const submitButton = document.querySelector("#submit");
        let elements;

        window.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const amountCentsFromUrl = urlParams.get('amount_cents');

            if (amountCentsFromUrl) {
                const amount = parseFloat(amountCentsFromUrl) / 100;
                if (!isNaN(amount) && amount >= 0.50) {
                    amountInput.value = amount.toFixed(2);
                    amountInput.readOnly = true;
                    amountInput.style.backgroundColor = '#e9ecef';
                    amountInput.style.cursor = 'not-allowed';
                    amountInput.dispatchEvent(new Event('change'));
                }
            }
        });

        amountInput.addEventListener('change', initialize);
        paymentForm.addEventListener("submit", handleSubmit);
        
        async function initialize() {
            const amount = parseFloat(amountInput.value);
            if (isNaN(amount) || amount < 0.50) {
                showMessage("Por favor, ingresa un monto válido (mínimo $0.50).");
                paymentElementContainer.style.display = 'none';
                submitButton.disabled = true;
                return;
            }
            const amountInCents = Math.round(amount * 100);
            
            setLoading(true, "Cargando formulario...");
            paymentElementContainer.style.display = 'block';

            const response = await fetch("/api/create-payment-intent/", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ 'amount': amountInCents }),
            });
            const { clientSecret, error } = await response.json();

            if (error) {
                showMessage(error);
                setLoading(false); return;
            }

            elements = stripe.elements({ clientSecret });
            const paymentElement = elements.create("payment");
            paymentElement.mount("#payment-element");
            setLoading(false);
        }

        async function handleSubmit(e) {
            e.preventDefault();
            setLoading(true, "Procesando pago...");
            const { error } = await stripe.confirmPayment({
                elements,
                confirmParams: { return_url: `${window.location.origin}/payment-success/` },
            });
            showMessage(error.type === "card_error" || error.type === "validation_error" ? error.message : "Ocurrió un error inesperado.");
            setLoading(false);
        }

        function showMessage(messageText) { document.querySelector("#payment-message").textContent = messageText; }
        function setLoading(isLoading, message = "Pagar") {
            submitButton.disabled = isLoading;
            document.querySelector("#button-text").textContent = message;
        }
    </script>
</body>
</html>