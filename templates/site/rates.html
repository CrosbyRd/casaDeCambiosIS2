{% extends "base.html" %}
{% load l10n %}
{% block title %}Global Exchange{% endblock %}

{% block content %}
<main class="max-w-[1200px] mx-auto px-6 py-10">
  <h1 class="h1 mb-6">Tipos de cambio</h1>

  <section class="bg-white border rounded-xl shadow-sm overflow-hidden" style="border-color:var(--line)">
    <table class="w-full border-collapse">
      <thead class="bg-[var(--brand)] text-white">
        <tr>
          <th class="px-4 py-3 text-left">Moneda</th>
          <th class="px-4 py-3 text-right">Compra (PYG)</th>
          <th class="px-4 py-3 text-right">Venta (PYG)</th>
          <th class="px-4 py-3 text-right">Actualizaci√≥n</th>
        </tr>
      </thead>
      <tbody>
        {% for c in cotizaciones %}
          <tr class="border-b hover:bg-[var(--brand-soft)]" style="border-color:var(--line)"
              data-code="{{ c.moneda_destino.codigo }}"
              data-compra="{{ c.total_compra|unlocalize|floatformat:0 }}"
              data-venta="{{ c.total_venta|unlocalize|floatformat:0 }}">
            <td class="px-4 py-3">
              <span class="currency-emoji" data-code="{{ c.moneda_destino.codigo }}"></span>
              {{ c.moneda_destino.codigo }}
            </td>

            <td class="px-4 py-3 text-right font-semibold">
              <span class="rate" data-field="compra">{{ c.total_compra|unlocalize|floatformat:0 }}</span>
            </td>
            <td class="px-4 py-3 text-right font-semibold">
              <span class="rate" data-field="venta">{{ c.total_venta|unlocalize|floatformat:0 }}</span>
            </td>

            <td class="px-4 py-3 text-right text-neutral-500">{{ c.fecha_actualizacion|date:"d/m/Y H:i" }}</td>
          </tr>
        {% empty %}
          <tr><td colspan="4" class="px-4 py-6 text-center text-neutral-500">Sin cotizaciones.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </section>
</main>

<script>
(function(){
  const MAP = {USD:"üá∫üá∏", EUR:"üá™üá∫", ARS:"üá¶üá∑", BRL:"üáßüá∑", CLP:"üá®üá±", COP:"üá®üá¥",
               MXN:"üá≤üáΩ", PEN:"üáµüá™", PYG:"üáµüáæ", UYU:"üá∫üáæ", GBP:"üá¨üáß", JPY:"üáØüáµ",
               CNY:"üá®üá≥", AUD:"üá¶üá∫", CAD:"üá®üá¶", CHF:"üá®üá≠"};
  document.querySelectorAll('.currency-emoji').forEach(el=>{
    const code = String(el.dataset.code||'').toUpperCase();
    el.textContent = (MAP[code] || "üí±") + " ";
  });
      // Indicadores de variaci√≥n con persistencia de 12h
  const TTL = 12 * 60 * 60 * 1000; // 12 horas en ms
  const rows = document.querySelectorAll('tbody tr[data-code]');

  rows.forEach(row => {
    const code = String(row.dataset.code || '').toUpperCase();

    ['compra', 'venta'].forEach(field => {
      const el = row.querySelector(`.rate[data-field="${field}"]`);
      if (!el) return;

      const textNum = (el.textContent || '').replace(/\D+/g, '');
      const nowVal = Number(row.dataset[field] || textNum);
      const key = `rates:${code}:${field}`;
      const nowTs = Date.now();

      let data = null;
      try { data = JSON.parse(localStorage.getItem(key) || 'null'); } catch (_) {}

      const prevVal = (data && typeof data.value === 'number') ? data.value : null;
      let lastChange = data && data.lastChange ? data.lastChange : null; // {time, dir:'up'|'down'}

      // ¬øQu√© mostrar?
      let showDir = null;
      if (prevVal !== null && nowVal !== prevVal) {
        // Cambi√≥: mostrar y actualizar "lastChange"
        showDir = nowVal > prevVal ? 'up' : 'down';
        lastChange = { time: nowTs, dir: showDir };
      } else if (lastChange && (nowTs - lastChange.time) < TTL) {
        // No cambi√≥ ahora, pero hubo un cambio reciente (<12h)
        showDir = lastChange.dir;
      }

      if (showDir) {
        const badge = document.createElement('span');
        badge.textContent = showDir === 'up' ? '‚ñ≤' : '‚ñº';
        badge.className = 'ml-1 text-xs opacity-70 align-middle';
        badge.classList.add(showDir === 'up' ? 'text-emerald-600' : 'text-red-600');
        // microajuste vertical
        badge.style.position = 'relative';
        badge.style.top = '-1px';
        el.after(badge);
      }

      // Guardar valor actual y limpiar lastChange si ya expir√≥
      const persisted = lastChange && (nowTs - lastChange.time) < TTL ? lastChange : null;
      localStorage.setItem(key, JSON.stringify({ value: nowVal, lastChange: persisted }));
    });
  });
})();
</script>
{% endblock %}
