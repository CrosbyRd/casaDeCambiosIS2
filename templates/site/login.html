{% extends "base.html" %}
{% block title %}Iniciar sesi√≥n ‚Äî Global Exchange{% endblock %}

{% block content %}
<main id="main" class="max-w-[800px] mx-auto px-6 py-10">

  <h1 class="h1 mb-6">Iniciar Sesi√≥n</h1>

  <style>
    .api-login *{box-sizing:border-box}
    .api-login label{display:block;margin:.5rem 0 .25rem;font-weight:600}
    .api-login input{width:100%;padding:.7rem;border:1px solid #d1d5db;border-radius:.5rem}
    .api-login button{padding:.75rem 1rem;border-radius:.9rem;background:var(--brand);color:#fff;border:0;cursor:pointer;font-weight:800}
    .api-login .box{border:1px solid #e5e7eb;border-radius:.9rem;padding:1rem;margin-top:1rem;background:#fff}
    .api-login .ok{background:#e6ffed}
    .api-login .err{background:#ffe6e6;color:#b91c1c}
  </style>

  <div class="api-login">
    <form id="loginForm" class="box">
      <label for="username">Usuario</label>
      <input type="text" id="username" name="username" required autocomplete="username" autofocus>

      <label for="password" class="mt-3">Contrase√±a</label>
      <input type="password" id="password" name="password" required autocomplete="current-password">

      <div class="mt-3 flex items-center justify-between">
        <a href="{% url 'site_forgot_password' %}" class="text-brand hover:underline">¬øOlvidaste tu contrase√±a?</a>
      </div>

      <button type="submit" class="mt-4 w-full">Ingresar</button>

      <a class="btn-secondary mt-3 w-full inline-flex justify-center" href="{% url 'site_signup' %}">
        Crear cuenta
      </a>
    </form>

    <div id="userInfo" class="box ok" style="display:none;">
      <h2 class="font-bold mb-2">Informaci√≥n del usuario</h2>
      <pre id="userData" class="whitespace-pre-wrap text-sm"></pre>
      <button id="logoutButton" class="mt-2">Cerrar sesi√≥n</button>
    </div>

    <div id="errorInfo" class="box err" style="display:none;"></div>
  </div>
</main>

<script>
  const loginForm = document.getElementById('loginForm');
  const userInfoDiv = document.getElementById('userInfo');
  const userDataPre = document.getElementById('userData');
  const errorInfoDiv = document.getElementById('errorInfo');
  const logoutButton = document.getElementById('logoutButton');

  // Cargar desde storage al abrir (si ya hay token)
  document.addEventListener('DOMContentLoaded', fetchAndShowUserData);

loginForm.addEventListener('submit', async function(event) {
  event.preventDefault();
  errorInfoDiv.style.display = 'none';

  const username = event.target.username.value;
  const password = event.target.password.value;

  try {
    const res = await fetch('/api/token/', {
      method: 'POST', // üí° M√©todo HTTP
      headers: {
        'Content-Type': 'application/json' // üí° Tipo de contenido
      },
      body: JSON.stringify({ username, password }) // üí° Datos a enviar
    });
    
    if (!res.ok) throw new Error('Usuario o contrase√±a incorrectos.');
    const data = await res.json();

    localStorage.setItem('accessToken', data.access);
    localStorage.setItem('refreshToken', data.refresh);

    // Redirige al usuario a la vista 'home' despu√©s del login
    window.location.href = '/'; 

  } catch (err) {
    errorInfoDiv.textContent = err.message;
    errorInfoDiv.style.display = 'block';
  }
});

// ... (c√≥digo existente)

async function fetchAndShowUserData() {
  const accessToken = localStorage.getItem('accessToken');
  if (!accessToken) return;
  try {
    const res = await fetch('/api/auth/me/', {
      method: 'GET',
      headers: { 'Authorization': `Bearer ${accessToken}` }
    });
    
    // Si la sesi√≥n ha expirado o el token es inv√°lido, cierra sesi√≥n
    if (res.status === 401) throw new Error('Sesi√≥n expirada. Inicia sesi√≥n de nuevo.');
    
    // Si la petici√≥n falla por otro motivo
    if (!res.ok) throw new Error('No se pudo obtener la informaci√≥n del usuario.');

    const user = await res.json();
    console.log(user);
    
    // üí° L√≥gica de Redirecci√≥n üí°
    if (user.tipo_usuario === 'ADMIN') {
        // Redirige al men√∫ de administrador si el usuario es un ADMIN
        window.location.href = '/api/auth/admin-menu/';
    } else {
        // Si no es un ADMIN, muestra la informaci√≥n en la misma p√°gina
        userDataPre.textContent = JSON.stringify(user, null, 2);
        userInfoDiv.style.display = 'block';
        loginForm.style.display = 'none';
    }

  } catch (err) {
    // Si ocurre un error, limpia los tokens y muestra el mensaje
    logout();
    errorInfoDiv.textContent = err.message;
    errorInfoDiv.style.display = 'block';
  }
}

// ... (resto del c√≥digo)
  function logout() {
    localStorage.removeItem('accessToken');
    localStorage.removeItem('refreshToken');
    userInfoDiv.style.display = 'none';
    loginForm.style.display = 'block';
    loginForm.reset();
  }

  if (logoutButton) logoutButton.addEventListener('click', logout);
</script>
{% endblock %}
