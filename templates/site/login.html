{% extends "base.html" %}
{% block title %}Iniciar sesión — Global Exchange{% endblock %}

{% block content %}
<main id="main" class="max-w-[800px] mx-auto px-6 py-10">

  <h1 class="h1 mb-6">Iniciar Sesión</h1>

  <style>
    .api-login *{box-sizing:border-box}
    .api-login label{display:block;margin:.5rem 0 .25rem;font-weight:600}
    .api-login input{width:100%;padding:.7rem;border:1px solid #d1d5db;border-radius:.5rem}
    .api-login button{padding:.75rem 1rem;border-radius:.9rem;background:var(--brand);color:#fff;border:0;cursor:pointer;font-weight:800}
    .api-login .box{border:1px solid #e5e7eb;border-radius:.9rem;padding:1rem;margin-top:1rem;background:#fff}
    .api-login .ok{background:#e6ffed}
    .api-login .err{background:#ffe6e6;color:#b91c1c}
  </style>

  <div class="api-login">
    <form id="loginForm" class="box">
      <label for="username">Usuario</label>
      <input type="text" id="username" name="username" required autocomplete="username" autofocus>

      <label for="password" class="mt-3">Contraseña</label>
      <input type="password" id="password" name="password" required autocomplete="current-password">

      <div class="mt-3 flex items-center justify-between">
        <a href="{% url 'site_forgot_password' %}" class="text-brand hover:underline">¿Olvidaste tu contraseña?</a>
      </div>

      <button type="submit" class="mt-4 w-full">Ingresar</button>

      <a class="btn-secondary mt-3 w-full inline-flex justify-center" href="{% url 'site_signup' %}">
        Crear cuenta
      </a>
    </form>

    <div id="info" class="box ok" style="display:none;"></div>
    <div id="errorInfo" class="box err" style="display:none;"></div>
  </div>
</main>

<script>
  const loginForm = document.getElementById('loginForm');
  const infoDiv = document.getElementById('info');
  const errorInfoDiv = document.getElementById('errorInfo');

  loginForm.addEventListener('submit', async function(event) {
    event.preventDefault();
    errorInfoDiv.style.display = 'none';
    infoDiv.style.display = 'none';

    const username = event.target.username.value;
    const password = event.target.password.value;

    try {
      const res = await fetch('/api/auth/login-step1/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password })
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.detail || 'No se pudo iniciar el proceso MFA.');

      // Guardar token temporal para el paso 2
      localStorage.setItem('mfaToken', data.mfa_token || '');
      const destino = data.email_mask || 'tu correo';
      infoDiv.textContent = `Te enviamos un código de 6 dígitos a ${destino}. Ingrésalo para completar el acceso.`;
      infoDiv.style.display = 'block';

      // Redirigir a la pantalla de verificación
      window.location.href = "{% url 'site_verify_code' %}";
    } catch (err) {
      errorInfoDiv.textContent = err.message;
      errorInfoDiv.style.display = 'block';
    }
  });
</script>
{% endblock %}
