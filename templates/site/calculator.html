{% extends "base.html" %}
{% load static %}

{% block title %}Global Exchange{% endblock %}
{% block extra_head %}<link rel="icon" href="{% static 'img/logo.ico' %}" sizes="any">{% endblock %}

{% block content %}

{% include "partials/page_header.html" with title="Calculadora" subtitle="Simul√° tu conversi√≥n al instante" %}
{% include "partials/messages.html" %}

<main class="max-w-5xl mx-auto px-6 py-10">
  <section class="bg-white border rounded-xl shadow-sm mb-4" style="border-color:var(--line)">
    <form method="post"
          id="form-simulador"
          data-initial-blank="{% if form.is_bound %}0{% else %}1{% endif %}"
          data-currencies='{
            "USD":{"name":"D√≥lar estadounidense","symbol":"$","emoji":"üá∫üá∏"},
            "EUR":{"name":"Euro","symbol":"‚Ç¨","emoji":"üá™üá∫"},
            "ARS":{"name":"Peso argentino","symbol":"$","emoji":"üá¶üá∑"},
            "BRL":{"name":"Real brasile√±o","symbol":"R$","emoji":"üáßüá∑"},
            "CLP":{"name":"Peso chileno","symbol":"$","emoji":"üá®üá±"},
            "COP":{"name":"Peso colombiano","symbol":"$","emoji":"üá®üá¥"},
            "MXN":{"name":"Peso mexicano","symbol":"$","emoji":"üá≤üáΩ"},
            "PEN":{"name":"Sol peruano","symbol":"S/","emoji":"üáµüá™"},
            "PYG":{"name":"Guaran√≠ paraguayo","symbol":"‚Ç≤","emoji":"üáµüáæ"},
            "UYU":{"name":"Peso uruguayo","symbol":"$","emoji":"üá∫üáæ"},
            "GBP":{"name":"Libra esterlina","symbol":"¬£","emoji":"üá¨üáß"},
            "JPY":{"name":"Yen japon√©s","symbol":"¬•","emoji":"üáØüáµ"},
            "CNY":{"name":"Yuan chino","symbol":"¬•","emoji":"üá®üá≥"},
            "AUD":{"name":"D√≥lar australiano","symbol":"$","emoji":"üá¶üá∫"},
            "CAD":{"name":"D√≥lar canadiense","symbol":"$","emoji":"üá®üá¶"},
            "CHF":{"name":"Franco suizo","symbol":"Fr","emoji":"üá®üá≠"}
          }'>
      {% csrf_token %}

      <div class="overflow-x-auto">
        <!-- tabla con borde redondeado -->
        <div class="table-shell rounded-2xl overflow-hidden border" style="border-color:var(--line)">
          <table class="w-full border-collapse min-w-[520px]">
            <thead class="bg-[var(--brand)] text-white">
              <tr>
                <th class="px-4 py-3 text-left">Tengo esta moneda</th>
                <th class="px-4 py-3 text-left">Quiero esta moneda</th>
              </tr>
            </thead>
            <tbody>
              <tr class="hover:bg-[var(--brand-soft)]">
                <td class="px-4 py-3">{{ form.moneda_origen }}</td>
                <td class="px-4 py-3">{{ form.moneda_destino }}</td>
              </tr>
              <tr class="hover:bg-[var(--brand-soft)]">
                <td class="px-4 py-3">
                  {{ form.monto }}
                  <!-- Input visible SOLO para mostrar/editar con miles -->
                  <input
                    type="text"
                    id="id_monto_visible"
                    inputmode="numeric"
                    autocomplete="off"
                    placeholder="0"
                    class="gx-input mt-2"
                  />
                </td>
                <td class="px-4 py-3">
                  <input id="out-amount" class="gx-input" type="text" readonly
                         value="{% if resultado and not resultado.error %}{{ resultado.monto_recibido }}{% endif %}"
                         placeholder="0,00">
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="px-4 py-4">
        <div class="btn-row" style="margin-top:18px;">
          <button id="btn-calcular" class="gx-btn" type="submit">Calcular</button>
          <button id="btn-clear" class="gx-btn gx-btn--ghost" type="button">Borrar</button>
        </div>

        {% if resultado %}
          {% if resultado.error %}
            <div class="gx-error mt-4"><strong>Error:</strong> {{ resultado.error }}</div>
          {% else %}
            <div class="gx-result-wrap mt-4 w-full" id="result-wrap">
              <div class="gx-result-big">
                Recibir√°s aproximadamente:
                <span id="res-num" data-raw="{{ resultado.monto_recibido|default:'' }}">{{ resultado.monto_recibido }}</span>
                <span id="res-flag" aria-hidden="true"></span>
                <span id="res-code">{{ form.moneda_destino.value }}</span>
              </div>
            </div>
            {% if user.is_authenticated %}
              <div class="mt-4">
                <button form="form-simulador" type="submit" name="proceder" class="gx-btn">Proceder a Operaci√≥n</button>
              </div>
            {% else %}
              <div class="mt-4">
                <a href="{% url 'login' %}" class="gx-btn">Inicia sesi√≥n para operar</a>
              </div>
            {% endif %}
          {% endif %}
        {% endif %}
      </div>
    </form>
  </section>
</main>

<style>
  .gx-input, .gx-select{
    width:100%; border:1.5px solid var(--line); border-radius:12px;
    padding:12px 14px; height:48px; font-size:1rem; color:var(--ink); background:#fff;
    transition:box-shadow .2s ease,border-color .2s ease;
  }
  .gx-input:focus, .gx-select:focus{ outline:none; border-color:var(--brand); box-shadow:0 0 0 3px rgba(115,60,255,.15); }

  .gx-btn{
    background:var(--brand); color:#fff; font-weight:800; border:none; border-radius:12px;
    padding:12px 16px; font-size:16px; width:100%;
    box-shadow:0 8px 24px color-mix(in oklab, var(--brand) 30%, transparent);
    cursor:pointer;
  }
  .gx-btn[disabled]{opacity:.55;cursor:not-allowed;box-shadow:none;}

  .gx-btn--ghost{ background:#fff; color:var(--ink); border:1.5px solid var(--line); box-shadow:none; }
  .gx-btn--ghost:hover{ background:var(--brand-soft); }

  .gx-error{ background:#fee2e2; color:#991b1b; border:1px solid #fecaca; padding:12px 14px; border-radius:12px; }

  .gx-result-wrap{
    background:var(--brand-soft);
    border:1px solid color-mix(in oklab, var(--brand) 35%, white);
    padding:14px 16px; border-radius:14px;
  }
  .gx-result-big{ font-size:24px; font-weight:900; color:var(--brand); }
  #res-flag{ margin:0 .35rem; } /* peque√±o espacio alrededor de la banderita */

  .btn-row{ display:grid; gap:10px; grid-template-columns:1fr; }
  @media (min-width: 520px){ .btn-row{ grid-template-columns:1fr 1fr; } }

  /* üîí Ocultamos SOLO visualmente el input real de monto (no rompe POST/validaciones) */
  #id_monto{
    position:absolute !important;
    left:-99999px !important;
    width:1px !important;
    height:1px !important;
    opacity:0 !important;
    pointer-events:none !important;
  }
</style>

<script>
(function () {
  const form   = document.getElementById('form-simulador');
  if (!form) return;

  function toNumber(raw){
    if (raw == null) return NaN;
    const s = String(raw).replace(/\./g,'').replace(',','.');
    const n = parseFloat(s);
    return Number.isFinite(n) ? n : NaN;
  }
  function fmt(n){
    const num = typeof n === 'number' ? n : toNumber(n);
    if (!Number.isFinite(num)) return n;
    return num.toLocaleString('es-ES', { minimumFractionDigits: 0, maximumFractionDigits: 6 });
  }

  const out   = document.getElementById('out-amount');
  const res   = document.getElementById('res-num');
  const wrap  = document.getElementById('result-wrap');
  const resFlag = document.getElementById('res-flag');
  const resCode = document.getElementById('res-code');

  if (out && out.value) out.value = fmt(out.value);
  if (res) { const raw = res.dataset.raw || res.textContent; res.textContent = fmt(raw); }

  const data   = JSON.parse(form.dataset.currencies || "{}");
  const selOri = document.getElementById('id_moneda_origen');
  const selDst = document.getElementById('id_moneda_destino');
  const monto  = document.getElementById('id_monto');
  const btn    = document.getElementById('btn-calcular');
  const btnClr = document.getElementById('btn-clear');

  const isPYG     = (v) => String(v || '').toUpperCase() === 'PYG';
  const isForeign = (v) => v && !isPYG(v);

  function decorateSelect(sel){
    if(!sel) return;
    [...sel.options].forEach(opt=>{
      const code = opt.value; if (code && data[code]) {
        const {emoji, name} = data[code];
        opt.textContent = `${emoji} ${code} ‚Äî ${name}`;
      }
    });
    sel.classList.add('gx-select');
  }
  function ensurePlaceholder(sel){
    if(!sel) return;
    if(!sel.querySelector('option[value=""]')){
      const ph = document.createElement('option');
      ph.value = ''; ph.textContent = 'Seleccion√° una moneda‚Ä¶'; ph.disabled = true; ph.hidden = true;
      sel.insertBefore(ph, sel.firstChild);
    }
  }

  decorateSelect(selOri); decorateSelect(selDst);
  ensurePlaceholder(selOri); ensurePlaceholder(selDst);
  if (monto) monto.classList.add('gx-input');

  if (form.dataset.initialBlank === '1') {
    selOri.value = '';
    selDst.value = '';
  }

  function updateResultFlag(){
    if (!resFlag || !selDst) return;
    const code = selDst.value || (resCode ? resCode.textContent.trim() : '');
    resFlag.textContent = (data[code] && data[code].emoji) ? data[code].emoji : '';
  }

  function enforceRules(changed){
    const o = selOri?.value || '';
    const d = selDst?.value || '';

    if (changed === 'ori' && isForeign(o)) { if (!isPYG(d)) selDst.value = 'PYG'; }
    if (changed === 'dst' && isForeign(d)) { if (!isPYG(o)) selOri.value = 'PYG'; }

    if (isPYG(selOri.value) && isPYG(selDst.value)) {
      if (changed === 'ori') selDst.value = '';
      else if (changed === 'dst') selOri.value = '';
      else selDst.value = '';
    }

    const ready = selOri.value && selDst.value && selOri.value !== selDst.value &&
                  (!monto || (toNumber(monto.value) > 0));
    btn.disabled = !ready;

    updateResultFlag();
  }

  selOri?.addEventListener('change', () => enforceRules('ori'));
  selDst?.addEventListener('change', () => enforceRules('dst'));
  monto?.addEventListener('input', () => enforceRules('amount'));
  enforceRules();          // estado inicial
  updateResultFlag();      // y bandera inicial

  // BORRAR
  btnClr?.addEventListener('click', () => {
    if (monto) { monto.value = ''; }
    const inputVisible = document.getElementById('id_monto_visible');
    if (inputVisible) inputVisible.value = '';
    if (out) out.value = '';
    if (res) res.textContent = '';
    if (wrap) wrap.style.display = 'none';
    enforceRules('amount');
    inputVisible?.focus();
  });

  /* ====== Formateo de miles en el campo de entrada (visual) ====== */
  const inputHidden  = document.getElementById('id_monto');
  const inputVisible = document.getElementById('id_monto_visible');

  function cleanFormat(str){
    return String(str || '').replace(/\./g,'').replace(/\s+/g,'').replace(/[^0-9]/g,'');
  }
  function applyFormat(rawStr){
    const clean = cleanFormat(rawStr);
    if (!clean) return '';
    const normalized = clean.replace(/^0+(?=\d)/,'');
    return new Intl.NumberFormat('es-PY', { maximumFractionDigits: 0 }).format(Number(normalized));
  }
  function setFormattedValuePreservingCaret(input, nextFormatted){
    const prev = input.value;
    const start = input.selectionStart || 0;
    const digitsBefore = prev.slice(0,start).replace(/\D/g,'').length;
    input.value = nextFormatted;
    let pos = 0, consumed = 0;
    while (pos < nextFormatted.length && consumed < digitsBefore) {
      if (/\d/.test(nextFormatted[pos])) consumed++;
      pos++;
    }
    input.setSelectionRange(pos, pos);
  }

  if (inputHidden && inputVisible) {
    // Inicializar visible desde el hidden (si viene un valor)
    inputVisible.value = applyFormat(inputHidden.value || '');

    inputVisible.addEventListener('focus', () => {
      inputVisible.style.borderColor = 'var(--brand)';
      inputVisible.style.boxShadow = '0 0 0 3px rgba(124,58,237,.18)';
    });
    inputVisible.addEventListener('blur', () => {
      inputVisible.style.borderColor = 'var(--line)';
      inputVisible.style.boxShadow = 'none';
    });

    inputVisible.addEventListener('input', () => {
      const formatted = applyFormat(inputVisible.value);
      setFormattedValuePreservingCaret(inputVisible, formatted);
      inputHidden.value = cleanFormat(formatted);           // valor limpio para el POST/l√≥gica
      inputHidden.dispatchEvent(new Event('input', { bubbles: true }));  // mantiene la l√≥gica existente
      inputHidden.dispatchEvent(new Event('change', { bubbles: true }));
    });

    inputHidden.addEventListener('change', () => {
      inputVisible.value = applyFormat(inputHidden.value);
    });
  }
})();
</script>

{% endblock %}
