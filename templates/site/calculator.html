{% extends "base.html" %}
{% load static %}

{% block title %}Global Exchange - Calculadora{% endblock %}
{% block extra_head %}<link rel="icon" href="{% static 'img/logo.ico' %}" sizes="any">{% endblock %}

{% block content %}

{% include "partials/page_header.html" with title="Calculadora" subtitle="Cotiz√° tu operaci√≥n al instante" %}
{% include "partials/messages.html" %}

<main class="max-w-3xl mx-auto px-6 py-10">
  <section class="bg-white border rounded-2xl shadow-xl shadow-slate-200/50 mb-8 overflow-hidden transition-all duration-300 hover:shadow-2xl hover:shadow-slate-200/60" style="border-color:var(--line)">
    
    <div class="border-b bg-gray-50/50 px-6 py-5" style="border-color:var(--line)">
      <div class="flex relative bg-white border rounded-xl p-1.5 shadow-sm" style="border-color:var(--line)">
        
        <button type="button" class="op-switch w-1/2 py-3 rounded-lg text-sm font-bold transition-all duration-200 flex items-center justify-center gap-2.5"
                data-val="compra" onclick="setOperation('compra')">
           <span class="text-xl filter drop-shadow-sm">üì•</span> 
           <span>Quiero Comprar</span>
        </button>
        <button type="button" class="op-switch w-1/2 py-3 rounded-lg text-sm font-bold transition-all duration-200 flex items-center justify-center gap-2.5"
                data-val="venta" onclick="setOperation('venta')">
           <span class="text-xl filter drop-shadow-sm">üì§</span> 
           <span>Quiero Vender</span>
        </button>
      </div>
    </div>

    <form method="post" id="form-simulador" class="p-6 md:p-8"
          data-currencies='{
            "USD":{"name":"D√≥lar estadounidense","emoji":"üá∫üá∏"},
            "EUR":{"name":"Euro","emoji":"üá™üá∫"},
            "ARS":{"name":"Peso argentino","emoji":"üá¶üá∑"},
            "BRL":{"name":"Real brasile√±o","emoji":"üáßüá∑"},
            "CLP":{"name":"Peso chileno","emoji":"üá®üá±"},
            "COP":{"name":"Peso colombiano","emoji":"üá®üá¥"},
            "MXN":{"name":"Peso mexicano","emoji":"üá≤üáΩ"},
            "PEN":{"name":"Sol peruano","emoji":"üáµüá™"},
            "UYU":{"name":"Peso uruguayo","emoji":"üá∫üáæ"},
            "GBP":{"name":"Libra esterlina","emoji":"üá¨üáß"},
            "JPY":{"name":"Yen japon√©s","emoji":"üáØüáµ"},
            "CNY":{"name":"Yuan chino","emoji":"üá®üá≥"},
            "AUD":{"name":"D√≥lar australiano","emoji":"üá¶üá∫"},
            "CAD":{"name":"D√≥lar canadiense","emoji":"üá®üá¶"},
            "CHF":{"name":"Franco suizo","emoji":"üá®üá≠"},
            "PYG":{"name":"Guaran√≠","emoji":"üáµüáæ"}
          }'>
      {% csrf_token %}

      {{ form.tipo_operacion }} 
      {{ form.monto }}

      <script id="tasas-json" type="application/json">{{ tasas_json|default:"{}"|safe }}</script>

      <div class="grid gap-8">
        
        <div class="group">
          <label class="block text-xs font-bold uppercase tracking-wider text-[var(--muted)] mb-2 ml-1">Divisa Extranjera</label>
          <div class="relative">
             {{ form.moneda }} 
             <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-gray-500">
                <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
             </div>
          </div>
          {% if form.moneda.errors %}
            <div class="text-red-500 text-sm mt-1 ml-1 font-medium">{{ form.moneda.errors }}</div>
          {% endif %}
        </div>

        <div class="relative">
            <label class="block text-xs font-bold uppercase tracking-wider text-[var(--muted)] mb-2 ml-1" id="label-monto">
                Monto
            </label>
            <div class="relative flex items-center">
                <input type="text" id="monto_visible" 
                       class="gx-input text-3xl font-bold tracking-tight pr-24 h-20 pl-6 shadow-sm" 
                       placeholder="0" inputmode="numeric" autocomplete="off"
                       value="{{ form.monto.value|default:'' }}">
                
                <div class="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none bg-gray-100 rounded-lg px-3 py-2 border border-gray-200 flex items-center gap-2">
                    <span id="currency-flag" class="text-2xl leading-none">üá∫üá∏</span>
                    <span id="currency-code" class="font-black text-gray-600 text-lg leading-none">USD</span>
                </div>
            </div>
            {% if form.monto.errors %}
                <div class="text-red-500 text-sm mt-1 ml-1 font-medium">{{ form.monto.errors }}</div>
            {% endif %}
        </div>

        <div id="result-box" class="bg-gray-50 border border-gray-200 rounded-2xl p-6 text-center transition-all duration-300 opacity-60 grayscale relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-[var(--brand)] to-transparent opacity-50"></div>

            <p class="text-xs font-bold uppercase tracking-wider text-[var(--muted)] mb-2" id="res-label">
                Total Estimado en Guaran√≠es
            </p>
            
            <div class="text-5xl font-black text-[var(--brand)] my-3 tracking-tighter flex items-baseline justify-center gap-1.5" style="text-shadow: 0 2px 10px rgba(115,60,255,0.1);">
                <span class="text-2xl text-[var(--muted)] font-bold translate-y-[-4px]">‚Ç≤</span>
                <span id="res-value">
                    {% if resultado %}{{ resultado.monto_final|floatformat:0 }}{% else %}0{% endif %}
                </span>
            </div>

            <div class="inline-flex items-center gap-2 bg-white px-4 py-1.5 rounded-full border border-gray-200 shadow-sm mt-2">
                <span class="text-lg animate-pulse">üí±</span>
                <span class="text-sm font-semibold text-[var(--ink)]" id="rate-display">
                    {% if resultado %}
                        Cotizaci√≥n aplicada: {{ resultado.tasa|floatformat:0 }} Gs
                    {% else %}
                        Seleccion√° una moneda
                    {% endif %}
                </span>
            </div>
        </div>

      </div>

      <div class="mt-8 pt-8 border-t border-dashed" style="border-color:var(--line)">
        {% if user.is_authenticated %}
            <button id="btn-submit" type="submit" name="proceder" value="1" 
                    class="gx-btn h-14 text-lg shadow-lg hover:shadow-[var(--brand)]/30 transition-all transform hover:-translate-y-0.5" disabled>
                Continuar Operaci√≥n
            </button>
        {% else %}
            <a href="{% url 'login' %}" class="gx-btn h-14 text-lg flex items-center justify-center hover:shadow-lg transition-all">
                Iniciar sesi√≥n para operar
            </a>
        {% endif %}
      </div>

    </form>
  </section>
  
  <div class="flex items-center justify-center gap-2 text-sm text-[var(--muted)] max-w-lg mx-auto opacity-80">
    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
    <p>Las cotizaciones se actualizar√°n al confirmar.</p>
  </div>

</main>

<style>
  /* --- ESTILOS CSS MEJORADOS --- */
  
  /* Input y Select Base */
  .gx-input, .gx-select {
    width:100%; 
    border:1.5px solid var(--line); 
    border-radius:16px; /* M√°s redondeado */
    padding:12px 16px; 
    font-size:1.1rem; 
    color:var(--ink); 
    background:#fff;
    transition: all .25s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  /* Select con apariencia nativa limpia */
  .gx-select { 
    height: 64px; 
    appearance: none; 
    -webkit-appearance: none; 
    cursor: pointer;
    font-weight: 600;
  } 

  /* Estados Focus */
  .gx-input:focus, .gx-select:focus { 
    outline:none; 
    border-color:var(--brand); 
    box-shadow:0 0 0 4px rgba(115,60,255,.12); 
    transform: translateY(-1px);
  }

  /* Bot√≥n Principal */
  .gx-btn {
    background:var(--brand); 
    color:#fff; 
    font-weight:800; 
    border:none; 
    border-radius:14px;
    width:100%; 
    cursor:pointer;
  }
  .gx-btn:active { transform: scale(0.98); }
  .gx-btn:disabled { 
    background: #f3f4f6; 
    color: #9ca3af; 
    cursor: not-allowed; 
    box-shadow: none; 
    transform: none; 
  }

  /* Switch Styles - Mejorado visualmente */
  .op-switch { 
    color: var(--muted); 
    border: 1px solid transparent; 
  }
  .op-switch:hover { 
    background: rgba(0,0,0,0.02); 
    color: var(--ink); 
  }
  
  .op-switch[data-val="compra"].active {
    background: #ecfdf5; 
    color: #047857; 
    border-color: rgba(167, 243, 208, 0.5);
    box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.1);
  }
  
  .op-switch[data-val="venta"].active {
    background: #fff1f2; 
    color: #be123c; 
    border-color: rgba(254, 205, 211, 0.5);
    box-shadow: 0 4px 6px -1px rgba(244, 63, 94, 0.1);
  }

  /* Ocultar input real de monto (accesibilidad mantenida) */
  #id_monto { 
    position: absolute; width: 1px; height: 1px; padding: 0; 
    overflow: hidden; clip: rect(0,0,0,0); border: 0; 
  }
</style>

<script>
(function () {
  // --- CONFIGURACI√ìN & DOM ---
  const form = document.getElementById('form-simulador');
  const currencyData = JSON.parse(form.dataset.currencies || "{}");
  
  let tasasData = {};
  try { 
      const rawJson = document.getElementById('tasas-json').textContent;
      tasasData = JSON.parse(rawJson); 
  } catch(e){ console.error("Error parseando tasas", e); }

  const elOpInput   = document.getElementById('id_tipo_operacion'); // Hidden Django
  const elMoneda    = document.getElementById('id_moneda');         // Select Django
  const elMontoVis  = document.getElementById('monto_visible');     // Input JS
  const elMontoHid  = document.getElementById('id_monto');          // Hidden Django
  const btnSubmit   = document.getElementById('btn-submit');
  
  const uiFlag      = document.getElementById('currency-flag');
  const uiCode      = document.getElementById('currency-code');
  const uiLabelMonto= document.getElementById('label-monto');
  const uiResBox    = document.getElementById('result-box');
  const uiResVal    = document.getElementById('res-value');
  const uiRateDisp  = document.getElementById('rate-display');
  const uiResLabel  = document.getElementById('res-label');

  // --- 1. INYECTAR EMOJIS EN SELECT ---
  if(elMoneda) {
    [...elMoneda.options].forEach(opt => {
        const code = opt.value;
        if(code && (currencyData[code] || tasasData[code])) {
             // Prioridad: 1. Backend Tasas, 2. Dataset HTML, 3. Fallback
             const emoji = (tasasData[code] && tasasData[code].emoji) || (currencyData[code] ? currencyData[code].emoji : 'üè≥Ô∏è');
             const name  = (tasasData[code] && tasasData[code].name)  || (currencyData[code] ? currencyData[code].name : '');
             // Actualizamos el texto del select
             opt.textContent = `${emoji} ${code} - ${name}`;
        }
    });
  }

  // --- 2. SWITCH COMPRA / VENTA ---
  window.setOperation = function(op) {
    if(elOpInput) elOpInput.value = op; 
    
    document.querySelectorAll('.op-switch').forEach(btn => {
        if(btn.dataset.val === op) btn.classList.add('active');
        else btn.classList.remove('active');
    });

    const monedaNombre = elMoneda.options[elMoneda.selectedIndex]?.text.split('-')[1]?.trim() || 'Divisa';
    
    // Cambiamos colores del label seg√∫n operaci√≥n para feedback visual
    if (op === 'compra') {
        uiLabelMonto.textContent = `¬øCu√°ntos ${monedaNombre} quer√©s COMPRAR?`;
        uiLabelMonto.style.color = 'var(--brand)';
        uiResLabel.textContent = "Total Aproximado a PAGAR";
    } else {
        uiLabelMonto.textContent = `¬øCu√°ntos ${monedaNombre} quer√©s VENDER?`;
        uiLabelMonto.style.color = '#be123c'; // Rojo suave
        uiResLabel.textContent = "Total Aproximado a RECIBIR";
    }
    
    calculate();
  };

  // --- 3. LOGICA DE FORMATEO ---
  if(elMontoVis) {
      if(elMontoHid && elMontoHid.value){
          elMontoVis.value = new Intl.NumberFormat('es-PY').format(elMontoHid.value);
      }
      elMontoVis.addEventListener('input', (e) => {
        let raw = e.target.value.replace(/\D/g, '');
        if(elMontoHid) elMontoHid.value = raw;
        if(raw) {
            e.target.value = new Intl.NumberFormat('es-PY').format(raw);
        } else {
            e.target.value = '';
        }
        calculate();
      });
  }

  // --- 4. CALCULADORA EN TIEMPO REAL ---
  function calculate() {
    if(!elMoneda || !elOpInput || !elMontoHid) return;

    const code = elMoneda.value;
    const op = elOpInput.value;
    const monto = parseFloat(elMontoHid.value) || 0;

    // Actualizar "Badge" visual dentro del input
    if(code) {
        // Buscar emoji en tasasData o currencyData
        const emoji = (tasasData[code] && tasasData[code].emoji) || 
                      (currencyData[code] ? currencyData[code].emoji : 'üè≥Ô∏è');
        
        uiFlag.textContent = emoji;
        uiCode.textContent = code;
    }

    if(!code || monto <= 0 || !tasasData[code]) {
        uiResBox.classList.add('opacity-60', 'grayscale');
        if (monto <= 0) uiResVal.textContent = '0';
        if(btnSubmit) btnSubmit.disabled = true;
        if(code && !tasasData[code]) uiRateDisp.textContent = "Cotizaci√≥n no disponible";
        return;
    }

    uiResBox.classList.remove('opacity-60', 'grayscale');
    if(btnSubmit) btnSubmit.disabled = false;

    let tasa = 0;
    if (op === 'compra') {
        tasa = parseFloat(tasasData[code].venta || 0);
    } else {
        tasa = parseFloat(tasasData[code].compra || 0);
    }

    const total = Math.round(monto * tasa);
    
    uiResVal.textContent = new Intl.NumberFormat('es-PY').format(total);
    uiRateDisp.textContent = `1 ${code} = ${new Intl.NumberFormat('es-PY').format(tasa)} Gs`;
  }

  if(elMoneda) {
      elMoneda.addEventListener('change', () => {
          setOperation(elOpInput.value); 
          calculate();
      });
  }

  // Inicializaci√≥n
  const initialOp = elOpInput.value || 'compra';
  setOperation(initialOp);

})();
</script>
{% endblock %}