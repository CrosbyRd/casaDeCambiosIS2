{% extends "base.html" %}
{% load static %}

{% block title %}Global Exchange{% endblock %}
{% block extra_head %}
<link rel="icon" href="{% static 'img/logo.ico' %}" sizes="any">
{% endblock %}

{% block content %}

{# Encabezado sin back_url para no mostrar ‚ÄúVolver‚Äù #}
{% include "partials/page_header.html" with title="Calculadora" subtitle="Simul√° tu conversi√≥n al instante" %}

{% include "partials/messages.html" %}

<main class="max-w-5xl mx-auto px-6 py-10">

  <section class="bg-white border rounded-xl shadow-sm mb-4" style="border-color:var(--line)">

    <form method="post"
          id="form-simulador"
          data-initial-blank="{% if form.is_bound %}0{% else %}1{% endif %}"
          data-currencies='{
            "USD":{"name":"D√≥lar estadounidense","symbol":"$","emoji":"üá∫üá∏"},
            "EUR":{"name":"Euro","symbol":"‚Ç¨","emoji":"üá™üá∫"},
            "ARS":{"name":"Peso argentino","symbol":"$","emoji":"üá¶üá∑"},
            "BRL":{"name":"Real brasile√±o","symbol":"R$","emoji":"üáßüá∑"},
            "CLP":{"name":"Peso chileno","symbol":"$","emoji":"üá®üá±"},
            "COP":{"name":"Peso colombiano","symbol":"$","emoji":"üá®üá¥"},
            "MXN":{"name":"Peso mexicano","symbol":"$","emoji":"üá≤üáΩ"},
            "PEN":{"name":"Sol peruano","symbol":"S/","emoji":"üáµüá™"},
            "PYG":{"name":"Guaran√≠ paraguayo","symbol":"‚Ç≤","emoji":"üáµüáæ"},
            "UYU":{"name":"Peso uruguayo","symbol":"$","emoji":"üá∫üáæ"},
            "GBP":{"name":"Libra esterlina","symbol":"¬£","emoji":"üá¨üáß"},
            "JPY":{"name":"Yen japon√©s","symbol":"¬•","emoji":"üáØüáµ"},
            "CNY":{"name":"Yuan chino","symbol":"¬•","emoji":"üá®üá≥"},
            "AUD":{"name":"D√≥lar australiano","symbol":"$","emoji":"üá¶üá∫"},
            "CAD":{"name":"D√≥lar canadiense","symbol":"$","emoji":"üá®üá¶"},
            "CHF":{"name":"Franco suizo","symbol":"Fr","emoji":"üá®üá≠"}
          }'>
      {% csrf_token %}

      <div class="overflow-x-auto">
        <table class="w-full border-collapse min-w-[520px]">
          <thead class="bg-[var(--brand)] text-white">
            <tr>
              <th class="px-4 py-3 text-left">Tengo esta moneda</th>
              <th class="px-4 py-3 text-left">Quiero esta moneda</th>
            </tr>
          </thead>
          <tbody>
            <tr class="hover:bg-[var(--brand-soft)]">
              <td class="px-4 py-3">{{ form.moneda_origen }}</td>
              <td class="px-4 py-3">{{ form.moneda_destino }}</td>
            </tr>
            <tr class="hover:bg-[var(--brand-soft)]">
              <td class="px-4 py-3">{{ form.monto }}</td>
              <td class="px-4 py-3">
                <input id="out-amount" class="gx-input" type="text" readonly
                       value="{% if resultado and not resultado.error %}{{ resultado.monto_recibido }}{% endif %}"
                       placeholder="0,00">
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="px-4 py-4">
        <div style="margin-top:18px;">
          <button id="btn-calcular" class="gx-btn" type="submit">Calcular</button>

          {% if resultado %}
            {% if resultado.error %}
              <div class="gx-error mt-4"><strong>Error:</strong> {{ resultado.error }}</div>
            {% else %}
              <div class="gx-result-wrap mt-4">
                <div class="gx-result-big">
                  Recibir√°s aproximadamente:
                  <span id="res-num" data-raw="{{ resultado.monto_recibido|default:'' }}">
                    {{ resultado.monto_recibido }}
                  </span>
                  {{ form.moneda_destino.value }}
                </div>
              </div>
            {% endif %}
          {% endif %}
        </div>
      </div>

    </form>
  </section>
</main>

<style>
  .gx-input, .gx-select{
    width:100%; border:1.5px solid var(--line); border-radius:12px;
    padding:12px 14px; height:48px; font-size:1rem; color:var(--ink); background:#fff;
    transition:box-shadow .2s ease,border-color .2s ease;
  }
  .gx-input:focus, .gx-select:focus{ outline:none; border-color:var(--brand); box-shadow:0 0 0 3px rgba(115,60,255,.15); }

  .gx-btn{
    background:var(--brand); color:#fff; font-weight:800; border:none; border-radius:12px;
    padding:12px 16px; font-size:16px; width:100%;
    box-shadow:0 8px 24px color-mix(in oklab, var(--brand) 30%, transparent);
    cursor:pointer;
  }
  .gx-btn[disabled]{opacity:.55;cursor:not-allowed;box-shadow:none;}

  .gx-error{ background:#fee2e2; color:#991b1b; border:1px solid #fecaca; padding:12px 14px; border-radius:12px; }

  .gx-result-wrap{
    background:var(--brand-soft);
    border:1px solid color-mix(in oklab, var(--brand) 35%, white);
    padding:14px 16px; border-radius:14px;
  }
  .gx-result-big{
    font-size:24px; font-weight:900; color:var(--brand);
  }
</style>

<script>
(function () {
  const form   = document.getElementById('form-simulador');
  if (!form) return;

  /* ====== helpers de formato ====== */
  function toNumber(raw){
    if (raw == null) return NaN;
    const s = String(raw).replace(/\./g,'').replace(',','.');
    const n = parseFloat(s);
    return Number.isFinite(n) ? n : NaN;
  }
  function fmt(n){
    const num = typeof n === 'number' ? n : toNumber(n);
    if (!Number.isFinite(num)) return n;
    // miles con punto, decimales con coma
    return num.toLocaleString('es-ES', { minimumFractionDigits: 0, maximumFractionDigits: 6 });
  }

  // Formateo de preview / resultado (si existe)
  const out = document.getElementById('out-amount');
  if (out && out.value) out.value = fmt(out.value);
  const res = document.getElementById('res-num');
  if (res) { const raw = res.dataset.raw || res.textContent; res.textContent = fmt(raw); }

  /* ====== selects y reglas ====== */
  const data   = JSON.parse(form.dataset.currencies || "{}");
  const selOri = document.getElementById('id_moneda_origen');
  const selDst = document.getElementById('id_moneda_destino');
  const monto  = document.getElementById('id_monto');
  const btn    = document.getElementById('btn-calcular');

  const isPYG     = (v) => String(v || '').toUpperCase() === 'PYG';
  const isForeign = (v) => v && !isPYG(v);

  function decorateSelect(sel){
    if(!sel) return;
    [...sel.options].forEach(opt=>{
      const code = opt.value; if (code && data[code]) {
        const {emoji, name} = data[code];
        opt.textContent = `${emoji} ${code} ‚Äî ${name}`;
      }
    });
    sel.classList.add('gx-select');
  }
  function ensurePlaceholder(sel){
    if(!sel) return;
    if(!sel.querySelector('option[value=""]')){
      const ph = document.createElement('option');
      ph.value = ''; ph.textContent = 'Seleccion√° una moneda‚Ä¶'; ph.disabled = true; ph.hidden = true;
      sel.insertBefore(ph, sel.firstChild);
    }
  }

  decorateSelect(selOri); decorateSelect(selDst);
  ensurePlaceholder(selOri); ensurePlaceholder(selDst);
  if (monto) monto.classList.add('gx-input');

  // Dejar vac√≠os al entrar por primera vez (solo GET, sin datos)
  if (form.dataset.initialBlank === '1') {
    selOri.value = '';
    selDst.value = '';
  }

  function enforceRules(changed){
    const o = selOri?.value || '';
    const d = selDst?.value || '';

    // Si una es extranjera, la otra debe ser PYG
    if (changed === 'ori' && isForeign(o)) { if (!isPYG(d)) selDst.value = 'PYG'; }
    if (changed === 'dst' && isForeign(d)) { if (!isPYG(o)) selOri.value = 'PYG'; }

    // Nunca ambas PYG simult√°neamente
    if (isPYG(selOri.value) && isPYG(selDst.value)) {
      if (changed === 'ori') selDst.value = '';
      else if (changed === 'dst') selOri.value = '';
      else selDst.value = '';
    }

    // Habilitar bot√≥n solo cuando se puede calcular
    const ready = selOri.value && selDst.value && selOri.value !== selDst.value &&
                  (!monto || (toNumber(monto.value) > 0));
    btn.disabled = !ready;
  }

  selOri?.addEventListener('change', () => enforceRules('ori'));
  selDst?.addEventListener('change', () => enforceRules('dst'));
  monto?.addEventListener('input', () => enforceRules('amount'));
  enforceRules(); // estado inicial
})();
</script>

{% endblock %}
