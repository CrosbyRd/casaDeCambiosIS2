

<!DOCTYPE html>
<html class="writer-html5" lang="es" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>core.tests &mdash; documentación de CasaDeCambioIS2 Documentation - </title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=e2bb6099"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../_static/translations.js?v=f85f4cfb"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Índice" href="../../genindex.html" />
    <link rel="search" title="Búsqueda" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            CasaDeCambioIS2 Documentation
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Buscar documentos" aria-label="Buscar documentos" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">casaDeCambiosIS2</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">CasaDeCambioIS2 Documentation</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Código de módulo</a></li>
      <li class="breadcrumb-item active">core.tests</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Código fuente para core.tests</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Módulo de pruebas unitarias para la lógica de simulación de cambio de divisas.</span>

<span class="sd">Este módulo contiene pruebas para la función `calcular_simulacion` en `core.logic`,</span>
<span class="sd">asegurando que los cálculos de compra/venta, la aplicación de bonificaciones y</span>
<span class="sd">el manejo de errores funcionen como se espera.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.test</span><span class="w"> </span><span class="kn">import</span> <span class="n">TestCase</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">decimal</span><span class="w"> </span><span class="kn">import</span> <span class="n">Decimal</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">patch</span><span class="p">,</span> <span class="n">Mock</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">core.logic</span><span class="w"> </span><span class="kn">import</span> <span class="n">calcular_simulacion</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.contrib.auth</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_user_model</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">clientes.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Cliente</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cotizaciones.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Cotizacion</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">monedas.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Moneda</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">timezone</span> <span class="c1"># Importar timezone</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">timedelta</span> <span class="c1"># Importar timedelta</span>
<span class="c1"># Importar excepciones específicas si se desea mockearlas con precisión</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.core.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">ObjectDoesNotExist</span> <span class="k">as</span> <span class="n">DjangoObjectDoesNotExist</span>

<span class="n">User</span> <span class="o">=</span> <span class="n">get_user_model</span><span class="p">()</span>

<div class="viewcode-block" id="SimulacionLogicTest">
<a class="viewcode-back" href="../../core.html#core.tests.SimulacionLogicTest">[documentos]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">SimulacionLogicTest</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Conjunto de pruebas para la función `calcular_simulacion` en `core.logic`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="SimulacionLogicTest.setUpTestData">
<a class="viewcode-back" href="../../core.html#core.tests.SimulacionLogicTest.setUpTestData">[documentos]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">setUpTestData</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Configura los datos de prueba iniciales para todas las pruebas de la clase.</span>
<span class="sd">        Asegura que los objetos Moneda esenciales existan en la base de datos de prueba.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Moneda</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">codigo</span><span class="o">=</span><span class="s1">&#39;PYG&#39;</span><span class="p">,</span> <span class="n">nombre</span><span class="o">=</span><span class="s1">&#39;Guaraní Paraguayo&#39;</span><span class="p">,</span> <span class="n">decimales</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">minima_denominacion</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;100&#39;</span><span class="p">))</span>
        <span class="n">Moneda</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">codigo</span><span class="o">=</span><span class="s1">&#39;USD&#39;</span><span class="p">,</span> <span class="n">nombre</span><span class="o">=</span><span class="s1">&#39;Dólar Estadounidense&#39;</span><span class="p">,</span> <span class="n">decimales</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">minima_denominacion</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;0.01&#39;</span><span class="p">))</span>
        <span class="n">Moneda</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">codigo</span><span class="o">=</span><span class="s1">&#39;EUR&#39;</span><span class="p">,</span> <span class="n">nombre</span><span class="o">=</span><span class="s1">&#39;Euro&#39;</span><span class="p">,</span> <span class="n">decimales</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">minima_denominacion</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;0.01&#39;</span><span class="p">))</span></div>

        <span class="c1"># No creamos &#39;BTC&#39; intencionalmente para probar escenarios de moneda no existente.</span>

<div class="viewcode-block" id="SimulacionLogicTest.test_venta_usd_minorista">
<a class="viewcode-back" href="../../core.html#core.tests.SimulacionLogicTest.test_venta_usd_minorista">[documentos]</a>
    <span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;clientes.models.Cliente.objects.first&#39;</span><span class="p">)</span>
    <span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;cotizaciones.models.Cotizacion.objects.get&#39;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_venta_usd_minorista</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_cotizacion_get</span><span class="p">,</span> <span class="n">mock_cliente_first</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prueba la venta de USD (PYG -&gt; USD) para un cliente minorista sin bonificación.</span>

<span class="sd">        Verifica que el monto recibido, la tasa aplicada y la bonificación sean correctos</span>
<span class="sd">        cuando un cliente minorista vende PYG para comprar USD.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mock_client_instance</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">(</span><span class="n">spec</span><span class="o">=</span><span class="n">Cliente</span><span class="p">)</span>
        <span class="n">mock_client_instance</span><span class="o">.</span><span class="n">bonificacion</span> <span class="o">=</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;0&#39;</span><span class="p">)</span>
        <span class="n">mock_cliente_first</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_client_instance</span>

        <span class="c1"># Mock del objeto Cotizacion con precisión Decimal apropiada</span>
        <span class="n">mock_cotizacion_instance</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">(</span><span class="n">spec</span><span class="o">=</span><span class="n">Cotizacion</span><span class="p">)</span>
        <span class="n">mock_cotizacion_instance</span><span class="o">.</span><span class="n">moneda_base</span><span class="o">.</span><span class="n">codigo</span> <span class="o">=</span> <span class="s1">&#39;PYG&#39;</span>
        <span class="n">mock_cotizacion_instance</span><span class="o">.</span><span class="n">moneda_destino</span><span class="o">.</span><span class="n">codigo</span> <span class="o">=</span> <span class="s1">&#39;USD&#39;</span>
        <span class="n">mock_cotizacion_instance</span><span class="o">.</span><span class="n">valor_venta</span> <span class="o">=</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;7450.0000&#39;</span><span class="p">)</span> <span class="c1"># Precisión explícita</span>
        <span class="n">mock_cotizacion_instance</span><span class="o">.</span><span class="n">comision_venta</span> <span class="o">=</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;100.0000&#39;</span><span class="p">)</span> <span class="c1"># Precisión explícita</span>
        <span class="n">mock_cotizacion_get</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_cotizacion_instance</span>

        <span class="n">mock_user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">resultado</span> <span class="o">=</span> <span class="n">calcular_simulacion</span><span class="p">(</span>
            <span class="n">monto_origen</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;755000&#39;</span><span class="p">),</span>
            <span class="n">moneda_origen</span><span class="o">=</span><span class="s1">&#39;PYG&#39;</span><span class="p">,</span>
            <span class="n">moneda_destino</span><span class="o">=</span><span class="s1">&#39;USD&#39;</span><span class="p">,</span>
            <span class="n">user</span><span class="o">=</span><span class="n">mock_user</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">resultado</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">resultado</span><span class="p">[</span><span class="s1">&#39;monto_recibido&#39;</span><span class="p">],</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;100.00&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">resultado</span><span class="p">[</span><span class="s1">&#39;tasa_aplicada&#39;</span><span class="p">],</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;7550.0000&#39;</span><span class="p">))</span> <span class="c1"># Usar precisión consistente con el modelo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">resultado</span><span class="p">[</span><span class="s1">&#39;bonificacion_aplicada&#39;</span><span class="p">],</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;0.0000&#39;</span><span class="p">))</span> <span class="c1"># Usar precisión consistente con el modelo</span>

        <span class="n">mock_cotizacion_get</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
            <span class="n">moneda_base__codigo</span><span class="o">=</span><span class="s1">&#39;PYG&#39;</span><span class="p">,</span>
            <span class="n">moneda_destino__codigo</span><span class="o">=</span><span class="s1">&#39;USD&#39;</span>
        <span class="p">)</span></div>



<div class="viewcode-block" id="SimulacionLogicTest.test_compra_eur_vip">
<a class="viewcode-back" href="../../core.html#core.tests.SimulacionLogicTest.test_compra_eur_vip">[documentos]</a>
    <span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;cotizaciones.models.Cotizacion.objects.get&#39;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_compra_eur_vip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_cotizacion_get</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prueba la compra de EUR (EUR -&gt; PYG) para un cliente VIP con 10% de bonificación.</span>

<span class="sd">        Verifica que el monto recibido, la bonificación aplicada y la tasa sean correctos</span>
<span class="sd">        cuando un cliente VIP compra PYG con EUR, aplicando la bonificación sobre la comisión.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mock_client_instance</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">(</span><span class="n">spec</span><span class="o">=</span><span class="n">Cliente</span><span class="p">)</span>
        <span class="n">mock_client_instance</span><span class="o">.</span><span class="n">bonificacion</span> <span class="o">=</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;10.0&#39;</span><span class="p">)</span> <span class="c1"># Precisión explícita</span>
        <span class="n">mock_client_instance</span><span class="o">.</span><span class="n">tipo_cliente</span> <span class="o">=</span> <span class="s1">&#39;VIP&#39;</span>

        <span class="c1"># Mock del objeto Cotizacion con precisión explícita</span>
        <span class="n">mock_cotizacion_instance</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">(</span><span class="n">spec</span><span class="o">=</span><span class="n">Cotizacion</span><span class="p">)</span>
        <span class="n">mock_cotizacion_instance</span><span class="o">.</span><span class="n">moneda_base</span><span class="o">.</span><span class="n">codigo</span> <span class="o">=</span> <span class="s1">&#39;PYG&#39;</span>
        <span class="n">mock_cotizacion_instance</span><span class="o">.</span><span class="n">moneda_destino</span><span class="o">.</span><span class="n">codigo</span> <span class="o">=</span> <span class="s1">&#39;EUR&#39;</span>
        <span class="n">mock_cotizacion_instance</span><span class="o">.</span><span class="n">valor_compra</span> <span class="o">=</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;8100.0000&#39;</span><span class="p">)</span> <span class="c1"># Precisión explícita</span>
        <span class="n">mock_cotizacion_instance</span><span class="o">.</span><span class="n">comision_compra</span> <span class="o">=</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;60.0000&#39;</span><span class="p">)</span> <span class="c1"># Precisión explícita</span>
        <span class="n">mock_cotizacion_get</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_cotizacion_instance</span>

        <span class="n">mock_user</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">(</span><span class="n">spec</span><span class="o">=</span><span class="n">User</span><span class="p">)</span> <span class="c1"># Crear un mock de usuario</span>
        <span class="n">mock_user</span><span class="o">.</span><span class="n">is_authenticated</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># Asegurar que el usuario está autenticado</span>
        <span class="n">mock_user</span><span class="o">.</span><span class="n">clientes</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span> <span class="c1"># Mockear el atributo &#39;clientes&#39;</span>
        <span class="n">mock_user</span><span class="o">.</span><span class="n">clientes</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_client_instance</span> <span class="c1"># Configurar first() para devolver el cliente mockeado</span>

        <span class="n">resultado</span> <span class="o">=</span> <span class="n">calcular_simulacion</span><span class="p">(</span>
            <span class="n">monto_origen</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;100&#39;</span><span class="p">),</span>
            <span class="n">moneda_origen</span><span class="o">=</span><span class="s1">&#39;EUR&#39;</span><span class="p">,</span>
            <span class="n">moneda_destino</span><span class="o">=</span><span class="s1">&#39;PYG&#39;</span><span class="p">,</span>
            <span class="n">user</span><span class="o">=</span><span class="n">mock_user</span> <span class="c1"># Pasar el usuario mockeado</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">resultado</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">resultado</span><span class="p">[</span><span class="s1">&#39;monto_recibido&#39;</span><span class="p">],</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;804600.00&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">resultado</span><span class="p">[</span><span class="s1">&#39;bonificacion_aplicada&#39;</span><span class="p">],</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;6.0000&#39;</span><span class="p">))</span> <span class="c1"># Precisión explícita</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">resultado</span><span class="p">[</span><span class="s1">&#39;tasa_aplicada&#39;</span><span class="p">],</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;8046.0000&#39;</span><span class="p">))</span> <span class="c1"># Precisión explícita</span>

        <span class="n">mock_cotizacion_get</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
            <span class="n">moneda_base__codigo</span><span class="o">=</span><span class="s1">&#39;PYG&#39;</span><span class="p">,</span>
            <span class="n">moneda_destino__codigo</span><span class="o">=</span><span class="s1">&#39;EUR&#39;</span>
        <span class="p">)</span></div>



<div class="viewcode-block" id="SimulacionLogicTest.test_error_moneda_invalida">
<a class="viewcode-back" href="../../core.html#core.tests.SimulacionLogicTest.test_error_moneda_invalida">[documentos]</a>
    <span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;monedas.models.Moneda.objects.get&#39;</span><span class="p">)</span> <span class="c1"># Mockear sin side_effect inicialmente</span>
    <span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;cotizaciones.models.Cotizacion.objects.get&#39;</span><span class="p">,</span> <span class="n">side_effect</span><span class="o">=</span><span class="n">Cotizacion</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">(</span><span class="s2">&quot;Cotización no encontrada para el par&quot;</span><span class="p">))</span>
    <span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;clientes.models.Cliente.objects.first&#39;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_error_moneda_invalida</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_cliente_first</span><span class="p">,</span> <span class="n">mock_cotizacion_get</span><span class="p">,</span> <span class="n">mock_moneda_get</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prueba que la función devuelve un error si la moneda de destino no existe.</span>

<span class="sd">        Configura mocks para que la moneda de origen (PYG) sea válida, pero la de destino (BTC)</span>
<span class="sd">        genere un error de Moneda.DoesNotExist.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mock_cliente_first</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Configurar mock_moneda_get para devolver objetos específicos o lanzar excepciones</span>
        <span class="c1"># basándose en el &#39;codigo&#39; de la moneda.</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">mock_get_moneda_side_effect</span><span class="p">(</span><span class="n">codigo</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">codigo</span> <span class="o">==</span> <span class="s1">&#39;PYG&#39;</span><span class="p">:</span>
                <span class="c1"># Devolver un objeto Moneda mockeado para PYG</span>
                <span class="n">mock_pyg</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">(</span><span class="n">spec</span><span class="o">=</span><span class="n">Moneda</span><span class="p">)</span>
                <span class="n">mock_pyg</span><span class="o">.</span><span class="n">codigo</span> <span class="o">=</span> <span class="s1">&#39;PYG&#39;</span>
                <span class="n">mock_pyg</span><span class="o">.</span><span class="n">decimales</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">mock_pyg</span><span class="o">.</span><span class="n">minima_denominacion</span> <span class="o">=</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;100&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">mock_pyg</span>
            <span class="k">elif</span> <span class="n">codigo</span> <span class="o">==</span> <span class="s1">&#39;BTC&#39;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">Moneda</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Moneda matching query does not exist for &#39;</span><span class="si">{</span><span class="n">codigo</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Fallback para otras llamadas inesperadas</span>
                <span class="k">raise</span> <span class="n">Moneda</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Moneda matching query does not exist for &#39;</span><span class="si">{</span><span class="n">codigo</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>

        <span class="n">mock_moneda_get</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">mock_get_moneda_side_effect</span>

        <span class="n">resultado</span> <span class="o">=</span> <span class="n">calcular_simulacion</span><span class="p">(</span>
            <span class="n">monto_origen</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;1000&#39;</span><span class="p">),</span>
            <span class="n">moneda_origen</span><span class="o">=</span><span class="s1">&#39;PYG&#39;</span><span class="p">,</span>
            <span class="n">moneda_destino</span><span class="o">=</span><span class="s1">&#39;BTC&#39;</span><span class="p">,</span> <span class="c1"># Moneda inválida</span>
            <span class="n">user</span><span class="o">=</span><span class="kc">None</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">resultado</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s1">&#39;BTC&#39;</span><span class="p">,</span> <span class="n">resultado</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s2">&quot;Moneda de destino &#39;BTC&#39; no encontrada.&quot;</span><span class="p">,</span> <span class="n">resultado</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">])</span></div>



<div class="viewcode-block" id="SimulacionLogicTest.test_error_transaccion_no_pyg">
<a class="viewcode-back" href="../../core.html#core.tests.SimulacionLogicTest.test_error_transaccion_no_pyg">[documentos]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_error_transaccion_no_pyg</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prueba que la función devuelve un error si la simulación no involucra PYG.</span>

<span class="sd">        Verifica que se genere un ValueError cuando se intenta una transacción</span>
<span class="sd">        directa entre dos monedas extranjeras (USD a EUR).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># No se necesita un mock explícito para Cotizacion.objects.get aquí, ya que la lógica</span>
        <span class="c1"># debería alcanzar el ValueError antes de intentar buscar una cotización.</span>
        <span class="c1"># setUpTestData asegura que los objetos Moneda &#39;USD&#39; y &#39;EUR&#39; existan.</span>
        <span class="n">resultado</span> <span class="o">=</span> <span class="n">calcular_simulacion</span><span class="p">(</span>
            <span class="n">monto_origen</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;100&#39;</span><span class="p">),</span>
            <span class="n">moneda_origen</span><span class="o">=</span><span class="s1">&#39;USD&#39;</span><span class="p">,</span>
            <span class="n">moneda_destino</span><span class="o">=</span><span class="s1">&#39;EUR&#39;</span><span class="p">,</span>
            <span class="n">user</span><span class="o">=</span><span class="kc">None</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">resultado</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s1">&#39;La simulación debe ser entre PYG&#39;</span><span class="p">,</span> <span class="n">resultado</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">])</span></div>
</div>

        
<span class="c1"># To run tests: python manage.py test core</span>


<div class="viewcode-block" id="SimulacionLogicConcrectTest">
<a class="viewcode-back" href="../../core.html#core.tests.SimulacionLogicConcrectTest">[documentos]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">SimulacionLogicConcrectTest</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Conjunto de pruebas para la función `calcular_simulacion` utilizando</span>
<span class="sd">    datos reales en la base de datos de prueba para verificar los cálculos</span>
<span class="sd">    específicos de la lógica de negocio.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="SimulacionLogicConcrectTest.setUpTestData">
<a class="viewcode-back" href="../../core.html#core.tests.SimulacionLogicConcrectTest.setUpTestData">[documentos]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">setUpTestData</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Configura los datos de prueba necesarios para los escenarios de negocio.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Crear Monedas</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">pyg</span> <span class="o">=</span> <span class="n">Moneda</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">codigo</span><span class="o">=</span><span class="s1">&#39;PYG&#39;</span><span class="p">,</span> <span class="n">nombre</span><span class="o">=</span><span class="s1">&#39;Guaraní&#39;</span><span class="p">,</span> <span class="n">decimales</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">usd</span> <span class="o">=</span> <span class="n">Moneda</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">codigo</span><span class="o">=</span><span class="s1">&#39;USD&#39;</span><span class="p">,</span> <span class="n">nombre</span><span class="o">=</span><span class="s1">&#39;Dólar&#39;</span><span class="p">,</span> <span class="n">decimales</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="c1"># Crear Usuarios</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">user_vip</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span>
            <span class="n">email</span><span class="o">=</span><span class="s1">&#39;vip@example.com&#39;</span><span class="p">,</span>
            <span class="n">password</span><span class="o">=</span><span class="s1">&#39;password&#39;</span><span class="p">,</span>
            <span class="n">first_name</span><span class="o">=</span><span class="s1">&#39;Vip&#39;</span><span class="p">,</span>
            <span class="n">last_name</span><span class="o">=</span><span class="s1">&#39;User&#39;</span>
        <span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">user_corp</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span>
            <span class="n">email</span><span class="o">=</span><span class="s1">&#39;corp@example.com&#39;</span><span class="p">,</span>
            <span class="n">password</span><span class="o">=</span><span class="s1">&#39;password&#39;</span><span class="p">,</span>
            <span class="n">first_name</span><span class="o">=</span><span class="s1">&#39;Corp&#39;</span><span class="p">,</span>
            <span class="n">last_name</span><span class="o">=</span><span class="s1">&#39;User&#39;</span>
        <span class="p">)</span>

        <span class="c1"># Crear Clientes y asociarlos a los usuarios</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">cliente_vip</span> <span class="o">=</span> <span class="n">Cliente</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">nombre</span><span class="o">=</span><span class="s1">&#39;Cliente VIP de Prueba&#39;</span><span class="p">,</span>
            <span class="n">categoria</span><span class="o">=</span><span class="n">Cliente</span><span class="o">.</span><span class="n">Categoria</span><span class="o">.</span><span class="n">VIP</span>
        <span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">user_vip</span><span class="o">.</span><span class="n">clientes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">cliente_vip</span><span class="p">)</span>

        <span class="bp">cls</span><span class="o">.</span><span class="n">cliente_corp</span> <span class="o">=</span> <span class="n">Cliente</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">nombre</span><span class="o">=</span><span class="s1">&#39;Cliente Corporativo de Prueba&#39;</span><span class="p">,</span>
            <span class="n">categoria</span><span class="o">=</span><span class="n">Cliente</span><span class="o">.</span><span class="n">Categoria</span><span class="o">.</span><span class="n">CORPORATIVO</span>
        <span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">user_corp</span><span class="o">.</span><span class="n">clientes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">cliente_corp</span><span class="p">)</span>

        <span class="c1"># Crear Cotización con los valores del ejemplo</span>
        <span class="c1"># PB_DOLAR = 7.300, COMISION_VTA = 100, COMISION_COM = 50</span>
        <span class="n">Cotizacion</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">moneda_base</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">pyg</span><span class="p">,</span>
            <span class="n">moneda_destino</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">usd</span><span class="p">,</span>
            <span class="n">valor_venta</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;7300&#39;</span><span class="p">),</span>
            <span class="n">comision_venta</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;100&#39;</span><span class="p">),</span>
            <span class="n">valor_compra</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;7300&#39;</span><span class="p">),</span>
            <span class="n">comision_compra</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;50&#39;</span><span class="p">)</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="SimulacionLogicConcrectTest.test_venta_a_cliente_vip">
<a class="viewcode-back" href="../../core.html#core.tests.SimulacionLogicConcrectTest.test_venta_a_cliente_vip">[documentos]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_venta_a_cliente_vip</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verifica el cálculo de venta de 1000 USD a un cliente VIP.</span>
<span class="sd">        Fórmula: DOLARES = GUARANIES / (PB_DOLAR + COMISION_VTA - (COMISION_VTA * 10%))</span>
<span class="sd">        TC_VTA_VIP = 7300 + 100 - (100 * 0.10) = 7390</span>
<span class="sd">        GUARANIES para 1000 USD = 1000 * 7390 = 7,390,000</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">monto_pyg</span> <span class="o">=</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;7390000&#39;</span><span class="p">)</span>
        <span class="n">resultado</span> <span class="o">=</span> <span class="n">calcular_simulacion</span><span class="p">(</span>
            <span class="n">monto_origen</span><span class="o">=</span><span class="n">monto_pyg</span><span class="p">,</span>
            <span class="n">moneda_origen</span><span class="o">=</span><span class="s1">&#39;PYG&#39;</span><span class="p">,</span>
            <span class="n">moneda_destino</span><span class="o">=</span><span class="s1">&#39;USD&#39;</span><span class="p">,</span>
            <span class="n">user</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">user_vip</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">resultado</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">])</span>
        <span class="c1"># La bonificación es el 10% de la comisión de 100 = 10</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">resultado</span><span class="p">[</span><span class="s1">&#39;bonificacion_aplicada&#39;</span><span class="p">],</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;10.0&#39;</span><span class="p">))</span>
        <span class="c1"># La tasa aplicada es 7300 + 100 - 10 = 7390</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">resultado</span><span class="p">[</span><span class="s1">&#39;tasa_aplicada&#39;</span><span class="p">],</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;7390.0&#39;</span><span class="p">))</span>
        <span class="c1"># El monto recibido debe ser 7,390,000 / 7390 = 1000</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">resultado</span><span class="p">[</span><span class="s1">&#39;monto_recibido&#39;</span><span class="p">],</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;1000.00&#39;</span><span class="p">))</span></div>


<div class="viewcode-block" id="SimulacionLogicConcrectTest.test_compra_a_cliente_corporativo">
<a class="viewcode-back" href="../../core.html#core.tests.SimulacionLogicConcrectTest.test_compra_a_cliente_corporativo">[documentos]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_compra_a_cliente_corporativo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verifica el cálculo de compra de 1000 USD a un cliente Corporativo.</span>
<span class="sd">        Fórmula: GUARANIES = DOLARES * (PB_DOLAR - (COMISION_COM - (COMISION_COM * 5%)))</span>
<span class="sd">        COMISION_FINAL = 50 - (50 * 0.05) = 50 - 2.5 = 47.5</span>
<span class="sd">        TC_COMP_CORP = 7300 - 47.5 = 7252.5</span>
<span class="sd">        GUARANIES por 1000 USD = 1000 * 7252.5 = 7,252,500</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">monto_usd</span> <span class="o">=</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;1000&#39;</span><span class="p">)</span>
        <span class="n">resultado</span> <span class="o">=</span> <span class="n">calcular_simulacion</span><span class="p">(</span>
            <span class="n">monto_origen</span><span class="o">=</span><span class="n">monto_usd</span><span class="p">,</span>
            <span class="n">moneda_origen</span><span class="o">=</span><span class="s1">&#39;USD&#39;</span><span class="p">,</span>
            <span class="n">moneda_destino</span><span class="o">=</span><span class="s1">&#39;PYG&#39;</span><span class="p">,</span>
            <span class="n">user</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">user_corp</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">resultado</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">])</span>
        <span class="c1"># La bonificación (descuento en comisión) es 5% de 50 = 2.5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">resultado</span><span class="p">[</span><span class="s1">&#39;bonificacion_aplicada&#39;</span><span class="p">],</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;2.5&#39;</span><span class="p">))</span>
        <span class="c1"># La tasa aplicada es 7300 - (50 - 2.5) = 7252.5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">resultado</span><span class="p">[</span><span class="s1">&#39;tasa_aplicada&#39;</span><span class="p">],</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;7252.5&#39;</span><span class="p">))</span>
        <span class="c1"># El monto recibido debe ser 1000 * 7252.5 = 7,252,500</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">resultado</span><span class="p">[</span><span class="s1">&#39;monto_recibido&#39;</span><span class="p">],</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;7252500&#39;</span><span class="p">))</span></div>
</div>



<span class="kn">from</span><span class="w"> </span><span class="nn">django.urls</span><span class="w"> </span><span class="kn">import</span> <span class="n">reverse</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.test</span><span class="w"> </span><span class="kn">import</span> <span class="n">Client</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">transacciones.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Transaccion</span>

<div class="viewcode-block" id="CoreViewsTest">
<a class="viewcode-back" href="../../core.html#core.tests.CoreViewsTest">[documentos]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">CoreViewsTest</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Pruebas para las vistas en la app `core` que manejan el flujo de operaciones.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="CoreViewsTest.setUpTestData">
<a class="viewcode-back" href="../../core.html#core.tests.CoreViewsTest.setUpTestData">[documentos]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">setUpTestData</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="s1">&#39;testuser@example.com&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">&#39;password&#39;</span><span class="p">,</span> <span class="n">is_active</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">cliente</span> <span class="o">=</span> <span class="n">Cliente</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">nombre</span><span class="o">=</span><span class="s1">&#39;Test Client&#39;</span><span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">clientes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">cliente</span><span class="p">)</span>
        
        <span class="bp">cls</span><span class="o">.</span><span class="n">pyg</span> <span class="o">=</span> <span class="n">Moneda</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">codigo</span><span class="o">=</span><span class="s1">&#39;PYG&#39;</span><span class="p">,</span> <span class="n">nombre</span><span class="o">=</span><span class="s1">&#39;Guaraní&#39;</span><span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">usd</span> <span class="o">=</span> <span class="n">Moneda</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">codigo</span><span class="o">=</span><span class="s1">&#39;USD&#39;</span><span class="p">,</span> <span class="n">nombre</span><span class="o">=</span><span class="s1">&#39;Dólar&#39;</span><span class="p">)</span>
        
        <span class="n">Cotizacion</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">moneda_base</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">pyg</span><span class="p">,</span>
            <span class="n">moneda_destino</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">usd</span><span class="p">,</span>
            <span class="n">valor_venta</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;7400&#39;</span><span class="p">),</span>
            <span class="n">comision_venta</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;100&#39;</span><span class="p">),</span>
            <span class="n">valor_compra</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;7300&#39;</span><span class="p">),</span>
            <span class="n">comision_compra</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;50&#39;</span><span class="p">)</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="CoreViewsTest.setUp">
<a class="viewcode-back" href="../../core.html#core.tests.CoreViewsTest.setUp">[documentos]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="s1">&#39;testuser@example.com&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">&#39;password&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="CoreViewsTest.test_confirmar_operacion_crea_transaccion_con_bloqueo_tasa">
<a class="viewcode-back" href="../../core.html#core.tests.CoreViewsTest.test_confirmar_operacion_crea_transaccion_con_bloqueo_tasa">[documentos]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_confirmar_operacion_crea_transaccion_con_bloqueo_tasa</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verifica que la vista `confirmar_operacion` crea una transacción de tipo &#39;compra&#39;</span>
<span class="sd">        (cliente vende USD) y establece correctamente el campo `tasa_garantizada_hasta`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># 1. Simular los datos que la vista `iniciar_operacion` guardaría en la sesión</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">session</span>
        <span class="n">session</span><span class="p">[</span><span class="s1">&#39;operacion_pendiente&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;tipo_operacion&#39;</span><span class="p">:</span> <span class="s1">&#39;compra&#39;</span><span class="p">,</span> <span class="c1"># Cliente vende USD</span>
            <span class="s1">&#39;moneda_origen_codigo&#39;</span><span class="p">:</span> <span class="s1">&#39;USD&#39;</span><span class="p">,</span>
            <span class="s1">&#39;monto_origen&#39;</span><span class="p">:</span> <span class="s1">&#39;100.00&#39;</span><span class="p">,</span>
            <span class="s1">&#39;moneda_destino_codigo&#39;</span><span class="p">:</span> <span class="s1">&#39;PYG&#39;</span><span class="p">,</span>
            <span class="s1">&#39;monto_recibido&#39;</span><span class="p">:</span> <span class="s1">&#39;725000.00&#39;</span><span class="p">,</span> <span class="c1"># (7300 - 50) * 100</span>
            <span class="s1">&#39;tasa_aplicada&#39;</span><span class="p">:</span> <span class="s1">&#39;7250.00&#39;</span><span class="p">,</span>
            <span class="s1">&#39;comision_aplicada&#39;</span><span class="p">:</span> <span class="s1">&#39;0.00&#39;</span><span class="p">,</span> <span class="c1"># Simplificado para la prueba</span>
        <span class="p">}</span>
        <span class="n">session</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="c1"># 2. Realizar el POST a la vista de confirmación</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">reverse</span><span class="p">(</span><span class="s1">&#39;core:confirmar_operacion&#39;</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

        <span class="c1"># 3. Verificar la redirección y la creación del objeto</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="mi">302</span><span class="p">)</span>
        <span class="c1"># La redirección ahora va a la página de detalle de la operación</span>
        <span class="n">transaccion_id</span> <span class="o">=</span> <span class="n">Transaccion</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">id</span> <span class="c1"># Obtener el ID de la transacción creada</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRedirects</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">reverse</span><span class="p">(</span><span class="s1">&#39;core:detalle_transaccion&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">transaccion_id</span><span class="p">]))</span>

        <span class="c1"># 4. Comprobar que la transacción se creó con los datos correctos</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">Transaccion</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">exists</span><span class="p">())</span>
        <span class="n">transaccion</span> <span class="o">=</span> <span class="n">Transaccion</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">transaccion</span><span class="o">.</span><span class="n">cliente</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">transaccion</span><span class="o">.</span><span class="n">tipo_operacion</span><span class="p">,</span> <span class="s1">&#39;compra&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">transaccion</span><span class="o">.</span><span class="n">estado</span><span class="p">,</span> <span class="s1">&#39;pendiente_deposito_tauser&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">transaccion</span><span class="o">.</span><span class="n">tasa_garantizada_hasta</span><span class="p">)</span>

        <span class="c1"># 5. Verificar que la fecha de garantía sea aproximadamente 2 horas en el futuro</span>
        <span class="n">ahora</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">dos_horas_despues</span> <span class="o">=</span> <span class="n">ahora</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">diferencia</span> <span class="o">=</span> <span class="n">dos_horas_despues</span> <span class="o">-</span> <span class="n">transaccion</span><span class="o">.</span><span class="n">tasa_garantizada_hasta</span>
        
        <span class="c1"># Permitimos una pequeña diferencia (ej. 5 segundos) para la ejecución del código</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">diferencia</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">())</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span></div>


<div class="viewcode-block" id="CoreViewsTest.test_confirmar_operacion_crea_transaccion_venta_con_bloqueo_tasa_15min">
<a class="viewcode-back" href="../../core.html#core.tests.CoreViewsTest.test_confirmar_operacion_crea_transaccion_venta_con_bloqueo_tasa_15min">[documentos]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_confirmar_operacion_crea_transaccion_venta_con_bloqueo_tasa_15min</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verifica que la vista `confirmar_operacion` crea una transacción de tipo &#39;venta&#39;</span>
<span class="sd">        (cliente compra USD) y establece `tasa_garantizada_hasta` a 15 minutos.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># 1. Simular los datos que la vista `iniciar_operacion` guardaría en la sesión</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">session</span>
        <span class="n">session</span><span class="p">[</span><span class="s1">&#39;operacion_pendiente&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;tipo_operacion&#39;</span><span class="p">:</span> <span class="s1">&#39;venta&#39;</span><span class="p">,</span> <span class="c1"># Cliente compra USD</span>
            <span class="s1">&#39;moneda_origen_codigo&#39;</span><span class="p">:</span> <span class="s1">&#39;PYG&#39;</span><span class="p">,</span>
            <span class="s1">&#39;monto_origen&#39;</span><span class="p">:</span> <span class="s1">&#39;740000.00&#39;</span><span class="p">,</span>
            <span class="s1">&#39;moneda_destino_codigo&#39;</span><span class="p">:</span> <span class="s1">&#39;USD&#39;</span><span class="p">,</span>
            <span class="s1">&#39;monto_recibido&#39;</span><span class="p">:</span> <span class="s1">&#39;100.00&#39;</span><span class="p">,</span>
            <span class="s1">&#39;tasa_aplicada&#39;</span><span class="p">:</span> <span class="s1">&#39;7400.00&#39;</span><span class="p">,</span>
            <span class="s1">&#39;comision_aplicada&#39;</span><span class="p">:</span> <span class="s1">&#39;0.00&#39;</span><span class="p">,</span> <span class="c1"># Simplificado para la prueba</span>
        <span class="p">}</span>
        <span class="n">session</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="c1"># 2. Realizar el POST a la vista de confirmación</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">reverse</span><span class="p">(</span><span class="s1">&#39;core:confirmar_operacion&#39;</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

        <span class="c1"># 3. Verificar la redirección y la creación del objeto</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="mi">302</span><span class="p">)</span>
        <span class="n">transaccion_id</span> <span class="o">=</span> <span class="n">Transaccion</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRedirects</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">reverse</span><span class="p">(</span><span class="s1">&#39;core:detalle_transaccion&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">transaccion_id</span><span class="p">]))</span>

        <span class="c1"># 4. Comprobar que la transacción se creó con los datos correctos</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">Transaccion</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">exists</span><span class="p">())</span>
        <span class="n">transaccion</span> <span class="o">=</span> <span class="n">Transaccion</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">transaccion</span><span class="o">.</span><span class="n">cliente</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">transaccion</span><span class="o">.</span><span class="n">tipo_operacion</span><span class="p">,</span> <span class="s1">&#39;venta&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">transaccion</span><span class="o">.</span><span class="n">estado</span><span class="p">,</span> <span class="s1">&#39;pendiente_pago_cliente&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">transaccion</span><span class="o">.</span><span class="n">tasa_garantizada_hasta</span><span class="p">)</span>

        <span class="c1"># 5. Verificar que la fecha de garantía sea aproximadamente 15 minutos en el futuro</span>
        <span class="n">ahora</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">quince_minutos_despues</span> <span class="o">=</span> <span class="n">ahora</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        <span class="n">diferencia</span> <span class="o">=</span> <span class="n">quince_minutos_despues</span> <span class="o">-</span> <span class="n">transaccion</span><span class="o">.</span><span class="n">tasa_garantizada_hasta</span>
        
        <span class="c1"># Permitimos una pequeña diferencia (ej. 5 segundos) para la ejecución del código</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">diferencia</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">())</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Derechos de autor 2025, Diego.</p>
  </div>

  Compilado con <a href="https://www.sphinx-doc.org/">Sphinx</a> usando un
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">tema</a>
    proporcionado por <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>