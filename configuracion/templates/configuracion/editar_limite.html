{% extends "base.html" %}
{% load configuracion_extras %}  {% block title %}Global Exchange{% endblock %}

{% block content %}
<main class="max-w-5xl mx-auto px-6 py-10">
  <header class="flex items-center justify-between mb-8">
    <div>
      <h1 class="text-4xl font-extrabold mb-2 text-[var(--ink)]">
        {% if form.instance.pk %}Editar LÃ­mite{% else %}Agregar Nuevo LÃ­mite{% endif %}
      </h1>
      <p class="text-lg leading-relaxed max-w-2xl text-[var(--muted)]">
        {% if form.instance.pk %}
          Modifica los lÃ­mites del usuario.
        {% else %}
          Completa los campos para registrar un nuevo lÃ­mite.
        {% endif %}
      </p>
    </div>
    <a href="{% url 'configuracion:lista_limites' %}"
       class="px-4 py-2 rounded-lg font-bold bg-[var(--brand-soft)] hover:brightness-95"
       style="color:var(--brand-dark)">â¬… Volver</a>
  </header>

  <section class="bg-white border rounded-xl shadow-sm mb-4 p-6" style="border-color:var(--line)">
    <form method="post">
      {% csrf_token %}

      <div class="mb-6">
        <label class="block text-sm font-semibold mb-2">Moneda Base</label>
        <input type="text" value="GuaranÃ­ (â‚²)" disabled
               class="w-full max-w-[380px] p-3 border rounded-xl bg-gray-100 cursor-not-allowed">
      </div>

      <div class="mb-6 flex flex-col gap-4">
        <div class="flex items-center gap-4">
          {{ form.aplica_diario }} 
          <label class="font-semibold">Aplicar LÃ­mite Diario</label>
          
          <div class="relative flex-grow max-w-[200px]">
              {{ form.monto_diario }} 
          </div>

        </div>

        <div class="flex items-center gap-4">
          {{ form.aplica_mensual }} 
          <label class="font-semibold">Aplicar LÃ­mite Mensual</label>

          <div class="relative flex-grow max-w-[200px]">
              {{ form.monto_mensual }}
          </div>

        </div>
      </div>

      <div class="flex justify-end gap-3 pt-2">
        <a href="{% url 'configuracion:lista_limites' %}"
           class="px-4 py-2 rounded-lg font-semibold text-white bg-red-600 hover:bg-red-700">
          Cancelar
        </a>
        <button type="submit"
                class="px-6 py-2 rounded-lg font-bold text-white shadow-sm"
                style="background:var(--brand)">
          {% if form.instance.pk %}ðŸ’¾ Guardar Cambios{% else %}âž• Agregar{% endif %}
        </button>
      </div>

    </form>
  </section>
</main>


<script>
    // FunciÃ³n para limpiar el formato: 1.000.000 -> 1000000
    function cleanFormat(value) {
        // Solo elimina puntos de miles. No se necesita manejar la coma decimal
        return value.toString().replace(/\./g, '');
    }

    // FunciÃ³n para aplicar el formato: 1000000 -> 1.000.000 (formato PY)
    function applyFormat(value) {
        if (!value) return '';
        // Convierte el valor limpio a un nÃºmero entero
        let number = parseInt(cleanFormat(value));
        if (isNaN(number)) return value;

        // Usa Intl.NumberFormat sin decimales
        return new Intl.NumberFormat('es-PY', {
            maximumFractionDigits: 0
        }).format(number);
    }
    
    // FunciÃ³n de inicializaciÃ³n para los campos
    function initCurrencyField(fieldId) {
        const inputHidden = document.getElementById(fieldId);
        
        if (!inputHidden) return;
        
        // 1. ConfiguraciÃ³n de campos
        inputHidden.style.display = 'none';

        const inputVisible = document.createElement('input');
        inputVisible.setAttribute('type', 'text');
        inputVisible.className = inputHidden.className + ' p-3 border rounded-xl'; 
        inputVisible.id = fieldId + '_visible';
        inputVisible.value = applyFormat(inputHidden.value);
        
        inputHidden.parentNode.insertBefore(inputVisible, inputHidden);

        // 6. Evento al escribir (input): Sincroniza y MANTIENE el cursor
        inputVisible.addEventListener('input', function() {
            const oldValue = this.value;
            const oldCleanValue = cleanFormat(oldValue);
            
            // 1. Guardar la posiciÃ³n actual del cursor (offset)
            const cursorPosition = this.selectionStart;
            
            // 2. Contar cuÃ¡ntos separadores de miles (puntos) hay antes del cursor
            const nonDigitsBeforeCursor = (oldValue.substring(0, cursorPosition).match(/\./g) || []).length;

            // 3. Limpiar el valor que estÃ¡ escribiendo el usuario (esto actualiza el campo oculto)
            const cleanedValue = cleanFormat(oldValue);
            inputHidden.value = cleanedValue;

            // 4. Volver a aplicar el formato al campo visible
            const newValue = applyFormat(cleanedValue);
            this.value = newValue;

            // 5. Contar cuÃ¡ntos separadores de miles (puntos) hay en el NUEVO valor formateado
            const newNonDigitsBeforeCursor = (newValue.substring(0, cursorPosition).match(/\./g) || []).length;

            // 6. Calcular el desplazamiento del cursor:
            //    Si se borrÃ³ un separador, el cursor debe moverse una posiciÃ³n *menos*.
            //    Si se insertÃ³ un separador (al escribir el 1000), el cursor debe moverse una posiciÃ³n *mÃ¡s*.
            const adjustment = newNonDigitsBeforeCursor - nonDigitsBeforeCursor;

            // 7. Restablecer la posiciÃ³n del cursor ajustada
            //    Usamos setTimeout para asegurarnos de que el DOM estÃ© actualizado
            setTimeout(() => {
                const newCursorPosition = cursorPosition + adjustment;
                this.setSelectionRange(newCursorPosition, newCursorPosition);
            }, 0); 
        });

        // 7. Evento al perder el foco (blur): Asegura el formato final
        inputVisible.addEventListener('blur', function() {
            this.value = applyFormat(this.value);
        });
    }

    // Inicializa los dos campos
    initCurrencyField('{{ form.monto_diario.id_for_label }}');
    initCurrencyField('{{ form.monto_mensual.id_for_label }}');

</script>
{% endblock %}