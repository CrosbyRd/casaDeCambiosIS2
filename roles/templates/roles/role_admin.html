{% extends "base.html" %}
{% block title %}Global Exchange - Gesti√≥n de Roles por Usuario{% endblock %}

{% block content %}
<main class="max-w-6xl mx-auto px-6 py-10">

  <header class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-8">
    <div>
      <h1 class="text-4xl font-extrabold mb-2" style="color:var(--ink)">üë• Gesti√≥n de Roles por Usuario</h1>
      <p class="text-lg leading-relaxed max-w-xl" style="color:var(--muted)">
        Asigna o quita roles a cada usuario del sistema.
      </p>
    </div>
    <div class="flex items-center gap-3">
      <a href="{% url 'admin_panel:dashboard' %}"
         class="px-4 py-2 rounded-xl font-bold bg-[var(--brand-soft)] hover:brightness-95"
         style="color:var(--brand-dark)">‚¨Ö Volver al Panel</a>
    </div>
  </header>

  {% if messages %}
    <div class="mb-6">
      {% for message in messages %}
        <div class="bg-green-500 text-white px-4 py-2 rounded-lg mb-2">{{ message }}</div>
      {% endfor %}
    </div>
  {% endif %}

  {# --- Barra de filtros: por rol y por nombre/correo --- #}
  <section class="bg-white border rounded-xl shadow-sm p-4 mb-6" style="border-color:var(--line)">
    <form class="grid grid-cols-1 md:grid-cols-3 gap-4" onsubmit="return false;">
      <div class="md:col-span-2">
        <label for="filtroTexto" class="block text-sm font-medium mb-1" style="color:var(--muted)">Buscar por nombre o correo</label>
        <input id="filtroTexto" type="search" placeholder="Ej: ana, @empresa.com"
               class="w-full rounded-lg border px-3 py-2 outline-none focus:ring-2"
               style="border-color:var(--line); --tw-ring-color:var(--brand);" />
      </div>
      <div>
        <label for="filtroRol" class="block text-sm font-medium mb-1" style="color:var(--muted)">Filtrar por rol</label>
        <select id="filtroRol"
                class="w-full rounded-lg border px-3 py-2 bg-white outline-none focus:ring-2"
                style="border-color:var(--line); --tw-ring-color:var(--brand);">
          <option value="">Todos</option>
          {# Se hidrata autom√°ticamente con los roles presentes en la tabla #}
        </select>
      </div>
    </form>
  </section>

  <!-- Tabla de Usuarios -->
  <section class="bg-white border rounded-xl shadow-sm overflow-hidden" style="border-color:var(--line)">
    <div class="overflow-x-auto">
      <table class="w-full text-left border-collapse min-w-[800px]">
        <thead style="background:var(--brand); color:#fff">
          <tr>
            <th class="px-6 py-3">Usuario</th>
            <th class="px-6 py-3">Correo</th>
            <th class="px-6 py-3">Roles Asignados</th>
            <th class="px-6 py-3 text-center">Acciones</th>
          </tr>
        </thead>
        <tbody id="tbodyUsuarios">
          {% for usuario in usuarios %}
          <tr class="border-b hover:bg-[var(--brand-soft)]" style="border-color:var(--line)"
              data-text="{{ usuario.first_name }} {{ usuario.last_name }} {{ usuario.email|lower }}"
              data-roles="{% for rol in usuario.roles.all %}{{ rol.name }}{% if not forloop.last %}|{% endif %}{% endfor %}">
            <td class="px-6 py-4 font-semibold text-[var(--ink)]">
              {{ usuario.first_name }} {{ usuario.last_name }}
            </td>
            <td class="px-6 py-4 text-neutral-600">
              {{ usuario.email }}
            </td>
            <td class="px-6 py-4">
              {% if usuario.roles.all %}
                <div class="flex flex-wrap gap-2">
                  {% for rol in usuario.roles.all %}
                    <span class="bg-[var(--brand-soft)] text-[var(--brand-dark)] px-2 py-1 rounded-lg text-xs font-semibold">{{ rol.name }}</span>
                  {% endfor %}
                </div>
              {% else %}
                <span class="text-neutral-400 text-sm">Sin rol</span>
              {% endif %}
            </td>
            <td class="px-6 py-4">
              <div class="flex justify-center">
                <a href="{% url 'roles:manage-user-roles' usuario.id %}"
                   class="px-4 py-2 rounded-lg font-semibold text-white bg-gray-600 hover:bg-gray-700">
                  Gestionar Roles
                </a>
              </div>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="4" class="px-6 py-10 text-center text-neutral-500">No hay usuarios para mostrar.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>

</main>

{# --- JS de filtrado (rol + texto) sin dependencias --- #}
<script>
  // Debounce util para inputs
  function debounce(fn, ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }

  const filtroTexto = document.getElementById('filtroTexto');
  const filtroRol   = document.getElementById('filtroRol');
  const tbody       = document.getElementById('tbodyUsuarios');
  const rows        = [...tbody.querySelectorAll('tr[data-text]')];

  // Hidratar el <select> de roles a partir de los chips presentes en la tabla
  (function hydrateRoleFilter(){
    const set = new Set();
    rows.forEach(tr=>{
      const roles = (tr.dataset.roles || '').split('|').map(s=>s.trim()).filter(Boolean);
      roles.forEach(r => set.add(r));
    });
    [...set].sort().forEach(r=>{
      const opt = document.createElement('option');
      opt.value = r;
      opt.textContent = r;
      filtroRol.appendChild(opt);
    });
  })();

  function aplicarFiltros(){
    const q   = (filtroTexto.value || '').toLowerCase().trim();
    const rol = (filtroRol.value || '').toLowerCase();

    rows.forEach(tr=>{
      const txt   = (tr.dataset.text || '').toLowerCase();
      const roles = (tr.dataset.roles || '').toLowerCase().split('|').map(s=>s.trim());

      const matchTxt = !q || txt.includes(q);
      const matchRol = !rol || roles.includes(rol);

      tr.style.display = (matchTxt && matchRol) ? '' : 'none';
    });
  }

  const filtrar = debounce(aplicarFiltros, 150);
  filtroTexto.addEventListener('input', filtrar);
  filtroRol.addEventListener('change', aplicarFiltros);
</script>
{% endblock %}
