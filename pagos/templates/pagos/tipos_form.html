{% extends "base.html" %}
{% load static %}
{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/styles.css' %}">
<style>
  /* Compactar tabla y controles */
  .cmpct th, .cmpct td { padding: .5rem .75rem; vertical-align: top; }
  .cmpct .cell { padding: .5rem; }

  /* Botón estado Activo/Inactivo */
  .state-btn { border-radius:999px; font-weight:800; padding:.5rem .9rem; border:1.5px solid var(--line); }
  .state-on  { background:#10b9811a; color:#0f766e; border-color:#10b98150; }
  .state-off { background:#ef44441a; color:#7f1d1d; border-color:#ef444450; }
  .state-btn:hover { filter:saturate(110%); }

  /* Caja angosta como tablas de cotización */
  .box-narrow { max-width: 1100px; margin: 0 auto; }

  /* Botón eliminar que marca DELETE del formset */
  .btn-danger { background:#ef4444; color:#fff; font-weight:800; border:none; border-radius:12px; padding:.45rem .8rem; }
  .btn-danger:hover { filter:brightness(0.95); }
  .row-removed { opacity:.55; filter:grayscale(15%); }
  .hint { font-size:.75rem; color:var(--muted); }

  /* Encabezado lila (idéntico a cotizaciones) */
  .head-purple { background:var(--brand); color:#fff; font-weight:900; text-transform:uppercase; letter-spacing:.02em; }
</style>
{% endblock %}

{% block content %}
<div class="px-6 py-6">

  <!-- Encabezado alineado -->
  <div class="mb-6 box-narrow flex items-start justify-between gap-4">
    <div>
      <h1 class="h1">
        {% if object %}Editar tipo de medio de pago{% else %}Nuevo tipo de medio de pago{% endif %}
      </h1>
      <p class="lead max-w-3xl">
        Definí el medio de pago y su <strong>comisión %</strong>. Después agregá los
        <strong>campos requeridos</strong> que el cliente deberá completar.
      </p>
    </div>
    <a href="{% url 'pagos:tipos_list' %}" class="btn-secondary self-start">Volver</a>
  </div>

  {% include "partials/messages.html" %}

  <form method="post" novalidate class="relative form">
    {% csrf_token %}

    <div class="box box-narrow space-y-6">

      <!-- Cabecera: Nombre / Comisión -->
      <div class="rounded-xl overflow-hidden border border-[var(--line)]">
        <div class="grid grid-cols-1 md:grid-cols-3">
          <div class="md:col-span-2 px-4 py-3 head-purple">Nombre</div>
          <div class="md:col-span-1 px-4 py-3 head-purple">Comisión porcentaje</div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-0 bg-white">
          <div class="p-4 border-t border-[var(--line)] md:col-span-2">
            {{ form.nombre }}
            {% if form.nombre.errors %}
              <p class="text-red-600 text-sm mt-1">{{ form.nombre.errors|striptags }}</p>
            {% else %}
              <p class="hint mt-1">Ej.: Tarjeta de crédito, Billetera, Transferencia…</p>
            {% endif %}
          </div>

          <div class="p-4 border-t border-l border-[var(--line)] md:col-span-1">
            <div class="flex items-stretch rounded-lg border border-[var(--line)] overflow-hidden focus-within:ring-2 focus-within:ring-[var(--brand)]">
              {{ form.comision_porcentaje }}
              <span class="px-3 py-2 bg-[var(--brand-soft)] text-[var(--brand-dark)] font-semibold">%</span>
            </div>
            <p class="hint mt-1">Rango sugerido: 0,00 – 100,00</p>
            {% if form.comision_porcentaje.errors %}
              <p class="text-red-600 text-sm mt-1">{{ form.comision_porcentaje.errors|striptags }}</p>
            {% endif %}
          </div>
        </div>

        <!-- Descripción (segunda fila) -->
        <div class="grid grid-cols-1">
          <div class="px-4 py-3 head-purple">Descripción</div>
          <div class="p-4 border-t border-[var(--line)] bg-white">
            {{ form.descripcion }}
            {% if form.descripcion.errors %}
              <p class="text-red-600 text-sm mt-1">{{ form.descripcion.errors|striptags }}</p>
            {% else %}
              <p class="hint mt-1">Texto breve para administradores (opcional).</p>
            {% endif %}
          </div>
        </div>

        <!-- Estado -->
        <div class="p-4 border-t border-[var(--line)] bg-white flex items-center gap-3">
          <span class="hint">Estado</span>
          <input type="checkbox" id="id_activo" name="{{ form.activo.name }}" {% if form.activo.value %}checked{% endif %} class="hidden">
          <button type="button" id="btn-estado" class="state-btn {% if form.activo.value %}state-on{% else %}state-off{% endif %}">
            {% if form.activo.value %}Activo{% else %}Inactivo{% endif %}
          </button>
          <script>
            (function(){
              const chk = document.getElementById('id_activo');
              const btn = document.getElementById('btn-estado');
              if(!chk || !btn) return;
              btn.addEventListener('click', function(){
                chk.checked = !chk.checked;
                if(chk.checked){ btn.classList.remove('state-off'); btn.classList.add('state-on'); btn.textContent = 'Activo'; }
                else{ btn.classList.remove('state-on'); btn.classList.add('state-off'); btn.textContent = 'Inactivo'; }
              });
            })();
          </script>
        </div>
      </div>

      <!-- Campos del medio -->
      <section class="box-narrow">
        <div class="flex items-center justify-between mb-3">
          <h2 class="h2">Campos del medio</h2>
          <button type="button" id="add-form" class="btn-secondary">
            <span class="text-xl leading-none">＋</span> Agregar campo
          </button>
        </div>

        {{ formset.management_form }}

        <!-- Tabla estilo medios de acreditación -->
        <div class="rounded-xl overflow-hidden border border-[var(--line)] cmpct">
          <!-- Header lila -->
          <div class="hidden md:grid md:grid-cols-12 head-purple">
            <div class="md:col-span-3 px-4 py-2">Nombre del Campo</div>
            <div class="md:col-span-2 px-4 py-2">Tipo de Dato</div>
            <div class="md:col-span-1 px-4 py-2">Obligatorio</div>
            <div class="md:col-span-2 px-4 py-2">Regex (predef.)</div>
            <div class="md:col-span-1 px-4 py-2 text-right">Acciones</div>
          </div>

          <div id="formset" class="space-y-2 p-3">
            {% for f in formset %}
              <div class="grid grid-cols-1 md:grid-cols-12 gap-3 border border-[var(--line)] rounded-xl p-3 bg-white transition" data-row>
                <div class="md:col-span-3 cell">
                  <label class="font-semibold mb-1 block">{{ f.nombre_campo.label }}</label>
                  {{ f.nombre_campo }}
                  {% if f.nombre_campo.errors %}<p class="text-red-600 text-sm">{{ f.nombre_campo.errors|striptags }}</p>{% endif %}
                </div>
                <div class="md:col-span-2 cell">
                  <label class="font-semibold mb-1 block">{{ f.tipo_dato.label }}</label>
                  {{ f.tipo_dato }}
                </div>
                <div class="md:col-span-1 cell flex items-end">
                  <label class="inline-flex items-center gap-2">
                    {{ f.obligatorio }} <span class="text-sm">Requerido</span>
                  </label>
                </div>
                <div class="md:col-span-2 cell">
                  <label class="font-semibold mb-1 block">{{ f.regex_opcional.label }}</label>
                  {{ f.regex_opcional }}
                </div>

                <!-- Acciones: activar/eliminar -->
                <div class="md:col-span-1 cell flex items-center justify-end gap-2">
                  <label class="inline-flex items-center gap-2">
                    {{ f.activo }} <span class="hint">Activo</span>
                  </label>

                  <!-- Checkbox DELETE real (oculto) + botón UI rojo -->
                  <label class="hidden">{{ f.DELETE }}</label>
                  <button type="button" class="btn-danger" data-delete>Eliminar</button>
                </div>

                <!-- Nota sobre DELETE (se mantiene para claridad) -->
                <div class="md:col-span-12">
                  {% if object %}
                    <span class="hint">En edición: <strong>Eliminar</strong> marca el campo para desactivar/borrar al guardar.</span>
                  {% else %}
                    <span class="hint">En creación: <strong>Eliminar</strong> quita el campo de esta lista.</span>
                  {% endif %}
                </div>
              </div>
            {% empty %}
              <div class="rounded-xl border border-dashed border-[var(--line)] p-6 text-center text-[var(--muted)] bg-white">
                Aún no agregaste campos. Usá “Agregar campo”.
              </div>
            {% endfor %}
          </div>
        </div>
      </section>
    </div>

    <!-- Acciones -->
    <div class="sticky bottom-4 mt-6 flex justify-end">
      <div class="rounded-2xl bg-white/90 backdrop-blur border border-[var(--line)] shadow-lg px-3 py-2 flex gap-2">
        <button type="submit" name="_save" class="btn">Guardar</button>
        <button type="submit" name="_save_and_add" class="btn-secondary">Guardar y agregar otro</button>
      </div>
    </div>

  </form>
</div>

<!-- JS: agregar/quitar filas del formset y UI de eliminar -->
<script>
(function(){
  const addBtn   = document.getElementById('add-form');
  const formset  = document.getElementById('formset');
  const totalInp = document.querySelector('input[name$="-TOTAL_FORMS"]');
  if(!formset || !totalInp) return;

  /* Botón estado (arriba) */
  (function(){
    const chk = document.getElementById('id_activo');
    const btn = document.getElementById('btn-estado');
    if(!chk || !btn) return;
    btn.addEventListener('click', function(){
      chk.checked = !chk.checked;
      if(chk.checked){ btn.classList.remove('state-off'); btn.classList.add('state-on'); btn.textContent = 'Activo'; }
      else{ btn.classList.remove('state-on'); btn.classList.add('state-off'); btn.textContent = 'Inactivo'; }
    });
  })();

  /* Marcar DELETE con botón rojo y efecto visual */
  function wireDeleteButtons(scope){
    scope.querySelectorAll('[data-delete]').forEach(function(btn){
      const row = btn.closest('[data-row]');
      if(!row) return;
      const del = row.querySelector('input[type="checkbox"][name$="-DELETE"]');
      if(!del) return;

      btn.addEventListener('click', function(){
        del.checked = true;
        row.classList.add('row-removed');
        // En creación, podemos quitar visualmente la fila
        const creating = !document.querySelector('input[name="id"]').value; // si existe "id" de objeto
        if(creating){ setTimeout(()=>row.remove(), 150); totalInp.value = Math.max(0, parseInt(totalInp.value,10) - 1); }
      });
    });
  }
  wireDeleteButtons(document);

  /* Agregar nueva fila al formset */
  if(addBtn){
    const prefix = totalInp.name.replace(/-TOTAL_FORMS$/,'');
    addBtn.addEventListener('click', function(){
      const index = parseInt(totalInp.value, 10);
      const row = document.createElement('div');
      row.className = "grid grid-cols-1 md:grid-cols-12 gap-3 border border-[var(--line)] rounded-xl p-3 bg-white transition";
      row.setAttribute('data-row','');

    row.innerHTML = `
      <div class="md:col-span-4 cell">
        <label class="font-semibold mb-1 block" for="id_${prefix}-${index}-nombre_campo">Nombre del campo</label>
        <input type="text" name="${prefix}-${index}-nombre_campo" id="id_${prefix}-${index}-nombre_campo" class="form-input w-full" />
      </div>
      <div class="md:col-span-2 cell">
        <label class="font-semibold mb-1 block" for="id_${prefix}-${index}-tipo_dato">Tipo de dato</label>
        <select name="${prefix}-${index}-tipo_dato" id="id_${prefix}-${index}-tipo_dato" class="form-select w-full">
          <option value="texto">Texto</option>
          <option value="numero">Número</option>
          <option value="telefono">Teléfono</option>
          <option value="email">Email</option>
          <option value="ruc">RUC</option>
        </select>
      </div>
      <div class="md:col-span-1 cell flex items-end">
        <label class="inline-flex items-center gap-2">
          <input type="checkbox" name="${prefix}-${index}-obligatorio" class="form-checkbox"> <span class="text-sm">Requerido</span>
        </label>
      </div>
      <div class="md:col-span-4 cell">
        <label class="font-semibold mb-1 block" for="id_${prefix}-${index}-regex_opcional">Regex (predef.)</label>
        <select name="${prefix}-${index}-regex_opcional" id="id_${prefix}-${index}-regex_opcional" class="form-select w-full">
          <option value="">(sin regex)</option>
          <option value="^\\d+$">Solo números</option>
          <option value="^[^@\\s]+@[^@\\s]+\\.[^@\\s]+$">Email básico</option>
          <option value="^\\+?595\\d{7,10}$">Teléfono PY (+595...)</option>
          <option value="^\\d{6,8}-\\d{1}$">RUC PY (########-#)</option>
        </select>
      </div>
      <div class="md:col-span-1 cell flex items-center justify-end gap-2">
        <label class="inline-flex items-center gap-2">
          <input type="checkbox" name="${prefix}-${index}-activo" class="form-checkbox" checked>
          <span class="hint">Activo</span>
        </label>
        <input type="checkbox" name="${prefix}-${index}-DELETE" class="hidden">
        <button type="button" class="btn-danger" data-delete>Eliminar</button>
      </div>
      <div class="md:col-span-12 hint">En creación: <strong>Eliminar</strong> quita el campo de esta lista.</div>
      <input type="hidden" name="${prefix}-${index}-id" />
    `;


      formset.appendChild(row);
      totalInp.value = index + 1;
      wireDeleteButtons(row);
    });
  }
})();
</script>
{% endblock %}
