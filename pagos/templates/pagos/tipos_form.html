{% extends "base.html" %}
{% load static %}
{% block content %}
<div class="px-6 py-6">
  <!-- Encabezado -->
  <div class="flex items-center justify-between mb-6">
    <div>
      <h1 class="text-4xl font-extrabold">
        {% if object %}Editar tipo de medio de pago{% else %}Nuevo tipo de medio de pago{% endif %}
      </h1>
      <p class="text-lg text-[var(--muted)] leading-relaxed max-w-xl">
        Definí el medio de pago y su <strong>comisión %</strong>. Después agregá los
        <strong>campos requeridos</strong> que el cliente deberá completar.
      </p>
    </div>
    <a href="{% url 'pagos:tipos_list' %}"
       class="rounded-2xl px-4 py-2 bg-[var(--brand-soft)] text-[var(--brand-dark)] shadow hover:shadow-lg transition">
      Volver
    </a>
  </div>

  {% include "partials/messages.html" %}

  <!-- Card principal -->
  <form method="post" novalidate class="relative">
    {% csrf_token %}

    <div class="bg-white rounded-xl border border-[var(--line)] shadow p-6 space-y-8">
      <!-- Datos del tipo -->
      <section>
        <h2 class="text-2xl font-bold mb-4">Datos del tipo</h2>

        <div class="grid grid-cols-1 md:grid-cols-6 gap-4">
          <!-- Nombre -->
          <div class="md:col-span-3">
            <label for="{{ form.nombre.id_for_label }}" class="block font-semibold mb-1">Nombre</label>
            {{ form.nombre }}
            {% if form.nombre.errors %}
              <p class="text-red-600 text-sm mt-1">{{ form.nombre.errors|striptags }}</p>
            {% else %}
              <p class="text-sm text-[var(--muted)] mt-1">Ej.: Tarjeta de crédito, Billetera, Transferencia…</p>
            {% endif %}
          </div>

          <!-- Comisión % con sufijo visual -->
          <div class="md:col-span-2">
            <label for="{{ form.comision_porcentaje.id_for_label }}" class="block font-semibold mb-1">Comisión porcentaje</label>
            <div class="flex items-stretch rounded-lg border border-[var(--line)] overflow-hidden focus-within:ring-2 focus-within:ring-[var(--brand)]">
            {{ form.comision_porcentaje }}
              <span class="px-3 py-2 bg-[var(--brand-soft)] text-[var(--brand-dark)] font-semibold">%</span>
            </div>
            <p class="text-sm text-[var(--muted)] mt-1">Rango sugerido: 0,00 – 100,00</p>
            {% if form.comision_porcentaje.errors %}
              <p class="text-red-600 text-sm mt-1">{{ form.comision_porcentaje.errors|striptags }}</p>
            {% endif %}
          </div>

          <!-- Activo (switch simple) -->
          <div class="md:col-span-1">
            <label class="block font-semibold mb-1">Activo</label>
            <label class="inline-flex items-center gap-2">
              {{ form.activo }}
              <span class="text-sm text-[var(--muted)]">Visible para su uso</span>
            </label>
          </div>

          <!-- Descripción -->
          <div class="md:col-span-6">
            <label for="{{ form.descripcion.id_for_label }}" class="block font-semibold mb-1">Descripción</label>
            {{ form.descripcion }}
            {% if form.descripcion.errors %}
              <p class="text-red-600 text-sm mt-1">{{ form.descripcion.errors|striptags }}</p>
            {% else %}
              <p class="text-sm text-[var(--muted)] mt-1">Texto breve para administradores (opcional).</p>
            {% endif %}
          </div>
        </div>
      </section>

      <!-- Campos del medio -->
      <section>
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-2xl font-bold">Campos del medio</h2>
          <button type="button" id="add-form"
                  class="rounded-2xl px-4 py-2 bg-[var(--brand-soft)] text-[var(--brand-dark)] shadow hover:shadow-lg transition flex items-center gap-2">
            <span class="text-xl leading-none">＋</span> Agregar campo
          </button>
        </div>

        {{ formset.management_form }}

        <!-- Encabezados listados como “tabla” accesible -->
        <div class="hidden md:grid md:grid-cols-12 text-xs uppercase tracking-wide text-[var(--muted)] mb-1">
          <div class="md:col-span-3">Nombre del campo</div>
          <div class="md:col-span-2">Tipo de dato</div>
          <div class="md:col-span-1">Obligatorio</div>
          <div class="md:col-span-2">Regex (predef.)</div>
          <div class="md:col-span-3">Regex personalizada</div>
          <div class="md:col-span-1 text-right pr-2">Activo</div>
        </div>

        <div id="formset" class="space-y-3">
          {% for f in formset %}
            <div class="grid grid-cols-1 md:grid-cols-12 gap-3 border border-[var(--line)] rounded-xl p-3 hover:shadow transition">
              <div class="md:col-span-3">
                <label class="font-semibold mb-1 block">{{ f.nombre_campo.label }}</label>
                {{ f.nombre_campo }}
                {% if f.nombre_campo.errors %}<p class="text-red-600 text-sm">{{ f.nombre_campo.errors|striptags }}</p>{% endif %}
              </div>
              <div class="md:col-span-2">
                <label class="font-semibold mb-1 block">{{ f.tipo_dato.label }}</label>
                {{ f.tipo_dato }}
              </div>
              <div class="md:col-span-1 flex items-end">
                <label class="inline-flex items-center gap-2">
                  {{ f.obligatorio }} <span class="text-sm">Requerido</span>
                </label>
              </div>
              <div class="md:col-span-2">
                <label class="font-semibold mb-1 block">{{ f.regex_opcional.label }}</label>
                {{ f.regex_opcional }}
              </div>
              <div class="md:col-span-3">
                <label class="font-semibold mb-1 block">{{ f.regex_personalizado.label }}</label>
                {{ f.regex_personalizado }}
                <p class="text-xs text-[var(--muted)] mt-1">Ej.: <code>^\d{6,8}-\d{1}$</code></p>
              </div>
              <div class="md:col-span-1 flex items-center justify-end">
                {{ f.activo }}
              </div>

              <!-- Eliminar/Desactivar -->
              <div class="md:col-span-12 flex items-center justify-between pt-1">
                <label class="inline-flex items-center gap-2">
                  {{ f.DELETE }} <span class="text-sm">Desactivar / Eliminar</span>
                </label>
                {% if object %}
                  <span class="text-xs text-[var(--muted)]">En edición: <strong>DELETE</strong> desactiva el campo existente (no lo borra físicamente).</span>
                {% else %}
                  <span class="text-xs text-[var(--muted)]">En creación: <strong>DELETE</strong> quita el campo del guardado.</span>
                {% endif %}
              </div>
            </div>
          {% empty %}
            <div class="rounded-xl border border-dashed border-[var(--line)] p-6 text-center text-[var(--muted)]">
              Aún no agregaste campos. Usá “Agregar campo”.
            </div>
          {% endfor %}
        </div>
      </section>
    </div>

    <!-- Barra de acciones fija -->
    <div class="sticky bottom-4 mt-6 flex justify-end">
      <div class="rounded-2xl bg-white/80 backdrop-blur border border-[var(--line)] shadow-lg px-3 py-2 flex gap-2">
        <button type="submit" name="_save" class="rounded-2xl px-4 py-2 bg-[var(--brand)] text-white shadow hover:shadow-lg transition">
          Guardar
        </button>
        <button type="submit" name="_save_and_add" class="rounded-2xl px-4 py-2 bg-[var(--brand-soft)] text-[var(--brand-dark)] shadow hover:shadow-lg transition">
          Guardar y agregar otro
        </button>
      </div>
    </div>
  </form>
</div>

<!-- JS UX: agregar filas del formset de forma robusta -->
<script>
(function(){
  const addBtn   = document.getElementById('add-form');
  const formset  = document.getElementById('formset');
  const totalInp = document.querySelector('input[name$="-TOTAL_FORMS"]');

  if(!addBtn || !formset || !totalInp) return;

  // Inferir prefijo del formset (lo que está antes de -TOTAL_FORMS)
  const prefix = totalInp.name.replace(/-TOTAL_FORMS$/,'');

  addBtn.addEventListener('click', function(){
    const index = parseInt(totalInp.value, 10);
    const row = document.createElement('div');
    row.className = "grid grid-cols-1 md:grid-cols-12 gap-3 border border-[var(--line)] rounded-xl p-3 hover:shadow transition";

    row.innerHTML = `
      <div class="md:col-span-3">
        <label class="font-semibold mb-1 block" for="id_${prefix}-${index}-nombre_campo">Nombre del campo</label>
        <input type="text" name="${prefix}-${index}-nombre_campo" id="id_${prefix}-${index}-nombre_campo" class="form-input w-full" />
      </div>
      <div class="md:col-span-2">
        <label class="font-semibold mb-1 block" for="id_${prefix}-${index}-tipo_dato">Tipo de dato</label>
        <select name="${prefix}-${index}-tipo_dato" id="id_${prefix}-${index}-tipo_dato" class="form-select w-full">
          <option value="texto">Texto</option>
          <option value="numero">Número</option>
          <option value="telefono">Teléfono</option>
          <option value="email">Email</option>
          <option value="ruc">RUC</option>
        </select>
      </div>
      <div class="md:col-span-1 flex items-end">
        <label class="inline-flex items-center gap-2">
          <input type="checkbox" name="${prefix}-${index}-obligatorio" class="form-checkbox"> <span class="text-sm">Requerido</span>
        </label>
      </div>
      <div class="md:col-span-2">
        <label class="font-semibold mb-1 block" for="id_${prefix}-${index}-regex_opcional">Regex (predef.)</label>
        <select name="${prefix}-${index}-regex_opcional" id="id_${prefix}-${index}-regex_opcional" class="form-select w-full">
          <option value="">(sin regex)</option>
          <option value="^\\d+$">Solo números</option>
          <option value="^[^@\\s]+@[^@\\s]+\\.[^@\\s]+$">Email básico</option>
          <option value="^\\+?595\\d{7,10}$">Teléfono PY (+595...)</option>
          <option value="^\\d{6,8}-\\d{1}$">RUC PY (########-#)</option>
        </select>
      </div>
      <div class="md:col-span-3">
        <label class="font-semibold mb-1 block" for="id_${prefix}-${index}-regex_personalizado">Regex personalizada</label>
        <input type="text" name="${prefix}-${index}-regex_personalizado" id="id_${prefix}-${index}-regex_personalizado" class="form-input w-full" placeholder="^...$" />
        <p class="text-xs text-[var(--muted)] mt-1">Se aplica si está presente (tiene prioridad).</p>
      </div>
      <div class="md:col-span-1 flex items-center justify-end">
        <input type="checkbox" name="${prefix}-${index}-activo" class="form-checkbox" checked>
      </div>
      <div class="md:col-span-12 flex items-center justify-between pt-1">
        <label class="inline-flex items-center gap-2">
          <input type="checkbox" name="${prefix}-${index}-DELETE" class="form-checkbox">
          <span class="text-sm">Eliminar (nuevo)</span>
        </label>
        <button type="button" class="text-sm text-red-600 hover:underline remove-row">Quitar fila</button>
      </div>
      <input type="hidden" name="${prefix}-${index}-id" />
    `;

    formset.appendChild(row);
    totalInp.value = index + 1;

    // Permitir quitar filas nuevas sin dejar huecos
    row.querySelector('.remove-row').addEventListener('click', () => {
      row.remove();
      totalInp.value = Math.max(0, parseInt(totalInp.value,10) - 1);
    });
  });
})();
</script>
{% endblock %}
