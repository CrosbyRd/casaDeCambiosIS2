{% extends "base.html" %}
{% block title %}Gesti√≥n de Usuarios y Clientes ‚Äî Global Exchange{% endblock %}

{% block content %}
<main class="max-w-6xl mx-auto px-6 py-10">

  <!-- Mensajes -->
  {% if messages %}
  <div class="mb-6">
    {% for message in messages %}
      <div class="bg-green-500 text-white px-4 py-2 rounded-lg mb-2">
        {{ message }}
      </div>
    {% endfor %}
  </div>
  {% endif %}

  <!-- Encabezado -->
  <header class="flex items-center justify-between mb-8">
    <div>
      <h1 class="text-4xl font-extrabold mb-2" style="color:var(--ink)">üë• Gesti√≥n de Usuarios y Clientes</h1>
      <p class="text-lg leading-relaxed max-w-xl" style="color:var(--muted)">
        Aqu√≠ puedes asignar y quitar clientes a cada usuario del sistema.
      </p>
    </div>
    <div>
      <a href="{% url 'admin_panel:dashboard' %}" 
         class="px-4 py-2 rounded-lg font-bold bg-[var(--brand-soft)] hover:brightness-95"
         style="color:var(--brand-dark)">
        ‚¨Ö Volver al Panel
      </a>
    </div>
  </header>

  <!-- Tabla -->
  <section class="bg-white border rounded-xl shadow-sm overflow-hidden" style="border-color:var(--line)">
    <div class="overflow-x-auto">
      <table class="w-full text-left border-collapse">
        <thead style="background:var(--brand); color:#fff">
          <tr>
            <th class="px-6 py-3">Usuario</th>
            <th class="px-6 py-3">Correo Electr√≥nico</th>
            <th class="px-6 py-3">Rol</th>
            <th class="px-6 py-3">Clientes Asociados</th>
            <th class="px-6 py-3">Clientes Disponibles</th>
          </tr>
        </thead>
        <tbody>
          {% for usuario in usuarios %}
          <tr class="border-b hover:bg-[var(--brand-soft)]" style="border-color:var(--line)">
            <!-- Usuario -->
            <td class="px-6 py-4 font-semibold text-[var(--ink)]">
              {{ usuario.first_name }} {{ usuario.last_name }}
            </td>
            <td class="px-6 py-4 text-neutral-600">
              {{ usuario.email }}
            </td>
            <!-- Rol -->
            <td class="px-6 py-4 text-neutral-600">
              {% if usuario.roles.all %}
                {% for rol in usuario.roles.all %}
                  <span class="bg-[var(--brand-soft)] text-[var(--brand-dark)] px-2 py-1 rounded-lg text-sm font-medium">{{ rol.name }}</span>
                {% endfor %}
              {% else %}
                <span class="text-neutral-400">Sin rol</span>
              {% endif %}
            </td>
            <!-- Clientes asociados -->
            <td class="px-6 py-4">
              {% for cliente in usuario.clientes.all %}
                <div class="flex items-center justify-between mb-1 bg-neutral-100 rounded px-2 py-1">
                  <span>{{ cliente.nombre }}</span>
                  <a href="{% url 'usuarios:quitar_cliente' usuario.id cliente.id_cliente %}" 
                     class="bg-red-600 hover:bg-red-700 text-white px-2 py-1 rounded-md text-sm">
                    Quitar
                  </a>
                </div>
              {% empty %}
                <span class="text-neutral-400">Ninguno</span>
              {% endfor %}
            </td>
            <!-- Clientes disponibles -->
            <td class="px-6 py-4">
              {% for cliente in todos_clientes %}
                {% if cliente not in usuario.clientes.all %}
                  <div class="flex items-center justify-between mb-1 bg-neutral-50 rounded px-2 py-1">
                    <span>{{ cliente.nombre }}</span>
                    <a href="{% url 'usuarios:agregar_cliente' usuario.id cliente.id_cliente %}" 
                       class="bg-green-600 hover:bg-green-700 text-white px-2 py-1 rounded-md text-sm">
                      Agregar
                    </a>
                  </div>
                {% endif %}
              {% endfor %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>
</main>
{% endblock %}
