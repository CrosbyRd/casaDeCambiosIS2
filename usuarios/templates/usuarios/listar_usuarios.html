{% extends "base.html" %}
{% load static %}
{% block title %}Global Exchange ‚Äì Gesti√≥n de Usuarios y Clientes{% endblock %}
{% block extra_head %}
<link rel="icon" href="{% static 'img/logo.ico' %}" sizes="any">
{% endblock %}

{% block content %}
<main class="max-w-6xl mx-auto px-6 py-10">

  {# ---- Mensajes del sistema ---- #}
  {% if messages %}
  <div class="mb-6">
    {% for message in messages %}
      <div class="bg-green-500 text-white px-4 py-2 rounded-lg mb-2">
        {{ message }}
      </div>
    {% endfor %}
  </div>
  {% endif %}

  {# ---- Header consistente con la gu√≠a de UI ---- #}
  <header class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-8">
    <div>
      <h1 class="text-4xl font-extrabold mb-2" style="color:var(--ink)">üë• Gesti√≥n de Usuarios y Clientes</h1>
      <p class="text-lg leading-relaxed max-w-xl" style="color:var(--muted)">
        Asigna o quita clientes a cada usuario. Usa los filtros de arriba para encontrar r√°pido.
      </p>
    </div>
    <div class="flex items-center gap-3">
      <a href="{% url 'admin_panel:dashboard' %}"
         class="px-4 py-2 rounded-xl font-bold bg-[var(--brand-soft)] hover:brightness-95"
         style="color:var(--brand-dark)">‚¨Ö Volver al Panel</a>
    </div>
  </header>

  {# ---- Barra de filtros ---- #}
  <section class="bg-white border rounded-xl shadow-sm p-4 mb-6" style="border-color:var(--line)">
    <form class="grid grid-cols-1 md:grid-cols-3 gap-4" onsubmit="return false;">
      <div>
        <label for="filtroTexto" class="block text-sm font-medium mb-1" style="color:var(--muted)">Buscar (nombre o email)</label>
        <input id="filtroTexto" type="search" placeholder="Ej: ana, @empresa.com"
               class="w-full rounded-lg border px-3 py-2 outline-none focus:ring-2"
               style="border-color:var(--line); --tw-ring-color:var(--brand);" />
      </div>
      <div>
        <label for="filtroRol" class="block text-sm font-medium mb-1" style="color:var(--muted)">Filtrar por rol</label>
        <select id="filtroRol"
                class="w-full rounded-lg border px-3 py-2 bg-white outline-none focus:ring-2"
                style="border-color:var(--line); --tw-ring-color:var(--brand);">
          <option value="">Todos</option>
          {# Opcional: si env√≠as "roles" desde la vista puedes renderizarlos aqu√≠ #}
        </select>
      </div>
      <div class="flex items-end">
        <label class="inline-flex items-center gap-2 text-sm" style="color:var(--muted)">
          <input id="soloSinClientes" type="checkbox" class="rounded border"
                 style="border-color:var(--line)"> Solo usuarios sin clientes
        </label>
      </div>
    </form>
  </section>

  {# ---- Tabla ---- #}
  <section class="bg-white border rounded-xl shadow-sm overflow-hidden" style="border-color:var(--line)">
    <div class="overflow-x-auto">
      <table class="w-full min-w-[900px] text-left border-collapse">
        <caption class="sr-only">Tabla de usuarios y clientes asociados</caption>
        <thead class="sticky top-0 z-10" style="background:var(--brand); color:#fff">
          <tr>
            <th class="px-6 py-3">Usuario</th>
            <th class="px-6 py-3">Correo</th>
            <th class="px-6 py-3">Roles</th>
            <th class="px-6 py-3">Clientes Asociados</th>
            <th class="px-6 py-3 w-[260px]">Acciones</th>
          </tr>
        </thead>
        <tbody id="tbodyUsuarios">
          {% for usuario in usuarios %}
          <tr class="border-b hover:bg-[var(--brand-soft)] transition"
              style="border-color:var(--line)"
              data-text="{{ usuario.first_name }} {{ usuario.last_name }} {{ usuario.email|lower }}"
              data-roles="{% for rol in usuario.roles.all %}{{ rol.name }}{% if not forloop.last %}|{% endif %}{% endfor %}"
              data-sinclientes="{% if usuario.clientes.count == 0 %}1{% else %}0{% endif %}">
            <td class="px-6 py-4 font-semibold text-[var(--ink)]">
              {{ usuario.first_name }} {{ usuario.last_name }}
            </td>
            <td class="px-6 py-4 text-neutral-600">
              {{ usuario.email }}
            </td>
            <td class="px-6 py-4">
              {% if usuario.roles.all %}
                <div class="flex flex-wrap gap-2">
                  {% for rol in usuario.roles.all %}
                    <span class="bg-[var(--brand-soft)] text-[var(--brand-dark)] px-2 py-1 rounded-lg text-xs font-semibold">{{ rol.name }}</span>
                  {% endfor %}
                </div>
              {% else %}
                <span class="text-neutral-400 text-sm">Sin rol</span>
              {% endif %}
            </td>

            {# Clientes asociados #}
            <td class="px-6 py-4">
              {% if usuario.clientes.all %}
                <ul class="space-y-1">
                {% for cliente in usuario.clientes.all %}
                  <li class="flex items-center justify-between bg-neutral-100 rounded px-2 py-1">
                    <span class="truncate">{{ cliente.nombre }}</span>
                    <a href="{% url 'usuarios:quitar_cliente' usuario.id cliente.id_cliente %}"
                       class="px-2 py-1 rounded-md text-sm bg-red-600 hover:bg-red-700 text-white"
                       title="Quitar cliente">Quitar</a>
                  </li>
                {% endfor %}
                </ul>
              {% else %}
                <span class="text-neutral-400 text-sm">Ninguno</span>
              {% endif %}
            </td>

            {# Acciones: abrir modal "Agregar cliente" #}
            <td class="px-6 py-4">
              <div class="flex flex-col sm:flex-row gap-2">
                <button type="button"
                        class="px-3 py-2 rounded-lg font-semibold text-white"
                        style="background:var(--brand)"
                        data-open-modal="modal-{{ usuario.id }}">
                  ‚ûï Agregar cliente
                </button>
                <a href="{% url 'roles:manage-user-roles' usuario.id %}"
                   class="px-3 py-2 rounded-lg font-semibold text-white bg-gray-600 hover:bg-gray-700">
                  Gestionar Roles
                </a>
              </div>

              {# --- Modal Agregar cliente con buscador --- #}
              <dialog id="modal-{{ usuario.id }}" class="rounded-2xl p-0 w-full max-w-xl">
                <form method="dialog">
                  <header class="px-6 py-4 border-b" style="border-color:var(--line)">
                    <h3 class="text-xl font-bold" style="color:var(--ink)">Agregar cliente a {{ usuario.first_name }}</h3>
                  </header>
                  <div class="p-6 space-y-4">
                    <div>
                      <label class="block text-sm font-medium mb-1" style="color:var(--muted)">Buscar cliente</label>
                      <input type="search" placeholder="Escribe para filtrar‚Ä¶"
                             class="w-full rounded-lg border px-3 py-2 outline-none focus:ring-2"
                             style="border-color:var(--line); --tw-ring-color:var(--brand);"
                             data-search-list="list-{{ usuario.id }}">
                    </div>
                    <div class="max-h-72 overflow-auto border rounded-lg" style="border-color:var(--line)">
                      <ul id="list-{{ usuario.id }}" class="divide-y" style="--tw-divide-color:var(--line)">
                        {% for cliente in todos_clientes %}
                          {% if cliente not in usuario.clientes.all %}
                            <li class="flex items-center justify-between px-4 py-2 hover:bg-[var(--brand-soft)]">
                              <span class="truncate">{{ cliente.nombre }}</span>
                              <a href="{% url 'usuarios:agregar_cliente' usuario.id cliente.id_cliente %}"
                                 class="px-2 py-1 rounded-md text-sm bg-green-600 hover:bg-green-700 text-white">
                                Agregar
                              </a>
                            </li>
                          {% endif %}
                        {% endfor %}
                      </ul>
                    </div>
                  </div>
                  <footer class="px-6 py-4 border-t flex justify-end" style="border-color:var(--line)">
                    <button class="px-4 py-2 rounded-lg font-semibold bg-[var(--brand-soft)]"
                            style="color:var(--brand-dark)">Cerrar</button>
                  </footer>
                </form>
              </dialog>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="5" class="px-6 py-10 text-center text-neutral-500">No hay usuarios para mostrar.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>

  <!-- === MODAL: Confirmaci√≥n para quitar cliente de un usuario (estilo tipos_list) === -->
  <style>
    .modal-backdrop{
      position:fixed; inset:0; background:rgba(17,24,39,.45);
      display:none; align-items:center; justify-content:center; z-index:60;
    }
    .modal-card{
      width:min(92vw,560px); background:#fff; border-radius:16px;
      border:1px solid var(--line); box-shadow:0 20px 50px rgba(0,0,0,.25);
      overflow:hidden;
    }
    .modal-head{ background:#b91c1c; color:#fff; font-weight:900; padding:14px 16px; }
    .modal-body{ padding:16px; background:#fef2f2; color:#7f1d1d; }
    .modal-actions{ padding:12px 16px; display:flex; justify-content:flex-end; gap:8px; }
    .icon-warning{ width:22px; height:22px; flex:0 0 22px; color:#b91c1c; margin-right:.5rem; }
  </style>

  <div id="confirmQuitarModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal-card">
      <div class="modal-head">Quitar cliente del usuario</div>
      <div class="modal-body">
        <div class="flex items-start gap-2">
          <svg class="icon-warning" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M12 9v4m0 4h.01M10.29 3.86l-8.4 14.55A2 2 0 0 0 3.6 21h16.8a2 2 0 0 0 1.71-2.59L13.71 3.86a2 2 0 0 0-3.42 0Z"
                  stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <div>
            <p id="confirmQuitarText" class="font-bold">
              ¬øSeguro que quer√©s quitar este cliente del usuario?
            </p>
            <p class="text-sm mt-1">La relaci√≥n se eliminar√° y el usuario ya no podr√° operar con ese cliente.</p>
          </div>
        </div>
      </div>
      <div class="modal-actions">
        <button type="button"
                class="px-4 py-2 rounded-lg font-bold bg-[var(--brand-soft)] text-[var(--brand-dark)]"
                id="confirmQuitarCancel">Cancelar</button>
        <button type="button"
                class="px-4 py-2 rounded-lg font-bold text-white"
                style="background:#dc2626"
                id="confirmQuitarOk">Quitar</button>
      </div>
    </div>
  </div>
  <!-- === FIN MODAL === -->

</main>

{# ---------- JS m√≠nimo, accesible y sin dependencias ---------- #}
<script>
  // Debounce simple para evitar filtrar en cada tecla
  function debounce(fn, ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }

  // Construir opciones del filtro de roles a partir de las chips de la tabla (si no las env√≠as desde la vista)
  (function hydrateRoleFilter(){
    const sel = document.getElementById('filtroRol');
    if (!sel) return;
    const set = new Set();
    document.querySelectorAll('#tbodyUsuarios [data-roles]').forEach(tr=>{
      tr.dataset.roles.split('|').filter(Boolean).forEach(r=>set.add(r.trim()));
    });
    [...set].sort().forEach(r=>{
      const o=document.createElement('option'); o.value=r; o.textContent=r; sel.appendChild(o);
    });
  })();

  // L√≥gica de filtrado
  const filtroTexto = document.getElementById('filtroTexto');
  const filtroRol   = document.getElementById('filtroRol');
  const soloSin     = document.getElementById('soloSinClientes');
  const rows        = [...document.querySelectorAll('#tbodyUsuarios > tr')];

  function aplicarFiltros(){
    const q = (filtroTexto.value || '').toLowerCase().trim();
    const rol = (filtroRol.value || '').toLowerCase();
    const onlyEmpty = !!soloSin.checked;

    rows.forEach(tr=>{
      const txt  = tr.dataset.text.toLowerCase();
      const roles = tr.dataset.roles.toLowerCase();
      const sin = tr.dataset.sinclientes === '1';

      const matchTxt = !q || txt.includes(q);
      const matchRol = !rol || roles.split('|').includes(rol);
      const matchSin = !onlyEmpty || sin;

      tr.style.display = (matchTxt && matchRol && matchSin) ? '' : 'none';
    });
  }
  const filtrar = debounce(aplicarFiltros, 150);
  filtroTexto.addEventListener('input', filtrar);
  filtroRol.addEventListener('change', aplicarFiltros);
  soloSin.addEventListener('change', aplicarFiltros);

  // Modales: abrir/cerrar (Agregar cliente)
  document.querySelectorAll('[data-open-modal]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const dlg = document.getElementById(btn.dataset.openModal);
      if (dlg && typeof dlg.showModal === 'function') dlg.showModal();
    });
  });

  // Buscador dentro de cada modal de "Agregar cliente"
  document.querySelectorAll('input[data-search-list]').forEach(inp=>{
    const listId = inp.getAttribute('data-search-list');
    const list = document.getElementById(listId);
    const items = list ? [...list.querySelectorAll('li')] : [];
    inp.addEventListener('input', debounce(()=>{
      const q = inp.value.toLowerCase().trim();
      items.forEach(li=>{
        const name = (li.querySelector('span')?.textContent || '').toLowerCase();
        li.style.display = !q || name.includes(q) ? '' : 'none';
      });
    }, 100));
  });

  // --- Confirmaci√≥n al quitar cliente (estilo tipos_list) ---
  (function(){
    const modal = document.getElementById('confirmQuitarModal');
    const txt   = document.getElementById('confirmQuitarText');
    const btnOk = document.getElementById('confirmQuitarOk');
    const btnNo = document.getElementById('confirmQuitarCancel');

    let pendingHref = null;

    function openModal(href, usuarioNombre, clienteNombre){
      pendingHref = href;
      if (usuarioNombre || clienteNombre){
        txt.textContent = `¬øSeguro que quer√©s quitar ‚Äú${clienteNombre||'este cliente'}‚Äù de ‚Äú${usuarioNombre||'este usuario'}‚Äù?`;
      }
      modal.style.display = 'flex';
      modal.setAttribute('aria-hidden','false');
    }
    function closeModal(){
      modal.style.display = 'none';
      modal.setAttribute('aria-hidden','true');
      pendingHref = null;
    }

    // Interceptar SOLO los links con title="Quitar cliente"
    document.querySelectorAll('a[title="Quitar cliente"]').forEach(a=>{
      a.addEventListener('click', (e)=>{
        e.preventDefault();
        // Buscar nombres para copiar al mensaje
        const tr = a.closest('tr');
        const usuarioNombre = tr ? tr.querySelector('td:first-child')?.textContent.trim() : '';
        const clienteNombre = a.closest('li')?.querySelector('span')?.textContent.trim() || '';
        openModal(a.getAttribute('href'), usuarioNombre, clienteNombre);
      });
    });

    btnOk.addEventListener('click', ()=>{ if(pendingHref) window.location.href = pendingHref; });
    btnNo.addEventListener('click', closeModal);
    modal.addEventListener('click', (e)=>{ if(e.target === modal) closeModal(); });
    document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') closeModal(); });
  })();
</script>
{% endblock %}
