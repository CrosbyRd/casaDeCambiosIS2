{% extends "base.html" %}
{% load static %}
{% block title %}Global Exchange{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/ted.css' %}"/>

<!-- Estilos mínimos SOLO para el bloque de confirmación -->
<style>
  .confirm-box{
    display:none;
    margin:18px auto 8px auto;
    max-width:640px;
    background:linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.03));
    border:1.5px solid rgba(255,255,255,0.16);
    border-radius:18px;
    padding:18px 20px;
    box-shadow:0 6px 20px rgba(0,0,0,0.25) inset, 0 10px 30px rgba(0,0,0,0.10);
  }
  .confirm-box .cb-top{
    display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:6px;
  }
  .confirm-box .cb-chip{
    display:inline-flex; align-items:center; gap:8px;
    padding:6px 10px; border-radius:999px;
    background:rgba(255,255,255,0.10); border:1px solid rgba(255,255,255,0.18);
    font-weight:700; letter-spacing:.3px;
  }
  .confirm-box .cb-flag{ font-size:18px; line-height:1; }
  .confirm-box .cb-code{ opacity:.95 }
  .confirm-box .cb-mode{ font-size:14px; opacity:.85 }
  .confirm-box .cb-value{
    font-weight:900; line-height:1.15; letter-spacing:.2px;
    font-size:36px; margin:6px 0 2px 0;
    text-shadow:0 1px 0 rgba(0,0,0,0.35);
  }
  .confirm-box .cb-value .cb-code{
    font-size:18px; font-weight:800; margin-left:6px; opacity:.9;
  }
  .confirm-box .cb-sub{
    margin-top:6px; font-size:14px; opacity:.9;
  }
  #confirm-amount-text.hidden { display:none !important; }
</style>

<style>
/* ===== Variantes de título "Confirmación" (elige UNA en el HTML) ===== */
.confirm-title { text-align:center; margin:0 0 10px; }

/* Opción 2: Texto con gradiente + subrayado brillante */
.confirm-title--gradient{
  display:inline-block; margin:auto; font-weight:900; letter-spacing:.3px;
  font-size:22px;
  background:linear-gradient(90deg,#c4b5fd,#a78bfa,#c4b5fd);
  -webkit-background-clip:text; background-clip:text; color:transparent;
  position:relative; text-transform:uppercase;
}
.confirm-title--gradient::after{
  content:""; display:block; width:120px; height:3px; margin:8px auto 0;
  background:linear-gradient(90deg, transparent, #a78bfa, transparent);
  border-radius:99px; box-shadow:0 0 16px rgba(167,139,250,.6);
}
</style>

<main style="max-width:1100px;margin:0 auto;padding:24px">
  <section class="ted-machine">
    <div class="ted-layout">
      <!-- Pantalla principal -->
      <div class="ted-layout-main">
        <div class="ted-screen">
          <div class="ted-screen-glow"></div>

          <div class="ted-screen-inner">
            <!-- Cabecera -->
            <header class="ted-header">
              <div class="logo-badge">
                <img class="ted-logo" src="{% static 'img/logo-secundario.png' %}" alt="Global Exchange">
              </div>
              <div class="welcome-badge" id="welcome-badge">👋 Bienvenido</div>
              <h1 class="ted-title">GLOBAL EXCHANGE</h1>
            </header>

            <!-- Vistas -->
            <div class="ted-views-container">
              <!-- VISTA: Inicio -->
              <section id="login-screen" class="ted-screen-view active" aria-live="polite">
                <div class="view-content">
                  <p>Hola,
                    <strong>{% firstof request.user.get_full_name request.user.username request.user.email "Usuario" %}</strong>.
                  </p>

                  <div class="location-picker">
                    <label for="select-ubicacion" class="location-label">Ubicación del TED</label>
                    <select id="select-ubicacion" class="ted-select" aria-required="true">
                      <option value="">— Seleccioná una sucursal —</option>
                      <!-- Si ya renderizas ubicaciones desde el server, mantienen este select -->
                    </select>
                    <p class="location-hint">Para continuar al menú de operaciones.</p>
                  </div>

                  <button class="gx-btn" type="button" id="btn-login-ingresar" disabled>Continuar</button>
                </div>
              </section>

              <!-- VISTA: Menú -->
              <section id="menu-screen" class="ted-screen-view" aria-live="polite">
                <div class="view-content">
                  <h2 style="text-align:center;margin-bottom:12px">Operaciones disponibles</h2>
                  <div class="menu-grid">
                    <button id="btn-menu-retirar" type="button" class="menu-card" aria-label="Retiro de dinero">
                      <div class="menu-icon">💵</div>
                      <div class="menu-label">Retiro de Dinero</div>
                    </button>
                    <button id="btn-menu-deposito" type="button" class="menu-card" aria-label="Depósito de dinero">
                      <div class="menu-icon">💰</div>
                      <div class="menu-label">Depósito de Dinero</div>
                    </button>
                  </div>
                  <div style="text-align:center;margin-top:16px">
                    <button id="btn-menu-salir" type="button" class="gx-btn gx-btn--ghost">🚪 Salir</button>
                  </div>
                </div>
              </section>

              <!-- VISTA: Retiro / Depósito (ingreso código) -->
              <section id="transaction-screen" class="ted-screen-view" aria-live="polite">
                <div class="view-content">
                  <h3 id="tx-title">Operación</h3>
                  <label for="transaction-number">Ingrese número de transacción</label>
                  <input id="transaction-number" data-kb="1" type="text" class="ted-input" placeholder="Código de operación"/>
                  <div class="button-group">
                    <button class="gx-btn gx-btn--ghost" type="button" id="btn-tx-cancelar">Cancelar</button>
                    <button class="gx-btn" type="button" id="btn-tx-validar">Validar</button>
                  </div>
                </div>
              </section>

              <!-- VISTA: Confirmación de monto -->
              <section id="confirm-amount-screen" class="ted-screen-view" aria-live="polite">
                <div class="view-content view-content--centered">
                  <div class="confirm-title">
                    <span class="confirm-title--gradient">Confirmación</span>
                  </div>

                  <!-- NUEVO bloque visual -->
                  <div id="confirm-amount-box" class="confirm-box" aria-live="polite"></div>

                  <!-- Fallback de texto plano (se ocultará si hay box) -->
                  <div id="confirm-amount-text" class="confirm-text">¿Desea confirmar la operación?</div>

                  <div class="button-group">
                    <button class="gx-btn gx-btn--ghost" type="button" id="btn-amount-cancel">Cancelar</button>
                    <button class="gx-btn" type="button" id="btn-amount-confirm">Continuar</button>
                  </div>
                </div>
              </section>

              <!-- VISTA: OTP -->
              <section id="otp-screen" class="ted-screen-view" aria-live="polite">
                <div class="view-content view-content--centered">
                  <h3 class="status-title">Verificación</h3>
                  <p class="status-message">Ingresá el código de verificación enviado a tu correo.</p>
                  <div id="otp-summary" class="status-message" style="margin:8px 0 14px 0"></div>
                  <input id="otp-input" type="text" class="ted-input" inputmode="numeric" maxlength="6" placeholder="Código OTP (6 dígitos)" />
                  <div class="button-group">
                    <button class="gx-btn gx-btn--ghost" type="button" id="btn-otp-back">Volver</button>
                    <button class="gx-btn" type="button" id="btn-otp-confirm">Confirmar</button>
                  </div>
                </div>
              </section>

              <!-- VISTA: Procesando -->
              <section id="processing-screen" class="ted-screen-view" aria-live="polite">
                <div class="view-content view-content--centered">
                  <div class="processing-text">
                    <span id="processing-message">Procesando</span><span class="processing-dots"></span>
                  </div>
                </div>
              </section>

              <!-- VISTA: Éxito -->
              <section id="success-screen" class="ted-screen-view" aria-live="polite">
                <div class="view-content view-content--centered">
                  <div class="status-title status-title--success">¡Operación exitosa!</div>
                  <!-- Tarjeta de resultado -->
                  <div id="success-amount-box" class="result-box" aria-live="polite"></div>
                  <div id="success-message" class="status-message">Listo.</div>
                  <div class="button-group">
                    <button class="gx-btn gx-btn--ghost" type="button" id="btn-success-exit">Salir</button>
                    <button class="gx-btn" type="button" id="btn-success-print">Imprimir ticket</button>
                  </div>
                </div>
              </section>

              <!-- VISTA: Cancelado / Error -->
              <section id="cancel-screen" class="ted-screen-view" aria-live="polite">
                <div class="view-content view-content--centered">
                  <div class="status-title status-title--cancel">Operación cancelada</div>
                  <div id="cancel-sub" class="status-message">Recoja su dinero.</div>
                  <button class="gx-btn gx-btn--ghost" type="button" id="btn-cancel-exit">Salir</button>
                </div>
              </section>
            </div><!-- /ted-views-container -->
          </div>
        </div>
      </div>

      <!-- Panel lateral (reloj + teclado) -->
      <aside class="ted-layout-aside">
        <div class="pad-info-card">
          <div class="clock" id="ted-clock">--:--:--</div>
          <div class="info-line">Nº de serie: <strong id="info-serie">—</strong></div>
          <div class="info-line">Ubicación: <strong id="info-ubicacion">—</strong></div>
        </div>

        <div class="pad-bezel">
          <div class="ted-pad" aria-label="Teclado">
            <div class="grid">
              {% for key in "123a456b789c0def" %}
              <button class="ted-key" type="button" data-key="{{ key }}">{{ key }}</button>
              {% endfor %}
            </div>
          </div>
        </div>
      </aside>
    </div>

    <!-- Ranuras -->
    <div class="slots-container">
      <div id="bill-slot" class="ted-slot">
        <div class="slot-opening"></div>
        <div class="slot-indicator"></div>
        <div class="bill-stack">
          <div class="bill-item" style="animation-delay:0s">$100</div>
          <div class="bill-item" style="animation-delay:0.15s">$100</div>
          <div class="bill-item" style="animation-delay:0.3s">$100</div>
          <div class="bill-item" style="animation-delay:0.45s">$100</div>
        </div>
        <div class="slot-label">Ranura de billetes</div>
      </div>

      <div id="receipt-slot" class="ted-slot">
        <div class="slot-opening"></div>
        <div class="slot-indicator"></div>
        <div class="receipt-anim">
          <div class="receipt-paper">
            <div class="receipt-header">GLOBAL EXCHANGE</div>
            <div id="receipt-body"></div>
          </div>
        </div>
        <div class="slot-label">Salida de tickets</div>
      </div>
    </div>
  </section>
</main>

<script>
(() => {
  const qs = (sel, el=document) => el.querySelector(sel);
  const qsa = (sel, el=document) => [...el.querySelectorAll(sel)];
  const flag = (code) => ({USD:'🇺🇸', EUR:'🇪🇺', PYG:'🇵🇾'})[String(code||'').toUpperCase()] || '🏳️';
  const formatAmountRaw = (a) => {
    try{
      const n = Number(a);
      if(Number.isFinite(n)){
        return n.toLocaleString('es-PY',{maximumFractionDigits:0});
      }
    }catch(e){}
    return String(a);
  };
  const formatAmount = (a, code)=> `${formatAmountRaw(a)} ${code}`;

  const ctx = { modo:null, code:null, ubicacion:null, raw:null, reserva_id:null, ticket_url:null };

  // --- HTTP helpers / endpoints ---
  async function api(url, body){
    const res = await fetch(url, {
      method: body ? 'POST' : 'GET',
      credentials:'same-origin',
      headers: body ? {'Content-Type':'application/json'} : {},
      body: body ? JSON.stringify(body||{}) : undefined
    });
    const data = await res.json().catch(()=>({}));
    if(!res.ok || data.ok === false) throw new Error(data.error || 'Error');
    return data.data || data;
  }
  const URLS = {
    validar: "{% url 'usuarios:ted_api_validar' %}",
    precontar: "{% url 'usuarios:ted_api_precontar' %}",
    otp_enviar: "{% url 'usuarios:ted_api_otp_enviar' %}",
    otp_verificar: "{% url 'usuarios:ted_api_otp_verificar' %}",
    confirmar: "{% url 'usuarios:ted_api_confirmar' %}",
    ubicaciones: "{% url 'usuarios:ted_api_ubicaciones' %}",
    terminal: "{% url 'usuarios:ted_api_terminal' %}",
  };

  // --- Navegación entre vistas (FIX: alterna clase 'active') ---
  const show = (id) => {
    qsa('.ted-screen-view').forEach(el => {
      el.classList.remove('active');
      el.setAttribute('aria-hidden','true');
      el.style.display='none';
    });
    const el = qs('#'+id);
    if(el){
      el.classList.add('active');
      el.setAttribute('aria-hidden','false');
      el.style.display='block';
    }
  };

  // --- Login (cargar ubicaciones & terminal) ---
  const ubicSel = qs('#select-ubicacion');
  const btnLogin = qs('#btn-login-ingresar');

  async function cargarTerminal(){
    try{
      const data = await api(URLS.terminal);
      qs('#info-serie').textContent = (data && data.serial) || '—';
    }catch(_e){
      qs('#info-serie').textContent = '—';
    }
  }

  async function cargarUbicaciones(){
    try{
      const data = await api(URLS.ubicaciones);
      const list = (data && data.ubicaciones) || [];
      ubicSel.innerHTML = '<option value="">— Seleccioná una sucursal —</option>';
      list.forEach(u=>{
        const opt = document.createElement('option');
        opt.value = u; opt.textContent = u;
        ubicSel.appendChild(opt);
      });
      if(list.length === 1){ ubicSel.value = list[0]; }
      ctx.ubicacion = ubicSel.value || null;
      btnLogin.disabled = !ctx.ubicacion;
      qs('#info-ubicacion').textContent = ctx.ubicacion || '—';
    }catch(_e){
      ubicSel.innerHTML = '<option value="">(Sin ubicaciones cargadas)</option>';
      btnLogin.disabled = true;
    }
  }

  ubicSel?.addEventListener('change', ()=>{
    ctx.ubicacion = ubicSel.value || null;
    btnLogin.disabled = !ctx.ubicacion;
    qs('#info-ubicacion').textContent = ctx.ubicacion || '—';
  });
  btnLogin?.addEventListener('click', ()=> show('menu-screen'));

  // --- Menú ---
  qs('#btn-menu-retirar')?.addEventListener('click', ()=>{
    ctx.modo = 'retiro';
    qs('#tx-title').textContent = 'Retiro de Dinero';
    show('transaction-screen');
  });
  qs('#btn-menu-deposito')?.addEventListener('click', ()=>{
    ctx.modo = 'deposito';
    qs('#tx-title').textContent = 'Depósito de Dinero';
    show('transaction-screen');
  });
  qs('#btn-menu-salir')?.addEventListener('click', ()=>{
    ctx.modo = null; ctx.code = null; show('login-screen');
  });

  // --- Código + validar ---
  const codeInput = qs('#transaction-number');
  const btnTxValidar = qs('#btn-tx-validar');
  const btnTxCancelar = qs('#btn-tx-cancelar');
  codeInput?.addEventListener('input', ()=>{
    ctx.code = (codeInput.value||'').trim().toUpperCase();
    btnTxValidar.disabled = !ctx.code;
  });
  btnTxCancelar?.addEventListener('click', ()=> show('menu-screen'));

  btnTxValidar?.addEventListener('click', async ()=>{
    try{
      if(!ctx.modo) throw new Error('Seleccioná primero Retiro o Depósito.');
      const info = await api(URLS.validar, {codigo: ctx.code, modo: ctx.modo});
      ctx.raw = info;

      const box = qs('#confirm-amount-box');
      const textEl = qs('#confirm-amount-text');
      const emoji = flag(info.moneda);
      box.innerHTML = `
        <div class="cb-top">
          <span class="cb-chip"><span class="cb-flag">${emoji}</span><span class="cb-code">${info.moneda}</span></span>
          <div class="cb-mode">${ctx.modo==='deposito'?'Depósito':'Retiro'}</div>
        </div>
        <div class="cb-value"><span class="cb-number">${formatAmountRaw(info.monto)}</span> <span class="cb-code">${info.moneda}</span></div>
        <div class="cb-sub">Transacción <code>${info.codigo}</code></div>
      `;
      box.style.display = 'block';
      textEl?.classList.add('hidden');
      show('confirm-amount-screen');
    }catch(err){
      qs('#cancel-sub') && (qs('#cancel-sub').textContent = String(err.message||err));
      show('cancel-screen');
    }
  });

  // --- Precontar + OTP ---
  qs('#btn-amount-cancel')?.addEventListener('click', ()=> show('menu-screen'));
  qs('#btn-amount-confirm')?.addEventListener('click', async ()=>{
    try{
      const data = await api(URLS.precontar, { codigo: ctx.code, modo: ctx.modo, ubicacion: ctx.ubicacion });
      ctx.reserva_id = data.reserva_id;

      const list = qs('#otp-summary');
      if(list){
        const rows = (data.breakdown||[]).map(b=>`<li>${b.unidades} x ${b.valor} ${data.moneda}</li>`).join('') || '<li>Depósito: ingrese billetes en la terminal</li>';
        list.innerHTML = `<ul>${rows}</ul><div class="text-[var(--muted)]">Redondeo: ${formatAmount(data.diff, data.moneda)} (a favor de la casa)</div>`;
      }

      await api(URLS.otp_enviar, {reserva_id: ctx.reserva_id});
      show('otp-screen');
    }catch(err){
      qs('#cancel-sub') && (qs('#cancel-sub').textContent = String(err.message||err));
      show('cancel-screen');
    }
  });

  // --- OTP confirmar ---
  qs('#btn-otp-back')?.addEventListener('click', ()=> show('confirm-amount-screen'));
  qs('#btn-otp-confirm')?.addEventListener('click', async ()=>{
    try{
      const otp = (qs('#otp-input')?.value || '').trim();
      if(!otp) throw new Error('Ingrese el código OTP.');
      await api(URLS.otp_verificar, {reserva_id: ctx.reserva_id, otp});
      const result = await api(URLS.confirmar, {reserva_id: ctx.reserva_id, otp});
      ctx.ticket_url = result.ticket_url || null;

      qs('#success-message') && (qs('#success-message').textContent =
        `${ctx.modo==='deposito'?'Depósito':'Retiro'} completado para la transacción ${ctx.code}.`);
      show('success-screen');
    }catch(err){
      qs('#cancel-sub') && (qs('#cancel-sub').textContent = String(err.message||err));
      show('cancel-screen');
    }
  });

  // --- Teclado virtual ---
  let active = null;
  qsa('input[data-kb]').forEach(inp=>{
    inp.addEventListener('focus',()=> active=inp);
    inp.addEventListener('blur',()=> active=null);
  });
  qsa('.ted-key').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      if(!active) return;
      const k = btn.dataset.key;
      if(k==='a'){ active.value += 'A'; }
      else if(k==='b'){ active.value += 'B'; }
      else if(k==='c'){ active.value += 'C'; }
      else if(k==='d'){ active.value = active.value.slice(0,-1); }
      else { active.value += k; }
      active.dispatchEvent(new Event('input',{bubbles:true}));
    });
  });

  // --- Reloj y arranque ---
  function tick(){ const now=new Date(); qs('#ted-clock').textContent = now.toLocaleTimeString('es-PY',{hour12:false}); }
  setInterval(tick, 1000); tick();

  // Inicialización
  (async () => {
    await cargarTerminal();
    await cargarUbicaciones();
    // Mostrar siempre la pantalla de login al iniciar
    show('login-screen');
  })();
})();
</script>

{% endblock %}
