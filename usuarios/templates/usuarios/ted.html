{% extends "base.html" %}
{% load static %}
{% block title %}Global Exchange{% endblock %}

{% block extra_head %}
<style>
  .ted-machine{background:linear-gradient(145deg,color-mix(in oklab,#f3f4f6 60%,#fff));border:1.5px solid var(--line);border-radius:24px}
  .ted-screen{background:radial-gradient(120% 120% at 30% 20%,color-mix(in oklab,var(--brand) 18%,#1f2937) 0%,#0f172a 60%);border-radius:16px;box-shadow:inset 0 0 0 1px color-mix(in oklab,#fff 8%,transparent)}
  .ted-screen-glow{position:absolute;inset:0;background:radial-gradient(80% 60% at 20% 15%,color-mix(in oklab,var(--brand) 18%,transparent) 0%,transparent 65%);pointer-events:none}
  .ted-screen-view{display:none !important;animation:tedFade .25s ease-out}
  .ted-screen-view.active{display:block !important}
  @keyframes tedFade{from{opacity:0;transform:scale(.98)}to{opacity:1;transform:scale(1)}}

  /* Ranuras físicas */
  .ted-slot{background:linear-gradient(145deg,#cbd5e1,#94a3b8);border-radius:12px;position:relative;overflow:visible}
  .ted-slot .open{height:8px;border-radius:4px;background:#0b0f1a;box-shadow:inset 0 2px 6px rgba(0,0,0,.7)}
  .ted-slot .dot{position:absolute;right:10px;top:50%;transform:translateY(-50%);width:8px;height:8px;border-radius:999px;background:#ef4444;box-shadow:0 0 10px rgba(220,38,38,.5);transition:.25s}
  .ted-slot.active .dot{background:#10b981;box-shadow:0 0 14px rgba(16,185,129,.9)}
  .slot-anim{position:absolute;left:50%;transform:translateX(-50%);top:-6px;pointer-events:none}

  /* Animaciones desde la ranura */
  .bill-anim,.check-anim{display:none;align-items:center;justify-content:center;border-radius:6px;box-shadow:0 6px 18px rgba(0,0,0,.25);font-weight:800}
  .bill-anim{width:120px;height:50px;background:linear-gradient(45deg,#85bb65,#6fa855);border:2px solid #5a8a45;color:#fff}
  .check-anim{width:150px;height:70px;background:linear-gradient(45deg,#e0f2fe,#bae6fd);border:2px solid #0284c7;color:#075985}

  .ted-slot.show-bill .bill-anim{display:flex;animation:slotOutUp 1.15s ease-out}
  .ted-slot.show-check .check-anim{display:flex;animation:slotOutUp 1.15s ease-out}
  @keyframes slotOutUp{
    0%{transform:translateX(-50%) translateY(40px);opacity:0}
    55%{opacity:1}
    100%{transform:translateX(-50%) translateY(-28px);opacity:1}
  }

  /* Ticket desde ranura */
  .receipt-anim{display:none;position:relative;width:220px;background:#fff;color:#111827;border-radius:8px;box-shadow:0 10px 30px rgba(0,0,0,.25);font-family:ui-monospace,Consolas,monospace;font-size:12px;padding:16px}
  .ted-slot.show-receipt .receipt-anim{display:block;animation:printRec 2s ease-out}
  @keyframes printRec{
    0%{transform:translateY(40px);opacity:0}
    65%{opacity:1}
    100%{transform:translateY(-6px);opacity:1}
  }

  /* Cartas del menú */
  .menu-card{border-radius:18px;border:1px solid rgba(255,255,255,.22);background:rgba(255,255,255,.08);
             padding:22px;min-height:128px;display:flex;flex-direction:column;align-items:center;justify-content:center;
             gap:.35rem;text-align:center;backdrop-filter:blur(6px);transition:transform .08s, box-shadow .2s, background .2s}
  .menu-card:hover{background:rgba(255,255,255,.12);box-shadow:0 0 0 2px var(--brand-soft);transform:translateY(-1px)}

  /* Botones */
  .gx-btn{display:inline-flex;align-items:center;justify-content:center;gap:.5rem;padding:.85rem 1.2rem;border-radius:.9rem;font-weight:800;text-decoration:none;border:1px solid transparent;background:var(--brand);color:#fff;box-shadow:0 12px 24px -10px rgba(124,58,237,.35)}
  .gx-btn:hover{transform:translateY(-1px)}
  .gx-btn--ghost{background:var(--brand-soft);color:#4c1d95}

  /* Logo */
  .logo-badge{display:inline-flex;align-items:center;justify-content:center;width:68px;height:68px;border-radius:999px;
              background:linear-gradient(90deg,var(--brand-soft),color-mix(in oklab,#fff 12%,var(--brand-soft)));
              box-shadow:0 10px 24px -12px rgba(124,58,237,.45); margin:0 auto 10px auto}
  .ted-logo{height:36px;width:auto;display:block;filter:drop-shadow(0 4px 10px rgba(0,0,0,.35))}

  .currency-chip{display:inline-flex;align-items:center;justify-content:center;min-width:48px;height:48px;border-radius:12px;border:1px solid rgba(255,255,255,.3);background:rgba(255,255,255,.1);font-size:24px;line-height:1;color:#fff;pointer-events:none;user-select:none}

  .welcome-badge{display:inline-flex;align-items:center;gap:.5rem;padding:.35rem .7rem;border-radius:999px;
                 background:linear-gradient(90deg,var(--brand-soft),color-mix(in oklab,#fff 12%,var(--brand-soft)));
                 color:#4c1d95;font-weight:800;box-shadow:0 8px 20px -10px rgba(124,58,237,.45)}

  /* Panel info (hora/serie/ubicación) separado del teclado */
  .pad-info-card{border:1px solid rgba(255,255,255,.18);background:radial-gradient(120% 120% at 30% 20%,color-mix(in oklab,var(--brand) 12%,#1f2937) 0%,#0f172a 60%);border-radius:14px;padding:14px;color:#e5e7eb}
  .pad-info-card .clock{font-variant-numeric:tabular-nums;font-weight:900}
  .pad-bezel{background:#0b0b0f;border-radius:18px;padding:12px;box-shadow:inset 0 0 0 1px rgba(255,255,255,.06)}
  .ted-pad{border:1px solid rgba(255,255,255,.18);background:radial-gradient(120% 120% at 30% 20%,color-mix(in oklab,var(--brand) 12%,#1f2937) 0%,#0f172a 60%);border-radius:14px;padding:14px;position:relative;overflow:hidden}
  .ted-pad::after{content:"";position:absolute;inset:0;background:radial-gradient(80% 60% at 20% 15%,color-mix(in oklab,var(--brand) 14%,transparent) 0%,transparent 65%);pointer-events:none}
  .ted-key{display:flex;align-items:center;justify-content:center;height:56px;border-radius:14px;
           border:1px solid rgba(255,255,255,.22); background:linear-gradient(180deg,rgba(255,255,255,.12),rgba(255,255,255,.06));
           color:#fff;font-weight:900;font-size:18px;backdrop-filter:blur(3px);
           box-shadow:inset 0 0 0 1px rgba(255,255,255,.06), 0 10px 20px rgba(0,0,0,.18);
           transition:transform .05s ease, box-shadow .2s ease, background .2s ease}
  .ted-key:hover{box-shadow:inset 0 0 0 1px rgba(255,255,255,.12), 0 12px 22px rgba(0,0,0,.22)}
  .ted-key:active{transform:translateY(1px);background:linear-gradient(180deg,rgba(255,255,255,.18),rgba(255,255,255,.1))}

  /* Alineación superior en desktop */
  @media (min-width: 768px){
    .align-top{align-items:flex-start}
  }
</style>
{% endblock %}

{% block content %}
<main class="max-w-4xl mx-auto px-6 py-8">
  <section class="ted-machine p-4 md:p-6">
    <!-- Pantalla + Keypad -->
    <div class="flex flex-col md:flex-row gap-5 align-top">
      <!-- Pantalla TED -->
      <div class="flex-1">
        <div class="bg-black rounded-2xl p-3 md:p-5 mb-5">
          <div class="relative ted-screen min-h-[380px] p-5 md:p-7 overflow-hidden">
            <div class="ted-screen-glow"></div>

            <div class="relative z-10 text-white">
              <div class="text-center mb-4">
                <div class="logo-badge">
                  <img class="ted-logo" src="{% static 'img/logo-secundario.png' %}" alt="Global Exchange">
                </div>
                <div class="text-2xl font-extrabold tracking-widest">GLOBAL EXCHANGE</div>
              </div>

              <!-- LOGIN -->
              <div id="login-screen" class="ted-screen-view active">
                <div class="text-center mb-3">
                  <span class="welcome-badge">👋 Bienvenido</span>
                  <p class="text-white/85 mt-3">Ingrese sus datos para continuar.</p>
                </div>
                <div class="text-center">
                  <input id="account-number" type="text"
                    class="w-full max-w-xs text-center rounded-xl border border-white/30 bg-white/10 text-white placeholder-white/60
                           focus:outline-none focus:ring-2 focus:ring-[var(--brand)] focus:border-transparent px-4 py-3 mb-3"
                    placeholder="Número de cuenta"/>
                  <input id="pin-input" type="password"
                    class="w-full max-w-xs text-center rounded-xl border border-white/30 bg-white/10 text-white placeholder-white/60
                           focus:outline-none focus:ring-2 focus:ring-[var(--brand)] focus:border-transparent px-4 py-3 mb-4"
                    placeholder="PIN"/>
                  <div class="flex items-center justify-center gap-2">
                    <button class="gx-btn" type="button" id="btn-login-ingresar">Ingresar</button>
                  </div>
                </div>
              </div>

              <!-- MENÚ -->
              <div id="menu-screen" class="ted-screen-view">
                <div class="text-center mb-5">
                  <h2 class="text-white font-bold text-xl">Operaciones disponibles</h2>
                  <p class="text-white/80">Seleccioná una opción</p>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                  <button id="btn-menu-retirar" type="button" class="menu-card">
                    <div class="text-4xl">💵</div>
                    <div class="font-semibold leading-tight">Retiro de Dinero</div>
                  </button>
                  <button id="btn-menu-deposito" type="button" class="menu-card">
                    <div class="text-4xl">💰</div>
                    <div class="font-semibold leading-tight">Depósito de Dinero</div>
                  </button>
                  <button id="btn-menu-cheque" type="button" class="menu-card">
                    <div class="text-4xl">📄</div>
                    <div class="font-semibold leading-tight">Depósito de Cheque</div>
                  </button>
                  <button id="btn-menu-salir" type="button" class="menu-card">
                    <div class="text-4xl">🚪</div>
                    <div class="font-semibold leading-tight">Salir</div>
                  </button>
                </div>
              </div>

              <!-- RETIRO -->
              <div id="transaction-screen" class="ted-screen-view">
                <div class="text-center">
                  <h3 class="text-white font-bold mb-4">Retiro de Dinero</h3>
                  <label class="block text-white/85 mb-2" for="transaction-number">Ingrese número de transacción</label>
                  <input id="transaction-number" type="text"
                    class="w-full max-w-xs text-center rounded-xl border border-white/30 bg-white/10 text-white placeholder-white/60
                           focus:outline-none focus:ring-2 focus:ring-[var(--brand)] focus:border-transparent px-4 py-3 mb-4"
                    placeholder="Número de transacción"/>
                  <div class="text-white/85 mb-2">Divisas disponibles</div>
                  <div id="retiro-currency-list" class="flex items-center justify-center flex-wrap gap-3 mb-6"></div>
                  <div class="flex items-center justify-center gap-2">
                    <button class="gx-btn gx-btn--ghost" type="button" id="btn-retirar-cancelar">Cancelar</button>
                    <button class="gx-btn" type="button" id="btn-retirar-confirmar">Confirmar</button>
                  </div>
                </div>
              </div>

              <!-- DEPÓSITO DINERO -->
              <div id="deposit-screen" class="ted-screen-view">
                <div class="text-center">
                  <h3 class="text-white font-bold mb-4">Depósito de Dinero</h3>
                  <label class="block text-white/85 mb-2" for="deposit-tx">Ingrese número de transacción</label>
                  <input id="deposit-tx" type="text"
                    class="w-full max-w-xs text-center rounded-xl border border-white/30 bg-white/10 text-white placeholder-white/60
                           focus:outline-none focus:ring-2 focus:ring-[var(--brand)] focus:border-transparent px-4 py-3 mb-6"
                    placeholder="Número de transacción"/>
                  <div class="flex items-center justify-center gap-2">
                    <button class="gx-btn gx-btn--ghost" type="button" id="btn-depo-cancelar">Cancelar</button>
                    <button class="gx-btn" type="button" id="btn-depo-confirmar">Confirmar</button>
                  </div>
                </div>
              </div>

              <!-- DEPÓSITO CHEQUE -->
              <div id="check-screen" class="ted-screen-view">
                <div class="text-center">
                  <h3 class="text-white font-bold mb-4">Depósito de Cheque</h3>
                  <label class="block text-white/85 mb-2" for="check-tx">Ingrese número de transacción</label>
                  <input id="check-tx" type="text"
                    class="w-full max-w-xs text-center rounded-xl border border-white/30 bg-white/10 text-white placeholder-white/60
                           focus:outline-none focus:ring-2 focus:ring-[var(--brand)] focus:border-transparent px-4 py-3 mb-6"
                    placeholder="Número de transacción"/>
                  <div class="flex items-center justify-center gap-2">
                    <button class="gx-btn gx-btn--ghost" type="button" id="btn-cheque-cancelar">Cancelar</button>
                    <button class="gx-btn" type="button" id="btn-cheque-confirmar">Confirmar</button>
                  </div>
                </div>
              </div>

              <!-- PROCESOS/CONFIRMACIONES/RESULTADOS -->
              <div id="processing-screen" class="ted-screen-view"><div class="text-center"><div class="text-lg font-bold" id="processing-message">Procesando...</div></div></div>
              <div id="confirm-amount-screen" class="ted-screen-view"><div class="text-center space-y-4"><div class="text-xl font-bold">Confirmación</div><div id="confirm-amount-text" class="text-white/90">¿Desea confirmar el depósito?</div><div class="flex items-center justify-center gap-2"><button class="gx-btn gx-btn--ghost" type="button" id="btn-amount-cancel">Cancelar</button><button class="gx-btn" type="button" id="btn-amount-confirm">Confirmar</button></div></div></div>
              <div id="confirm-cheque-screen" class="ted-screen-view"><div class="text-center space-y-4"><div class="text-xl font-bold">Confirmación</div><div id="confirm-cheque-text" class="text-white/90">¿Desea confirmar el depósito de su cheque?</div><div class="flex items-center justify-center gap-2"><button class="gx-btn gx-btn--ghost" type="button" id="btn-cheque-cancel2">Cancelar</button><button class="gx-btn" type="button" id="btn-cheque-confirm2">Confirmar</button></div></div></div>
              <div id="success-screen" class="ted-screen-view"><div class="text-center space-y-3"><div class="text-2xl font-extrabold text-emerald-400">¡Operación exitosa!</div><div class="text-white" id="success-message">Listo.</div><div class="flex items-center justify-center gap-2"><button class="gx-btn gx-btn--ghost" type="button" id="btn-success-exit">Salir</button><button class="gx-btn" type="button" id="btn-success-print">Imprimir ticket</button></div></div></div>
              <div id="cancel-screen" class="ted-screen-view"><div class="text-center space-y-3"><div class="text-rose-400 font-extrabold text-2xl">Operación cancelada</div><div class="text-white/90" id="cancel-sub">Recoja su dinero.</div><button class="gx-btn gx-btn--ghost" type="button" id="btn-cancel-exit">Salir</button></div></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Lateral: info arriba + keypad abajo -->
      <aside class="w-full md:w-[300px] md:self-start">
        <div class="pad-info-card mb-3">
          <div class="clock" id="ted-clock">--:--:--</div>
          <div class="mt-1">Nº de serie: <strong>TED-AGSL-0001</strong></div>
          <div class="mt-1">Ubicación: <strong>Campus, San Lorenzo – Paraguay</strong></div>
        </div>
        <div class="pad-bezel">
          <div class="ted-pad">
            <div class="grid grid-cols-4 gap-3">
              <button class="ted-key" type="button" data-key="1">1</button>
              <button class="ted-key" type="button" data-key="2">2</button>
              <button class="ted-key" type="button" data-key="3">3</button>
              <button class="ted-key" type="button" data-key="a">a</button>

              <button class="ted-key" type="button" data-key="4">4</button>
              <button class="ted-key" type="button" data-key="5">5</button>
              <button class="ted-key" type="button" data-key="6">6</button>
              <button class="ted-key" type="button" data-key="b">b</button>

              <button class="ted-key" type="button" data-key="7">7</button>
              <button class="ted-key" type="button" data-key="8">8</button>
              <button class="ted-key" type="button" data-key="9">9</button>
              <button class="ted-key" type="button" data-key="c">c</button>

              <button class="ted-key" type="button" data-key="0">0</button>
              <button class="ted-key" type="button" data-key="d">d</button>
              <button class="ted-key" type="button" data-key="e">e</button>
              <button class="ted-key" type="button" data-key="f">f</button>
            </div>
          </div>
        </div>
      </aside>
    </div>

    <!-- Ranuras físicas (con elementos de animación internos) -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-5">
      <div id="bill-slot" class="ted-slot p-3">
        <div class="open"></div><div class="dot"></div>
        <div class="slot-anim"><div id="bill-anim" class="bill-anim">$100</div></div>
        <div class="text-center font-bold mt-2">Ranura de billetes</div>
      </div>
      <div id="check-slot" class="ted-slot p-3">
        <div class="open"></div><div class="dot"></div>
        <div class="slot-anim"><div id="check-anim" class="check-anim">CHEQUE</div></div>
        <div class="text-center font-bold mt-2">Ranura de cheques</div>
      </div>
      <div id="receipt-slot" class="ted-slot p-3">
        <div class="open"></div><div class="dot"></div>
        <div class="slot-anim">
          <div id="receipt-anim" class="receipt-anim">
            <div class="text-center border-b border-dashed border-black/60 pb-2 mb-2 font-bold">GLOBAL EXCHANGE</div>
            <div id="receipt-body"></div>
          </div>
        </div>
        <div class="text-center font-bold mt-2">Salida de tickets</div>
      </div>
    </div>
  </section>
</main>

<script>
(function(){
  const qs = (s, c=document)=>c.querySelector(s);
  const qsa = (s, c=document)=>Array.from(c.querySelectorAll(s));
  const after = (ms,fn)=>setTimeout(fn, ms);

  /* ===== Reloj lateral ===== */
  function startClock(){
    const el=qs('#ted-clock'); if(!el) return;
    const fmt = new Intl.DateTimeFormat('es-PY',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
    const tick=()=>{ el.textContent = fmt.format(new Date()); };
    tick(); setInterval(tick,1000);
  }

  /* ===== Navegación de pantallas ===== */
  function showScreen(name){
    qsa('.ted-screen-view').forEach(v=>v.classList.remove('active'));
    const el = qs('#'+name+'-screen'); if (el) el.classList.add('active');
    qsa('.ted-slot').forEach(s=>s.classList.remove('active','show-bill','show-check','show-receipt'));
  }
  function showProcessing(msg){ qs('#processing-message').textContent=msg; showScreen('processing'); }

  let currentOp=null;

  function animBillFromSlot(){
    const slot=qs('#bill-slot'); if(!slot) return;
    slot.classList.add('active','show-bill');
    after(1400, ()=> slot.classList.remove('show-bill'));
  }
  function animCheckFromSlot(){
    const slot=qs('#check-slot'); if(!slot) return;
    slot.classList.add('active','show-check');
    after(1400, ()=> slot.classList.remove('show-check'));
  }

  function showSuccess(msg){
    qs('#success-message').textContent = msg || 'Listo.';
    showScreen('success');
    if(currentOp==='retiro' || currentOp==='deposito') animBillFromSlot();
    if(currentOp==='cheque') animCheckFromSlot();
  }
  function showCancel(_main, subMsg){ qs('#cancel-sub').textContent = subMsg || ''; showScreen('cancel'); }

  document.addEventListener('DOMContentLoaded', ()=>{
    startClock();
    showScreen('login');
    qs('#account-number')?.focus();
  });

  /* ===== Login ===== */
  qs('#btn-login-ingresar')?.addEventListener('click', ()=>{
    showProcessing('Procesando...');
    after(2000, ()=> showScreen('menu'));
  });

  /* ===== Menú ===== */
  qs('#btn-menu-retirar')?.addEventListener('click', ()=>{
    showScreen('transaction'); currentOp=null; loadRetiroCurrencies(); qs('#bill-slot')?.classList.add('active');
  });
  qs('#btn-menu-deposito')?.addEventListener('click', ()=>{ showScreen('deposit'); currentOp=null; qs('#bill-slot')?.classList.add('active'); });
  qs('#btn-menu-cheque')?.addEventListener('click', ()=>{ showScreen('check'); currentOp=null; qs('#check-slot')?.classList.add('active'); });
  qs('#btn-menu-salir')?.addEventListener('click', ()=> showScreen('login'));

  /* ===== Flags informativas ===== */
  const currencyFlagMap={USD:'🇺🇸',EUR:'🇪🇺',ARS:'🇦🇷',BRL:'🇧🇷',PYG:'🇵🇾',CNY:'🇨🇳',JPY:'🇯🇵',GBP:'🇬🇧',UYU:'🇺🇾',CLP:'🇨🇱',COP:'🇨🇴',BOB:'🇧🇴',PEN:'🇵🇪',MXN:'🇲🇽',CAD:'🇨🇦',AUD:'🇦🇺',CHF:'🇨🇭',VES:'🇻🇪',VEF:'🇻🇪',RUB:'🇷🇺',ILS:'🇮🇱',CRC:'🇨🇷',DOP:'🇩🇴',NOK:'🇳🇴',SEK:'🇸🇪',DKK:'🇩🇰',ZAR:'🇿🇦',HNL:'🇭🇳',GTQ:'🇬🇹',PAB:'🇵🇦',NIO:'🇳🇮',TRY:'🇹🇷',INR:'🇮🇳',KRW:'🇰🇷',SGD:'🇸🇬',HKD:'🇭🇰'};
  const flagForCurrency=code=>currencyFlagMap[code]||code;

  async function loadRetiroCurrencies(){
    const cont=qs('#retiro-currency-list'); if(!cont) return;
    cont.innerHTML='<span class="muted">Cargando...</span>';
    try{
      const res=await fetch("{% url 'admin_panel:ted:monedas_disponibles' %}",{credentials:'same-origin'});
      if(!res.ok) throw new Error('HTTP '+res.status);
      const data=await res.json(); const monedas=Array.isArray(data.monedas)?data.monedas:[];
      if(!monedas.length){ cont.innerHTML='<span class="muted">Sin divisas disponibles en este momento.</span>'; return; }
      const frag=document.createDocumentFragment();
      monedas.forEach(code=>{ const chip=document.createElement('span'); chip.className='currency-chip'; chip.title=code; chip.setAttribute('aria-label',code); chip.textContent=flagForCurrency(code); frag.appendChild(chip); });
      cont.innerHTML=''; cont.appendChild(frag);
    }catch(e){ console.error(e); cont.innerHTML='<span class="form-alert">No se pudo cargar el stock de divisas.</span>'; }
  }

  /* ===== Recibo / impresión desde la ranura ===== */
  let lastReceipt={lines:[]};
  function prepareReceipt(_title, lines){ lastReceipt={lines}; }
  function printReceipt(){
    const slot=qs('#receipt-slot'); const rc=qs('#receipt-body'); const el=qs('#receipt-anim');
    if(!slot || !rc || !el) return;
    rc.innerHTML=(lastReceipt.lines||[]).map(l=>`<div>${l}</div>`).join('');
    slot.classList.add('active','show-receipt');
    after(2200, ()=> slot.classList.remove('show-receipt'));
  }

  /* ===== Retiro ===== */
  qs('#btn-retirar-cancelar')?.addEventListener('click', ()=> showScreen('menu'));
  qs('#btn-retirar-confirmar')?.addEventListener('click', ()=>{
    const tx=(qs('#transaction-number')?.value||'').trim();
    if(!tx){ showProcessing('Falta el número de transacción'); return after(700,()=>showScreen('transaction')); }
    currentOp='retiro';
    showProcessing('Procesando...');
    after(1200, ()=>{
      showProcessing('Retire su dinero…');
      animBillFromSlot();
      after(7000, ()=>{
        prepareReceipt('Retiro de Dinero',[
          `Operación: Retiro de Dinero`,
          `Transacción: ${tx}`,
          `Fecha: ${new Date().toLocaleString('es-PY')}`
        ]);
        showSuccess('Retirá tus billetes');
      });
    });
  });

  /* ===== Depósito dinero ===== */
  qs('#btn-depo-cancelar')?.addEventListener('click', ()=> showScreen('menu'));
  let pendingAmount=null;
  qs('#btn-depo-confirmar')?.addEventListener('click', ()=>{
    const tx=(qs('#deposit-tx')?.value||'').trim();
    if(!tx){ showProcessing('Falta el número de transacción'); return after(700,()=>showScreen('deposit')); }
    currentOp='deposito';
    showProcessing('Inserte su dinero…'); animBillFromSlot();
    after(7000, ()=>{
      const v=(Math.floor(Math.random()*18)+3)*100; pendingAmount='$ '+v.toLocaleString('es-PY');
      qs('#confirm-amount-text').textContent=`¿Desea confirmar el depósito por ${pendingAmount}?`;
      prepareReceipt('Depósito de Dinero',[
        `Operación: Depósito de Dinero`,
        `Transacción: ${tx}`,
        `Monto simulado: ${pendingAmount}`,
        `Fecha: ${new Date().toLocaleString('es-PY')}`
      ]);
      showScreen('confirm-amount');
    });
  });
  qs('#btn-amount-confirm')?.addEventListener('click', ()=>{
    showProcessing('Procesando...');
    after(1200, ()=> showSuccess('Depósito registrado.'));
  });
  qs('#btn-amount-cancel')?.addEventListener('click', ()=>{
    showProcessing('Procesando...');
    after(1200, ()=> showCancel('Operación cancelada','Recoja su dinero.'));
  });

  /* ===== Depósito cheque ===== */
  qs('#btn-cheque-cancelar')?.addEventListener('click', ()=> showScreen('menu'));
  qs('#btn-cheque-confirmar')?.addEventListener('click', ()=>{
    const tx=(qs('#check-tx')?.value||'').trim();
    if(!tx){ showProcessing('Falta el número de transacción'); return after(700,()=>showScreen('check')); }
    currentOp='cheque';
    showProcessing('Inserte su cheque…'); animCheckFromSlot();
    after(7000, ()=>{
      qs('#confirm-cheque-text').textContent=`¿Desea confirmar el depósito del cheque de la transacción ${tx}?`;
      prepareReceipt('Depósito de Cheque',[
        `Operación: Depósito de Cheque`,
        `Transacción: ${tx}`,
        `Fecha: ${new Date().toLocaleString('es-PY')}`
      ]);
      showScreen('confirm-cheque');
    });
  });
  qs('#btn-cheque-confirm2')?.addEventListener('click', ()=>{
    showProcessing('Procesando...');
    after(1200, ()=> showSuccess('Cheque depositado.'));
  });
  qs('#btn-cheque-cancel2')?.addEventListener('click', ()=>{
    showProcessing('Procesando...');
    after(1200, ()=> showCancel('Operación cancelada','Retire su cheque.'));
  });

  /* ===== Éxito / Cancelado ===== */
  qs('#btn-success-exit')?.addEventListener('click', ()=> { currentOp=null; showScreen('login'); });
  qs('#btn-success-print')?.addEventListener('click', printReceipt);
  qs('#btn-cancel-exit')?.addEventListener('click', ()=> { currentOp=null; showScreen('login'); });

  /* ===== Keypad 0-9 / a-f ===== */
  let lastFocusedInput=null;
  document.addEventListener('focusin', (e)=>{
    if(e.target instanceof HTMLInputElement && (e.target.type==='text' || e.target.type==='password')){
      lastFocusedInput = e.target;
    }
  }, true);

  function activeInput(){
    const ae=document.activeElement;
    if(ae instanceof HTMLInputElement && (ae.type==='text' || ae.type==='password')) return ae;
    if(lastFocusedInput && document.body.contains(lastFocusedInput)) return lastFocusedInput;
    const current = document.querySelector('.ted-screen-view.active');
    return current ? current.querySelector('input[type="text"], input[type="password"]') : null;
  }
  function insertChar(ch){
    const field = activeInput(); if(!field) return;
    const start = field.selectionStart ?? field.value.length;
    const end   = field.selectionEnd ?? field.value.length;
    field.value = field.value.slice(0,start) + ch + field.value.slice(end);
    const pos = start + ch.length;
    try{ field.setSelectionRange(pos,pos); }catch(_){}
    field.dispatchEvent(new Event('input',{bubbles:true}));
    field.focus();
  }
  const pad = document.querySelector('.ted-pad');
  pad?.addEventListener('mousedown', (e)=>{ if(e.target.closest('.ted-key')) e.preventDefault(); });
  pad?.addEventListener('click', (e)=>{
    const btn = e.target.closest('.ted-key'); if(!btn) return;
    const key = (btn.dataset.key || '').toString();
    if(/^[0-9a-f]$/.test(key)) insertChar(key);
  });
})();
</script>
{% endblock %}
