{% extends "base.html" %}
{% load static %}
{% block title %}Global Exchange{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/ted.css' %}"/>

<main style="max-width:1100px;margin:0 auto;padding:24px">
  <section class="ted-machine">
    <div class="ted-layout">
      <!-- Pantalla principal -->
      <div class="ted-layout-main">
        <div class="ted-screen">
          <div class="ted-screen-glow"></div>

          <div class="ted-screen-inner">
            <!-- Cabecera -->
            <header class="ted-header">
              <div class="logo-badge">
                <img class="ted-logo" src="{% static 'img/logo-secundario.png' %}" alt="Global Exchange">
              </div>
              <div class="welcome-badge" id="welcome-badge">ðŸ‘‹ Bienvenido</div>
              <h1 class="ted-title">GLOBAL EXCHANGE</h1>
            </header>

            <!-- Vistas -->
            <div class="ted-views-container">
              <!-- VISTA: Inicio -->
              <section id="login-screen" class="ted-screen-view active" aria-live="polite">
                <div class="view-content">
                  <p>Hola,
                    <strong>{% firstof request.user.get_full_name request.user.username request.user.email "Usuario" %}</strong>.
                  </p>

                  <div class="location-picker">
                    <label for="select-ubicacion" class="location-label">UbicaciÃ³n del TED</label>
                    <select id="select-ubicacion" class="ted-select" aria-required="true">
                      <option value="">â€” SeleccionÃ¡ una ubicaciÃ³n â€”</option>
                    </select>
                    <p class="location-hint">Este dato define el inventario a usar para este terminal.</p>
                  </div>

                  <button class="gx-btn" type="button" id="btn-login-ingresar" disabled>Continuar</button>
                </div>
              </section>

              <!-- VISTA: MenÃº -->
              <section id="menu-screen" class="ted-screen-view" aria-live="polite">
                <div class="view-content">
                  <h2 style="text-align:center;margin-bottom:12px">Operaciones disponibles</h2>
                  <div class="menu-grid">
                    <button id="btn-menu-retirar" type="button" class="menu-card" aria-label="Retiro de dinero">
                      <div class="menu-icon">ðŸ’µ</div>
                      <div class="menu-label">Retiro de Dinero</div>
                    </button>
                    <button id="btn-menu-deposito" type="button" class="menu-card" aria-label="DepÃ³sito de dinero">
                      <div class="menu-icon">ðŸ’°</div>
                      <div class="menu-label">DepÃ³sito de Dinero</div>
                    </button>
                  </div>
                  <div style="text-align:center;margin-top:16px">
                    <button id="btn-menu-salir" type="button" class="gx-btn gx-btn--ghost">ðŸšª Salir</button>
                  </div>
                </div>
              </section>

              <!-- VISTA: Retiro -->
              <section id="transaction-screen" class="ted-screen-view" aria-live="polite">
                <div class="view-content">
                  <h3>Retiro de Dinero</h3>
                  <label for="transaction-number">Ingrese nÃºmero de transacciÃ³n</label>
                  <input id="transaction-number" type="text" class="ted-input" placeholder="NÃºmero de transacciÃ³n"/>

                  <div class="currency-section">
                    <div class="currency-label">Divisas disponibles</div>
                    <div id="retiro-currency-list" class="currency-list"></div>
                  </div>

                  <div class="button-group">
                    <button class="gx-btn gx-btn--ghost" type="button" id="btn-retirar-cancelar">Cancelar</button>
                    <button class="gx-btn" type="button" id="btn-retirar-confirmar">Confirmar</button>
                  </div>
                </div>
              </section>

              <!-- VISTA: DepÃ³sito -->
              <section id="deposit-screen" class="ted-screen-view" aria-live="polite">
                <div class="view-content">
                  <h3>DepÃ³sito de Dinero</h3>
                  <label for="deposit-tx">Ingrese nÃºmero de transacciÃ³n</label>
                  <input id="deposit-tx" type="text" class="ted-input" placeholder="NÃºmero de transacciÃ³n"/>
                  <div class="button-group">
                    <button class="gx-btn gx-btn--ghost" type="button" id="btn-depo-cancelar">Cancelar</button>
                    <button class="gx-btn" type="button" id="btn-depo-confirmar">Confirmar</button>
                  </div>
                </div>
              </section>

              <!-- VISTA: Procesando -->
              <section id="processing-screen" class="ted-screen-view" aria-live="polite">
                <div class="view-content view-content--centered">
                  <div class="processing-text">
                    <span id="processing-message">Procesando</span><span class="processing-dots"></span>
                  </div>
                </div>
              </section>

              <!-- VISTA: ConfirmaciÃ³n de monto -->
              <section id="confirm-amount-screen" class="ted-screen-view" aria-live="polite">
                <div class="view-content view-content--centered">
                  <div class="confirm-title">ConfirmaciÃ³n</div>
                  <div id="confirm-amount-text" class="confirm-text">Â¿Desea confirmar el depÃ³sito?</div>
                  <div class="button-group">
                    <button class="gx-btn gx-btn--ghost" type="button" id="btn-amount-cancel">Cancelar</button>
                    <button class="gx-btn" type="button" id="btn-amount-confirm">Confirmar</button>
                  </div>
                </div>
              </section>

              <!-- VISTA: Ã‰xito -->
              <section id="success-screen" class="ted-screen-view" aria-live="polite">
                <div class="view-content view-content--centered">
                  <div class="status-title status-title--success">Â¡OperaciÃ³n exitosa!</div>
                  <div id="success-message" class="status-message">Listo.</div>
                  <div class="button-group">
                    <button class="gx-btn gx-btn--ghost" type="button" id="btn-success-exit">Salir</button>
                    <button class="gx-btn" type="button" id="btn-success-print">Imprimir ticket</button>
                  </div>
                </div>
              </section>

              <!-- VISTA: Cancelado -->
              <section id="cancel-screen" class="ted-screen-view" aria-live="polite">
                <div class="view-content view-content--centered">
                  <div class="status-title status-title--cancel">OperaciÃ³n cancelada</div>
                  <div id="cancel-sub" class="status-message">Recoja su dinero.</div>
                  <button class="gx-btn gx-btn--ghost" type="button" id="btn-cancel-exit">Salir</button>
                </div>
              </section>
            </div><!-- /ted-views-container -->
          </div>
        </div>
      </div>

      <!-- Panel lateral (reloj + teclado) -->
      <aside class="ted-layout-aside">
        <div class="pad-info-card">
          <div class="clock" id="ted-clock">--:--:--</div>
          <div class="info-line">NÂº de serie: <strong id="info-serie">â€”</strong></div>
          <div class="info-line">UbicaciÃ³n: <strong id="info-ubicacion">â€”</strong></div>
        </div>

        <div class="pad-bezel">
          <div class="ted-pad" aria-label="Teclado">
            <div class="grid">
              {% for key in "123a456b789c0def" %}
              <button class="ted-key" type="button" data-key="{{ key }}">{{ key }}</button>
              {% endfor %}
            </div>
          </div>
        </div>
      </aside>
    </div>

    <!-- Ranuras mejoradas -->
    <div class="slots-container">
      <div id="bill-slot" class="ted-slot">
        <div class="slot-opening"></div>
        <div class="slot-indicator"></div>
        <div class="bill-stack">
          <div class="bill-item" style="animation-delay:0s">$100</div>
          <div class="bill-item" style="animation-delay:0.15s">$100</div>
          <div class="bill-item" style="animation-delay:0.3s">$100</div>
          <div class="bill-item" style="animation-delay:0.45s">$100</div>
        </div>
        <div class="slot-label">Ranura de billetes</div>
      </div>

      <div id="receipt-slot" class="ted-slot">
        <div class="slot-opening"></div>
        <div class="slot-indicator"></div>
        <div class="receipt-anim">
          <div class="receipt-paper">
            <div class="receipt-header">GLOBAL EXCHANGE</div>
            <div id="receipt-body"></div>
          </div>
        </div>
        <div class="slot-label">Salida de tickets</div>
      </div>
    </div>
  </section>
</main>

<script>
(function(){
  const qs=(s,c=document)=>c.querySelector(s);
  const qsa=(s,c=document)=>Array.from(c.querySelectorAll(s));
  const after=(ms,fn)=>setTimeout(fn,ms);

  /* Reloj */
  function startClock(){
    const el=qs('#ted-clock'); if(!el) return;
    const fmt=new Intl.DateTimeFormat('es-PY',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
    const tick=()=>{ el.textContent=fmt.format(new Date()); };
    tick(); setInterval(tick,1000);
  }

  /* Pantallas */
  function showScreen(name){
    qsa('.ted-screen-view').forEach(v=>v.classList.remove('active'));
    const screen = qs('#'+name+'-screen');
    if(screen) screen.classList.add('active');
    qsa('.ted-slot').forEach(s=>s.classList.remove('active','dispensing-bills','printing-receipt','inserting-bills'));
    
    // Mostrar/ocultar badge de bienvenida y ajustar header
    const welcomeBadge = qs('#welcome-badge');
    const header = qs('.ted-header');
    if(welcomeBadge){
      if(name === 'login'){
        welcomeBadge.classList.remove('hidden');
        if(header) header.classList.remove('compact');
      } else {
        welcomeBadge.classList.add('hidden');
        if(header) header.classList.add('compact');
      }
    }
  }
  function showProcessing(msg){ 
    const msgEl = qs('#processing-message');
    if(msgEl) msgEl.textContent=msg; 
    showScreen('processing'); 
  }

  /* Slots */
  function dispenseBills(){ 
    const slot=qs('#bill-slot'); 
    if(!slot) return; 
    slot.classList.add('active','dispensing-bills'); 
    after(2500,()=>slot.classList.remove('dispensing-bills')); 
  }
  function insertBills(){ 
    const slot=qs('#bill-slot'); 
    if(!slot) return; 
    slot.classList.add('active','inserting-bills'); 
    after(3000,()=>slot.classList.remove('inserting-bills')); 
  }

  /* Ticket */
  let lastReceipt={lines:[]};
  function prepareReceipt(_t,lines){ lastReceipt={lines}; }
  function printReceipt(){
    const slot=qs('#receipt-slot'), rc=qs('#receipt-body'); 
    if(!slot||!rc) return;
    rc.innerHTML='';
    (lastReceipt.lines||[]).forEach((line,i)=>{
      const d=document.createElement('div');
      d.className='receipt-line';
      d.textContent=line;
      d.style.animationDelay=(i*0.15)+'s';
      rc.appendChild(d);
    });
    slot.classList.add('active','printing-receipt');
    after(3800,()=>slot.classList.remove('printing-receipt'));
  }

  /* UbicaciÃ³n seleccionada */
  const SELECT = qs('#select-ubicacion');
  let ubicacionSeleccionada = "";
  
  // Intentar recuperar de memoria en vez de localStorage
  try {
    const stored = sessionStorage.getItem('ted_ubicacion');
    if(stored) ubicacionSeleccionada = stored;
  } catch(e) {
    // Si sessionStorage falla, usar variable en memoria
  }

  async function cargarUbicaciones(){
    try{
      const res = await fetch("{% url 'admin_panel:ted:ubicaciones_disponibles' %}", {credentials:'same-origin'});
      if(!res.ok) throw new Error('HTTP '+res.status);
      const data = await res.json();

      if(SELECT){
        SELECT.innerHTML = '<option value="">â€” SeleccionÃ¡ una ubicaciÃ³n â€”</option>';
        (data.ubicaciones || []).forEach(u=>{
          const opt=document.createElement('option');
          opt.value=u; opt.textContent=u;
          if (u===ubicacionSeleccionada) opt.selected=true;
          SELECT.appendChild(opt);
        });
      }

      const btnLogin = qs('#btn-login-ingresar');
      if(btnLogin) btnLogin.disabled = !ubicacionSeleccionada;
    }catch(_e){}
  }

  function activarUbicacion(ubic){
    ubicacionSeleccionada = ubic;
    try {
      sessionStorage.setItem('ted_ubicacion', ubicacionSeleccionada);
    } catch(e) {
      // Si falla, solo usar variable en memoria
    }
    const infoUbic = qs('#info-ubicacion');
    const infoSerie = qs('#info-serie');
    if(infoUbic) infoUbic.textContent = ubicacionSeleccionada || 'â€”';
    if(infoSerie) infoSerie.textContent = ubicacionSeleccionada ? 'TED-AGSL-0001' : 'â€”';
  }

  SELECT?.addEventListener('change', e=>{
    const val = e.target.value || "";
    const btnLogin = qs('#btn-login-ingresar');
    if(btnLogin) btnLogin.disabled = !val;
  });

  /* Monedas por ubicaciÃ³n (para Retiro) */
  const FLAGS={USD:'ðŸ‡ºðŸ‡¸',EUR:'ðŸ‡ªðŸ‡º',ARS:'ðŸ‡¦ðŸ‡·',BRL:'ðŸ‡§ðŸ‡·',PYG:'ðŸ‡µðŸ‡¾',CNY:'ðŸ‡¨ðŸ‡³',JPY:'ðŸ‡¯ðŸ‡µ',GBP:'ðŸ‡¬ðŸ‡§',UYU:'ðŸ‡ºðŸ‡¾',CLP:'ðŸ‡¨ðŸ‡±',COP:'ðŸ‡¨ðŸ‡´',BOB:'ðŸ‡§ðŸ‡´',PEN:'ðŸ‡µðŸ‡ª',MXN:'ðŸ‡²ðŸ‡½',CAD:'ðŸ‡¨ðŸ‡¦',AUD:'ðŸ‡¦ðŸ‡º',CHF:'ðŸ‡¨ðŸ‡­',VES:'ðŸ‡»ðŸ‡ª',VEF:'ðŸ‡»ðŸ‡ª',RUB:'ðŸ‡·ðŸ‡º',ILS:'ðŸ‡®ðŸ‡±',CRC:'ðŸ‡¨ðŸ‡·',DOP:'ðŸ‡©ðŸ‡´',NOK:'ðŸ‡³ðŸ‡´',SEK:'ðŸ‡¸ðŸ‡ª',DKK:'ðŸ‡©ðŸ‡°',ZAR:'ðŸ‡¿ðŸ‡¦',HNL:'ðŸ‡­ðŸ‡³',GTQ:'ðŸ‡¬ðŸ‡¹',PAB:'ðŸ‡µðŸ‡¦',NIO:'ðŸ‡³ðŸ‡®',TRY:'ðŸ‡¹ðŸ‡·',INR:'ðŸ‡®ðŸ‡³',KRW:'ðŸ‡°ðŸ‡·',SGD:'ðŸ‡¸ðŸ‡¬',HKD:'ðŸ‡­ðŸ‡°'};
  const flag = c => FLAGS[c] || c;

  async function loadRetiroCurrencies(){
    const cont = qs('#retiro-currency-list'); 
    if(!cont) return;
    cont.textContent = 'Cargando...';
    try{
      const q = ubicacionSeleccionada ? ('?ubicacion=' + encodeURIComponent(ubicacionSeleccionada)) : '';
      const res = await fetch("{% url 'admin_panel:ted:monedas_disponibles' %}"+q, {credentials:'same-origin'});
      if(!res.ok) throw new Error('HTTP '+res.status);
      const data = await res.json();
      const monedas = Array.isArray(data.monedas) ? data.monedas : [];
      cont.innerHTML = '';
      if(!monedas.length){ 
        cont.textContent='Sin divisas disponibles.'; 
        return; 
      }
      monedas.forEach(code=>{
        const chip=document.createElement('span');
        chip.className='currency-chip';
        chip.title=code;
        chip.textContent=flag(code);
        cont.appendChild(chip);
      });
    }catch(e){
      cont.textContent='No se pudo cargar.';
    }
  }

  /* NavegaciÃ³n */
  document.addEventListener('DOMContentLoaded',()=>{
    startClock();
    // Placeholders forzados al inicio
    const infoSerie = qs('#info-serie');
    const infoUbic = qs('#info-ubicacion');
    if(infoSerie) infoSerie.textContent = 'â€”';
    if(infoUbic) infoUbic.textContent = 'â€”';
    cargarUbicaciones();
    showScreen('login');
  });

  qs('#btn-login-ingresar')?.addEventListener('click',()=>{
    const val = SELECT?.value || ubicacionSeleccionada || "";
    if(!val) return;
    activarUbicacion(val);
    showProcessing('Preparando terminal');
    after(800,()=>showScreen('menu'));
  });

  qs('#btn-menu-retirar')?.addEventListener('click',()=>{ 
    showScreen('transaction'); 
    loadRetiroCurrencies(); 
  });
  qs('#btn-menu-deposito')?.addEventListener('click',()=>{ showScreen('deposit'); });
  qs('#btn-menu-salir')?.addEventListener('click',()=>{ showScreen('login'); });

  /* Retiro */
  qs('#btn-retirar-cancelar')?.addEventListener('click',()=>{ showScreen('menu'); });
  qs('#btn-retirar-confirmar')?.addEventListener('click',()=>{
    const txInput = qs('#transaction-number');
    const tx = (txInput?.value||'').trim();
    if(!tx){ 
      showProcessing('Falta el nÃºmero de transacciÃ³n'); 
      return after(800,()=>showScreen('transaction')); 
    }
    showProcessing('Dispensando billetes');
    dispenseBills();
    after(2800,()=>{
      prepareReceipt('Retiro de Dinero',[
        `OperaciÃ³n: Retiro de Dinero`,
        `TransacciÃ³n: ${tx}`,
        `UbicaciÃ³n: ${ubicacionSeleccionada||'â€”'}`,
        `Monto: $400.00`,
        `Fecha: ${new Date().toLocaleString('es-PY')}`,
        `Estado: COMPLETADO`
      ]);
      showScreen('success');
      const successMsg = qs('#success-message');
      if(successMsg) successMsg.textContent='RetirÃ¡ tus billetes';
    });
  });

  /* DepÃ³sito */
  qs('#btn-depo-cancelar')?.addEventListener('click',()=>{ showScreen('menu'); });
  qs('#btn-depo-confirmar')?.addEventListener('click',()=>{
    const txInput = qs('#deposit-tx');
    const tx = (txInput?.value||'').trim();
    if(!tx){ 
      showProcessing('Falta el nÃºmero de transacciÃ³n'); 
      return after(800,()=>showScreen('deposit')); 
    }
    showProcessing('Esperando inserciÃ³n de billetes');
    insertBills();
    after(3300,()=>{
      const v=(Math.floor(Math.random()*18)+3)*100;
      const confirmText = qs('#confirm-amount-text');
      if(confirmText) confirmText.textContent=`Â¿Desea confirmar el depÃ³sito por $ ${v.toLocaleString('es-PY')}?`;
      showScreen('confirm-amount');
    });
  });
  qs('#btn-amount-confirm')?.addEventListener('click',()=>{ 
    showProcessing('Confirmando'); 
    after(1400,()=>{ 
      showScreen('success'); 
      const successMsg = qs('#success-message');
      if(successMsg) successMsg.textContent='DepÃ³sito registrado correctamente'; 
    }); 
  });
  qs('#btn-amount-cancel')?.addEventListener('click',()=>{ 
    showProcessing('Cancelando'); 
    after(1000,()=>{ showScreen('cancel'); }); 
  });

  /* Salir de cancel */
  qs('#btn-cancel-exit')?.addEventListener('click',()=>{ showScreen('login'); });

  /* Ã‰xito / impresiÃ³n */
  qs('#btn-success-exit')?.addEventListener('click',()=>{ showScreen('login'); });
  qs('#btn-success-print')?.addEventListener('click', printReceipt);

  /* Teclado on-screen */
  function activeInput(){
    const a=document.activeElement;
    if(a && a.tagName==='INPUT') return a;
    return qs('.ted-screen-view.active input');
  }
  function insertChar(ch){
    const f=activeInput(); 
    if(!f) return;
    const s=f.selectionStart??f.value.length, e=f.selectionEnd??f.value.length;
    f.value=f.value.slice(0,s)+ch+f.value.slice(e);
    const p=s+String(ch).length; 
    f.setSelectionRange(p,p); 
    f.focus();
  }
  qsa('.ted-key').forEach(b=>b.addEventListener('click',()=>insertChar(b.dataset.key||'')));
})();
</script>
{% endblock %}