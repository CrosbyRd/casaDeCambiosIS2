{% extends "base.html" %}
{% load static %}
{% block title %}Global Exchange{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/ted.css' %}"/>

<!-- Estilos m√≠nimos SOLO para el bloque de confirmaci√≥n -->
<style>
  .confirm-box{
    display:none;
    margin:18px auto 8px auto;
    max-width:640px;
    background:linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.03));
    border:1.5px solid rgba(255,255,255,0.16);
    border-radius:18px;
    padding:18px 20px;
    box-shadow:0 6px 20px rgba(0,0,0,0.25) inset, 0 10px 30px rgba(0,0,0,0.10);
  }
  .confirm-box .cb-top{
    display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:6px;
  }
  .confirm-box .cb-chip{
    display:inline-flex; align-items:center; gap:8px;
    padding:6px 10px; border-radius:999px;
    background:rgba(255,255,255,0.10); border:1px solid rgba(255,255,255,0.18);
    font-weight:700; letter-spacing:.3px;
  }
  .confirm-box .cb-flag{ font-size:18px; line-height:1; }
  .confirm-box .cb-code{ opacity:.95 }
  .confirm-box .cb-mode{ font-size:14px; opacity:.85 }
  .confirm-box .cb-value{
    font-weight:900; line-height:1.15; letter-spacing:.2px;
    font-size:36px; margin:6px 0 2px 0;
    text-shadow:0 1px 0 rgba(0,0,0,0.35);
  }
  .confirm-box .cb-value .cb-code{
    font-size:18px; font-weight:800; margin-left:6px; opacity:.9;
  }
  .confirm-box .cb-sub{
    margin-top:6px; font-size:14px; opacity:.9;
  }
  #confirm-amount-text.hidden { display:none !important; }
</style>

<style>
/* ===== Variantes de t√≠tulo "Confirmaci√≥n" (elige UNA en el HTML) ===== */
.confirm-title { text-align:center; margin:0 0 10px; }

/* Opci√≥n 2: Texto con gradiente + subrayado brillante */
.confirm-title--gradient{
  display:inline-block; margin:auto; font-weight:900; letter-spacing:.3px;
  font-size:22px;
  background:linear-gradient(90deg,#c4b5fd,#a78bfa,#c4b5fd);
  -webkit-background-clip:text; background-clip:text; color:transparent;
  position:relative; text-transform:uppercase;
}
.confirm-title--gradient::after{
  content:""; display:block; width:120px; height:3px; margin:8px auto 0;
  background:linear-gradient(90deg, transparent, #a78bfa, transparent);
  border-radius:99px; box-shadow:0 0 16px rgba(167,139,250,.6);
}

/* === Estados visuales de chips de divisa === */
.currency-chip.match{
  outline:2px solid rgba(124,58,237,.45);
  box-shadow:0 0 0 3px rgba(124,58,237,.18), 0 8px 18px rgba(0,0,0,.22);
  transform:translateY(-1px);
}
.currency-chip.dimmed{
  opacity:.45;
  filter:grayscale(.2);
}
</style>

<main style="max-width:1100px;margin:0 auto;padding:24px">
  <section class="ted-machine">
    <div class="ted-layout">
      <!-- Pantalla principal -->
      <div class="ted-layout-main">
        <div class="ted-screen">
          <div class="ted-screen-glow"></div>

          <div class="ted-screen-inner">
            <!-- Cabecera -->
            <header class="ted-header">
              <div class="logo-badge">
                <img class="ted-logo" src="{% static 'img/logo-secundario.png' %}" alt="Global Exchange">
              </div>
              <div class="welcome-badge" id="welcome-badge">üëã Bienvenido</div>
              <h1 class="ted-title">GLOBAL EXCHANGE</h1>
            </header>

            <!-- Vistas -->
            <div class="ted-views-container">
              <!-- VISTA: Inicio -->
              <section id="login-screen" class="ted-screen-view active" aria-live="polite">
                <div class="view-content">
                  <p>Hola,
                    <strong>{% firstof request.user.get_full_name request.user.username request.user.email "Usuario" %}</strong>.
                  </p>

                  <div class="location-picker">
                    <label for="select-ubicacion" class="location-label">Ubicaci√≥n del TED</label>
                    <select id="select-ubicacion" class="ted-select" aria-required="true">
                      <option value="">‚Äî Seleccion√° una sucursal ‚Äî</option>
                      <!-- Si ya renderizas ubicaciones desde el server, mantienen este select -->
                    </select>
                    <p class="location-hint">Tras elegir la sucursal, ingres√° el c√≥digo de la operaci√≥n.</p>
                  </div>

                  <button class="gx-btn" type="button" id="btn-login-ingresar" disabled>Continuar</button>
                </div>
              </section>

              <!-- VISTA: Retiro / Dep√≥sito (ingreso c√≥digo) -->
              <section id="transaction-screen" class="ted-screen-view" aria-live="polite">
                <div class="view-content">
                  <h3 id="tx-title">Operaci√≥n</h3>
                  <label for="transaction-number">Ingrese el c√≥digo de operaci√≥n</label>
                  <input id="transaction-number" type="text" class="ted-input" placeholder="C√≥digo de operaci√≥n" autocomplete="off" data-kb="num" />
                  
                  <!-- Divisas disponibles (solo para RETIRO) -->
                  <div id="retiro-currencies" class="currency-section" style="display:none">
                    <div class="currency-label">Divisas disponibles</div>
                    <div id="retiro-currency-list" class="currency-list" aria-live="polite">
                    </div>
                  </div>

                  <div class="button-group">
                    <button class="gx-btn gx-btn--ghost" type="button" id="btn-tx-cancelar">Cancelar</button>
                    <button class="gx-btn" type="button" id="btn-tx-validar">Validar</button>
                  </div>
                </div>
              </section>

              <!-- VISTA: Confirmaci√≥n de monto -->
              <section id="confirm-amount-screen" class="ted-screen-view" aria-live="polite">
                <div class="view-content view-content--centered">
                  <div class="confirm-title">
                    <span class="confirm-title--gradient">Confirmaci√≥n</span>
                  </div>

                  <!-- NUEVO bloque visual -->
                  <div id="confirm-amount-box" class="confirm-box" aria-live="polite"></div>

                  <!-- Fallback de texto plano (se ocultar√° si hay box) -->
                  <div id="confirm-amount-text" class="confirm-text">¬øDesea confirmar la operaci√≥n?</div>

                  <div class="button-group">
                    <button class="gx-btn gx-btn--ghost" type="button" id="btn-amount-cancel">Cancelar</button>
                    <button class="gx-btn" type="button" id="btn-amount-confirm">Continuar</button>
                  </div>
                </div>
              </section>

              <!-- VISTA: OTP -->
              <section id="otp-screen" class="ted-screen-view" aria-live="polite">
                <div class="view-content view-content--centered">
                  <h3 class="status-title">Verificaci√≥n</h3>
                  <p class="status-message">Ingres√° el c√≥digo de verificaci√≥n enviado a tu correo.</p>
                  <div id="otp-summary" class="status-message" style="margin:8px 0 14px 0"></div>
                  <input id="otp-input" type="text" class="ted-input" inputmode="numeric" maxlength="6" placeholder="C√≥digo OTP (6 d√≠gitos)" data-kb="num" />                  <div class="button-group">
                    <button class="gx-btn gx-btn--ghost" type="button" id="btn-otp-back">Volver</button>
                    <button class="gx-btn" type="button" id="btn-otp-confirm">Confirmar</button>
                  </div>
                </div>
              </section>

              <!-- VISTA: Procesando -->
              <section id="processing-screen" class="ted-screen-view" aria-live="polite">
                <div class="view-content view-content--centered">
                  <div class="processing-text">
                    <span id="processing-message">Procesando</span><span class="processing-dots"></span>
                  </div>
                </div>
              </section>

              <!-- VISTA: √âxito -->
              <section id="success-screen" class="ted-screen-view" aria-live="polite">
                <div class="view-content view-content--centered">
                  <div class="status-title status-title--success">¬°Operaci√≥n exitosa!</div>
                  <!-- Tarjeta de resultado -->
                  <div id="success-amount-box" class="result-box" aria-live="polite"></div>
                  <div id="success-message" class="status-message">Listo.</div>
                  <div class="button-group">
                    <button class="gx-btn gx-btn--ghost" type="button" id="btn-success-exit">Salir</button>
                    <button class="gx-btn" type="button" id="btn-success-print">Imprimir ticket</button>
                  </div>
                </div>
              </section>

              <!-- VISTA: Cancelado / Error -->
              <section id="cancel-screen" class="ted-screen-view" aria-live="polite">
                <div class="view-content view-content--centered">
                  <div class="status-title status-title--cancel">Operaci√≥n cancelada</div>
                  <div id="cancel-sub" class="status-message">Recoja su dinero.</div>
                  <button class="gx-btn gx-btn--ghost" type="button" id="btn-cancel-exit">Salir</button>
                </div>
              </section>
            </div><!-- /ted-views-container -->
          </div>
        </div>
      </div>

      <!-- Panel lateral (reloj + teclado) -->
      <aside class="ted-layout-aside">
        <div class="pad-info-card">
          <div class="clock" id="ted-clock">--:--:--</div>
          <div class="info-line">N¬∫ de serie: <strong id="info-serie">‚Äî</strong></div>
          <div class="info-line">Ubicaci√≥n: <strong id="info-ubicacion">‚Äî</strong></div>
        </div>

        <div class="pad-bezel">
          <div class="ted-pad" aria-label="Teclado">

            <!-- Estilos espec√≠ficos SOLO del teclado -->
            <style>
              /* 4 columnas x 5 filas como en la imagen */
              .ted-pad .grid{
                display:grid;
                grid-template-columns:repeat(4,minmax(0,1fr));
                gap:12px;
              }
              /* Variantes de estilo para las teclas de acci√≥n de la √∫ltima fila */
              .ted-key--ghost{
                background:linear-gradient(180deg,rgba(255,255,255,.10),rgba(255,255,255,.06));
                border-color:rgba(255,255,255,.25);
              }
              .ted-key--danger{
                background:linear-gradient(180deg, rgba(239,68,68,0.25), rgba(239,68,68,0.12));
                border-color:rgba(239,68,68,.45);
                box-shadow:0 12px 24px -10px rgba(239,68,68,.25), inset 0 0 0 1px rgba(255,255,255,.06);
              }
              .ted-key--primary{
                background:linear-gradient(180deg, color-mix(in oklab, var(--brand) 30%, #0000), color-mix(in oklab, var(--brand) 15%, #0000));
                border-color:color-mix(in oklab, var(--brand) 50%, #0000);
                box-shadow:0 12px 24px -10px rgba(124,58,237,.35), inset 0 0 0 1px rgba(255,255,255,.06);
              }
              .ted-key .k-sub{
                display:block; font-size:12px; opacity:.9; margin-top:2px; font-weight:700;
              }
            </style>

            <div class="grid">
              <!-- Fila 1 -->
              <button class="ted-key" type="button" data-key="1">1</button>
              <button class="ted-key" type="button" data-key="2">2</button>
              <button class="ted-key" type="button" data-key="3">3</button>
              <button class="ted-key" type="button" data-key="a">a</button>

              <!-- Fila 2 -->
              <button class="ted-key" type="button" data-key="4">4</button>
              <button class="ted-key" type="button" data-key="5">5</button>
              <button class="ted-key" type="button" data-key="6">6</button>
              <button class="ted-key" type="button" data-key="b">b</button>

              <!-- Fila 3 -->
              <button class="ted-key" type="button" data-key="7">7</button>
              <button class="ted-key" type="button" data-key="8">8</button>
              <button class="ted-key" type="button" data-key="9">9</button>
              <button class="ted-key" type="button" data-key="c">c</button>

              <!-- Fila 4 -->
              <button class="ted-key" type="button" data-key="0">0</button>
              <button class="ted-key" type="button" data-key="d">d</button>
              <button class="ted-key" type="button" data-key="e">e</button>
              <button class="ted-key" type="button" data-key="f">f</button>

              <!-- Fila 5 (acciones) -->
              <button class="ted-key ted-key--ghost"  type="button" data-key="minus">‚àí<span class="k-sub"></span></button>
              <button class="ted-key"                type="button" data-key="backspace"><span class="k-sub">Borrar</span></button>
              <button class="ted-key ted-key--danger" type="button" data-key="clear"><span class="k-sub">Cancelar</span></button>
              <button class="ted-key ted-key--primary" type="button" data-key="confirm"><span class="k-sub">Continuar</span></button>
            </div>
          </div>
        </div>
      </aside>
    </div>

    <!-- Ranuras -->
    <div class="slots-container">
      <div id="bill-slot" class="ted-slot">
        <div class="slot-opening"></div>
        <div class="slot-indicator"></div>
        <div class="bill-stack">
          <div class="bill-item" style="animation-delay:0s">$100</div>
          <div class="bill-item" style="animation-delay:0.15s">$100</div>
          <div class="bill-item" style="animation-delay:0.3s">$100</div>
          <div class="bill-item" style="animation-delay:0.45s">$100</div>
        </div>
        <div class="slot-label">Ranura de billetes</div>
      </div>

      <div id="receipt-slot" class="ted-slot">
        <div class="slot-opening"></div>
        <div class="slot-indicator"></div>
        <div class="receipt-anim">
          <div class="receipt-paper">
            <div class="receipt-header">GLOBAL EXCHANGE</div>
            <div id="receipt-body"></div>
          </div>
        </div>
        <div class="slot-label">Salida de tickets</div>
      </div>
    </div>
  </section>
</main>

<script>
  // Si quer√©s limpiar tambi√©n cuando cambi√°s de modo u operaci√≥n:
  function resetCodigo() {
    const $code = document.getElementById("transaction-number");
    if ($code) $code.value = "";
  }
(() => {
  const qs = (sel, el=document) => el.querySelector(sel);
  const qsa = (sel, el=document) => [...el.querySelectorAll(sel)];
  const FLAGS = {
    USD:'üá∫üá∏', EUR:'üá™üá∫', ARS:'üá¶üá∑', BRL:'üáßüá∑', PYG:'üáµüáæ', CNY:'üá®üá≥', JPY:'üáØüáµ',
    GBP:'üá¨üáß', UYU:'üá∫üáæ', CLP:'üá®üá±', COP:'üá®üá¥', BOB:'üáßüá¥', PEN:'üáµüá™', MXN:'üá≤üáΩ',
    CAD:'üá®üá¶', AUD:'üá¶üá∫', CHF:'üá®üá≠', VES:'üáªüá™', VEF:'üáªüá™', RUB:'üá∑üá∫', ILS:'üáÆüá±',
    CRC:'üá®üá∑', DOP:'üá©üá¥', NOK:'üá≥üá¥', SEK:'üá∏üá™', DKK:'üá©üá∞', ZAR:'üáøüá¶', HNL:'üá≠üá≥',
    GTQ:'üá¨üáπ', PAB:'üáµüá¶', NIO:'üá≥üáÆ', TRY:'üáπüá∑', INR:'üáÆüá≥', KRW:'üá∞üá∑', SGD:'üá∏üá¨', HKD:'üá≠üá∞'
  };
  const flag = (code) => FLAGS[String(code||'').toUpperCase()] || 'üè≥Ô∏è';
  const formatAmountRaw = (a) => {
    try{ const n = Number(a); if(Number.isFinite(n)) return n.toLocaleString('es-PY',{maximumFractionDigits:0}); }
    catch(e){}
    return String(a);
  };
  const formatAmount = (a, code)=> `${formatAmountRaw(a)} ${code}`;

  const ctx = { modo:null, lastModo:null, code:null, ubicacion:null, raw:null, reserva_id:null, ticket_url:null, tx_id:null };

  // === CSRF ===
  function getCookie(name){
    const m = document.cookie.match(new RegExp('(^|; )'+name+'=([^;]+)'));
    return m ? decodeURIComponent(m[2]) : null;
  }
  const CSRF = getCookie('csrftoken');

  async function api(url, body){
    const isPost = !!body;
    const res = await fetch(url, {
      method: isPost ? 'POST' : 'GET',
      credentials:'same-origin',
      headers: isPost ? {'Content-Type':'application/json','X-CSRFToken': CSRF || ''} : {}
      , body: isPost ? JSON.stringify(body||{}) : undefined
    });
    const ct = res.headers.get('content-type') || '';
    let payload = null;
    if(ct.includes('application/json')){
      try{ payload = await res.json(); }catch(_){ payload = null; }
    }else{
      const text = await res.text().catch(()=> '');
      payload = { ok:false, error: text };
    }
    const notOk = !res.ok || (payload && payload.ok === false);
    if(notOk){
      let msg = (payload && (payload.error || payload.detail)) || res.statusText || 'Error';
      if(res.status===403 && (!ct || !ct.includes('application/json'))){
        msg = 'Protecci√≥n CSRF: falta o es inv√°lida. Refresque la p√°gina e intente de nuevo.';
      }
      const err = new Error(msg);
      err.status  = res.status || 0;
      err.payload = payload;
      throw err;
    }
    return (payload && payload.data) || payload;
  }

  // üëâ Helper para POST "form" (HTML) que puede redirigir; no esperamos JSON
  async function postForm(url, formDataObj){
    const form = new URLSearchParams();
    Object.entries(formDataObj||{}).forEach(([k,v])=> form.append(k, v==null?'':String(v)));
    const res = await fetch(url, {
      method:'POST',
      credentials:'same-origin',
      headers:{'Content-Type':'application/x-www-form-urlencoded; charset=UTF-8','X-CSRFToken': CSRF || ''},
      body: form.toString(),
      redirect:'follow'
    });
    // Consideramos 2xx/3xx como √©xito; no parseamos cuerpo
    if(!res.ok && (res.status<300 || res.status>=400)){
      const t = await res.text().catch(()=> '');
      const e = new Error(t || 'Fallo activando cliente');
      e.status = res.status;
      throw e;
    }
    return true;
  }

  const URLS = {
    validar: "{% url 'usuarios:ted_api_validar' %}",
    precontar: "{% url 'usuarios:ted_api_precontar' %}",
    otp_enviar: "{% url 'usuarios:ted_api_otp_enviar' %}",
    otp_verificar: "{% url 'usuarios:ted_api_otp_verificar' %}",
    confirmar: "{% url 'usuarios:ted_api_confirmar' %}",
    ubicaciones: "{% url 'usuarios:ted_api_ubicaciones' %}",
    terminal: "{% url 'usuarios:ted_api_terminal' %}",
    divisas: "{% url 'ted:monedas_disponibles' %}",
    // üÜï endpoint HTML que setea el cliente activo en la sesi√≥n
    set_cliente: "{% url 'usuarios:seleccionar_cliente' %}"
  };

  /* Carga y pinta las divisas disponibles para RETIRO (seg√∫n sucursal) */
  async function loadRetiroCurrencies(){
    const cont = qs('#retiro-currencies');
    const list = qs('#retiro-currency-list');
    if(!cont || !list) return;

    if (ctx.modo !== 'retiro' || !ctx.raw) {
      list.innerHTML = '';
      cont.style.display = 'none';
      cont.setAttribute('aria-hidden','true');
      return;
    }

    try{
      const data = await api(`${URLS.divisas}?ubicacion=${encodeURIComponent(ctx.ubicacion||'')}`);
      const currencies = (data && (data.currencies || data.monedas)) || [];

      if(currencies.length === 0){
        list.innerHTML = '<span style="opacity:.8">Sin stock disponible.</span>';
      }else{
        list.innerHTML = currencies.map(c =>
          `<span class="currency-chip" data-cur="${c}" title="${c}">${flag(c)}</span>`
        ).join('');
      }
      cont.style.display = 'block';
      cont.setAttribute('aria-hidden','false');
    }catch(_e){
      if (ctx.modo === 'retiro' && ctx.raw) {
        list.innerHTML = '<span style="opacity:.8">No se pudo cargar el stock.</span>';
        cont.style.display = 'block';
        cont.setAttribute('aria-hidden','false');
      } else {
        list.innerHTML = '';
        cont.style.display = 'none';
        cont.setAttribute('aria-hidden','true');
      }
    }
  }

  /* show() + control del ‚ÄúBienvenido‚Äù SOLO en Inicio */
  const show = (id) => {
    qsa('.ted-screen-view').forEach(el => {
      el.classList.remove('active'); el.setAttribute('aria-hidden','true'); el.style.display='none';
    });
    const el = qs('#'+id);
    if(el){
      el.classList.add('active'); el.setAttribute('aria-hidden','false'); el.style.display='block';
    }
    const header = qs('.ted-header');
    header?.classList.toggle('compact', id !== 'login-screen');

    const screen = qs('.ted-screen');
    if(screen){
      screen.classList.toggle('is-home', id === 'login-screen');
    }
    const wb = qs('#welcome-badge');
    if(wb){
      const isHome = (id === 'login-screen');
      wb.classList.toggle('hidden', !isHome);
      if(isHome) wb.style.removeProperty('display');
    }
    const cont = qs('#retiro-currencies');
    if(cont){
      const shouldShow = id === 'transaction-screen' && ctx.modo === 'retiro' && ctx.raw;
      cont.style.display = shouldShow ? 'block' : 'none';
      cont.setAttribute('aria-hidden', shouldShow ? 'false' : 'true');
    }
  };

  function showError(stage, err){
    let userMsg = 'Ocurri√≥ un error inesperado.';
    let code = `E${err.status||'000'}-DESCONOCIDO`;
    
    // Obtener el mensaje del error de m√∫ltiples fuentes posibles
    const rawMsg = (err && (err.message || '')) || 
                   (err && err.payload && (err.payload.error || err.payload.detail || err.payload.message)) || '';
    const raw = String(rawMsg).toLowerCase();
    
    // Debug: ver qu√© mensaje viene realmente
    console.log('showError debug:', {stage, status: err.status, raw, payload: err.payload});

    switch(err.status){
      case 404: {
        if (raw.includes('cliente activo') || raw.includes('no pertenece')) {
          userMsg = 'El c√≥digo no pertenece al cliente activo seleccionado. Cambi√° el cliente activo y volv√© a intentarlo.';
          code = 'E404-CODIGO-CLIENTE';
        } else {
          userMsg = (stage==='validar')
            ? 'C√≥digo no encontrado. Verific√° el n√∫mero e intent√° de nuevo.'
            : (stage==='confirmar' ? 'Reserva no encontrada o expirada. Volv√© a validar el c√≥digo.' : 'Recurso no encontrado.');
          code = (stage==='validar') ? 'E404-CODIGO' : 'E404-RESERVA';
        }
      break; }

      case 409: {
        // Imprimir el mensaje raw para debug (puedes comentar despu√©s)
        console.log('Error 409 mensaje:', raw, 'Stage:', stage);
        
        // Detectar c√≥digo ya usado/completado
        if (raw.includes('ya completad') || raw.includes('ya utiliz') || raw.includes('ya proces') || 
            raw.includes('completada') || raw.includes('utilizado') || raw.includes('procesado') ||
            raw.includes('already') || raw.includes('completed') || raw.includes('used') ||
            raw.includes('transaction') && raw.includes('complete')) {
          userMsg = 'Este c√≥digo ya fue utilizado en una transacci√≥n completada anteriormente.';
          code = 'E409-COMPLETADO';
        }
        // Detectar tipo de operaci√≥n incorrecto
        else if (raw.includes('tipo') || raw.includes('retiro') || raw.includes('dep√≥sito') || 
                 raw.includes('deposito') || raw.includes('withdraw') || raw.includes('deposit') ||
                 raw.includes('operaci√≥n') || raw.includes('operacion')) {
          userMsg = 'Este c√≥digo no corresponde al tipo de operaci√≥n seleccionada. Verific√° si es para Retiro o Dep√≥sito.';
          code = 'E409-TIPO';
        }
        // Si es en la etapa de validar y no es ninguno de los anteriores, asumir c√≥digo completado
        else if (stage === 'validar') {
          userMsg = 'Este c√≥digo ya fue utilizado en una transacci√≥n completada anteriormente.';
          code = 'E409-COMPLETADO';
        }
        // Por defecto: problema de stock (solo en precontar/confirmar)
        else {
          userMsg = 'No hay billetes suficientes en esta sucursal para ese monto.';
          code = 'E409-STOCK';
        }
        break;
      }

      case 403:
        if(raw.includes('csrf')){ userMsg = 'No autorizado: Protecci√≥n CSRF. Refresc√° la p√°gina e intent√° de nuevo.'; code = 'E403-AUT-CSRF'; }
        else if(raw.includes('cliente activo')){ userMsg = 'Deb√©s seleccionar un cliente activo en tu cuenta antes de usar el TED.'; code = 'E403-CLIENTE'; }
        else { userMsg = 'No autorizado para continuar.'; code = 'E403-AUT'; }
        break;
      case 410: userMsg = 'La operaci√≥n expir√≥. Volv√© a intentarlo.'; code = 'E410-EXPIRADO'; break;
      case 400: userMsg = err.message || 'Solicitud inv√°lida.'; code = 'E400-VALIDACION'; break;
      default:  userMsg = err.message || userMsg;
    }
    qs('#cancel-sub') && (qs('#cancel-sub').textContent = `${userMsg} (${code})`);
    show('cancel-screen');
  }

  // ====== helpers UI para limpiar estado ======
  const codeInput = () => qs('#transaction-number');
  window.addEventListener('pageshow', function (e) {
    if (e.persisted) {
      const el = codeInput();
      if (el) el.value = '';
    }
  });
  const btnTxValidar = () => qs('#btn-tx-validar');

  function resetTxUI() {
    const inp = codeInput();
    if (inp) inp.value = '';
    const btn = btnTxValidar();
    if (btn) btn.disabled = true;
    ctx.code = null; ctx.raw = null; ctx.reserva_id = null; ctx.ticket_url = null; ctx.tx_id = null; ctx.modo = null;
    const box = qs('#confirm-amount-box');
    if (box) { box.innerHTML = ''; box.style.display = 'none'; }
    qs('#confirm-amount-text')?.classList.remove('hidden');
    const cont = qs('#retiro-currencies');
    const list = qs('#retiro-currency-list');
    if (cont && list) {
      list.innerHTML = '';
      cont.style.display = 'none';
      cont.setAttribute('aria-hidden','true');
    }
    qsa('#retiro-currency-list .currency-chip').forEach(ch=> ch.classList.remove('match','dimmed'));
    qs('#tx-title') && (qs('#tx-title').textContent = 'Operaci√≥n');
  }

  // ---------------- Login (ubicaci√≥n + terminal) ----------------
  const ubicSel = qs('#select-ubicacion');
  const btnLogin = qs('#btn-login-ingresar');

  async function cargarTerminal(){
    try{
      const data = await api(URLS.terminal);
      let serial = (data && data.serial) || null;
      
      // Si el backend devuelve LOCAL-DEV o est√° vac√≠o, generar uno basado en ubicaci√≥n
      if (!serial || serial === 'LOCAL-DEV' || serial === '‚Äî') {
        const ubicacion = ctx.ubicacion || ubicSel?.value || '';
        if (ubicacion) {
          // Generar c√≥digo basado en las primeras 3 letras de la ubicaci√≥n + hash
          const code = ubicacion.substring(0, 3).toUpperCase();
          const hash = ubicacion.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0) % 1000;
          serial = `TED-${code}${String(hash).padStart(3, '0')}`;
        } else {
          serial = 'TED-001';
        }
      }
      
      qs('#info-serie').textContent = serial;
    }catch(_e){ 
      qs('#info-serie').textContent = 'TED-001'; 
    }
  }
  async function cargarUbicaciones(){
    try{
      const data = await api(URLS.ubicaciones);
      const list = (data && data.ubicaciones) || [];
      ubicSel.innerHTML = '<option value="">‚Äî Seleccion√° una sucursal ‚Äî</option>';
      list.forEach(u=>{
        const opt = document.createElement('option'); opt.value = u; opt.textContent = u; ubicSel.appendChild(opt);
      });
      if(list.length === 1){ ubicSel.value = list[0]; }
      ctx.ubicacion = ubicSel.value || null;
      btnLogin.disabled = !ctx.ubicacion;
      qs('#info-ubicacion').textContent = ctx.ubicacion || '‚Äî';
    }catch(e){
      ubicSel.innerHTML = '<option value="">(Sin ubicaciones cargadas)</option>';
      btnLogin.disabled = true;
    }
  }
  ubicSel?.addEventListener('change', ()=>{
    ctx.ubicacion = ubicSel.value || null;
    btnLogin.disabled = !ctx.ubicacion;
    qs('#info-ubicacion').textContent = ctx.ubicacion || '‚Äî';
    
    // Actualizar el n√∫mero de serie cuando cambia la ubicaci√≥n
    if (ctx.ubicacion) {
      const code = ctx.ubicacion.substring(0, 3).toUpperCase();
      const hash = ctx.ubicacion.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0) % 1000;
      qs('#info-serie').textContent = `TED-${code}${String(hash).padStart(3, '0')}`;
    }
    
    try { loadRetiroCurrencies(); } catch(_){}
  });

  btnLogin?.addEventListener('click', ()=>{
    resetTxUI();
    show('transaction-screen');
    const input = codeInput();
    if (input) {
      input.focus();
    }
  });

  // ---------------- C√≥digo + validar ----------------
  qs('#transaction-number')?.addEventListener('input', (e)=>{
    ctx.code = (e.target.value||'').trim();
    qs('#btn-tx-validar').disabled = !ctx.code;
  });
  qs('#btn-tx-cancelar')?.addEventListener('click', ()=>{
    resetTxUI();
    show('login-screen');
  });

  qs('#btn-tx-validar')?.addEventListener('click', async ()=>{
    try{
      const code = (ctx.code||'').trim();
      if(!code) throw new Error('Ingres√° el c√≥digo de operaci√≥n.');

      let modos = [];
      if (ctx.modo) {
        modos = [ctx.modo];
      } else if (ctx.lastModo) {
        modos = ctx.lastModo === 'retiro' ? ['retiro', 'deposito'] : ['deposito', 'retiro'];
      } else {
        modos = ['retiro', 'deposito'];
      }
      let info = null;
      let usedMode = ctx.modo || null;
      let lastError = null;

      for (const modo of modos) {
        try {
          const payload = { codigo: code, modo };
          info = await api(URLS.validar, payload);
          usedMode = info?.modo || info?.tipo_operacion || modo;
          break;
        } catch(err) {
          lastError = err;
          if (ctx.modo || modo === 'deposito') throw err;
        }
      }

      if (!info) {
        throw lastError || new Error('No se pudo validar la operaci√≥n.');
      }

      ctx.modo = (usedMode === 'deposito' || usedMode === 'retiro') ? usedMode : 'retiro';
      ctx.lastModo = ctx.modo;
      ctx.raw  = info;
      ctx.code = info && info.codigo ? String(info.codigo).trim() : code;
      ctx.tx_id = info && info.tx_id ? String(info.tx_id) : null;

      const title = qs('#tx-title');
      if (title) {
        title.textContent = ctx.modo === 'deposito' ? 'Dep√≥sito de Dinero' : 'Retiro de Dinero';
      }

      // üÜï Sincronizar el cliente activo de la sesi√≥n con el due√±o del c√≥digo
      //    (la vista `seleccionar_cliente` guarda SESSION_KEY en la sesi√≥n)
      const clienteId = info && (info.cliente_id || info.cliente || info.owner_id);
      if (clienteId) {
        try { await postForm(URLS.set_cliente + '?next=' + encodeURIComponent(location.pathname), {cliente_id: clienteId}); }
        catch(_e){ /* si falla, continuamos: precontar devolver√° 404 y lo mostraremos bonito */ }
      }

      if (ctx.modo === 'retiro') {
        await loadRetiroCurrencies();
        qsa('#retiro-currency-list .currency-chip').forEach(ch=>{
          if ((ch.dataset.cur||'').toUpperCase() === String(info.moneda||'').toUpperCase()) {
            ch.classList.add('match'); ch.classList.remove('dimmed');
          } else {
            ch.classList.add('dimmed'); ch.classList.remove('match');
          }
        });
      } else {
        const cont = qs('#retiro-currencies');
        const list = qs('#retiro-currency-list');
        if (list) list.innerHTML = '';
        if (cont) {
          cont.style.display = 'none';
          cont.setAttribute('aria-hidden','true');
        }
      }

      const box = qs('#confirm-amount-box');
      const textEl = qs('#confirm-amount-text');
      const emoji = flag(info.moneda);
      box.innerHTML = `
        <div class="cb-top">
          <span class="cb-chip"><span class="cb-flag">${emoji}</span><span class="cb-code">${info.moneda}</span></span>
          <div class="cb-mode">${ctx.modo==='deposito'?'Dep√≥sito':'Retiro'}</div>
        </div>
        <div class="cb-value"><span class="cb-number">${formatAmountRaw(info.monto)}</span> <span class="cb-code">${info.moneda}</span></div>
        <div class="cb-sub">Transacci√≥n <code>${ctx.code}</code></div>
      `;
      box.style.display = 'block';
      textEl?.classList.add('hidden');
      show('confirm-amount-screen');
    }catch(err){
      ctx.modo = null;
      showError('validar', err);
    }
  });

  // ---------------- Precontar + OTP ----------------
  qs('#btn-amount-cancel')?.addEventListener('click', ()=>{
    resetTxUI();
    show('transaction-screen');
    const input = codeInput();
    if (input) input.focus();
  });
  qs('#btn-amount-confirm')?.addEventListener('click', async ()=>{
    try{
      if (!ctx.modo) throw new Error('Valid√° una operaci√≥n antes de continuar.');
      const payload = { codigo: ctx.code, modo: ctx.modo, ubicacion: ctx.ubicacion };
      if (ctx.tx_id) payload.tx_id = ctx.tx_id;
      const data = await api(URLS.precontar, payload);

      ctx.reserva_id = data?.reserva_id ?? data?.reserva ?? data?.id ?? ctx.raw?.reserva_id ?? ctx.raw?.reserva ?? null;

      const list = qs('#otp-summary');
      if(list){
        if (ctx.modo === 'retiro' && data.breakdown && data.breakdown.length > 0) {
          const billsHTML = data.breakdown.map(b => 
            `<div style="display:inline-flex;align-items:center;gap:6px;padding:4px 10px;margin:3px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.15);border-radius:8px;font-size:14px;font-weight:600;">
              <span style="opacity:.85;">${b.unidades}√ó</span>
              <span style="color:#10b981;font-weight:800;">${b.valor}</span>
              <span style="font-size:18px;">üíµ</span>
            </div>`
          ).join('');
          list.innerHTML = `<div style="display:flex;flex-wrap:wrap;justify-content:center;margin:8px 0;">${billsHTML}</div>${data.diff ? `<div style="font-size:13px;opacity:.75;margin-top:6px;">Redondeo: ${formatAmount(data.diff, data.moneda)}</div>` : ''}`;
        } else {
          list.innerHTML = '<div style="padding:10px;opacity:.85;font-size:14px;">üí∞ Ingres√° los billetes en la ranura</div>';
        }
      }

      await api(URLS.otp_enviar, {reserva_id: ctx.reserva_id});
      show('otp-screen');
    }catch(err){ showError('precontar', err); }
  });

  // ---------------- OTP confirmar ----------------
  qs('#btn-otp-back')?.addEventListener('click', ()=> show('confirm-amount-screen'));
  qs('#btn-otp-confirm')?.addEventListener('click', async ()=>{
    try{
      const otp = (qs('#otp-input')?.value || '').trim();
      if(!otp) throw new Error('Ingrese el c√≥digo OTP.');
      await api(URLS.otp_verificar, {reserva_id: ctx.reserva_id, otp});
      const result = await api(URLS.confirmar, {
        reserva_id: ctx.reserva_id,
        codigo: ctx.code,
        modo: ctx.modo,
        otp
      });
      ctx.ticket_url = result.ticket_url || null;

      qs('#success-message') && (qs('#success-message').textContent =
        `${ctx.modo==='deposito'?'Dep√≥sito':'Retiro'} completado para la transacci√≥n ${ctx.code}.`);
      show('success-screen');
    }catch(err){ showError('confirmar', err); }
  });

  // ---------------- Botones de salida/imprimir ----------------
  qs('#btn-success-exit')?.addEventListener('click', ()=> { resetTxUI(); show('login-screen'); });
  qs('#btn-success-print')?.addEventListener('click', ()=> { if(ctx.ticket_url){ window.open(ctx.ticket_url, 'ticket', 'width=460,height=640'); } });
  qs('#btn-cancel-exit')?.addEventListener('click', ()=> { resetTxUI(); show('login-screen'); });

  // ---------------- Teclado virtual (delegaci√≥n + foco seguro) ----------------
  let active = null;

  // Seguimos actualizando active con focus/blur por si hay m√°s inputs con data-kb
  qsa('input[data-kb]').forEach(inp=>{
    inp.addEventListener('focus',()=> active=inp);
    inp.addEventListener('blur',()=> { if(active===inp) active=null; });
  });

  // Obtiene el input destino: prioriza el enfocado; si no, usa #transaction-number visible
  function getTargetInput(){
    if (active && document.body.contains(active)) return active;
    const focused = document.activeElement;
    if (focused && focused.matches && focused.matches('input[data-kb]')) return focused;
    const visible = qs('.ted-screen-view.active input[data-kb]') || qs('#transaction-number');
    return visible || null;
  }

  // Delegaci√≥n: un solo listener para todo el teclado
  qs('.ted-pad')?.addEventListener('click', (ev)=>{
    const btn = ev.target.closest('.ted-key');
    if(!btn) return;

    const input = getTargetInput();
    if(!input) return;

    const k = String(btn.dataset.key||'');
    // Letras A-F se agregan en may√∫scula
    if (k==='a' || k==='b' || k==='c' || k==='d' || k==='e' || k==='f') {
      input.value += k.toLowerCase();
    }
    else if (k==='backspace') {
      input.value = input.value.slice(0,-1);
    }
    else if (k==='clear') {
      input.value = '';
    }
    else if (k==='minus') {
      input.value += '-';
    }
    else if (k==='confirm') {
      const btnValidar = qs('#btn-tx-validar');
      if (btnValidar && !btnValidar.disabled) btnValidar.click();
      return; // no dispara 'input'
    }
    else {
      // n√∫meros u otros caracteres
      input.value += k;
    }

    // Asegurar foco para que el usuario vea el cursor
    input.focus();
    // Notificar cambios a la UI (habilitar bot√≥n Validar, etc.)
    input.dispatchEvent(new Event('input', { bubbles:true }));
  });

  function tick(){ const now=new Date(); qs('#ted-clock').textContent = now.toLocaleTimeString('es-PY',{hour12:false}); }
  setInterval(tick, 1000); tick();

  (async () => {
    await Promise.all([cargarTerminal(), cargarUbicaciones()]);
    resetTxUI();
    show('login-screen');
  })();
})();
</script>

{% endblock %}
