{% extends "base.html" %}
{% load static %}
{% block title %}Global Exchange{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/ted.css' %}"/>

<!-- Estilos m√≠nimos SOLO para el bloque de confirmaci√≥n -->
<style>
  .confirm-box{
    display:none;
    margin:18px auto 8px auto;
    max-width:640px;
    background:linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.03));
    border:1.5px solid rgba(255,255,255,0.16);
    border-radius:18px;
    padding:18px 20px;
    box-shadow:0 6px 20px rgba(0,0,0,0.25) inset, 0 10px 30px rgba(0,0,0,0.10);
  }
  .confirm-box .cb-top{
    display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:6px;
  }
  .confirm-box .cb-chip{
    display:inline-flex; align-items:center; gap:8px;
    padding:6px 10px; border-radius:999px;
    background:rgba(255,255,255,0.10); border:1px solid rgba(255,255,255,0.18);
    font-weight:700; letter-spacing:.3px;
  }
  .confirm-box .cb-flag{ font-size:18px; line-height:1; }
  .confirm-box .cb-code{ opacity:.95 }
  .confirm-box .cb-mode{ font-size:14px; opacity:.85 }
  .confirm-box .cb-value{
    font-weight:900; line-height:1.15; letter-spacing:.2px;
    font-size:36px; margin:6px 0 2px 0;
    text-shadow:0 1px 0 rgba(0,0,0,0.35);
  }
  .confirm-box .cb-value .cb-code{
    font-size:18px; font-weight:800; margin-left:6px; opacity:.9;
  }
  .confirm-box .cb-sub{
    margin-top:6px; font-size:14px; opacity:.9;
  }
  #confirm-amount-text.hidden { display:none !important; }
</style>

<style>
/* ===== Variantes de t√≠tulo "Confirmaci√≥n" (elige UNA en el HTML) ===== */
.confirm-title { text-align:center; margin:0 0 10px; }

/* Opci√≥n 2: Texto con gradiente + subrayado brillante */
.confirm-title--gradient{
  display:inline-block; margin:auto; font-weight:900; letter-spacing:.3px;
  font-size:22px;
  background:linear-gradient(90deg,#c4b5fd,#a78bfa,#c4b5fd);
  -webkit-background-clip:text; background-clip:text; color:transparent;
  position:relative; text-transform:uppercase;
}
.confirm-title--gradient::after{
  content:""; display:block; width:120px; height:3px; margin:8px auto 0;
  background:linear-gradient(90deg, transparent, #a78bfa, transparent);
  border-radius:99px; box-shadow:0 0 16px rgba(167,139,250,.6);
}
</style>

<main style="max-width:1100px;margin:0 auto;padding:24px">
  <section class="ted-machine">
    <div class="ted-layout">
      <!-- Pantalla principal -->
      <div class="ted-layout-main">
        <div class="ted-screen">
          <div class="ted-screen-glow"></div>

          <div class="ted-screen-inner">
            <!-- Cabecera -->
            <header class="ted-header">
              <div class="logo-badge">
                <img class="ted-logo" src="{% static 'img/logo-secundario.png' %}" alt="Global Exchange">
              </div>
              <div class="welcome-badge" id="welcome-badge">üëã Bienvenido</div>
              <h1 class="ted-title">GLOBAL EXCHANGE</h1>
            </header>

            <!-- Vistas -->
            <div class="ted-views-container">
              <!-- VISTA: Inicio -->
              <section id="login-screen" class="ted-screen-view active" aria-live="polite">
                <div class="view-content">
                  <p>Hola,
                    <strong>{% firstof request.user.get_full_name request.user.username request.user.email "Usuario" %}</strong>.
                  </p>

                  <div class="location-picker">
                    <label for="select-ubicacion" class="location-label">Ubicaci√≥n del TED</label>
                    <select id="select-ubicacion" class="ted-select" aria-required="true">
                      <option value="">‚Äî Seleccion√° una sucursal ‚Äî</option>
                      <!-- Si ya renderizas ubicaciones desde el server, mantienen este select -->
                    </select>
                    <p class="location-hint">Para continuar al men√∫ de operaciones.</p>
                  </div>

                  <button class="gx-btn" type="button" id="btn-login-ingresar" disabled>Continuar</button>
                </div>
              </section>

              <!-- VISTA: Men√∫ -->
              <section id="menu-screen" class="ted-screen-view" aria-live="polite">
                <div class="view-content">
                  <h2 style="text-align:center;margin-bottom:12px">Operaciones disponibles</h2>
                  <div class="menu-grid">
                    <button id="btn-menu-retirar" type="button" class="menu-card" aria-label="Retiro de dinero">
                      <div class="menu-icon">üíµ</div>
                      <div class="menu-label">Retiro de Dinero</div>
                    </button>
                    <button id="btn-menu-deposito" type="button" class="menu-card" aria-label="Dep√≥sito de dinero">
                      <div class="menu-icon">üí∞</div>
                      <div class="menu-label">Dep√≥sito de Dinero</div>
                    </button>
                  </div>
                  <div style="text-align:center;margin-top:16px">
                    <button id="btn-menu-salir" type="button" class="gx-btn gx-btn--ghost">üö™ Salir</button>
                  </div>
                </div>
              </section>

              <!-- VISTA: Retiro / Dep√≥sito (ingreso c√≥digo) -->
              <section id="transaction-screen" class="ted-screen-view" aria-live="polite">
                <div class="view-content">
                  <h3 id="tx-title">Operaci√≥n</h3>
                  <label for="transaction-number">Ingrese n√∫mero de transacci√≥n</label>
                  <input id="transaction-number" type="text" class="ted-input" placeholder="C√≥digo de operaci√≥n" autocomplete="off" />
                    <button class="gx-btn gx-btn--ghost" type="button" id="btn-tx-cancelar">Cancelar</button>
                    <button class="gx-btn" type="button" id="btn-tx-validar">Validar</button>
                  </div>
              </section>

              <!-- VISTA: Confirmaci√≥n de monto -->
              <section id="confirm-amount-screen" class="ted-screen-view" aria-live="polite">
                <div class="view-content view-content--centered">
                  <div class="confirm-title">
                    <span class="confirm-title--gradient">Confirmaci√≥n</span>
                  </div>

                  <!-- NUEVO bloque visual -->
                  <div id="confirm-amount-box" class="confirm-box" aria-live="polite"></div>

                  <!-- Fallback de texto plano (se ocultar√° si hay box) -->
                  <div id="confirm-amount-text" class="confirm-text">¬øDesea confirmar la operaci√≥n?</div>

                  <div class="button-group">
                    <button class="gx-btn gx-btn--ghost" type="button" id="btn-amount-cancel">Cancelar</button>
                    <button class="gx-btn" type="button" id="btn-amount-confirm">Continuar</button>
                  </div>
                </div>
              </section>

              <!-- VISTA: OTP -->
              <section id="otp-screen" class="ted-screen-view" aria-live="polite">
                <div class="view-content view-content--centered">
                  <h3 class="status-title">Verificaci√≥n</h3>
                  <p class="status-message">Ingres√° el c√≥digo de verificaci√≥n enviado a tu correo.</p>
                  <div id="otp-summary" class="status-message" style="margin:8px 0 14px 0"></div>
                  <input id="otp-input" type="text" class="ted-input" inputmode="numeric" maxlength="6" placeholder="C√≥digo OTP (6 d√≠gitos)" />
                  <div class="button-group">
                    <button class="gx-btn gx-btn--ghost" type="button" id="btn-otp-back">Volver</button>
                    <button class="gx-btn" type="button" id="btn-otp-confirm">Confirmar</button>
                  </div>
                </div>
              </section>

              <!-- VISTA: Procesando -->
              <section id="processing-screen" class="ted-screen-view" aria-live="polite">
                <div class="view-content view-content--centered">
                  <div class="processing-text">
                    <span id="processing-message">Procesando</span><span class="processing-dots"></span>
                  </div>
                </div>
              </section>

              <!-- VISTA: √âxito -->
              <section id="success-screen" class="ted-screen-view" aria-live="polite">
                <div class="view-content view-content--centered">
                  <div class="status-title status-title--success">¬°Operaci√≥n exitosa!</div>
                  <!-- Tarjeta de resultado -->
                  <div id="success-amount-box" class="result-box" aria-live="polite"></div>
                  <div id="success-message" class="status-message">Listo.</div>
                  <div class="button-group">
                    <button class="gx-btn gx-btn--ghost" type="button" id="btn-success-exit">Salir</button>
                    <button class="gx-btn" type="button" id="btn-success-print">Imprimir ticket</button>
                  </div>
                </div>
              </section>

              <!-- VISTA: Cancelado / Error -->
              <section id="cancel-screen" class="ted-screen-view" aria-live="polite">
                <div class="view-content view-content--centered">
                  <div class="status-title status-title--cancel">Operaci√≥n cancelada</div>
                  <div id="cancel-sub" class="status-message">Recoja su dinero.</div>
                  <button class="gx-btn gx-btn--ghost" type="button" id="btn-cancel-exit">Salir</button>
                </div>
              </section>
            </div><!-- /ted-views-container -->
          </div>
        </div>
      </div>

      <!-- Panel lateral (reloj + teclado) -->
      <aside class="ted-layout-aside">
        <div class="pad-info-card">
          <div class="clock" id="ted-clock">--:--:--</div>
          <div class="info-line">N¬∫ de serie: <strong id="info-serie">‚Äî</strong></div>
          <div class="info-line">Ubicaci√≥n: <strong id="info-ubicacion">‚Äî</strong></div>
        </div>

        <div class="pad-bezel">
          <div class="ted-pad" aria-label="Teclado">
            <div class="grid">
              {% for key in "123a456b789c0def" %}
              <button class="ted-key" type="button" data-key="{{ key }}">{{ key }}</button>
              {% endfor %}
            </div>
          </div>
        </div>
      </aside>
    </div>

    <!-- Ranuras -->
    <div class="slots-container">
      <div id="bill-slot" class="ted-slot">
        <div class="slot-opening"></div>
        <div class="slot-indicator"></div>
        <div class="bill-stack">
          <div class="bill-item" style="animation-delay:0s">$100</div>
          <div class="bill-item" style="animation-delay:0.15s">$100</div>
          <div class="bill-item" style="animation-delay:0.3s">$100</div>
          <div class="bill-item" style="animation-delay:0.45s">$100</div>
        </div>
        <div class="slot-label">Ranura de billetes</div>
      </div>

      <div id="receipt-slot" class="ted-slot">
        <div class="slot-opening"></div>
        <div class="slot-indicator"></div>
        <div class="receipt-anim">
          <div class="receipt-paper">
            <div class="receipt-header">GLOBAL EXCHANGE</div>
            <div id="receipt-body"></div>
          </div>
        </div>
        <div class="slot-label">Salida de tickets</div>
      </div>
    </div>
  </section>
</main>

<script>
  // Si quer√©s limpiar tambi√©n cuando cambi√°s de modo u operaci√≥n:
  function resetCodigo() {
    const $code = document.getElementById("transaction-number");
    if ($code) $code.value = "";
  }
(() => {
  const qs = (sel, el=document) => el.querySelector(sel);
  const qsa = (sel, el=document) => [...el.querySelectorAll(sel)];
  const flag = (code) => ({USD:'üá∫üá∏', EUR:'üá™üá∫', PYG:'üáµüáæ'})[String(code||'').toUpperCase()] || 'üè≥Ô∏è';
  const formatAmountRaw = (a) => {
    try{ const n = Number(a); if(Number.isFinite(n)) return n.toLocaleString('es-PY',{maximumFractionDigits:0}); }
    catch(e){}
    return String(a);
  };
  const formatAmount = (a, code)=> `${formatAmountRaw(a)} ${code}`;

  const ctx = { modo:null, code:null, ubicacion:null, raw:null, reserva_id:null, ticket_url:null };

  // === CSRF ===
  function getCookie(name){
    const m = document.cookie.match(new RegExp('(^|; )'+name+'=([^;]+)'));
    return m ? decodeURIComponent(m[2]) : null;
  }
  const CSRF = getCookie('csrftoken');

  async function api(url, body){
    const isPost = !!body;
    const res = await fetch(url, {
      method: isPost ? 'POST' : 'GET',
      credentials:'same-origin',
      headers: isPost ? {'Content-Type':'application/json','X-CSRFToken': CSRF || ''} : {},
      body: isPost ? JSON.stringify(body||{}) : undefined
    });
    const ct = res.headers.get('content-type') || '';
    let payload = null;
    if(ct.includes('application/json')){
      try{ payload = await res.json(); }catch(_){ payload = null; }
    }else{
      const text = await res.text().catch(()=> '');
      payload = { ok:false, error: text };
    }
    const notOk = !res.ok || (payload && payload.ok === false);
    if(notOk){
      let msg = (payload && (payload.error || payload.detail)) || res.statusText || 'Error';
      if(res.status===403 && (!ct || !ct.includes('application/json'))){
        msg = 'Protecci√≥n CSRF: falta o es inv√°lida. Refresque la p√°gina e intente de nuevo.';
      }
      const err = new Error(msg);
      err.status  = res.status || 0;
      err.payload = payload;
      throw err;
    }
    return (payload && payload.data) || payload;
  }

  const URLS = {
    validar: "{% url 'usuarios:ted_api_validar' %}",
    precontar: "{% url 'usuarios:ted_api_precontar' %}",
    otp_enviar: "{% url 'usuarios:ted_api_otp_enviar' %}",
    otp_verificar: "{% url 'usuarios:ted_api_otp_verificar' %}",
    confirmar: "{% url 'usuarios:ted_api_confirmar' %}",
    ubicaciones: "{% url 'usuarios:ted_api_ubicaciones' %}",
    terminal: "{% url 'usuarios:ted_api_terminal' %}",
  };

  const show = (id) => {
    qsa('.ted-screen-view').forEach(el => {
      el.classList.remove('active'); el.setAttribute('aria-hidden','true'); el.style.display='none';
    });
    const el = qs('#'+id);
    if(el){ el.classList.add('active'); el.setAttribute('aria-hidden','false'); el.style.display='block'; }
  };

  function showError(stage, err){
    let userMsg = 'Ocurri√≥ un error inesperado.';
    let code = `E${err.status||'000'}-DESCONOCIDO`;
    const raw = (err && (err.message||'')).toLowerCase();

    switch(err.status){
      case 404: userMsg = 'C√≥digo no encontrado. Verific√° el n√∫mero e intent√° de nuevo.'; code = 'E404-CODIGO'; break;
      case 409: userMsg = 'No hay billetes suficientes en esta sucursal para ese monto.'; code = 'E409-STOCK'; break;
      case 403:
        if(raw.includes('csrf')){ userMsg = 'No autorizado: Protecci√≥n CSRF. Refresc√° la p√°gina e intent√° de nuevo.'; code = 'E403-AUT-CSRF'; }
        else if(raw.includes('cliente activo')){ userMsg = 'Deb√©s seleccionar un cliente activo en tu cuenta antes de usar el TED.'; code = 'E403-CLIENTE'; }
        else { userMsg = 'No autorizado para continuar.'; code = 'E403-AUT'; }
        break;
      case 410: userMsg = 'La operaci√≥n expir√≥. Volv√© a intentarlo.'; code = 'E410-EXPIRADO'; break;
      case 400: userMsg = err.message || 'Solicitud inv√°lida.'; code = 'E400-VALIDACION'; break;
      default:  userMsg = err.message || userMsg;
    }
    qs('#cancel-sub') && (qs('#cancel-sub').textContent = `${userMsg} (${code})`);
    show('cancel-screen');
  }

  // ====== helpers UI para limpiar estado ======
  const codeInput = () => qs('#transaction-number');
  window.addEventListener('pageshow', function (e) {
    if (e.persisted) {
      const el = codeInput();
      if (el) el.value = '';
    }
  });

  const btnTxValidar = () => qs('#btn-tx-validar');

  function resetTxUI() {
    const inp = codeInput();
    if (inp) inp.value = '';
    const btn = btnTxValidar();
    if (btn) btn.disabled = true;
    ctx.code = null; ctx.raw = null; ctx.reserva_id = null; ctx.ticket_url = null;
    // ocultar box de confirmaci√≥n si qued√≥ armado
    const box = qs('#confirm-amount-box');
    if (box) { box.innerHTML = ''; box.style.display = 'none'; }
    qs('#confirm-amount-text')?.classList.remove('hidden');
  }

  // ---------------- Login (ubicaci√≥n + terminal) ----------------
  const ubicSel = qs('#select-ubicacion');
  const btnLogin = qs('#btn-login-ingresar');

  async function cargarTerminal(){
    try{
      const data = await api(URLS.terminal);
      qs('#info-serie').textContent = (data && data.serial) || '‚Äî';
    }catch(_e){ qs('#info-serie').textContent = '‚Äî'; }
  }
  async function cargarUbicaciones(){
    try{
      const data = await api(URLS.ubicaciones);
      const list = (data && data.ubicaciones) || [];
      ubicSel.innerHTML = '<option value="">‚Äî Seleccion√° una sucursal ‚Äî</option>';
      list.forEach(u=>{
        const opt = document.createElement('option'); opt.value = u; opt.textContent = u; ubicSel.appendChild(opt);
      });
      if(list.length === 1){ ubicSel.value = list[0]; }
      ctx.ubicacion = ubicSel.value || null;
      btnLogin.disabled = !ctx.ubicacion;
      qs('#info-ubicacion').textContent = ctx.ubicacion || '‚Äî';
    }catch(e){
      ubicSel.innerHTML = '<option value="">(Sin ubicaciones cargadas)</option>';
      btnLogin.disabled = true;
    }
  }
  ubicSel?.addEventListener('change', ()=>{
    ctx.ubicacion = ubicSel.value || null;
    btnLogin.disabled = !ctx.ubicacion;
    qs('#info-ubicacion').textContent = ctx.ubicacion || '‚Äî';
  });
  btnLogin?.addEventListener('click', ()=>{
    resetTxUI();
    show('menu-screen');
  });

  // ---------------- Men√∫ ----------------
  qs('#btn-menu-retirar')?.addEventListener('click', ()=>{
    ctx.modo = 'retiro';
    resetTxUI();
    qs('#tx-title').textContent = 'Retiro de Dinero';
    show('transaction-screen');
  });
  qs('#btn-menu-deposito')?.addEventListener('click', ()=>{
    ctx.modo = 'deposito';
    resetTxUI();
    qs('#tx-title').textContent = 'Dep√≥sito de Dinero';
    show('transaction-screen');
  });
  qs('#btn-menu-salir')?.addEventListener('click', ()=>{
    ctx.modo = null; resetTxUI(); show('login-screen');
  });

  // ---------------- C√≥digo + validar ----------------
  qs('#transaction-number')?.addEventListener('input', (e)=>{
    ctx.code = (e.target.value||'').trim().toUpperCase();
    qs('#btn-tx-validar').disabled = !ctx.code;
  });
  qs('#btn-tx-cancelar')?.addEventListener('click', ()=>{
    resetTxUI();
    show('menu-screen');
  });

  qs('#btn-tx-validar')?.addEventListener('click', async ()=>{
    try{
      if(!ctx.modo) throw new Error('Seleccion√° primero Retiro o Dep√≥sito.');
      const info = await api(URLS.validar, {codigo: ctx.code, modo: ctx.modo});
      ctx.raw = info;

      const box = qs('#confirm-amount-box');
      const textEl = qs('#confirm-amount-text');
      const emoji = flag(info.moneda);
      box.innerHTML = `
        <div class="cb-top">
          <span class="cb-chip"><span class="cb-flag">${emoji}</span><span class="cb-code">${info.moneda}</span></span>
          <div class="cb-mode">${ctx.modo==='deposito'?'Dep√≥sito':'Retiro'}</div>
        </div>
        <div class="cb-value"><span class="cb-number">${formatAmountRaw(info.monto)}</span> <span class="cb-code">${info.moneda}</span></div>
        <div class="cb-sub">Transacci√≥n <code>${info.codigo}</code></div>
      `;
      box.style.display = 'block';
      textEl?.classList.add('hidden');
      show('confirm-amount-screen');
    }catch(err){ showError('validar', err); }
  });

  // ---------------- Precontar + OTP ----------------
  qs('#btn-amount-cancel')?.addEventListener('click', ()=>{
    resetTxUI();
    show('menu-screen');
  });
  qs('#btn-amount-confirm')?.addEventListener('click', async ()=>{
    try{
      const data = await api(URLS.precontar, { codigo: ctx.code, modo: ctx.modo, ubicacion: ctx.ubicacion });
      ctx.reserva_id = data.reserva_id;

      const list = qs('#otp-summary');
      if(list){
        const rows = (data.breakdown||[]).map(b=>`<li>${b.unidades} x ${b.valor} ${data.moneda}</li>`).join('') || '<li>Dep√≥sito: ingrese billetes en la terminal</li>';
        list.innerHTML = `<ul>${rows}</ul><div class="text-[var(--muted)]">Redondeo: ${formatAmount(data.diff, data.moneda)} (a favor de la casa)</div>`;
      }

      await api(URLS.otp_enviar, {reserva_id: ctx.reserva_id});
      show('otp-screen');
    }catch(err){ showError('precontar', err); }
  });

  // ---------------- OTP confirmar ----------------
  qs('#btn-otp-back')?.addEventListener('click', ()=> show('confirm-amount-screen'));
  qs('#btn-otp-confirm')?.addEventListener('click', async ()=>{
    try{
      const otp = (qs('#otp-input')?.value || '').trim();
      if(!otp) throw new Error('Ingrese el c√≥digo OTP.');
      await api(URLS.otp_verificar, {reserva_id: ctx.reserva_id, otp});
      const result = await api(URLS.confirmar, {reserva_id: ctx.reserva_id, otp});
      ctx.ticket_url = result.ticket_url || null;

      qs('#success-message') && (qs('#success-message').textContent =
        `${ctx.modo==='deposito'?'Dep√≥sito':'Retiro'} completado para la transacci√≥n ${ctx.code}.`);
      show('success-screen');
    }catch(err){ showError('confirmar', err); }
  });

  // ---------------- Botones de salida/imprimir ----------------
  qs('#btn-success-exit')?.addEventListener('click', ()=> { resetTxUI(); show('menu-screen'); });
  qs('#btn-success-print')?.addEventListener('click', ()=> { if(ctx.ticket_url){ window.open(ctx.ticket_url, 'ticket', 'width=460,height=640'); } });
  qs('#btn-cancel-exit')?.addEventListener('click', ()=> { resetTxUI(); show('menu-screen'); });

  // ---------------- Teclado virtual ----------------
  let active = null;
  qsa('input[data-kb]').forEach(inp=>{
    inp.addEventListener('focus',()=> active=inp);
    inp.addEventListener('blur',()=> active=null);
  });
  qsa('.ted-key').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      if(!active) return;
      const k = btn.dataset.key;
      if(k==='a'){ active.value += 'A'; }
      else if(k==='b'){ active.value += 'B'; }
      else if(k==='c'){ active.value += 'C'; }
      else if(k==='d'){ active.value = active.value.slice(0,-1); }
      else { active.value += k; }
      active.dispatchEvent(new Event('input',{bubbles:true}));
    });
  });

  function tick(){ const now=new Date(); qs('#ted-clock').textContent = now.toLocaleTimeString('es-PY',{hour12:false}); }
  setInterval(tick, 1000); tick();

  (async () => {
    await Promise.all([cargarTerminal(), cargarUbicaciones()]);
    resetTxUI();
    show('login-screen');
  })();
})();
</script>

{% endblock %}
