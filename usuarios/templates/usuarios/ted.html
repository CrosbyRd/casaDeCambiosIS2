{% extends "base.html" %}
{% load static %}
{% block title %}Global Exchange{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/ted.css' %}"/>

<main style="max-width:1100px;margin:0 auto;padding:24px">
  <section class="ted-machine">
    <div class="ted-layout">
      <!-- Pantalla principal -->
      <div class="ted-layout-main">
        <div class="ted-screen">
          <div class="ted-screen-glow"></div>

          <div class="ted-screen-inner">
            <!-- Cabecera -->
            <header class="ted-header">
              <div class="logo-badge">
                <img class="ted-logo" src="{% static 'img/logo-secundario.png' %}" alt="Global Exchange">
              </div>
              <div class="welcome-badge" id="welcome-badge">ðŸ‘‹ Bienvenido</div>
              <h1 class="ted-title">GLOBAL EXCHANGE</h1>
            </header>

            <!-- Vistas -->
            <div class="ted-views-container">
              <!-- VISTA: Inicio -->
              <section id="login-screen" class="ted-screen-view active" aria-live="polite">
                <div class="view-content">
                  <p>Hola,
                    <strong>{% firstof request.user.get_full_name request.user.username request.user.email "Usuario" %}</strong>.
                  </p>

                  <div class="location-picker">
                    <label for="select-ubicacion" class="location-label">UbicaciÃ³n del TED</label>
                    <select id="select-ubicacion" class="ted-select" aria-required="true">
                      <option value="">â€” SeleccionÃ¡ una ubicaciÃ³n â€”</option>
                    </select>
                    <p class="location-hint">Este dato define el inventario a usar para este terminal.</p>
                  </div>

                  <button class="gx-btn" type="button" id="btn-login-ingresar" disabled>Continuar</button>
                </div>
              </section>

              <!-- VISTA: MenÃº -->
              <section id="menu-screen" class="ted-screen-view" aria-live="polite">
                <div class="view-content">
                  <h2 style="text-align:center;margin-bottom:12px">Operaciones disponibles</h2>
                  <div class="menu-grid">
                    <button id="btn-menu-retirar" type="button" class="menu-card" aria-label="Retiro de dinero">
                      <div class="menu-icon">ðŸ’µ</div>
                      <div class="menu-label">Retiro de Dinero</div>
                    </button>
                    <button id="btn-menu-deposito" type="button" class="menu-card" aria-label="DepÃ³sito de dinero">
                      <div class="menu-icon">ðŸ’°</div>
                      <div class="menu-label">DepÃ³sito de Dinero</div>
                    </button>
                  </div>
                  <div style="text-align:center;margin-top:16px">
                    <button id="btn-menu-salir" type="button" class="gx-btn gx-btn--ghost">ðŸšª Salir</button>
                  </div>
                </div>
              </section>

              <!-- VISTA: Retiro -->
              <section id="transaction-screen" class="ted-screen-view" aria-live="polite">
                <div class="view-content">
                  <h3>Retiro de Dinero</h3>
                  <label for="transaction-number">Ingrese nÃºmero de transacciÃ³n</label>
                  <input id="transaction-number" type="text" class="ted-input" placeholder="CÃ³digo de operaciÃ³n (TAUSER)"/>

                  <div class="currency-section">
                    <div class="currency-label">Divisas disponibles</div>
                    <div id="retiro-currency-list" class="currency-list"></div>
                  </div>

                  <div class="button-group">
                    <button class="gx-btn gx-btn--ghost" type="button" id="btn-retirar-cancelar">Cancelar</button>
                    <button class="gx-btn" type="button" id="btn-retirar-confirmar">Confirmar</button>
                  </div>
                </div>
              </section>

              <!-- VISTA: DepÃ³sito -->
              <section id="deposit-screen" class="ted-screen-view" aria-live="polite">
                <div class="view-content">
                  <h3>DepÃ³sito de Dinero</h3>
                  <label for="deposit-tx">Ingrese nÃºmero de transacciÃ³n</label>
                  <input id="deposit-tx" type="text" class="ted-input" placeholder="CÃ³digo de operaciÃ³n (TAUSER)"/>
                  <div class="button-group">
                    <button class="gx-btn gx-btn--ghost" type="button" id="btn-depo-cancelar">Cancelar</button>
                    <button class="gx-btn" type="button" id="btn-depo-confirmar">Confirmar</button>
                  </div>
                </div>
              </section>

              <!-- VISTA: Procesando -->
              <section id="processing-screen" class="ted-screen-view" aria-live="polite">
                <div class="view-content view-content--centered">
                  <div class="processing-text">
                    <span id="processing-message">Procesando</span><span class="processing-dots"></span>
                  </div>
                </div>
              </section>

              <!-- VISTA: ConfirmaciÃ³n de monto -->
              <section id="confirm-amount-screen" class="ted-screen-view" aria-live="polite">
                <div class="view-content view-content--centered">
                  <div class="confirm-title">ConfirmaciÃ³n</div>
                  <div id="confirm-amount-text" class="confirm-text">Â¿Desea confirmar la operaciÃ³n?</div>
                  <div class="button-group">
                    <button class="gx-btn gx-btn--ghost" type="button" id="btn-amount-cancel">Cancelar</button>
                    <button class="gx-btn" type="button" id="btn-amount-confirm">Confirmar</button>
                  </div>
                </div>
              </section>

              <!-- VISTA: Ã‰xito -->
              <section id="success-screen" class="ted-screen-view" aria-live="polite">
                <div class="view-content view-content--centered">
                  <div class="status-title status-title--success">Â¡OperaciÃ³n exitosa!</div>
                  <div id="success-message" class="status-message">Listo.</div>
                  <div class="button-group">
                    <button class="gx-btn gx-btn--ghost" type="button" id="btn-success-exit">Salir</button>
                    <button class="gx-btn" type="button" id="btn-success-print">Imprimir ticket</button>
                  </div>
                </div>
              </section>

              <!-- VISTA: Cancelado / Error -->
              <section id="cancel-screen" class="ted-screen-view" aria-live="polite">
                <div class="view-content view-content--centered">
                  <div class="status-title status-title--cancel">OperaciÃ³n cancelada</div>
                  <div id="cancel-sub" class="status-message">Recoja su dinero.</div>
                  <button class="gx-btn gx-btn--ghost" type="button" id="btn-cancel-exit">Salir</button>
                </div>
              </section>
            </div><!-- /ted-views-container -->
          </div>
        </div>
      </div>

      <!-- Panel lateral (reloj + teclado) -->
      <aside class="ted-layout-aside">
        <div class="pad-info-card">
          <div class="clock" id="ted-clock">--:--:--</div>
          <div class="info-line">NÂº de serie: <strong id="info-serie">â€”</strong></div>
          <div class="info-line">UbicaciÃ³n: <strong id="info-ubicacion">â€”</strong></div>
        </div>

        <div class="pad-bezel">
          <div class="ted-pad" aria-label="Teclado">
            <div class="grid">
              {% for key in "123a456b789c0def" %}
              <button class="ted-key" type="button" data-key="{{ key }}">{{ key }}</button>
              {% endfor %}
            </div>
          </div>
        </div>
      </aside>
    </div>

    <!-- Ranuras -->
    <div class="slots-container">
      <div id="bill-slot" class="ted-slot">
        <div class="slot-opening"></div>
        <div class="slot-indicator"></div>
        <div class="bill-stack">
          <div class="bill-item" style="animation-delay:0s">$100</div>
          <div class="bill-item" style="animation-delay:0.15s">$100</div>
          <div class="bill-item" style="animation-delay:0.3s">$100</div>
          <div class="bill-item" style="animation-delay:0.45s">$100</div>
        </div>
        <div class="slot-label">Ranura de billetes</div>
      </div>

      <div id="receipt-slot" class="ted-slot">
        <div class="slot-opening"></div>
        <div class="slot-indicator"></div>
        <div class="receipt-anim">
          <div class="receipt-paper">
            <div class="receipt-header">GLOBAL EXCHANGE</div>
            <div id="receipt-body"></div>
          </div>
        </div>
        <div class="slot-label">Salida de tickets</div>
      </div>
    </div>
  </section>
</main>

<script>
(function(){
  const qs=(s,c=document)=>c.querySelector(s);
  const qsa=(s,c=document)=>Array.from(c.querySelectorAll(s));
  const after=(ms,fn)=>setTimeout(fn,ms);

  /* CSRF */
  function getCookie(name){
    const value=`; ${document.cookie}`;
    const parts=value.split(`; ${name}=`);
    if(parts.length===2) return parts.pop().split(';').shift();
  }
  const csrfToken=getCookie('csrftoken');

  /* Reloj: hacerlo resiliente para que siempre prenda */
  function startClock(){
    try{
      const el=qs('#ted-clock'); if(!el) return;
      const fmt=new Intl.DateTimeFormat('es-PY',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
      const tick=()=>{ el.textContent=fmt.format(new Date()); };
      tick(); setInterval(tick,1000);
    }catch(e){
      // fallback simple si Intl falla por alguna razÃ³n
      const el=qs('#ted-clock'); if(!el) return;
      const pad=n=>String(n).padStart(2,'0');
      const tick=()=>{
        const d=new Date();
        el.textContent=`${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
      };
      tick(); setInterval(tick,1000);
    }
  }

  /* Pantallas */
  function showScreen(name){
    qsa('.ted-screen-view').forEach(v=>v.classList.remove('active'));
    const screen = qs('#'+name+'-screen');
    if(screen) screen.classList.add('active');
    qsa('.ted-slot').forEach(s=>s.classList.remove('active','dispensing-bills','printing-receipt','inserting-bills'));
    const welcomeBadge = qs('#welcome-badge');
    const header = qs('.ted-header');
    if(welcomeBadge){
      if(name === 'login'){
        welcomeBadge.classList.remove('hidden');
        header && header.classList.remove('compact');
      } else {
        welcomeBadge.classList.add('hidden');
        header && header.classList.add('compact');
      }
    }
  }
  function showProcessing(msg){ 
    const msgEl = qs('#processing-message');
    if(msgEl) msgEl.textContent=msg; 
    showScreen('processing'); 
  }

  /* Slots */
  function dispenseBills(){ 
    const slot=qs('#bill-slot'); 
    if(!slot) return; 
    slot.classList.add('active','dispensing-bills'); 
    after(2500,()=>slot.classList.remove('dispensing-bills')); 
  }
  function insertBills(){ 
    const slot=qs('#bill-slot'); 
    if(!slot) return; 
    slot.classList.add('active','inserting-bills'); 
    after(3000,()=>slot.classList.remove('inserting-bills')); 
  }

  /* Ticket */
  let lastReceipt={lines:[]};
  function prepareReceipt(_t,lines){ lastReceipt={lines}; }
  function printReceipt(){
    const slot=qs('#receipt-slot'), rc=qs('#receipt-body'); 
    if(!slot||!rc) return;
    rc.innerHTML='';
    (lastReceipt.lines||[]).forEach((line,i)=>{
      const d=document.createElement('div');
      d.className='receipt-line';
      d.textContent=line;
      d.style.animationDelay=(i*0.15)+'s';
      rc.appendChild(d);
    });
    slot.classList.add('active','printing-receipt');
    after(3800,()=>slot.classList.remove('printing-receipt'));
  }

  /* UbicaciÃ³n seleccionada */
  const SELECT = qs('#select-ubicacion');
  let ubicacionSeleccionada = "";
  try { ubicacionSeleccionada = sessionStorage.getItem('ted_ubicacion') || ""; } catch(e) {}

  function activarUbicacion(ubic){
    ubicacionSeleccionada = ubic || "";
    try { sessionStorage.setItem('ted_ubicacion', ubicacionSeleccionada); } catch(e) {}
    const infoUb=qs('#info-ubicacion'); if(infoUb) infoUb.textContent = ubicacionSeleccionada || 'â€”';
    const infoSe=qs('#info-serie');     if(infoSe) infoSe.textContent     = ubicacionSeleccionada ? 'TED-AGSL-0001' : 'â€”';
    const btnLogin=qs('#btn-login-ingresar'); if(btnLogin) btnLogin.disabled = !ubicacionSeleccionada;
  }

  // Normaliza respuestas: admite {ubicaciones:[]}, {data:[]}, {results:[]}, [].
  function pickUbicaciones(data){
    if(Array.isArray(data)) return data;
    if(data && Array.isArray(data.ubicaciones)) return data.ubicaciones;
    if(data && Array.isArray(data.data)) return data.data;
    if(data && Array.isArray(data.results)) return data.results;
    return [];
  }

  async function cargarUbicaciones(){
    const url = "{% url 'admin_panel:ted:ubicaciones_disponibles' %}";
    try{
      const res = await fetch(url, {credentials:'same-origin'});
      if(!res.ok) throw new Error('HTTP '+res.status);
      const data = await res.json();
      const lista = pickUbicaciones(data);

      if(SELECT){
        SELECT.innerHTML = '<option value="">â€” SeleccionÃ¡ una ubicaciÃ³n â€”</option>';
        lista.forEach(u=>{
          const opt=document.createElement('option');
          opt.value=u; opt.textContent=u;
          if (u===ubicacionSeleccionada) opt.selected=true;
          SELECT.appendChild(opt);
        });
      }
      activarUbicacion(SELECT?.value || ubicacionSeleccionada || "");
    }catch(e){
      // No bloquee el resto del flujo si falla; deja el default
      console.error('No se pudieron cargar ubicaciones:', e);
      activarUbicacion(ubicacionSeleccionada || "");
    }
  }

  /* Monedas por ubicaciÃ³n (para Retiro - UI informativa) */
  const FLAGS={USD:'ðŸ‡ºðŸ‡¸',EUR:'ðŸ‡ªðŸ‡º',ARS:'ðŸ‡¦ðŸ‡·',BRL:'ðŸ‡§ðŸ‡·',PYG:'ðŸ‡µðŸ‡¾',CNY:'ðŸ‡¨ðŸ‡³',JPY:'ðŸ‡¯ðŸ‡µ',GBP:'ðŸ‡¬ðŸ‡§',UYU:'ðŸ‡ºðŸ‡¾',CLP:'ðŸ‡¨ðŸ‡±',COP:'ðŸ‡¨ðŸ‡´',BOB:'ðŸ‡§ðŸ‡´',PEN:'ðŸ‡µðŸ‡ª',MXN:'ðŸ‡²ðŸ‡½',CAD:'ðŸ‡¨ðŸ‡¦',AUD:'ðŸ‡¦ðŸ‡º',CHF:'ðŸ‡¨ðŸ‡­',VES:'ðŸ‡»ðŸ‡ª',VEF:'ðŸ‡»ðŸ‡ª',RUB:'ðŸ‡·ðŸ‡º',ILS:'ðŸ‡®ðŸ‡±',CRC:'ðŸ‡¨ðŸ‡·',DOP:'ðŸ‡©ðŸ‡´',NOK:'ðŸ‡³ðŸ‡´',SEK:'ðŸ‡¸ðŸ‡ª',DKK:'ðŸ‡©ðŸ‡°',ZAR:'ðŸ‡¿ðŸ‡¦',HNL:'ðŸ‡­ðŸ‡³',GTQ:'ðŸ‡¬ðŸ‡¹',PAB:'ðŸ‡µðŸ‡¦',NIO:'ðŸ‡³ðŸ‡®',TRY:'ðŸ‡¹ðŸ‡·',INR:'ðŸ‡®ðŸ‡³',KRW:'ðŸ‡°ðŸ‡·',SGD:'ðŸ‡¸ðŸ‡¬',HKD:'ðŸ‡­ðŸ‡°'};
  const flag = c => FLAGS[c] || c;

  async function loadRetiroCurrencies(){
    const cont = qs('#retiro-currency-list'); 
    if(!cont) return;
    cont.textContent = 'Cargando...';
    try{
      const q = ubicacionSeleccionada ? ('?ubicacion=' + encodeURIComponent(ubicacionSeleccionada)) : '';
      const res = await fetch("{% url 'admin_panel:ted:monedas_disponibles' %}"+q, {credentials:'same-origin'});
      if(!res.ok) throw new Error('HTTP '+res.status);
      const data = await res.json();
      const monedas = Array.isArray(data.monedas) ? data.monedas
                    : Array.isArray(data.data) ? data.data
                    : Array.isArray(data.results) ? data.results
                    : Array.isArray(data) ? data
                    : [];
      cont.innerHTML = '';
      if(!monedas.length){ 
        cont.textContent='Sin divisas disponibles.'; 
        return; 
      }
      monedas.forEach(code=>{
        const chip=document.createElement('span');
        chip.className='currency-chip';
        chip.title=code;
        chip.textContent=flag(code);
        chip.dataset.code=code;
        cont.appendChild(chip);
      });
    }catch(e){
      console.error('No se pudieron cargar monedas:', e);
      cont.textContent='No se pudo cargar.';
    }
  }

  /* Estado transaccional local (TED) */
  const txCtx = {
    modo: null,         // 'retiro' | 'deposito'
    code: null,         // cÃ³digo ingresado
    moneda: null,       // cÃ³digo ISO p.ej. USD
    monto: null,        // string (serÃ¡ formateado)
    raw: null           // payload completo del backend
  };

  function formatAmount(a, code){
    try{
      const n = Number(a);
      if (Number.isFinite(n)){
        return new Intl.NumberFormat('es-PY',{maximumFractionDigits:2}).format(n) + ' ' + code;
      }
    }catch(e){}
    return a + ' ' + code;
  }

  async function validarCodigo(code, modo){
    const res = await fetch("{% url 'usuarios:ted_api_validar' %}", {
      method:'POST',
      credentials:'same-origin',
      headers:{'Content-Type':'application/json','X-CSRFToken':csrfToken},
      body: JSON.stringify({codigo: code, modo})
    });
    const data = await res.json();
    if(!res.ok || !data.ok) throw new Error(data.error || 'Error de validaciÃ³n');
    return data.data;
  }

  function confirmOperationView(text){
    const el = qs('#confirm-amount-text');
    if(el) el.textContent = text;
    showScreen('confirm-amount');
  }

  /* NavegaciÃ³n / bindings */
  document.addEventListener('DOMContentLoaded',()=>{
    // Enciende reloj pase lo que pase
    startClock();

    // Inicializa info
    qs('#info-serie') && (qs('#info-serie').textContent = 'â€”');
    qs('#info-ubicacion') && (qs('#info-ubicacion').textContent = 'â€”');

    // Carga ubicaciones de forma tolerante
    cargarUbicaciones();

    // Pantalla inicial
    showScreen('login');
  });

  // SelecciÃ³n de ubicaciÃ³n
  SELECT && SELECT.addEventListener('change', e=>{
    activarUbicacion(e.target.value || "");
  });

  qs('#btn-login-ingresar') && qs('#btn-login-ingresar').addEventListener('click',()=>{
    const val = SELECT?.value || ubicacionSeleccionada || "";
    if(!val) return;
    activarUbicacion(val);
    showProcessing('Preparando terminal');
    after(800,()=>showScreen('menu'));
  });

  // MenÃº
  qs('#btn-menu-retirar') && qs('#btn-menu-retirar').addEventListener('click',()=>{ 
    showScreen('transaction'); 
    loadRetiroCurrencies(); 
    txCtx.modo = 'retiro';
  });

  qs('#btn-menu-deposito') && qs('#btn-menu-deposito').addEventListener('click',()=>{ 
    showScreen('deposit'); 
    txCtx.modo = 'deposito';
  });

  qs('#btn-menu-salir') && qs('#btn-menu-salir').addEventListener('click',()=>{ showScreen('login'); });

  qs('#btn-retirar-cancelar') && qs('#btn-retirar-cancelar').addEventListener('click',()=> showScreen('menu'));
  qs('#btn-depo-cancelar') && qs('#btn-depo-cancelar').addEventListener('click',()=> showScreen('menu'));

  // Confirmar RETIRO â†’ valida cÃ³digo y restringe moneda a la de la transacciÃ³n
  qs('#btn-retirar-confirmar') && qs('#btn-retirar-confirmar').addEventListener('click', async ()=>{
    const code = (qs('#transaction-number')?.value || '').trim();
    if(!code) return;
    showProcessing('Validando cÃ³digo de operaciÃ³n');
    try{
      const info = await validarCodigo(code, 'retiro');
      txCtx.modo = 'retiro';
      txCtx.code = code;
      txCtx.moneda = info.moneda;
      txCtx.monto = info.monto;
      txCtx.raw = info;

      qsa('#retiro-currency-list .currency-chip').forEach(ch=>{
        if (ch.dataset.code === info.moneda){
          ch.classList.add('match');
        }else{
          ch.classList.add('dimmed');
        }
      });

      confirmOperationView(
        `Retirar ${formatAmount(info.monto, info.moneda)} de la transacciÃ³n ${info.codigo}.`
      );
    }catch(err){
      qs('#cancel-sub') && (qs('#cancel-sub').textContent = String(err.message || err) || 'No se pudo validar.');
      showScreen('cancel');
    }
  });

  // Confirmar DEPÃ“SITO â†’ valida cÃ³digo
  qs('#btn-depo-confirmar') && qs('#btn-depo-confirmar').addEventListener('click', async ()=>{
    const code = (qs('#deposit-tx')?.value || '').trim();
    if(!code) return;
    showProcessing('Validando cÃ³digo de operaciÃ³n');
    try{
      const info = await validarCodigo(code, 'deposito');
      txCtx.modo = 'deposito';
      txCtx.code = code;
      txCtx.moneda = info.moneda;
      txCtx.monto = info.monto;
      txCtx.raw = info;

      confirmOperationView(
        `Depositar ${formatAmount(info.monto, info.moneda)} para la transacciÃ³n ${info.codigo}.`
      );
    }catch(err){
      qs('#cancel-sub') && (qs('#cancel-sub').textContent = String(err.message || err) || 'No se pudo validar.');
      showScreen('cancel');
    }
  });

  // ConfirmaciÃ³n final
  qs('#btn-amount-confirm') && qs('#btn-amount-confirm').addEventListener('click', ()=>{
    if(!txCtx.modo) return;
    const lines = [
      `OperaciÃ³n: ${txCtx.modo.toUpperCase()}`,
      `CÃ³digo: ${txCtx.code}`,
      `Moneda: ${txCtx.moneda}`,
      `Monto: ${txCtx.monto}`,
      `Fecha: ${(new Date()).toLocaleString('es-PY')}`,
    ];
    prepareReceipt(null, lines);

    if(txCtx.modo === 'retiro'){
      dispenseBills();
      showProcessing('Entregando billetes');
      after(2600, ()=>{
        showScreen('success');
        qs('#success-message') && (qs('#success-message').textContent = `Retiro de ${formatAmount(txCtx.monto, txCtx.moneda)} completado.`);
      });
    }else{
      insertBills();
      showProcessing('Recibiendo billetes');
      after(3200, ()=>{
        showScreen('success');
        qs('#success-message') && (qs('#success-message').textContent = `DepÃ³sito de ${formatAmount(txCtx.monto, txCtx.moneda)} registrado.`);
      });
    }
  });

  // Otros botones
  qs('#btn-amount-cancel') && qs('#btn-amount-cancel').addEventListener('click', ()=> showScreen('menu'));
  qs('#btn-success-exit') && qs('#btn-success-exit').addEventListener('click', ()=> showScreen('menu'));
  qs('#btn-cancel-exit') && qs('#btn-cancel-exit').addEventListener('click', ()=> showScreen('menu'));
  qs('#btn-success-print') && qs('#btn-success-print').addEventListener('click', ()=> printReceipt());

  /* Teclado lateral â†’ escribe en input activo (si es un <input>) */
  let activeInput = null;
  ['#transaction-number', '#deposit-tx'].forEach(sel=>{
    qs(sel) && qs(sel).addEventListener('focus', e=> activeInput = e.target);
    qs(sel) && qs(sel).addEventListener('blur',  e=> activeInput = null);
  });
  qsa('.ted-key').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const k = btn.dataset.key;
      if(!activeInput) return;
      if(k==='a'){ activeInput.value += 'A'; return; }
      if(k==='b'){ activeInput.value += 'B'; return; }
      if(k==='c'){ activeInput.value += 'C'; return; }
      if(k==='d'){ activeInput.value = activeInput.value.slice(0,-1); return; }  // backspace
      if(k==='e'){ return; } // reservado
      if(k==='f'){ return; } // reservado
      activeInput.value += k;
      activeInput.dispatchEvent(new Event('input',{bubbles:true}));
    });
  });

})();
</script>
{% endblock %}
