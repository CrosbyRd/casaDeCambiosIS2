{% extends "base.html" %}
{% load static %}
{% block title %}Global Exchange{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/ted.css' %}"/>

<!-- Estilos mínimos SOLO para el bloque de confirmación -->
<style>
  .confirm-box{
    display:none;
    margin:18px auto 8px auto;
    max-width:640px;
    background:linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.03));
    border:1.5px solid rgba(255,255,255,0.16);
    border-radius:18px;
    padding:18px 20px;
    box-shadow:0 6px 20px rgba(0,0,0,0.25) inset, 0 10px 30px rgba(0,0,0,0.10);
  }
  .confirm-box .cb-top{
    display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:6px;
  }
  .confirm-box .cb-chip{
    display:inline-flex; align-items:center; gap:8px;
    padding:6px 10px; border-radius:999px;
    background:rgba(255,255,255,0.10); border:1px solid rgba(255,255,255,0.18);
    font-weight:700; letter-spacing:.3px;
  }
  .confirm-box .cb-flag{ font-size:18px; line-height:1; }
  .confirm-box .cb-code{ opacity:.95 }
  .confirm-box .cb-mode{ font-size:14px; opacity:.85 }
  .confirm-box .cb-value{
    font-weight:900; line-height:1.15; letter-spacing:.2px;
    font-size:36px; margin:6px 0 2px 0;
    text-shadow:0 1px 0 rgba(0,0,0,0.35);
  }
  .confirm-box .cb-value .cb-code{
    font-size:18px; font-weight:800; margin-left:6px; opacity:.9;
  }
  .confirm-box .cb-sub{
    margin-top:6px; font-size:14px; opacity:.9;
  }
  #confirm-amount-text.hidden { display:none !important; }
</style>

<style>
/* ===== Variantes de título "Confirmación" (elige UNA en el HTML) ===== */
.confirm-title { text-align:center; margin:0 0 10px; }

/* Opción 1: CHIP con ícono */
.confirm-title--chip{
  display:inline-flex; align-items:center; gap:10px;
  padding:8px 14px; border-radius:999px; margin:auto;
  background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04));
  border:1px solid rgba(255,255,255,.18);
  box-shadow: 0 6px 20px rgba(0,0,0,.25) inset, 0 8px 20px rgba(91,64,255,.20);
  font-weight:800; letter-spacing:.2px;
}
.ct-badge{
  width:28px; height:28px; display:grid; place-items:center; border-radius:999px;
  background:radial-gradient(circle at 35% 30%, #a78bfa, #6d28d9 70%);
  border:1px solid rgba(255,255,255,.35);
  box-shadow: inset 0 2px 6px rgba(0,0,0,.35), 0 0 10px rgba(109,40,217,.35);
  font-size:14px;
}

/* Opción 2: Texto con gradiente + subrayado brillante */
.confirm-title--gradient{
  display:inline-block; margin:auto; font-weight:900; letter-spacing:.3px;
  font-size:22px;
  background:linear-gradient(90deg,#c4b5fd,#a78bfa,#c4b5fd);
  -webkit-background-clip:text; background-clip:text; color:transparent;
  position:relative; text-transform:uppercase;
}
.confirm-title--gradient::after{
  content:""; display:block; width:120px; height:3px; margin:8px auto 0;
  background:linear-gradient(90deg, transparent, #a78bfa, transparent);
  border-radius:99px; box-shadow:0 0 16px rgba(167,139,250,.6);
}

/* Opción 3: Cinta/Ribbon */
.confirm-title--ribbon{
  display:inline-block; margin:auto; padding:8px 18px; color:#fff; font-weight:800;
  background:linear-gradient(180deg,#6d28d9,#5b21b6); border-radius:10px;
  box-shadow:0 10px 24px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.15);
  position:relative; letter-spacing:.2px;
}
.confirm-title--ribbon::before, .confirm-title--ribbon::after{
  content:""; position:absolute; top:100%; width:0; height:0; border:8px solid transparent;
}
.confirm-title--ribbon::before{ left:14px; border-top-color:#4c1d95; }
.confirm-title--ribbon::after { right:14px; border-top-color:#4c1d95; }
</style>


<main style="max-width:1100px;margin:0 auto;padding:24px">
  <section class="ted-machine">
    <div class="ted-layout">
      <!-- Pantalla principal -->
      <div class="ted-layout-main">
        <div class="ted-screen">
          <div class="ted-screen-glow"></div>

          <div class="ted-screen-inner">
            <!-- Cabecera -->
            <header class="ted-header">
              <div class="logo-badge">
                <img class="ted-logo" src="{% static 'img/logo-secundario.png' %}" alt="Global Exchange">
              </div>
              <div class="welcome-badge" id="welcome-badge">👋 Bienvenido</div>
              <h1 class="ted-title">GLOBAL EXCHANGE</h1>
            </header>

            <!-- Vistas -->
            <div class="ted-views-container">
              <!-- VISTA: Inicio -->
              <section id="login-screen" class="ted-screen-view active" aria-live="polite">
                <div class="view-content">
                  <p>Hola,
                    <strong>{% firstof request.user.get_full_name request.user.username request.user.email "Usuario" %}</strong>.
                  </p>

                  <div class="location-picker">
                    <label for="select-ubicacion" class="location-label">Ubicación del TED</label>
                    <select id="select-ubicacion" class="ted-select" aria-required="true">
                      <option value="">— Seleccioná una sucursal —</option>
                    </select>
                    <p class="location-hint">Para continuar al menu de operaciones.</p>
                  </div>

                  <button class="gx-btn" type="button" id="btn-login-ingresar" disabled>Continuar</button>
                </div>
              </section>

              <!-- VISTA: Menú -->
              <section id="menu-screen" class="ted-screen-view" aria-live="polite">
                <div class="view-content">
                  <h2 style="text-align:center;margin-bottom:12px">Operaciones disponibles</h2>
                  <div class="menu-grid">
                    <button id="btn-menu-retirar" type="button" class="menu-card" aria-label="Retiro de dinero">
                      <div class="menu-icon">💵</div>
                      <div class="menu-label">Retiro de Dinero</div>
                    </button>
                    <button id="btn-menu-deposito" type="button" class="menu-card" aria-label="Depósito de dinero">
                      <div class="menu-icon">💰</div>
                      <div class="menu-label">Depósito de Dinero</div>
                    </button>
                  </div>
                  <div style="text-align:center;margin-top:16px">
                    <button id="btn-menu-salir" type="button" class="gx-btn gx-btn--ghost">🚪 Salir</button>
                  </div>
                </div>
              </section>

              <!-- VISTA: Retiro -->
              <section id="transaction-screen" class="ted-screen-view" aria-live="polite">
                <div class="view-content">
                  <h3>Retiro de Dinero</h3>
                  <label for="transaction-number">Ingrese número de transacción</label>
                  <input id="transaction-number" type="text" class="ted-input" placeholder="Código de operación"/>

                  <div class="currency-section">
                    <div class="currency-label">Divisas disponibles</div>
                    <div id="retiro-currency-list" class="currency-list"></div>
                  </div>

                  <div class="button-group">
                    <button class="gx-btn gx-btn--ghost" type="button" id="btn-retirar-cancelar">Cancelar</button>
                    <button class="gx-btn" type="button" id="btn-retirar-confirmar">Confirmar</button>
                  </div>
                </div>
              </section>

              <!-- VISTA: Depósito -->
              <section id="deposit-screen" class="ted-screen-view" aria-live="polite">
                <div class="view-content">
                  <h3>Depósito de Dinero</h3>
                  <label for="deposit-tx">Ingrese número de transacción</label>
                  <input id="deposit-tx" type="text" class="ted-input" placeholder="Código de operación"/>
                  <div class="button-group">
                    <button class="gx-btn gx-btn--ghost" type="button" id="btn-depo-cancelar">Cancelar</button>
                    <button class="gx-btn" type="button" id="btn-depo-confirmar">Confirmar</button>
                  </div>
                </div>
              </section>

              <!-- VISTA: Procesando -->
              <section id="processing-screen" class="ted-screen-view" aria-live="polite">
                <div class="view-content view-content--centered">
                  <div class="processing-text">
                    <span id="processing-message">Procesando</span><span class="processing-dots"></span>
                  </div>
                </div>
              </section>

              <!-- VISTA: Confirmación de monto -->
              <section id="confirm-amount-screen" class="ted-screen-view" aria-live="polite">
                <div class="view-content view-content--centered">
                  <div class="confirm-title">
  <span class="confirm-title--gradient">Confirmación</span>
</div>

                  <!-- NUEVO bloque visual -->
                  <div id="confirm-amount-box" class="confirm-box" aria-live="polite"></div>

                  <!-- Fallback de texto plano (se ocultará si hay box) -->
                  <div id="confirm-amount-text" class="confirm-text">¿Desea confirmar la operación?</div>

                  <div class="button-group">
                    <button class="gx-btn gx-btn--ghost" type="button" id="btn-amount-cancel">Cancelar</button>
                    <button class="gx-btn" type="button" id="btn-amount-confirm">Confirmar</button>
                  </div>
                </div>
              </section>

              <!-- VISTA: Éxito -->
              <section id="success-screen" class="ted-screen-view" aria-live="polite">
                <div class="view-content view-content--centered">
                  <div class="status-title status-title--success">¡Operación exitosa!</div>
                  <!-- Tarjeta de resultado -->
                  <div id="success-amount-box" class="result-box" aria-live="polite"></div>
                  <div id="success-message" class="status-message">Listo.</div>
                  <div class="button-group">
                    <button class="gx-btn gx-btn--ghost" type="button" id="btn-success-exit">Salir</button>
                    <button class="gx-btn" type="button" id="btn-success-print">Imprimir ticket</button>
                  </div>
                </div>
              </section>

              <!-- VISTA: Cancelado / Error -->
              <section id="cancel-screen" class="ted-screen-view" aria-live="polite">
                <div class="view-content view-content--centered">
                  <div class="status-title status-title--cancel">Operación cancelada</div>
                  <div id="cancel-sub" class="status-message">Recoja su dinero.</div>
                  <button class="gx-btn gx-btn--ghost" type="button" id="btn-cancel-exit">Salir</button>
                </div>
              </section>
            </div><!-- /ted-views-container -->
          </div>
        </div>
      </div>

      <!-- Panel lateral (reloj + teclado) -->
      <aside class="ted-layout-aside">
        <div class="pad-info-card">
          <div class="clock" id="ted-clock">--:--:--</div>
          <div class="info-line">Nº de serie: <strong id="info-serie">—</strong></div>
          <div class="info-line">Ubicación: <strong id="info-ubicacion">—</strong></div>
        </div>

        <div class="pad-bezel">
          <div class="ted-pad" aria-label="Teclado">
            <div class="grid">
              {% for key in "123a456b789c0def" %}
              <button class="ted-key" type="button" data-key="{{ key }}">{{ key }}</button>
              {% endfor %}
            </div>
          </div>
        </div>
      </aside>
    </div>

    <!-- Ranuras -->
    <div class="slots-container">
      <div id="bill-slot" class="ted-slot">
        <div class="slot-opening"></div>
        <div class="slot-indicator"></div>
        <div class="bill-stack">
          <div class="bill-item" style="animation-delay:0s">$100</div>
          <div class="bill-item" style="animation-delay:0.15s">$100</div>
          <div class="bill-item" style="animation-delay:0.3s">$100</div>
          <div class="bill-item" style="animation-delay:0.45s">$100</div>
        </div>
        <div class="slot-label">Ranura de billetes</div>
      </div>

      <div id="receipt-slot" class="ted-slot">
        <div class="slot-opening"></div>
        <div class="slot-indicator"></div>
        <div class="receipt-anim">
          <div class="receipt-paper">
            <div class="receipt-header">GLOBAL EXCHANGE</div>
            <div id="receipt-body"></div>
          </div>
        </div>
        <div class="slot-label">Salida de tickets</div>
      </div>
    </div>
  </section>
</main>

<script>
(function(){
  const qs=(s,c=document)=>c.querySelector(s);
  const qsa=(s,c=document)=>Array.from(c.querySelectorAll(s));
  const after=(ms,fn)=>setTimeout(fn,ms);

  /* CSRF */
  function getCookie(name){
    const value=`; ${document.cookie}`;
    const parts=value.split(`; ${name}=`);
    if(parts.length===2) return parts.pop().split(';').shift();
  }
  const csrfToken=getCookie('csrftoken');

  /* Reloj */
  function startClock(){
    try{
      const el=qs('#ted-clock'); if(!el) return;
      const fmt=new Intl.DateTimeFormat('es-PY',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
      const tick=()=>{ el.textContent=fmt.format(new Date()); };
      tick(); setInterval(tick,1000);
    }catch(e){
      const el=qs('#ted-clock'); if(!el) return;
      const pad=n=>String(n).padStart(2,'0');
      const tick=()=>{
        const d=new Date();
        el.textContent=`${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
      };
      tick(); setInterval(tick,1000);
    }
  }

  /* Pantallas */
  function showScreen(name){
    qsa('.ted-screen-view').forEach(v=>v.classList.remove('active'));
    const screen = qs('#'+name+'-screen');
    if(screen) screen.classList.add('active');
    // ← pintar la tarjeta cuando entremos a la pantalla de éxito
if (name === 'success') { try { renderSuccessBox(); } catch(e) { console.error(e); } }
    // Limpia cualquier animación residual en las ranuras
    qsa('.ted-slot').forEach(s=>s.classList.remove('active','dispensing-bills','printing-receipt','inserting-bills'));
    const welcomeBadge = qs('#welcome-badge');
    const header = qs('.ted-header');
    if(welcomeBadge){
      if(name === 'login'){
        welcomeBadge.classList.remove('hidden');
        header && header.classList.remove('compact');
      } else {
        welcomeBadge.classList.add('hidden');
        header && header.classList.add('compact');
      }
    }
  }
  function showProcessing(msg){ 
    const msgEl = qs('#processing-message');
    if(msgEl) msgEl.textContent=msg; 
    showScreen('processing'); 
  }

  /* === Helpers de animación de ranura === */
  function restartBillAnimation(mode){ // mode: 'out' | 'in'
    const slot = qs('#bill-slot'); if(!slot) return;
    // Limpia clases previas
    slot.classList.remove('dispensing-bills','inserting-bills');
    // Reinicia anim de cada billete para permitir re-disparo
    qsa('#bill-slot .bill-item').forEach(el=>{
      el.style.animation='none';
      // fuerza reflow
      void el.offsetWidth;
      el.style.animation='';
    });
    // fuerza reflow del contenedor
    void slot.offsetWidth;
    slot.classList.add('active', mode==='out' ? 'dispensing-bills' : 'inserting-bills');
  }
function dispenseBills(){
  const slot = document.querySelector('#bill-slot');
  if(!slot) return;

  // Programar para el siguiente frame (después de mostrar "Procesando")
  requestAnimationFrame(()=> {
    requestAnimationFrame(()=> {
      restartBillAnimation('out');            // ← añade .dispensing-bills
      setTimeout(()=>{ 
        slot.classList.remove('dispensing-bills'); 
      }, 2600);
    });
  });
}

function insertBills(){
  const slot = document.querySelector('#bill-slot');
  if(!slot) return;

  // Programar para el siguiente frame (después de mostrar "Procesando")
  requestAnimationFrame(()=> {
    requestAnimationFrame(()=> {
      restartBillAnimation('in');             // ← añade .inserting-bills
      setTimeout(()=>{ 
        slot.classList.remove('inserting-bills'); 
      }, 3200);
    });
  });
}

  /* Ticket */
  let lastReceipt={lines:[]};
  function prepareReceipt(_t,lines){ lastReceipt={lines}; }
  function printReceipt(){
    const slot=qs('#receipt-slot'), rc=qs('#receipt-body'); 
    if(!slot||!rc) return;
    rc.innerHTML='';
    (lastReceipt.lines||[]).forEach((line,i)=>{
      const d=document.createElement('div');
      d.className='receipt-line';
      d.textContent=line;
      d.style.animationDelay=(i*0.15)+'s';
      rc.appendChild(d);
    });
    slot.classList.add('active','printing-receipt');
    after(3800,()=>slot.classList.remove('printing-receipt'));
  }

  /* Ubicación seleccionada */
  const SELECT = qs('#select-ubicacion');
  let ubicacionSeleccionada = "";
  try { ubicacionSeleccionada = sessionStorage.getItem('ted_ubicacion') || ""; } catch(e) {}

  function activarUbicacion(ubic){
    ubicacionSeleccionada = ubic || "";
    try { sessionStorage.setItem('ted_ubicacion', ubicacionSeleccionada); } catch(e) {}
    const infoUb=qs('#info-ubicacion'); if(infoUb) infoUb.textContent = ubicacionSeleccionada || '—';
    const infoSe=qs('#info-serie');     if(infoSe) infoSe.textContent     = ubicacionSeleccionada ? 'TED-AGSL-0001' : '—';
    const btnLogin=qs('#btn-login-ingresar'); if(btnLogin) btnLogin.disabled = !ubicacionSeleccionada;
  }

  // Normaliza respuestas
  function pickUbicaciones(data){
    if(Array.isArray(data)) return data;
    if(data && Array.isArray(data.ubicaciones)) return data.ubicaciones;
    if(data && Array.isArray(data.data)) return data.data;
    if(data && Array.isArray(data.results)) return data.results;
    return [];
  }

  async function cargarUbicaciones(){
    const url = "{% url 'admin_panel:ted:ubicaciones_disponibles' %}";
    try{
      const res = await fetch(url, {credentials:'same-origin'});
      if(!res.ok) throw new Error('HTTP '+res.status);
      const data = await res.json();
      const lista = pickUbicaciones(data);

      if(SELECT){
        SELECT.innerHTML = '<option value="">— Seleccioná una ubicación —</option>';
        lista.forEach(u=>{
          const opt=document.createElement('option');
          opt.value=u; opt.textContent=u;
          if (u===ubicacionSeleccionada) opt.selected=true;
          SELECT.appendChild(opt);
        });
      }
      activarUbicacion(SELECT?.value || ubicacionSeleccionada || "");
    }catch(e){
      console.error('No se pudieron cargar ubicaciones:', e);
      activarUbicacion(ubicacionSeleccionada || "");
    }
  }

  /* Monedas por ubicación (para Retiro - UI informativa) */
  const FLAGS={USD:'🇺🇸',EUR:'🇪🇺',ARS:'🇦🇷',BRL:'🇧🇷',PYG:'🇵🇾',CNY:'🇨🇳',JPY:'🇯🇵',GBP:'🇬🇧',UYU:'🇺🇾',CLP:'🇨🇱',COP:'🇨🇴',BOB:'🇧🇴',PEN:'🇵🇪',MXN:'🇲🇽',CAD:'🇨🇦',AUD:'🇦🇺',CHF:'🇨🇭',VES:'🇻🇪',VEF:'🇻🇪',RUB:'🇷🇺',ILS:'🇮🇱',CRC:'🇨🇷',DOP:'🇩🇴',NOK:'🇳🇴',SEK:'🇸🇪',DKK:'🇩🇰',ZAR:'🇿🇦',HNL:'🇭🇳',GTQ:'🇬🇹',PAB:'🇵🇦',NIO:'🇳🇮',TRY:'🇹🇷',INR:'🇮🇳',KRW:'🇰🇷',SGD:'🇸🇬',HKD:'🇭🇰'};
  const flag = c => FLAGS[c] || c;

  async function loadRetiroCurrencies(){
    const cont = qs('#retiro-currency-list'); 
    if(!cont) return;
    cont.textContent = 'Cargando...';
    try{
      const q = ubicacionSeleccionada ? ('?ubicacion=' + encodeURIComponent(ubicacionSeleccionada)) : '';
      const res = await fetch("{% url 'admin_panel:ted:monedas_disponibles' %}"+q, {credentials:'same-origin'});
      if(!res.ok) throw new Error('HTTP '+res.status);
      const data = await res.json();
      const monedas = Array.isArray(data.monedas) ? data.monedas
                    : Array.isArray(data.data) ? data.data
                    : Array.isArray(data.results) ? data.results
                    : Array.isArray(data) ? data
                    : [];
      cont.innerHTML = '';
      if(!monedas.length){ 
        cont.textContent='Sin divisas disponibles.'; 
        return; 
      }
      monedas.forEach(code=>{
        const chip=document.createElement('span');
        chip.className='currency-chip';
        chip.title=code;
        chip.textContent=flag(code);
        chip.dataset.code=code;
        cont.appendChild(chip);
      });
    }catch(e){
      console.error('No se pudieron cargar monedas:', e);
      cont.textContent='No se pudo cargar.';
    }
  }

  /* Estado transaccional local (TED) */
  const txCtx = {
    modo: null,         // 'retiro' | 'deposito'
    code: null,         // código ingresado
    moneda: null,       // código ISO p.ej. USD
    monto: null,        // string (será formateado)
    raw: null           // payload completo del backend
  };

  function formatAmountRaw(a){
    try{
      const n = Number(a);
      if (Number.isFinite(n)){
        return new Intl.NumberFormat('es-PY',{maximumFractionDigits:2}).format(n);
      }
    }catch(e){}
    return String(a);
  }
  function formatAmount(a, code){
    return `${formatAmountRaw(a)} ${code}`;
  }

  async function validarCodigo(code, modo){
    const res = await fetch("{% url 'usuarios:ted_api_validar' %}", {
      method:'POST',
      credentials:'same-origin',
      headers:{'Content-Type':'application/json','X-CSRFToken':csrfToken},
      body: JSON.stringify({codigo: code, modo})
    });
    const data = await res.json();
    if(!res.ok || !data.ok) throw new Error(data.error || 'Error de validación');
    return data.data;
  }

  // === Bloque visual de confirmación (con bandera y monto grande) ===
  function renderConfirmBox(){
    const box = qs('#confirm-amount-box');
    const textEl = qs('#confirm-amount-text');
    if(!box) return;

    if(txCtx && txCtx.moneda && txCtx.monto){
      const emoji = flag(txCtx.moneda);
      const modoLabel = txCtx.modo === 'deposito' ? 'Depósito' : 'Retiro';
      const amount = formatAmountRaw(txCtx.monto);
      const code = txCtx.code || (txCtx.raw && txCtx.raw.codigo) || '';

      box.innerHTML = `
        <div class="cb-top">
          <span class="cb-chip"><span class="cb-flag">${emoji}</span><span class="cb-code">${txCtx.moneda}</span></span>
          <div class="cb-mode">${modoLabel}</div>
        </div>
        <div class="cb-value"><span class="cb-number">${amount}</span> <span class="cb-code">${txCtx.moneda}</span></div>
        <div class="cb-sub">Transacción <code>${code}</code></div>
      `;
      box.style.display = 'block';
      textEl && textEl.classList.add('hidden'); // ocultar fallback
    }else{
      box.style.display = 'none';
      box.innerHTML = '';
      textEl && textEl.classList.remove('hidden');
    }
  }

  function renderSuccessBox(){
  const box = document.querySelector('#success-amount-box');
  const textEl = document.querySelector('#success-message');
  if(!box) return;

  if(txCtx && txCtx.moneda && txCtx.monto){
    const emoji = (typeof flag === 'function') ? flag(txCtx.moneda) : txCtx.moneda;
    const modoLabel = txCtx.modo === 'deposito' ? 'Depósito' : 'Retiro';
    const amount = (typeof formatAmountRaw === 'function') ? formatAmountRaw(txCtx.monto) : String(txCtx.monto);
    const code = txCtx.code || (txCtx.raw && txCtx.raw.codigo) || '';

    box.innerHTML = `
      <div class="rb-top">
        <span class="rb-chip"><span class="rb-flag">${emoji}</span><span class="rb-code">${txCtx.moneda}</span></span>
        <div class="rb-mode">${modoLabel} completado</div>
      </div>
      <div class="rb-value"><span class="rb-number">${amount}</span> <span class="rb-code">${txCtx.moneda}</span></div>
      <div class="rb-sub">${modoLabel} de la transacción <code>${code}</code></div>
    `;
    box.style.display = 'block';
    if(textEl) textEl.classList.add('hidden'); 
  }else{
    box.style.display = 'none';
    box.innerHTML = '';
    if(textEl) textEl.classList.remove('hidden');
  }
}

  function confirmOperationView(text){
    const el = qs('#confirm-amount-text');
    if(el && text){ el.textContent = text; }
    showScreen('confirm-amount');
    renderConfirmBox();
  }

  /* Navegación / bindings */
  document.addEventListener('DOMContentLoaded',()=>{
    startClock();
    qs('#info-serie') && (qs('#info-serie').textContent = '—');
    qs('#info-ubicacion') && (qs('#info-ubicacion').textContent = '—');
    cargarUbicaciones();
    showScreen('login');
  });

  SELECT && SELECT.addEventListener('change', e=>{
    activarUbicacion(e.target.value || "");
  });

  qs('#btn-login-ingresar') && qs('#btn-login-ingresar').addEventListener('click',()=>{
    const val = SELECT?.value || ubicacionSeleccionada || "";
    if(!val) return;
    activarUbicacion(val);
    showProcessing('Preparando terminal');
    after(800,()=>showScreen('menu'));
  });

  // Menú
  qs('#btn-menu-retirar') && qs('#btn-menu-retirar').addEventListener('click',()=>{ 
    showScreen('transaction'); 
    loadRetiroCurrencies(); 
    txCtx.modo = 'retiro';
  });

  qs('#btn-menu-deposito') && qs('#btn-menu-deposito').addEventListener('click',()=>{ 
    showScreen('deposit'); 
    txCtx.modo = 'deposito';
  });

  qs('#btn-menu-salir') && qs('#btn-menu-salir').addEventListener('click',()=>{ showScreen('login'); });

  qs('#btn-retirar-cancelar') && qs('#btn-retirar-cancelar').addEventListener('click',()=> showScreen('menu'));
  qs('#btn-depo-cancelar') && qs('#btn-depo-cancelar').addEventListener('click',()=> showScreen('menu'));

  // Confirmar RETIRO  (mostrar processing -> disparar animación)
  qs('#btn-retirar-confirmar') && qs('#btn-retirar-confirmar').addEventListener('click', async ()=>{
    const code = (qs('#transaction-number')?.value || '').trim();
    if(!code) return;
    showProcessing('Validando código de operación');
    try{
      const info = await validarCodigo(code, 'retiro');
      txCtx.modo = 'retiro';
      txCtx.code = code;
      txCtx.moneda = info.moneda;
      txCtx.monto = info.monto;
      txCtx.raw = info;

      qsa('#retiro-currency-list .currency-chip').forEach(ch=>{
        if (ch.dataset.code === info.moneda){ ch.classList.add('match'); }
        else{ ch.classList.add('dimmed'); }
      });

      confirmOperationView(
        `Retirar ${formatAmount(info.monto, info.moneda)} de la transacción ${info.codigo}.`
      );
    }catch(err){
      qs('#cancel-sub') && (qs('#cancel-sub').textContent = String(err.message || err) || 'No se pudo validar.');
      showScreen('cancel');
    }
  });

  // Confirmar DEPÓSITO  (mostrar processing -> disparar animación)
  qs('#btn-depo-confirmar') && qs('#btn-depo-confirmar').addEventListener('click', async ()=>{
    const code = (qs('#deposit-tx')?.value || '').trim();
    if(!code) return;
    showProcessing('Validando código de operación');
    try{
      const info = await validarCodigo(code, 'deposito');
      txCtx.modo = 'deposito';
      txCtx.code = code;
      txCtx.moneda = info.moneda;
      txCtx.monto = info.monto;
      txCtx.raw = info;

      confirmOperationView(
        `Depositar ${formatAmount(info.monto, info.moneda)} para la transacción ${info.codigo}.`
      );
    }catch(err){
      qs('#cancel-sub') && (qs('#cancel-sub').textContent = String(err.message || err) || 'No se pudo validar.');
      showScreen('cancel');
    }
  });

  // Confirmación final
  qs('#btn-amount-confirm') && qs('#btn-amount-confirm').addEventListener('click', ()=>{
    if(!txCtx.modo) return;

    const lines = [
      `Operación: ${txCtx.modo.toUpperCase()}`,
      `Código: ${txCtx.code}`,
      `Moneda: ${txCtx.moneda}`,
      `Monto: ${txCtx.monto}`,
      `Fecha: ${(new Date()).toLocaleString('es-PY')}`,
    ];
    prepareReceipt(null, lines);

    if(txCtx.modo === 'retiro'){
      // 1) mostramos processing, 2) luego disparamos animación de salida
      showProcessing('Entregando billetes');
      after(30, dispenseBills);
      after(2600, ()=>{
        showScreen('success');
        qs('#success-message') && (qs('#success-message').textContent = `Retiro de ${formatAmount(txCtx.monto, txCtx.moneda)} completado.`);
      });
    }else{
      // 1) mostramos processing, 2) luego disparamos animación de inserción
      showProcessing('Recibiendo billetes');
      after(30, insertBills);
      after(3200, ()=>{
        showScreen('success');
        qs('#success-message') && (qs('#success-message').textContent = `Depósito de ${formatAmount(txCtx.monto, txCtx.moneda)} registrado.`);
      });
    }
  });

  // Otros botones
  qs('#btn-amount-cancel') && qs('#btn-amount-cancel').addEventListener('click', ()=> showScreen('menu'));
  qs('#btn-success-exit') && qs('#btn-success-exit').addEventListener('click', ()=> showScreen('menu'));
  qs('#btn-cancel-exit') && qs('#btn-cancel-exit').addEventListener('click', ()=> showScreen('menu'));
  qs('#btn-success-print') && qs('#btn-success-print').addEventListener('click', ()=> printReceipt());

  /* Teclado lateral */
  let activeInput = null;
  ['#transaction-number', '#deposit-tx'].forEach(sel=>{
    qs(sel) && qs(sel).addEventListener('focus', e=> activeInput = e.target);
    qs(sel) && qs(sel).addEventListener('blur',  e=> activeInput = null);
  });
  qsa('.ted-key').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const k = btn.dataset.key;
      if(!activeInput) return;
      if(k==='a'){ activeInput.value += 'A'; return; }
      if(k==='b'){ activeInput.value += 'B'; return; }
      if(k==='c'){ activeInput.value += 'C'; return; }
      if(k==='d'){ activeInput.value = activeInput.value.slice(0,-1); return; }  // backspace
      if(k==='e'){ return; } // reservado
      if(k==='f'){ return; } // reservado
      activeInput.value += k;
      activeInput.dispatchEvent(new Event('input',{bubbles:true}));
    });
  });

})();
</script>
{% endblock %}