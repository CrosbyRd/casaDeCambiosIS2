{% extends "base.html" %}
{% load format_miles %}

{% block title %}Reporte de Ganancias{% endblock %}

{% block extra_head %}
<style>
    :root {
        --brand:#7c3aed;
        --brand-soft:#ede9fe;
        --brand-hover:#6d28d9;
        --ink:#111827;
        --muted:#6b7280;
        --line:#e5e7eb;
        --shadow-sm:0 2px 8px rgba(124,58,237,.08);
        --shadow-md:0 4px 12px rgba(124,58,237,.12);
        --shadow-lg:0 20px 40px rgba(124,58,237,.15);
    }

    main { max-width:1360px; margin:0 auto; padding:2rem; }

    header h1 { color: var(--ink); }
    header p { color: var(--muted); }

    /* Botones */
    .btn-primary { background:var(--brand); color:#fff; font-weight:600; padding:.6rem 1.2rem; border-radius:10px; transition:.2s; }
    .btn-primary:hover { background:var(--brand-hover); transform:translateY(-1px); }
    .btn-secondary { background:#fff; border:2px solid var(--line); color:var(--muted); padding:.6rem 1.2rem; border-radius:10px; transition:.2s; }
    .btn-secondary:hover { border-color:var(--brand); color:var(--brand); background:var(--brand-soft); }

    /* Filtros */
    .filter-section { background:#fff; border-radius:12px; padding:1.25rem; box-shadow:var(--shadow-sm); border:1px solid var(--line); margin-bottom:1.5rem; }
    .filter-section label { font-weight:600; color:var(--muted); font-size:.875rem; }
    .filter-section input, .filter-section select { width:100%; padding:.5rem .75rem; border-radius:8px; border:1px solid var(--line); transition:.2s; }
    .filter-section input:focus, .filter-section select:focus { border-color:var(--brand); outline:none; box-shadow:0 0 0 3px rgba(124,58,237,.15); }

    /* Hero KPI */
    .metric-hero { background:linear-gradient(135deg,var(--brand),var(--brand-hover)); border-radius:20px; padding:2rem; box-shadow:var(--shadow-lg); text-align:center; margin-bottom:1.5rem; color:#fff; position:relative; overflow:hidden; }
    .metric-hero::before { content:""; position:absolute; top:-50%; right:-20%; width:400px; height:400px; background:radial-gradient(circle,rgba(255,255,255,.15) 0%,transparent 70%); border-radius:50%; }
    .metric-hero-content { position:relative; z-index:1; }
    .metric-hero-icon { font-size:2.5rem; margin-bottom:.5rem; display:inline-block; animation:float 3s ease-in-out infinite; }
    @keyframes float { 0%,100%{transform:translateY(0);} 50%{transform:translateY(-8px);} }
    .metric-hero-label { font-weight:700; text-transform:uppercase; letter-spacing:1px; margin-bottom:.25rem; }
    .metric-hero-value { font-size:2.5rem; font-weight:900; line-height:1.1; text-shadow:0 4px 12px rgba(0,0,0,.2); }
    .metric-hero-currency { font-weight:700; opacity:.85; }

    /* Cards resumen */
    .cards-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:1rem; margin-bottom:1.5rem; }
    .metric-card { background:#fff; border-radius:16px; padding:1.25rem; box-shadow:var(--shadow-sm); border:1px solid var(--line); display:flex; gap:1rem; align-items:center; }
    .metric-card-icon { flex-shrink:0; width:48px; height:48px; background:var(--brand-soft); border-radius:12px; display:flex; justify-content:center; align-items:center; font-size:1.4rem; }
    .metric-card-label { color:var(--muted); font-size:.8rem; font-weight:700; text-transform:uppercase; margin-bottom:.25rem; }
    .metric-card-value { font-weight:800; font-size:1.25rem; color:var(--ink); }
    .metric-card-suffix { font-weight:600; font-size:.85rem; color:var(--brand); }

    /* Tabla */
    table { width:100%; border-collapse:collapse; border-radius:10px; overflow:hidden; }
    thead { background:var(--brand-soft); }
    th { padding:.75rem 1rem; text-align:left; font-size:.75rem; text-transform:uppercase; color:var(--brand); font-weight:700; }
    td { padding:.65rem 1rem; border-bottom:1px solid var(--line); }
    tbody tr:hover { background:var(--brand-soft); }

    /* PaginaciÃ³n */
    .pagination a { padding:.5rem .8rem; border-radius:6px; background:#f3f4f6; transition:.2s; text-decoration:none; color:var(--ink); }
    .pagination a:hover { background:var(--brand-soft); color:var(--brand); }
</style>
{% endblock %}

{% block content %}
<main>

  <header class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-8">
    <div class="text-center sm:text-left">
      <h1 class="text-4xl font-extrabold">ðŸ’¹ Reporte de Ganancias</h1>
      <p class="text-lg leading-relaxed max-w-xl mx-auto sm:mx-0">
        Revisa y analiza las ganancias generadas en tus operaciones de cambio durante el perÃ­odo seleccionado.
      </p>
    </div>

    <div class="flex justify-center sm:justify-end mt-4 sm:mt-0 gap-3">
      <a href="{% url 'reportes:panel_reportes' %}" class="btn-secondary">â¬… Volver al Panel de Reportes</a>
    </div>
  </header>

  <!-- FILTROS -->
  <section class="filter-section">
    <h2 class="text-lg font-semibold mb-2">Filtrar flujo de ganancias</h2>
    <form method="get" class="grid grid-cols-1 md:grid-cols-6 gap-4 items-end">
      <div>
        <label>Fecha Inicio</label>
        <input type="date" name="fecha_inicio" value="{{ request.GET.fecha_inicio }}">
      </div>
      <div>
        <label>Fecha Fin</label>
        <input type="date" name="fecha_fin" value="{{ request.GET.fecha_fin }}">
      </div>
      <div>
        <label>Tipo de operaciÃ³n</label>
        <select name="tipo" onchange="this.form.submit()">
          <option value="">-- Todos --</option>
          <option value="venta" {% if request.GET.tipo == 'venta' %}selected{% endif %}>Venta de Divisa</option>
          <option value="compra" {% if request.GET.tipo == 'compra' %}selected{% endif %}>Compra de Divisa</option>
        </select>
      </div>
      <div>
        <label>Moneda</label>
        <select name="moneda" onchange="this.form.submit()">
          <option value="">-- Todas --</option>
          {% for m in monedas %}
            {% if m.codigo != "PYG" %}
              <option value="{{ m.codigo }}" {% if request.GET.moneda == m.codigo %}selected{% endif %}>
                {{ m.nombre }} ({{ m.codigo }})
              </option>
            {% endif %}
          {% endfor %}
        </select>
      </div>
      <div>
        <label>Cliente</label>
        <input type="text" name="cliente" value="{{ request.GET.cliente }}" placeholder="Nombre cliente">
      </div>
      <div class="flex space-x-2">
        <button type="submit" class="btn-primary">Filtrar</button>
        <a href="{% url 'reportes:reporte_ganancias' %}" class="btn-secondary">Limpiar</a>
      </div>
    </form>
  </section>

  <!-- DESCARGAS -->
  <div class="flex justify-end items-center mb-4 space-x-2">
    <a href="{% url 'reportes:reporte_ganancias_pdf' %}?{{ request.GET.urlencode }}" class="btn-primary">ðŸ“„ Descargar PDF</a>
    <a href="{% url 'reportes:reporte_ganancias_excel' %}?{{ request.GET.urlencode }}" class="btn-primary">ðŸ“Š Exportar Excel</a>
  </div>

  <!-- HERO KPI -->
  <section class="metric-hero">
    <div class="metric-hero-content">
      <div class="metric-hero-icon">ðŸ’µ</div>
      <div class="metric-hero-label">Ganancia Total</div>
      <div class="metric-hero-value">{{ total_ganancia|floatformat:0|format_miles }}</div>
      <div class="metric-hero-currency">Gs</div>
    </div>
  </section>

  <!-- RESUMEN -->
  <div class="cards-grid">
    <div class="metric-card">
      <div class="metric-card-icon">ðŸ’°</div>
      <div>
        <div class="metric-card-label">Total Ventas</div>
        <div class="metric-card-value">{{ total_ventas|floatformat:0|format_miles }} Gs</div>
      </div>
    </div>
    <div class="metric-card">
      <div class="metric-card-icon">ðŸ›’</div>
      <div>
        <div class="metric-card-label">Total Compras</div>
        <div class="metric-card-value">{{ total_compras|floatformat:0|format_miles }} Gs</div>
      </div>
    </div>
    <div class="metric-card">
      <div class="metric-card-icon">ðŸ“Š</div>
      <div>
        <div class="metric-card-label">Clientes Analizados</div>
        <div class="metric-card-value">{{ page_obj|length }}</div>
      </div>
    </div>
  </div>

  <!-- TABLA -->
  <div class="overflow-x-auto bg-white shadow rounded-lg border border-gray-100">
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Cliente</th>
          <th>Tipo</th>
          <th>Monto Origen</th>
          <th>Moneda</th>
          <th>Tasa aplicada</th>
          <th>Monto Destino</th>
          <th>ComisiÃ³n</th>
          <th>Ganancia (PYG)</th>
          <th>Fecha</th>
        </tr>
      </thead>
      <tbody>
        {% for t in page_obj %}
        <tr>
          <td>{{ forloop.counter0|add:page_obj.start_index }}</td>
          <td>{{ t.cliente }}</td>
          <td>
            {% if t.tipo_operacion == "venta" %}
              <span class="text-green-700 font-semibold">Venta</span>
            {% else %}
              <span class="text-red-700 font-semibold">Compra</span>
            {% endif %}
          </td>
          <td class="text-right">{{ t.monto_origen|floatformat:0|format_miles }}</td>
          <td>
            {% if t.tipo_operacion == "venta" %}
              {{ t.moneda_destino.codigo }}
            {% else %}
              {{ t.moneda_origen.codigo }}
            {% endif %}
          </td>

          <td class="text-right">{{ t.tasa_cambio_aplicada|floatformat:0|format_miles }}</td>
          <td class="text-right">{{ t.monto_destino|floatformat:0|format_miles }}</td>
          <td class="text-right">{{ t.comision_aplicada|floatformat:0|format_miles }}</td>
          <<td class="text-right {% if t.ganancia < 0 %}text-red-600{% else %}text-green-600{% endif %}">{{ t.ganancia|floatformat:0|format_miles }}</td>
          <td>{{ t.fecha_creacion|date:"d/m/Y H:i" }}</td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="10" class="text-center text-gray-500">ðŸŒ€ No se registran flujos financieros en este perÃ­odo.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- PAGINACIÃ“N -->
  <div class="flex justify-center mt-4 gap-2 pagination">
    {% if page_obj.has_previous %}
      <a href="?{% for k,v in request.GET.items %}{% if k != 'page' %}{{ k }}={{ v }}&{% endif %}{% endfor %}page={{ page_obj.previous_page_number }}">â¬… Anterior</a>
    {% endif %}
    <span class="px-3 py-1">PÃ¡gina {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</span>
    {% if page_obj.has_next %}
      <a href="?{% for k,v in request.GET.items %}{% if k != 'page' %}{{ k }}={{ v }}&{% endif %}{% endfor %}page={{ page_obj.next_page_number }}">Siguiente âž¡</a>
    {% endif %}
  </div>

</main>
{% endblock %}
