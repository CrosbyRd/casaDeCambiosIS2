{% extends "base.html" %}
{% block title %}Global Exchange{% endblock %}

{% block content %}
<main class="max-w-6xl mx-auto px-6 py-10">

  <!-- Mensajes -->
  {% if messages %}
  <div class="mb-6">
    {% for message in messages %}
      <div class="bg-green-500 text-white px-4 py-2 rounded-lg mb-2">
        {{ message }}
      </div>
    {% endfor %}
  </div>
  {% endif %}

  <!-- Encabezado -->
  <header class="flex items-center justify-between mb-8">
    <div>
      <h1 class="text-4xl font-extrabold mb-2" style="color:var(--ink)">üë§ Clientes</h1>
      <p class="text-lg leading-relaxed max-w-xl" style="color:var(--muted)">
        Gestion√° clientes: crear, editar, activar/desactivar o eliminar.
      </p>
    </div>
    <div class="flex gap-3">
      <a href="{% url 'admin_panel:dashboard' %}" 
         class="px-4 py-2 rounded-lg font-bold bg-[var(--brand-soft)] hover:brightness-95"
         style="color:var(--brand-dark)">‚¨Ö Volver al Panel</a>
      <a href="{% url 'clientes:crear' %}" 
         class="px-4 py-2 rounded-lg font-bold text-white" style="background:var(--brand)">
        ‚ûï Crear Cliente
      </a>
    </div>
  </header>

  <!-- Filtros (frontend, similar a Roles) -->
  <section class="bg-white border rounded-xl shadow-sm p-4 mb-6" style="border-color:var(--line)">
    <form class="grid grid-cols-1 md:grid-cols-3 gap-4" onsubmit="return false;">
      <div class="md:col-span-1">
        <label for="filtroTextoClientes" class="block text-sm font-medium mb-1" style="color:var(--muted)">
          Buscar por nombre
        </label>
        <input id="filtroTextoClientes" type="search" placeholder="Ej: Juan, Cliente VIP"
               class="w-full rounded-lg border px-3 py-2 outline-none focus:ring-2"
               style="border-color:var(--line); --tw-ring-color:var(--brand);" />
      </div>
      <div>
        <label for="filtroCategoria" class="block text-sm font-medium mb-1" style="color:var(--muted)">
          Filtrar por categor√≠a
        </label>
        <select id="filtroCategoria"
                class="w-full rounded-lg border px-3 py-2 bg-white outline-none focus:ring-2"
                style="border-color:var(--line); --tw-ring-color:var(--brand);">
          <option value="">Todas</option>
          <option value="minorista">Minorista</option>
          <option value="corporativo">Corporativo</option>
          <option value="vip">VIP</option>
        </select>
      </div>
      <div>
        <label for="filtroActivo" class="block text-sm font-medium mb-1" style="color:var(--muted)">
          Filtrar por estado
        </label>
        <select id="filtroActivo"
                class="w-full rounded-lg border px-3 py-2 bg-white outline-none focus:ring-2"
                style="border-color:var(--line); --tw-ring-color:var(--brand);">
          <option value="">Todos</option>
          <option value="activo">Activos</option>
          <option value="inactivo">Inactivos</option>
        </select>
      </div>
    </form>
  </section>

  <!-- Tabla -->
  <section class="bg-white border rounded-xl shadow-sm overflow-hidden" style="border-color:var(--line)">
    <div class="overflow-x-auto">
      <table class="w-full text-left border-collapse min-w-[880px]">
        <thead style="background:var(--brand); color:#fff">
          <tr>
            <th class="px-6 py-3">Nombre</th>
            <th class="px-6 py-3">Categor√≠a</th>
            <th class="px-6 py-3">Bonificaci√≥n</th>
            <th class="px-6 py-3">Estado</th>
            <th class="px-6 py-3 text-center">Acciones</th>
          </tr>
        </thead>
        <tbody id="tbodyClientes">
          {% for cliente in clientes %}
          <tr class="border-b hover:bg-[var(--brand-soft)]" style="border-color:var(--line)"
              data-text="{{ cliente.nombre|lower }}"
              data-categoria="{{ cliente.categoria }}"
              data-activo="{% if cliente.activo %}activo{% else %}inactivo{% endif %}">
            <td class="px-6 py-4 font-semibold text-[var(--ink)]">{{ cliente.nombre }}</td>

            <td class="px-6 py-4">
              <span class="px-2 py-1 rounded text-sm font-medium bg-[var(--brand-soft)] text-[var(--brand-dark)]">
                {{ cliente.get_categoria_display }}
              </span>
            </td>
            <td class="px-6 py-4 text-green-600 font-bold">{{ cliente.bonificacion }}%</td>
            <td class="px-6 py-4">
              {% if cliente.activo %}
                <span class="text-green-600 font-semibold">Activo</span>
              {% else %}
                <span class="text-red-600 font-semibold">Inactivo</span>
              {% endif %}
            </td>
            <td class="px-6 py-4 text-center space-x-2">
              <a href="{% url 'clientes:detalle' cliente.id_cliente %}" 
                 class="px-3 py-1 rounded-md font-semibold text-[var(--brand-dark)] bg-[var(--brand-soft)] hover:brightness-95">
                Ver
              </a>
              <a href="{% url 'clientes:editar' cliente.id_cliente %}" 
                 class="px-3 py-1 rounded-md font-semibold text-[var(--brand-dark)] bg-[var(--brand-soft)] hover:brightness-95">
                Editar
              </a>
              <a href="{% url 'clientes:toggle_estado' cliente.id_cliente %}" 
                 class="px-3 py-1 rounded-md font-semibold text-white {% if cliente.activo %}bg-yellow-500 hover:bg-yellow-600{% else %}bg-green-600 hover:bg-green-700{% endif %}">
                {% if cliente.activo %}Desactivar{% else %}Activar{% endif %}
              </a>
              <a href="{% url 'clientes:eliminar' cliente.id_cliente %}" 
                 class="px-3 py-1 rounded-md font-semibold text-white bg-red-600 hover:bg-red-700">
                Eliminar
              </a>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="5" class="px-6 py-6 text-center text-neutral-400">              No se encontraron clientes.
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>
</main>
<script>
  // Debounce util para inputs (igual que en Roles)
  function debounce(fn, ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }

  const filtroTextoClientes = document.getElementById('filtroTextoClientes');
  const filtroCategoria = document.getElementById('filtroCategoria');
  const filtroActivo = document.getElementById('filtroActivo');
  const tbodyClientes = document.getElementById('tbodyClientes');
  const rowsClientes = [...tbodyClientes.querySelectorAll('tr[data-text]')];

  function aplicarFiltrosClientes(){
    const q   = (filtroTextoClientes.value || '').toLowerCase().trim();
    const cat = (filtroCategoria.value || '').toLowerCase();
    const act = (filtroActivo.value || '').toLowerCase();

    rowsClientes.forEach(tr => {
      const txt       = (tr.dataset.text || '').toLowerCase();
      const categoria = (tr.dataset.categoria || '').toLowerCase();
      const activo    = (tr.dataset.activo || '').toLowerCase();

      const matchTxt = !q   || txt.includes(q);
      const matchCat = !cat || categoria === cat;
      const matchAct = !act || activo === act;

      tr.style.display = (matchTxt && matchCat && matchAct) ? '' : 'none';
    });
  }

  const filtrarClientes = debounce(aplicarFiltrosClientes, 150);
  filtroTextoClientes.addEventListener('input', filtrarClientes);
  filtroCategoria.addEventListener('change', aplicarFiltrosClientes);
  filtroActivo.addEventListener('change', aplicarFiltrosClientes);
</script>
{% endblock %}
