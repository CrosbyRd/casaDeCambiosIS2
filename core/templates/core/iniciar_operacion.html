{% extends "base.html" %}
{% load static %}
{% load configuracion_extras %}
{% block title %}Iniciar Operaci√≥n - Global Exchange{% endblock %}

{% block content %}
<main class="max-w-5xl mx-auto px-6 py-10">

  <!-- Header (mismo patr√≥n que tus pantallas de crear) -->
  <header class="mb-6">
    <h1 class="text-4xl font-extrabold mb-2 text-[var(--ink)]">üí± Iniciar Operaci√≥n</h1>
    <p class="text-lg leading-relaxed max-w-2xl text-[var(--muted)]">
      Seleccion√° el tipo de operaci√≥n y complet√° los datos para continuar con la confirmaci√≥n.
    </p>
    <div class="mt-4">
      <a href="{% url 'home' %}"
         class="inline-flex items-center gap-2 px-4 py-2 rounded-xl border"
         style="background:var(--brand-soft); color:var(--brand-dark); border-color:var(--brand-soft);">
        ‚¨ÖÔ∏è Volver
      </a>
    </div>
  </header>

  <!-- Mensajes del framework -->
  {% if messages %}
    <div class="mb-4 space-y-2">
      {% for message in messages %}
        <div class="px-4 py-3 rounded-xl border" style="background:#fff; border-color:var(--line); color:var(--ink);">
          {{ message }}
        </div>
      {% endfor %}
    </div>
  {% endif %}

<!-- Mostrar el l√≠mite disponible para el cliente -->
<div class="mb-6">
  <h2 class="text-lg font-semibold text-[var(--ink)]">L√≠mite Disponible</h2>
  <p class="text-md text-[var(--muted)]">
    El l√≠mite disponible para realizar operaciones es de 
    <strong>{{ limite_disponible|floatformat:0|formatear_moneda }} PYG</strong>
  </p>
</div>

<!-- Mostrar informaci√≥n del cliente (si es necesario) -->
<div class="mb-6">
  <h2 class="text-lg font-semibold text-[var(--ink)]">Informaci√≥n del Cliente</h2>
  <p class="text-md text-[var(--muted)]">
    Cliente: <strong>{{ cliente.nombre }}</strong><br>
    Categor√≠a: <strong>{{ cliente.get_categoria_display }}</strong><br>
    Estado: <strong>{{ cliente.esta_activo|yesno:"Activo,Inactivo" }}</strong>
  </p>
</div>


  <!-- Card -->
  <section class="bg-white border rounded-xl shadow-sm overflow-hidden" style="border-color:var(--line)">
    <form method="post" id="form-operacion" novalidate>
      {% csrf_token %}

      <!-- Bloque: Tipo de operaci√≥n -->
      <div class="px-5 py-3 font-semibold text-white" style="background:var(--brand);">Tipo de operaci√≥n</div>
      <div class="p-5">
        <label for="{{ form.tipo_operacion.id_for_label }}" class="block text-sm font-medium text-[var(--ink)] mb-2">
          {{ form.tipo_operacion.label }}
        </label>
        {{ form.tipo_operacion }}
        {% if form.tipo_operacion.errors %}
          <p class="mt-2 text-sm text-red-600">{{ form.tipo_operacion.errors.as_text|cut:"* " }}</p>
        {% endif %}
      </div>

      <!-- Bloque: Monedas -->
      <div class="px-5 py-3 font-semibold text-white" style="background:var(--brand);">Monedas</div>
      <div class="p-5 grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label for="{{ form.moneda_origen.id_for_label }}" class="block text-sm font-medium text-[var(--ink)] mb-2">
            {{ form.moneda_origen.label }}
          </label>
          {{ form.moneda_origen }}
          {% if form.moneda_origen.errors %}
            <p class="mt-2 text-sm text-red-600">{{ form.moneda_origen.errors.as_text|cut:"* " }}</p>
          {% endif %}
        </div>
        <div>
          <label for="{{ form.moneda_destino.id_for_label }}" class="block text-sm font-medium text-[var(--ink)] mb-2">
            {{ form.moneda_destino.label }}
          </label>
          {{ form.moneda_destino }}
          {% if form.moneda_destino.errors %}
            <p class="mt-2 text-sm text-red-600">{{ form.moneda_destino.errors.as_text|cut:"* " }}</p>
          {% endif %}
        </div>
      </div>

      <!-- Bloque: Monto -->
      <div class="px-5 py-3 font-semibold text-white" style="background:var(--brand);">Monto</div>
      <div class="p-5">
        <label for="{{ form.monto.id_for_label }}" class="block text-sm font-medium text-[var(--ink)] mb-2">
          {{ form.monto.label }}
        </label>

        {{ form.monto }}

          {# Espejo visible (solo visualizaci√≥n con miles) #}
            <input
              type="text"
              id="id_monto_visible"
              inputmode="numeric"
              autocomplete="off"
              placeholder="0"
              class="mt-2 w-full"
              style="width:100%; border:1.5px solid var(--line); border-radius:12px;
                    padding:12px 14px; height:48px; font-size:1rem; color:var(--ink); background:#fff;
                    transition: box-shadow .15s ease, border-color .15s ease;"
            />

        {% if form.monto.errors %}
          <p class="mt-2 text-sm text-red-600">{{ form.monto.errors.as_text|cut:"* " }}</p>
        {% endif %}
        <p class="mt-2 text-sm text-[var(--muted)]">
          La operaci√≥n debe involucrar PYG. El monto m√≠nimo puede depender de la denominaci√≥n de la moneda.
        </p>
      </div>

      <!-- Bloque: Modalidad de Tasa -->
      <div class="px-5 py-3 font-semibold text-white" style="background:var(--brand);">Modalidad de Tasa</div>
      <div class="p-5">
        <label for="{{ form.modalidad_tasa.id_for_label }}" class="block text-sm font-medium text-[var(--ink)] mb-2">
          {{ form.modalidad_tasa.label }}
        </label>
        {{ form.modalidad_tasa }}
        {% if form.modalidad_tasa.errors %}
          <p class="mt-2 text-sm text-red-600">{{ form.modalidad_tasa.errors.as_text|cut:"* " }}</p>
        {% endif %}
        <p class="mt-2 text-sm text-[var(--muted)]">
          {{ form.modalidad_tasa.help_text }}
        </p>
      </div>

      <!-- Bloque: Medio de Pago (se muestra condicionalmente para VENTA) -->
      <div id="medio-pago-block" class="hidden">
        <div class="px-5 py-3 font-semibold text-white" style="background:var(--brand);">Medio de Pago</div>
        <div class="p-5">
          <label for="{{ form.medio_pago.id_for_label }}" class="block text-sm font-medium text-[var(--ink)] mb-2">
            {{ form.medio_pago.label }}
          </label>
          <div class="flex items-center gap-2">
            {{ form.medio_pago }}
            <a href="{% url 'pagos:clientes_create' %}?next={{ request.get_full_path|urlencode }}"
               class="inline-flex items-center px-3 py-2 rounded-xl text-sm font-semibold whitespace-nowrap"
               style="background:var(--brand-soft); color:var(--brand-dark);">
              ‚ûï Agregar
            </a>
          </div>
          {% if form.medio_pago.errors %}
            <p class="mt-2 text-sm text-red-600">{{ form.medio_pago.errors.as_text|cut:"* " }}</p>
          {% endif %}

          <!-- Contenedor para mostrar los detalles del medio de pago seleccionado -->
          <div id="medio-pago-detalles" class="mt-4 p-4 border rounded-xl bg-gray-50 hidden" style="border-color:var(--line);">
            <h3 class="text-md font-semibold text-[var(--ink)] mb-2">Detalles del Medio de Pago</h3>
            <p class="text-sm text-[var(--muted)]">Alias: <strong id="detalle-alias-pago"></strong></p>
            <p class="text-sm text-[var(--muted)]">Tipo: <strong id="detalle-tipo-pago"></strong></p>
            <div id="detalle-campos-dinamicos-pago" class="mt-2 space-y-1"></div>
          </div>
        </div>
      </div>

      <!-- Bloque: Medio de Acreditaci√≥n (se muestra condicionalmente para COMPRA) -->
      <div id="medio-acreditacion-block" class="hidden">
        <div class="px-5 py-3 font-semibold text-white" style="background:var(--brand);">Medio de Acreditaci√≥n</div>
        <div class="p-5">
          <label for="{{ form.medio_acreditacion.id_for_label }}" class="block text-sm font-medium text-[var(--ink)] mb-2">
            {{ form.medio_acreditacion.label }}
          </label>
          <div class="flex items-center gap-2">
            {{ form.medio_acreditacion }}
            <a href="{% url 'medios_acreditacion:clientes_create' %}?next={{ request.get_full_path|urlencode }}"
               class="inline-flex items-center px-3 py-2 rounded-xl text-sm font-semibold whitespace-nowrap"
               style="background:var(--brand-soft); color:var(--brand-dark);">
              ‚ûï Agregar
            </a>
          </div>
          {% if form.medio_acreditacion.errors %}
            <p class="mt-2 text-sm text-red-600">{{ form.medio_acreditacion.errors.as_text|cut:"* " }}</p>
          {% endif %}

          <!-- Contenedor para mostrar los detalles del medio de acreditaci√≥n seleccionado -->
          <div id="medio-acreditacion-detalles" class="mt-4 p-4 border rounded-xl bg-gray-50 hidden" style="border-color:var(--line);">
            <h3 class="text-md font-semibold text-[var(--ink)] mb-2">Detalles del Medio de Acreditaci√≥n</h3>
            <p class="text-sm text-[var(--muted)]">Alias: <strong id="detalle-alias-acreditacion"></strong></p>
            <p class="text-sm text-[var(--muted)]">Tipo: <strong id="detalle-tipo-acreditacion"></strong></p>
            <div id="detalle-campos-dinamicos-acreditacion" class="mt-2 space-y-1"></div>
          </div>
        </div>
      </div>

      <!-- Errores Generales del Formulario -->
      {% if form.non_field_errors %}
        <div class="p-5">
          <div class="px-4 py-3 rounded-xl border bg-red-50 border-red-300 text-red-800">
            {% for error in form.non_field_errors %}
              <p>{{ error }}</p>
            {% endfor %}
          </div>
        </div>
      {% endif %}

      <!-- Acciones -->
      <div class="p-5 border-t" style="border-color:var(--line)">
        <div class="flex flex-col md:flex-row gap-3 md:justify-end">
          <a href="{% url 'home' %}"
             class="inline-flex justify-center items-center px-4 py-3 rounded-xl font-semibold"
             style="background:#e11d48; color:#fff;">
            Cancelar
          </a>
          <button id="btn-submit" type="submit"
                  class="inline-flex justify-center items-center px-4 py-3 rounded-xl font-semibold"
                  style="background:var(--brand); color:#fff; box-shadow:0 8px 24px color-mix(in oklab, var(--brand) 30%, transparent);">
            Proceder a Confirmaci√≥n
          </button>
        </div>
      </div>
    </form>
  </section>
</main>

<!-- Estilos: aplicados por ID nativo (sin filtros ni as_widget) -->
<style>
  /* Inputs y selects con la est√©tica del proyecto */
  #id_monto, #id_tipo_operacion, #id_moneda_origen, #id_moneda_destino, #id_modalidad_tasa, #id_medio_pago {
    width:100%; border:1.5px solid var(--line); border-radius:12px;
    padding:12px 14px; height:48px; font-size:1rem; color:var(--ink); background:#fff;
    transition: box-shadow .15s ease, border-color .15s ease;
  }
  #id_monto:focus, #id_tipo_operacion:focus, #id_moneda_origen:focus, #id_moneda_destino:focus, #id_modalidad_tasa:focus, #id_medio_pago:focus {
    outline:none; border-color:var(--brand); box-shadow:0 0 0 3px rgba(124,58,237,.18);
  }
  .hidden { display: none; }

  #id_monto {
    position: absolute !important;
    left: -99999px !important;
    width: 1px !important;
    height: 1px !important;
    opacity: 0 !important;
    pointer-events: none !important;
  }
</style>

<!-- JS opcional: habilita/deshabilita submit seg√∫n reglas del negocio (frontend) -->
<script>
(function () {
  const tipo = document.getElementById('id_tipo_operacion');
  const ori  = document.getElementById('id_moneda_origen');
  const dst  = document.getElementById('id_moneda_destino');
  const monto= document.getElementById('id_monto');
  const btn  = document.getElementById('btn-submit');
  const medioPagoBlock = document.getElementById('medio-pago-block');
  const medioPagoSelect = document.getElementById('id_medio_pago');
  const medioPagoDetalles = document.getElementById('medio-pago-detalles');
  const detalleAliasPago = document.getElementById('detalle-alias-pago');
  const detalleTipoPago = document.getElementById('detalle-tipo-pago');
  const detalleCamposDinamicosPago = document.getElementById('detalle-campos-dinamicos-pago');

  const medioAcreditacionBlock = document.getElementById('medio-acreditacion-block');
  const medioAcreditacionSelect = document.getElementById('id_medio_acreditacion');
  const medioAcreditacionDetalles = document.getElementById('medio-acreditacion-detalles');
  const detalleAliasAcreditacion = document.getElementById('detalle-alias-acreditacion');
  const detalleTipoAcreditacion = document.getElementById('detalle-tipo-acreditacion');
  const detalleCamposDinamicosAcreditacion = document.getElementById('detalle-campos-dinamicos-acreditacion');

  const nfPY = new Intl.NumberFormat('es-PY', { maximumFractionDigits: 0 });


  // Datos de los medios de pago y acreditaci√≥n pasados desde la vista
  const mediosPagoData = JSON.parse('{{ medios_pago_json|escapejs }}');
  const mediosAcreditacionData = JSON.parse('{{ medios_acreditacion_json|escapejs }}');

  const isPYG = v => String(v||'').toUpperCase()==='PYG';
  const isForeign = v => v && !isPYG(v);

  function enforce() {
    let ok = true;
    const t = tipo?.value || '';
    const o = ori?.value  || '';
    const d = dst?.value  || '';
    const m = parseFloat(monto?.value || '0');

    // L√≥gica para mostrar/ocultar los bloques de medios
    if (t === 'venta') { // Cliente compra divisa, necesita pagar
      medioPagoBlock.classList.remove('hidden');
      medioAcreditacionBlock.classList.add('hidden');
      medioAcreditacionDetalles.classList.add('hidden');
    } else if (t === 'compra') { // Cliente vende divisa, necesita acreditar
      medioAcreditacionBlock.classList.remove('hidden');
      medioPagoBlock.classList.add('hidden');
      medioPagoDetalles.classList.add('hidden');
    } else {
      medioPagoBlock.classList.add('hidden');
      medioPagoDetalles.classList.add('hidden');
      medioAcreditacionBlock.classList.add('hidden');
      medioAcreditacionDetalles.classList.add('hidden');
    }

    if (t === 'compra') {          // cliente vende divisa a la casa (resultado en PYG)
      if (isPYG(o) || isForeign(d)) ok = false; // origen no PYG, destino PYG
    } else if (t === 'venta') {    // cliente compra divisa a la casa (origen PYG)
      if (isForeign(o) || isPYG(d)) ok = false; // origen PYG, destino no PYG
    } else {
      ok = false;
    }

    if (!t || !o || !d || o === d || !(m > 0)) ok = false;
    if (btn) btn.disabled = !ok;
  }
  ['change','input'].forEach(ev=>{
    tipo?.addEventListener(ev, enforce);
    ori?.addEventListener(ev, enforce);
    dst?.addEventListener(ev, enforce);
    monto?.addEventListener(ev, enforce);
  });
  
  // L√≥gica para mostrar los detalles del medio de pago seleccionado
  function mostrarDetallesMedioPago() {
    const selectedMedioPagoId = medioPagoSelect.value;
    if (selectedMedioPagoId && mediosPagoData[selectedMedioPagoId]) {
      const medio = mediosPagoData[selectedMedioPagoId];
      detalleAliasPago.textContent = medio.alias;
      detalleTipoPago.textContent = medio.tipo_nombre;

      detalleCamposDinamicosPago.innerHTML = ''; // Limpiar campos anteriores
      for (const campo of medio.campos) {
        const p = document.createElement('p');
        p.className = 'text-sm text-[var(--muted)]';
        p.innerHTML = `${campo.nombre_campo}: <strong>${campo.valor}</strong>`;
        detalleCamposDinamicosPago.appendChild(p);
      }
      medioPagoDetalles.classList.remove('hidden');
    } else {
      medioPagoDetalles.classList.add('hidden');
    }
  }

  // L√≥gica para mostrar los detalles del medio de acreditaci√≥n seleccionado
  function mostrarDetallesMedioAcreditacion() {
    const selectedMedioAcreditacionId = medioAcreditacionSelect.value;
    if (selectedMedioAcreditacionId && mediosAcreditacionData[selectedMedioAcreditacionId]) {
      const medio = mediosAcreditacionData[selectedMedioAcreditacionId];
      detalleAliasAcreditacion.textContent = medio.alias;
      detalleTipoAcreditacion.textContent = medio.tipo_nombre;

      detalleCamposDinamicosAcreditacion.innerHTML = ''; // Limpiar campos anteriores
      for (const campo of medio.campos) {
        const p = document.createElement('p');
        p.className = 'text-sm text-[var(--muted)]';
        p.innerHTML = `${campo.nombre_campo}: <strong>${campo.valor}</strong>`;
        detalleCamposDinamicosAcreditacion.appendChild(p);
      }
      medioAcreditacionDetalles.classList.remove('hidden');
    } else {
      medioAcreditacionDetalles.classList.add('hidden');
    }
  }

  medioPagoSelect?.addEventListener('change', mostrarDetallesMedioPago);
  medioAcreditacionSelect?.addEventListener('change', mostrarDetallesMedioAcreditacion);

  enforce();
  mostrarDetallesMedioPago(); // Mostrar detalles al cargar si ya hay una selecci√≥n
  mostrarDetallesMedioAcreditacion(); // Mostrar detalles al cargar si ya hay una selecci√≥n

  console.log('Valor inicial de tipo_operacion:', tipo?.value);
  console.log('Opciones de tipo_operacion:', Array.from(tipo?.options || []).map(opt => ({ value: opt.value, text: opt.text, selected: opt.selected })));

  function cleanFormat(str) {
    // Quita puntos/espacios, deja solo d√≠gitos
    return String(str || '').replace(/\./g, '').replace(/\s+/g, '').replace(/[^0-9]/g, '');
  }

  function applyFormat(rawStr) {
    const clean = cleanFormat(rawStr);
    if (!clean) return '';
    // Evita ceros a la izquierda innecesarios
    const normalized = clean.replace(/^0+(?=\d)/, '');
    return nfPY.format(Number(normalized));
  }

  // Mantener posici√≥n del cursor al agregar/quitar separadores
  function setFormattedValuePreservingCaret(input, nextFormatted) {
    const prev = input.value;
    const start = input.selectionStart;
    const beforePrev = prev.slice(0, start);
    const digitsBefore = beforePrev.replace(/\D/g, '').length;

    input.value = nextFormatted;

    // Recorremos nextFormatted hasta consumir 'digitsBefore' d√≠gitos
    let pos = 0, consumed = 0;
    while (pos < nextFormatted.length && consumed < digitsBefore) {
      if (/\d/.test(nextFormatted[pos])) consumed++;
      pos++;
    }
    input.setSelectionRange(pos, pos);
  }

  const inputHidden  = document.getElementById('id_monto');
  const inputVisible = document.getElementById('id_monto_visible');

  if (inputHidden && inputVisible) {
    // Inicializar visible desde el hidden (si viene un valor inicial)
    const initial = inputHidden.value || '';
    inputVisible.value = applyFormat(initial);

    // Estilos de focus iguales a los tuyos
    inputVisible.addEventListener('focus', () => {
      inputVisible.style.borderColor = 'var(--brand)';
      inputVisible.style.boxShadow = '0 0 0 3px rgba(124,58,237,.18)';
    });
    inputVisible.addEventListener('blur', () => {
      inputVisible.style.borderColor = 'var(--line)';
      inputVisible.style.boxShadow = 'none';
    });

    // Formatear mientras escribe y sincronizar al hidden
    inputVisible.addEventListener('input', () => {
      const formatted = applyFormat(inputVisible.value);
      setFormattedValuePreservingCaret(inputVisible, formatted);

      // Escribir el valor limpio (sin puntos) en el hidden para el POST
      inputHidden.value = cleanFormat(formatted);
      // Disparar 'input' para que tu l√≥gica de habilitar bot√≥n reaccione
      inputHidden.dispatchEvent(new Event('input', { bubbles: true }));
      inputHidden.dispatchEvent(new Event('change', { bubbles: true }));
    });

    // Si por cualquier raz√≥n alguien modifica el hidden, reflejar en visible
    inputHidden.addEventListener('change', () => {
      const formatted = applyFormat(inputHidden.value);
      inputVisible.value = formatted;
    });
  }

})();
</script>
{% endblock %}
