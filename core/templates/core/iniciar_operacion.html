{% extends "base.html" %}
{% load static %}

{% block title %}Iniciar Operación{% endblock %}
{% block extra_head %}<link rel="icon" href="{% static 'img/logo.ico' %}" sizes="any">{% endblock %}

{% block content %}
<main class="max-w-5xl mx-auto px-6 py-10">
  {% include "partials/page_header.html" with title="Iniciar Operación" subtitle="Selecciona el tipo de operación y el monto" %}
  {% include "partials/messages.html" %}

  <section class="bg-white border rounded-xl shadow-sm mb-4" style="border-color:var(--line)">
    <form method="post" id="form-operacion" class="pb-6">
      {% csrf_token %}

      <div class="px-4 py-4">
        <div class="mb-4">
          <label for="{{ form.tipo_operacion.id_for_label }}" class="block text-sm font-medium text-gray-700">
            {{ form.tipo_operacion.label }}
          </label>
          {{ form.tipo_operacion }}
          {% if form.tipo_operacion.errors %}
            <p class="text-red-500 text-xs italic">{{ form.tipo_operacion.errors }}</p>
          {% endif %}
        </div>

        <div class="mb-4">
          <label for="{{ form.moneda_origen.id_for_label }}" class="block text-sm font-medium text-gray-700">
            {{ form.moneda_origen.label }}
          </label>
          {{ form.moneda_origen }}
          {% if form.moneda_origen.errors %}
            <p class="text-red-500 text-xs italic">{{ form.moneda_origen.errors }}</p>
          {% endif %}
        </div>

        <div class="mb-4">
          <label for="{{ form.moneda_destino.id_for_label }}" class="block text-sm font-medium text-gray-700">
            {{ form.moneda_destino.label }}
          </label>
          {{ form.moneda_destino }}
          {% if form.moneda_destino.errors %}
            <p class="text-red-500 text-xs italic">{{ form.moneda_destino.errors }}</p>
          {% endif %}
        </div>

        <div class="mb-4">
          <label for="{{ form.monto.id_for_label }}" class="block text-sm font-medium text-gray-700">
            {{ form.monto.label }}
          </label>
          {{ form.monto }}
          {% if form.monto.errors %}
            <p class="text-red-500 text-xs italic">{{ form.monto.errors }}</p>
          {% endif %}
        </div>

        <div class="btn-row" style="margin-top:18px;">
          <button id="btn-proceder" class="gx-btn" type="submit">Proceder a Confirmación</button>
          <a href="{% url 'home' %}" class="gx-btn gx-btn--ghost">Cancelar</a>
        </div>
      </div>
    </form>
  </section>
</main>

<style>
  .gx-input, .gx-select{
    width:100%; border:1.5px solid var(--line); border-radius:12px;
    padding:12px 14px; height:48px; font-size:1rem; color:var(--ink); background:#fff;
    transition:box-shadow .2s ease,border-color .2s ease;
  }
  .gx-input:focus, .gx-select:focus{ outline:none; border-color:var(--brand); box-shadow:0 0 0 3px rgba(115,60,255,.15); }

  .gx-btn{
    background:var(--brand); color:#fff; font-weight:800; border:none; border-radius:12px;
    padding:12px 16px; font-size:16px; width:100%;
    box-shadow:0 8px 24px color-mix(in oklab, var(--brand) 30%, transparent);
    cursor:pointer;
  }
  .gx-btn[disabled]{opacity:.55;cursor:not-allowed;box-shadow:none;}

  .gx-btn--ghost{ background:#fff; color:var(--ink); border:1.5px solid var(--line); box-shadow:none; }
  .gx-btn--ghost:hover{ background:var(--brand-soft); }

  .btn-row{ display:grid; gap:10px; grid-template-columns:1fr; }
  @media (min-width: 520px){ .btn-row{ grid-template-columns:1fr 1fr; } }
</style>

<script>
(function () {
  const form   = document.getElementById('form-operacion');
  if (!form) return;

  const selTipo = document.getElementById('id_tipo_operacion');
  const selOri  = document.getElementById('id_moneda_origen');
  const selDst  = document.getElementById('id_moneda_destino');
  const monto   = document.getElementById('id_monto');
  const btn     = document.getElementById('btn-proceder');

  const isPYG     = (v) => String(v || '').toUpperCase() === 'PYG';
  const isForeign = (v) => v && !isPYG(v);

  function decorateSelect(sel){
    if(!sel) return;
    [...sel.options].forEach(opt=>{
      if (opt.value) { // No decorar la opción vacía si existe
        opt.classList.add('px-4', 'py-2'); // Añadir clases para estilo
      }
    });
    sel.classList.add('gx-select');
  }
  function ensurePlaceholder(sel, text){
    if(!sel) return;
    if(!sel.querySelector('option[value=""]')){
      const ph = document.createElement('option');
      ph.value = ''; ph.textContent = text; ph.disabled = true; ph.hidden = true;
      sel.insertBefore(ph, sel.firstChild);
    }
  }

  decorateSelect(selTipo);
  decorateSelect(selOri);
  decorateSelect(selDst);
  ensurePlaceholder(selTipo, 'Selecciona un tipo de operación…');
  ensurePlaceholder(selOri, 'Selecciona una moneda…');
  ensurePlaceholder(selDst, 'Selecciona una moneda…');
  if (monto) monto.classList.add('gx-input');

  function enforceRules(){
    const tipo = selTipo?.value || '';
    const o    = selOri?.value || '';
    const d    = selDst?.value || '';

    let valid = true;

    // Reglas de validación de monedas según el tipo de operación
    if (tipo === 'compra') { // Cliente VENDE divisa extranjera a la casa de cambio
      if (isPYG(o) || isForeign(d)) { // Origen no puede ser PYG, Destino debe ser PYG
        valid = false;
      }
    } else if (tipo === 'venta') { // Cliente COMPRA divisa extranjera de la casa de cambio
      if (isForeign(o) || isPYG(d)) { // Origen debe ser PYG, Destino no puede ser PYG
        valid = false;
      }
    } else { // Tipo de operación no seleccionado
      valid = false;
    }

    // Reglas generales
    if (!tipo || !o || !d || o === d || (monto && parseFloat(monto.value) <= 0)) {
      valid = false;
    }

    btn.disabled = !valid;
  }

  selTipo?.addEventListener('change', enforceRules);
  selOri?.addEventListener('change', enforceRules);
  selDst?.addEventListener('change', enforceRules);
  monto?.addEventListener('input', enforceRules);
  
  enforceRules(); // Estado inicial
})();
</script>
{% endblock %}
