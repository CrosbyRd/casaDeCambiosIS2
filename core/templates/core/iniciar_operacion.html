{% extends "base.html" %}
{% load static %}
{% load configuracion_extras %}
{% block title %}Iniciar Operaci√≥n - Global Exchange{% endblock %}

{% block content %}
<main class="max-w-5xl mx-auto px-6 py-6">

  <header class="mb-4">
    <h1 class="text-4xl font-extrabold mb-1 text-[var(--ink)]">üí± Iniciar Operaci√≥n</h1>
    <p class="text-base leading-relaxed max-w-2xl text-[var(--muted)]">
      Seleccion√° el tipo de operaci√≥n y complet√° los datos para continuar con la confirmaci√≥n.
    </p>
  </header>

  {% if messages %}
    <div id="flash-messages" class="mb-3 space-y-2">
      {% for message in messages %}
        <div class="px-3 py-2 rounded-xl border" style="background:#fff; border-color:var(--line); color:var(--ink);">
          {{ message }}
        </div>
      {% endfor %}
    </div>
  {% endif %}

  <div class="grid md:grid-cols-2 gap-4 mb-4">
    <div>
      <h2 class="text-base font-semibold text-[var(--ink)]">L√≠mite Disponible</h2>
      <p class="text-sm text-[var(--muted)]">
        El l√≠mite disponible para realizar operaciones es de
        <strong>{{ limite_disponible|floatformat:0|formatear_moneda }} PYG</strong>
      </p>
    </div>
    <div>
      <h2 class="text-base font-semibold text-[var(--ink)]">Informaci√≥n del Cliente</h2>
      <p class="text-sm text-[var(--muted)]">
        Cliente: <strong>{{ cliente.nombre }}</strong><br>
        Categor√≠a: <strong>{{ cliente.get_categoria_display }}</strong><br>
        Estado: <strong>{{ cliente.esta_activo|yesno:"Activo,Inactivo" }}</strong>
      </p>
    </div>
  </div>

  <section class="bg-white border rounded-xl shadow-sm overflow-hidden" style="border-color:var(--line)">
    <form method="post" id="form-operacion" novalidate
          {% if form.non_field_errors or messages %} data-has-errors="1"{% endif %}>
      {% csrf_token %}

      <div class="px-4 py-3 font-semibold text-white" style="background:var(--brand);">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-2">
          <span class="text-white">Tipo de operaci√≥n</span>
          <div class="w-full md:w-auto">
            <label for="{{ form.tipo_operacion.id_for_label }}" class="sr-only">
              {{ form.tipo_operacion.label }}
            </label>
            {{ form.tipo_operacion }}
          </div>
        </div>
      </div>
      {% if form.tipo_operacion.errors %}
        <div class="px-4 pt-2">
          <p class="text-sm text-red-600">{{ form.tipo_operacion.errors.as_text|cut:"* " }}</p>
        </div>
      {% endif %}

      <div class="p-4 grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <label for="{{ form.moneda_origen.id_for_label }}" class="block text-sm font-medium text-[var(--ink)] mb-1">
            {{ form.moneda_origen.label }}
          </label>
          {{ form.moneda_origen }}
          {% if form.moneda_origen.errors %}
            <p class="mt-1 text-sm text-red-600">{{ form.moneda_origen.errors.as_text|cut:"* " }}</p>
          {% endif %}
        </div>
        <div>
          <label for="{{ form.moneda_destino.id_for_label }}" class="block text-sm font-medium text-[var(--ink)] mb-1">
            {{ form.moneda_destino.label }}
          </label>
          {{ form.moneda_destino }}
          {% if form.moneda_destino.errors %}
            <p class="mt-1 text-sm text-red-600">{{ form.moneda_destino.errors.as_text|cut:"* " }}</p>
          {% endif %}
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <div class="px-4 py-2 font-semibold text-white" style="background:var(--brand);">Monto</div>
          <div class="p-4">
            <label for="{{ form.monto.id_for_label }}" class="block text-sm font-medium text-[var(--ink)] mb-1">
              {{ form.monto.label }}
            </label>

            {{ form.monto }}

            <input
              type="text"
              id="id_monto_visible"
              inputmode="numeric"
              autocomplete="off"
              placeholder="0"
              class="mt-2 w-full"
              style="width:100%; border:1.5px solid var(--line); border-radius:12px;
                     padding:10px 12px; height:42px; font-size:.95rem; color:var(--ink); background:#fff;
                     transition: box-shadow .15s ease, border-color .15s ease;"
            />

            {% if form.monto.errors %}
              <p class="mt-1 text-sm text-red-600">{{ form.monto.errors.as_text|cut:"* " }}</p>
            {% endif %}
            <p class="mt-2 text-sm text-[var(--muted)]">
              La operaci√≥n debe involucrar PYG. El monto m√≠nimo puede depender de la denominaci√≥n de la moneda.
            </p>
          </div>
        </div>

        <div>
          <div class="px-4 py-2 font-semibold text-white" style="background:var(--brand);">Modalidad de Tasa</div>
          <div class="p-4">
            <label for="{{ form.modalidad_tasa.id_for_label }}" class="block text-sm font-medium text-[var(--ink)] mb-1">
              {{ form.modalidad_tasa.label }}
            </label>
            {{ form.modalidad_tasa }}
            {% if form.modalidad_tasa.errors %}
              <p class="mt-1 text-sm text-red-600">{{ form.modalidad_tasa.errors.as_text|cut:"* " }}</p>
            {% endif %}
            <p class="mt-2 text-sm text-[var(--muted)]">
              {{ form.modalidad_tasa.help_text }}
            </p>
          </div>
        </div>
      </div>

      <div id="medio-pago-block" class="hidden">
        <div class="px-4 py-2 font-semibold text-white" style="background:var(--brand);">M√©todo de pago</div>
        <div class="p-4">
          <label for="{{ form.medio_pago.id_for_label }}" class="block text-sm font-medium text-[var(--ink)] mb-1">
            {{ form.medio_pago.label }}
          </label>
          <div class="flex items-center gap-2">
            {{ form.medio_pago }}
            <button type="button" id="btn-agregar-medio-pago"
               class="inline-flex items-center px-3 py-2 rounded-xl text-sm font-semibold whitespace-nowrap"
               style="background:var(--brand-soft); color:var(--brand-dark);">
              ‚ûï Agregar
            </button>
          </div>
          {% if form.medio_pago.errors %}
            <p class="mt-1 text-sm text-red-600">{{ form.medio_pago.errors.as_text|cut:"* " }}</p>
          {% endif %}

          <div id="contenedor-form-pago" class="mt-3 hidden">
            <!-- Aqu√≠ se cargar√° el formulario AJAX para crear un nuevo medio de pago -->
          </div>

          <div id="contenedor-detalle-pago" class="mt-3 hidden">
            <!-- Aqu√≠ se cargar√° el formulario AJAX para ver/editar un medio de pago existente -->
          </div>
        </div>
      </div>

      <div id="medio-acreditacion-block" class="hidden">
        <div class="px-4 py-2 font-semibold text-white" style="background:var(--brand);">Medio de Acreditaci√≥n</div>
        <div class="p-4">
          <label for="{{ form.medio_acreditacion.id_for_label }}" class="block text-sm font-medium text-[var(--ink)] mb-1">
            {{ form.medio_acreditacion.label }}
          </label>
          <div class="flex items-center gap-2">
            {{ form.medio_acreditacion }}
            <a href="{% url 'medios_acreditacion:clientes_create' %}?next={{ request.get_full_path|urlencode }}"
               class="inline-flex items-center px-3 py-2 rounded-xl text-sm font-semibold whitespace-nowrap"
               style="background:var(--brand-soft); color:var(--brand-dark);">
              ‚ûï Agregar
            </a>
          </div>
          {% if form.medio_acreditacion.errors %}
            <p class="mt-1 text-sm text-red-600">{{ form.medio_acreditacion.errors.as_text|cut:"* " }}</p>
          {% endif %}

          <div id="medio-acreditacion-detalles" class="mt-3 p-3 border rounded-xl bg-gray-50 hidden" style="border-color:var(--line);">
            <h3 class="text-sm font-semibold text-[var(--ink)] mb-1">Detalles del Medio de Acreditaci√≥n</h3>
            <p class="text-sm text-[var(--muted)]">Proveedor: <strong id="detalle-alias-acreditacion"></strong></p>
            <p class="text-sm text-[var(--muted)]">Tipo: <strong id="detalle-tipo-acreditacion"></strong></p>
            <div id="detalle-campos-dinamicos-acreditacion" class="mt-1 space-y-1"></div>
          </div>
        </div>
      </div>

      <div id="metodo-entrega-block" class="hidden">
        <div class="px-4 py-2 font-semibold text-white" style="background:var(--brand);">{{ form.metodo_entrega.label }}</div>
        <div class="p-4">
          <div class="flex flex-col gap-2" id="id_metodo_entrega_container">
              {{ form.metodo_entrega }}
          </div>
          {% if form.metodo_entrega.errors %}
            <p class="mt-1 text-sm text-red-600">{{ form.metodo_entrega.errors.as_text|cut:"* " }}</p>
          {% endif %}
        </div>
      </div>
      {% if form.non_field_errors %}
        <div class="p-4">
          <div id="limit-error-box" class="px-3 py-2 rounded-xl border bg-red-50 border-red-300 text-red-800">
            {% for error in form.non_field_errors %}
              <p class="text-sm">{{ error }}</p>
            {% endfor %}
          </div>
        </div>
      {% endif %}

      <div class="p-4 border-t sticky-actions" style="border-color:var(--line)">
        <div class="flex flex-col md:flex-row gap-2 md:justify-end">
          <a href="{% url 'home' %}"
             class="inline-flex justify-center items-center px-4 py-3 rounded-xl font-semibold"
             style="background:#e11d48; color:#fff;">
            Cancelar
          </a>
          <button id="btn-submit" type="submit"
                  class="inline-flex justify-center items-center px-4 py-3 rounded-xl font-semibold"
                  style="background:var(--brand); color:#fff; box-shadow:0 8px 24px color-mix(in oklab, var(--brand) 30%, transparent);">
            Proceder a Confirmaci√≥n
          </button>
        </div>
      </div>
    </form>
  </section>
</main>

<style>
  #id_monto, #id_tipo_operacion, #id_moneda_origen, #id_moneda_destino, #id_modalidad_tasa, #id_medio_pago, #id_medio_acreditacion {
    width:100%; border:1.5px solid var(--line); border-radius:12px;
    padding:10px 12px; height:42px; font-size:.95rem; color:var(--ink); background:#fff;
    transition: box-shadow .15s ease, border-color .15s ease;
  }
  #id_monto:focus, #id_tipo_operacion:focus, #id_moneda_origen:focus, #id_moneda_destino:focus,
  #id_modalidad_tasa:focus, #id_medio_pago:focus, #id_medio_acreditacion:focus {
    outline:none; border-color:var(--brand); box-shadow:0 0 0 3px rgba(124,58,237,.18);
  }

  /* Input real de monto oculto visualmente (POST intacto) */
  #id_monto {
    position: absolute !important;
    left: -99999px !important;
    width: 1px !important;
    height: 1px !important;
    opacity: 0 !important;
    pointer-events: none !important;
  }
  
  /* Estilos para los radio buttons de metodo_entrega */
  #id_metodo_entrega_container ul {
    list-style-type: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }
  #id_metodo_entrega_container li {
    display: block;
  }
  #id_metodo_entrega_container label {
    display: flex;
    align-items: center;
    padding: 0.75rem 1rem;
    border: 1.5px solid var(--line);
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.15s ease;
  }
  #id_metodo_entrega_container input[type="radio"] {
    margin-right: 0.75rem;
  }
  #id_metodo_entrega_container input[type="radio"]:checked + label {
    border-color: var(--brand);
    background-color: color-mix(in oklab, var(--brand-soft) 85%, white);
    box-shadow: 0 0 0 3px rgba(124,58,237,.18);
  }

  .sticky-actions {
    position: sticky; bottom: 0;
    background: #fff;
    backdrop-filter: saturate(1.1) blur(4px);
    box-shadow: 0 -6px 16px rgba(0,0,0,0.06);
    z-index: 20;
  }
</style>

<script>
(function () {
  const tipo = document.getElementById('id_tipo_operacion');
  const ori  = document.getElementById('id_moneda_origen');
  const dst  = document.getElementById('id_moneda_destino');
  const monto= document.getElementById('id_monto');
  const btn  = document.getElementById('btn-submit');

  const medioPagoBlock = document.getElementById('medio-pago-block');
  const medioPagoSelect = document.getElementById('id_medio_pago');
  const btnAgregarMedioPago = document.getElementById('btn-agregar-medio-pago');
  const contenedorFormPago = document.getElementById('contenedor-form-pago');
  const contenedorDetallePago = document.getElementById('contenedor-detalle-pago');

  const medioAcreditacionBlock = document.getElementById('medio-acreditacion-block');
  const medioAcreditacionSelect = document.getElementById('id_medio_acreditacion');
  const medioAcreditacionDetalles = document.getElementById('medio-acreditacion-detalles');
  const detalleAliasAcreditacion = document.getElementById('detalle-alias-acreditacion');
  const detalleTipoAcreditacion = document.getElementById('detalle-tipo-acreditacion');
  const detalleCamposDinamicosAcreditacion = document.getElementById('detalle-campos-dinamicos-acreditacion');

  const metodoEntregaBlock = document.getElementById('metodo-entrega-block'); // <-- NUEVO

  const form = document.getElementById('form-operacion');
  const hasErrors = form && form.dataset.hasErrors === '1';

  const nfPY = new Intl.NumberFormat('es-PY', { maximumFractionDigits: 0 });

  // mediosPagoData ya se pasa desde el contexto de Django
  const mediosPagoData = JSON.parse('{{ medios_pago_json|default:"{}"|escapejs }}');
  const mediosAcreditacionData = JSON.parse('{{ medios_acreditacion_json|default:"{}"|escapejs }}');

  const isPYG = v => String(v||'').toUpperCase()==='PYG';
  const isForeign = v => v && !isPYG(v);

  function enforce() {
    let ok = true;
    const t = tipo?.value || '';
    const o = ori?.value  || '';
    const d = dst?.value  || '';
    const m = parseFloat(monto?.value || '0');

    /* Visibilidad seg√∫n tipo */
    if (t === 'venta') {
      medioPagoBlock?.classList.remove('hidden');
      medioAcreditacionBlock?.classList.add('hidden');
      medioAcreditacionDetalles?.classList.add('hidden');
    } else if (t === 'compra') {
      medioAcreditacionBlock?.classList.remove('hidden');
      medioPagoBlock?.classList.add('hidden');
      contenedorFormPago?.classList.add('hidden'); // Ocultar form de pago si es compra
      contenedorDetallePago?.classList.add('hidden'); // Ocultar detalle de pago si es compra
    } else {
      medioPagoBlock?.classList.add('hidden');
      contenedorFormPago?.classList.add('hidden');
      contenedorDetallePago?.classList.add('hidden');
      medioAcreditacionBlock?.classList.add('hidden');
      medioAcreditacionDetalles?.classList.add('hidden');
    }
    
    // --- L√ìGICA MODIFICADA ---
    // La condici√≥n clave: solo mostrar el selector de Stripe si es Compra Y USD -> PYG
    if (t === 'compra' && o === 'USD' && d === 'PYG') {
      metodoEntregaBlock?.classList.remove('hidden');
    } else {
      metodoEntregaBlock?.classList.add('hidden');
    }

    /* En caso de errores/mensajes (l√≠mite, etc.), MANTENER SOLO el que corresponde al tipo actual */
    if (hasErrors) {
      if (t === 'venta') {
        medioPagoBlock?.classList.remove('hidden');
        medioAcreditacionBlock?.classList.add('hidden');
      } else if (t === 'compra') {
        medioAcreditacionBlock?.classList.remove('hidden');
        medioPagoBlock?.classList.add('hidden');
      }
    }
    // -------------------------------------------------------------

    /* Habilitaci√≥n del bot√≥n (l√≥gica visual) */
    if (t === 'compra') {
      if (isPYG(o) || isForeign(d)) ok = false;
    } else if (t === 'venta') {
      if (isForeign(o) || isPYG(d)) ok = false;
    } else {
      ok = false;
    }
    if (!t || !o || !d || o === d || !(m > 0)) ok = false;
    if (btn) btn.disabled = !ok;
  }
  ['change','input'].forEach(ev=>{
    tipo?.addEventListener(ev, enforce);
    ori?.addEventListener(ev, enforce);
    dst?.addEventListener(ev, enforce);
    monto?.addEventListener(ev, enforce);
  });

  // --- L√≥gica AJAX para Medios de Pago ---
  async function cargarFormularioCreacion() {
    contenedorDetallePago.classList.add('hidden'); // Ocultar detalles si se va a crear
    contenedorFormPago.classList.remove('hidden');
    try {
      const response = await fetch('{% url "pagos:ajax_clientes_create" %}', {
        method: 'GET', // Opcional, para obtener un formulario vac√≠o
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'Content-Type': 'application/json',
        },
      });
      const data = await response.json();
      if (data.success) {
        contenedorFormPago.innerHTML = data.form_html;
        inicializarFormularioDinamico(contenedorFormPago);
      } else {
        // Manejar error si la carga inicial del formulario falla
        contenedorFormPago.innerHTML = `<p class="text-red-600">${data.message}</p>`;
      }
    } catch (error) {
      console.error('Error al cargar el formulario de creaci√≥n:', error);
      contenedorFormPago.innerHTML = `<p class="text-red-600">Error al cargar el formulario de creaci√≥n.</p>`;
    }
  }

  async function enviarFormularioCreacion(event) {
    event.preventDefault();
    const formElement = event.target;
    const formData = new FormData(formElement);

    try {
      const response = await fetch('{% url "pagos:ajax_clientes_create" %}', {
        method: 'POST',
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
        },
        body: formData,
      });
      const data = await response.json();

      if (data.success) {
        // A√±adir el nuevo medio de pago al select
        const newOption = new Option(data.alias, data.id_medio, true, true);
        medioPagoSelect.add(newOption);
        medioPagoSelect.value = data.id_medio; // Seleccionar el nuevo medio
        
        // Actualizar mediosPagoData para que los detalles funcionen
        mediosPagoData[data.id_medio] = {
            id_medio: data.id_medio,
            alias: data.alias,
            tipo_nombre: data.tipo_nombre,
            campos: data.campos,
        };

        mostrarDetallesMedioPago(); // Mostrar los detalles del nuevo medio
        contenedorFormPago.classList.add('hidden'); // Ocultar el formulario de creaci√≥n
        messages.success(data.message); // Mostrar mensaje de √©xito
      } else {
        // Mostrar el formulario con errores
        contenedorFormPago.innerHTML = data.form_html;
        inicializarFormularioDinamico(contenedorFormPago); // Re-inicializar scripts del form
        messages.error(data.message); // Mostrar mensaje de error
      }
    } catch (error) {
      console.error('Error al enviar el formulario de creaci√≥n:', error);
      messages.error('Error de red al intentar crear el medio de pago.');
    }
  }

  async function cargarFormularioEdicion(idMedio) {
    contenedorFormPago.classList.add('hidden'); // Ocultar formulario de creaci√≥n
    contenedorDetallePago.classList.remove('hidden');
    try {
      const response = await fetch(`/pagos/api/clientes/${idMedio}/form/`, {
        method: 'GET',
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
        },
      });
      const data = await response.json();
      if (data.success) {
        contenedorDetallePago.innerHTML = data.form_html;
        // Deshabilitar todos los campos del formulario cargado para que sea solo de visualizaci√≥n
        contenedorDetallePago.querySelectorAll('input, select, textarea, button[type="submit"]').forEach(field => {
          field.setAttribute('disabled', 'true');
        });
        // Ocultar el bot√≥n de guardar en el modo de solo lectura
        const saveButton = contenedorDetallePago.querySelector('button[type="submit"]');
        if (saveButton) {
          saveButton.style.display = 'none';
        }
        // Ocultar el bot√≥n de cancelar tambi√©n, ya que no hay acci√≥n real
        const cancelButton = contenedorDetallePago.querySelector('#btn-cancelar-form-pago');
        if (cancelButton) {
          cancelButton.style.display = 'none';
        }
      } else {
        contenedorDetallePago.innerHTML = `<p class="text-red-600">${data.message}</p>`;
      }
    } catch (error) {
      console.error('Error al cargar el formulario de edici√≥n:', error);
      contenedorDetallePago.innerHTML = `<p class="text-red-600">Error al cargar los detalles del medio de pago.</p>`;
    }
  }

  function inicializarFormularioDinamico(container) {
    const formElement = container.querySelector('form.gx-form');
    if (formElement) {
      formElement.addEventListener('submit', enviarFormularioCreacion);
      const tipoSelect = formElement.querySelector('#id_tipo');
      if (tipoSelect) {
        tipoSelect.addEventListener('change', async function() {
          const selectedTipoId = this.value;
          if (selectedTipoId) {
            // Recargar el formulario con el tipo seleccionado para mostrar los campos din√°micos
            try {
              const response = await fetch(`{% url "pagos:ajax_clientes_create" %}?tipo=${selectedTipoId}`, {
                method: 'GET',
                headers: {
                  'X-Requested-With': 'XMLHttpRequest',
                  'Content-Type': 'application/json',
                },
              });
              const data = await response.json();
              if (data.success) {
                contenedorFormPago.innerHTML = data.form_html;
                inicializarFormularioDinamico(contenedorFormPago); // Re-inicializar
              } else {
                contenedorFormPago.innerHTML = `<p class="text-red-600">${data.message}</p>`;
              }
            } catch (error) {
              console.error('Error al recargar el formulario por cambio de tipo:', error);
            }
          }
        });
      }
      // Manejar el bot√≥n de cancelar dentro del formulario AJAX
      const btnCancelar = formElement.querySelector('#btn-cancelar-form-pago');
      if (btnCancelar) {
        btnCancelar.addEventListener('click', () => {
          contenedorFormPago.classList.add('hidden');
          // Si hab√≠a un medio de pago seleccionado antes, mostrar sus detalles
          if (medioPagoSelect.value) {
            cargarFormularioEdicion(medioPagoSelect.value);
          } else {
            // Si no hab√≠a nada seleccionado, ocultar tambi√©n el contenedor de detalles
            contenedorDetallePago.classList.add('hidden');
          }
        });
      }
    }
  }

  btnAgregarMedioPago?.addEventListener('click', cargarFormularioCreacion);

  medioPagoSelect?.addEventListener('change', function() {
    const selectedId = this.value;
    if (selectedId) {
      cargarFormularioEdicion(selectedId);
    } else {
      contenedorDetallePago.classList.add('hidden');
      contenedorFormPago.classList.add('hidden');
    }
  });

  // Inicializar al cargar la p√°gina si ya hay un medio de pago seleccionado
  if (medioPagoSelect?.value) {
    cargarFormularioEdicion(medioPagoSelect.value);
  }

  // Funci√≥n para mostrar mensajes de Django (si se usan)
  function showMessage(type, text) {
    const messagesContainer = document.getElementById('flash-messages') || document.createElement('div');
    if (!messagesContainer.id) {
      messagesContainer.id = 'flash-messages';
      messagesContainer.className = 'mb-3 space-y-2';
      form.before(messagesContainer);
    }
    const messageDiv = document.createElement('div');
    messageDiv.className = `px-3 py-2 rounded-xl border ${type === 'error' ? 'bg-red-50 border-red-300 text-red-800' : 'bg-green-50 border-green-300 text-green-800'}`;
    messageDiv.textContent = text;
    messagesContainer.appendChild(messageDiv);
    setTimeout(() => messageDiv.remove(), 5000); // Eliminar mensaje despu√©s de 5 segundos
  }
  // Sobrescribir messages.success y messages.error para usar nuestra funci√≥n
  window.messages = {
    success: (text) => showMessage('success', text),
    error: (text) => showMessage('error', text),
    info: (text) => showMessage('info', text), // A√±adir info si es necesario
  };

  enforce();
  // La l√≥gica de mostrarDetallesMedioPago ya no es necesaria directamente aqu√≠,
  // ya que cargarFormularioEdicion se encarga de mostrar los detalles.
  // mostrarDetallesMedioPago();
  mostrarDetallesMedioAcreditacion();

  /* === Formateo visual del monto (input espejo) === */
  function cleanFormat(str) {
    return String(str || '').replace(/\./g, '').replace(/\s+/g, '').replace(/[^0-9]/g, '');
  }
  function applyFormat(rawStr) {
    const clean = cleanFormat(rawStr);
    if (!clean) return '';
    const normalized = clean.replace(/^0+(?=\d)/, '');
    return nfPY.format(Number(normalized));
  }
  function setFormattedValuePreservingCaret(input, nextFormatted) {
    const prev = input.value;
    const start = input.selectionStart || 0;
    const digitsBefore = prev.slice(0, start).replace(/\D/g, '').length;
    input.value = nextFormatted;
    let pos = 0, consumed = 0;
    while (pos < nextFormatted.length && consumed < digitsBefore) {
      if (/\d/.test(nextFormatted[pos])) consumed++;
      pos++;
    }
    input.setSelectionRange(pos, pos);
  }

  const inputHidden  = document.getElementById('id_monto');
  const inputVisible = document.getElementById('id_monto_visible');

  if (inputHidden && inputVisible) {
    const initial = inputHidden.value || '';
    inputVisible.value = applyFormat(initial);

    inputVisible.addEventListener('focus', () => {
      inputVisible.style.borderColor = 'var(--brand)';
      inputVisible.style.boxShadow = '0 0 0 3px rgba(124,58,237,.18)';
    });
    inputVisible.addEventListener('blur', () => {
      inputVisible.style.borderColor = 'var(--line)';
      inputVisible.style.boxShadow = 'none';
    });

    inputVisible.addEventListener('input', () => {
      const formatted = applyFormat(inputVisible.value);
      setFormattedValuePreservingCaret(inputVisible, formatted);
      inputHidden.value = cleanFormat(formatted);            // limpio para POST
      inputHidden.dispatchEvent(new Event('input',  {bubbles:true}));
      inputHidden.dispatchEvent(new Event('change', {bubbles:true}));
    });

    inputHidden.addEventListener('change', () => {
      inputVisible.value = applyFormat(inputHidden.value);
    });
  }

  /* === Formateo de n√∫meros con miles en mensajes/errores === */
  function formatNumbersIn(container){
    if (!container) return;
    const nf = new Intl.NumberFormat('es-PY', { maximumFractionDigits: 0 });
    container.querySelectorAll('*').forEach(node=>{
      node.childNodes?.forEach(ch=>{
        if (ch.nodeType === Node.TEXT_NODE) {
          const text = ch.nodeValue;
          const replaced = text.replace(/\b(\d{4,})\b/g, (m)=> nf.format(Number(m)));
          if (replaced !== text) ch.nodeValue = replaced;
        }
      });
    });
  }
  formatNumbersIn(document.getElementById('limit-error-box'));
  formatNumbersIn(document.getElementById('flash-messages'));

})();
</script>
{% endblock %}
