diff --git a/usuarios/templates/usuarios/ted.html b/usuarios/templates/usuarios/ted.html
index d3e469d1c1d44e765e178b1f6fbe4129342bdd6e..916c717e646a5da17ba2197bfc6db10191ce93dd 100644
--- a/usuarios/templates/usuarios/ted.html
+++ b/usuarios/templates/usuarios/ted.html
@@ -84,77 +84,57 @@
           <div class="ted-screen-inner">
             <!-- Cabecera -->
             <header class="ted-header">
               <div class="logo-badge">
                 <img class="ted-logo" src="{% static 'img/logo-secundario.png' %}" alt="Global Exchange">
               </div>
               <div class="welcome-badge" id="welcome-badge">ðŸ‘‹ Bienvenido</div>
               <h1 class="ted-title">GLOBAL EXCHANGE</h1>
             </header>
 
             <!-- Vistas -->
             <div class="ted-views-container">
               <!-- VISTA: Inicio -->
               <section id="login-screen" class="ted-screen-view active" aria-live="polite">
                 <div class="view-content">
                   <p>Hola,
                     <strong>{% firstof request.user.get_full_name request.user.username request.user.email "Usuario" %}</strong>.
                   </p>
 
                   <div class="location-picker">
                     <label for="select-ubicacion" class="location-label">UbicaciÃ³n del TED</label>
                     <select id="select-ubicacion" class="ted-select" aria-required="true">
                       <option value="">â€” SeleccionÃ¡ una sucursal â€”</option>
                       <!-- Si ya renderizas ubicaciones desde el server, mantienen este select -->
                     </select>
-                    <p class="location-hint">Para continuar al menÃº de operaciones.</p>
+                    <p class="location-hint">Tras elegir la sucursal, ingresÃ¡ el cÃ³digo de la operaciÃ³n.</p>
                   </div>
 
                   <button class="gx-btn" type="button" id="btn-login-ingresar" disabled>Continuar</button>
                 </div>
               </section>
 
-              <!-- VISTA: MenÃº -->
-              <section id="menu-screen" class="ted-screen-view" aria-live="polite">
-                <div class="view-content">
-                  <h2 style="text-align:center;margin-bottom:12px">Operaciones disponibles</h2>
-                  <div class="menu-grid">
-                    <button id="btn-menu-retirar" type="button" class="menu-card" aria-label="Retiro de dinero">
-                      <div class="menu-icon">ðŸ’µ</div>
-                      <div class="menu-label">Retiro de Dinero</div>
-                    </button>
-                    <button id="btn-menu-deposito" type="button" class="menu-card" aria-label="DepÃ³sito de dinero">
-                      <div class="menu-icon">ðŸ’°</div>
-                      <div class="menu-label">DepÃ³sito de Dinero</div>
-                    </button>
-                  </div>
-                  <div style="text-align:center;margin-top:16px">
-                    <button id="btn-menu-salir" type="button" class="gx-btn gx-btn--ghost">ðŸšª Salir</button>
-                  </div>
-                </div>
-              </section>
-
               <!-- VISTA: Retiro / DepÃ³sito (ingreso cÃ³digo) -->
               <section id="transaction-screen" class="ted-screen-view" aria-live="polite">
                 <div class="view-content">
                   <h3 id="tx-title">OperaciÃ³n</h3>
                   <label for="transaction-number">Ingrese el cÃ³digo de operaciÃ³n</label>
                   <input id="transaction-number" type="text" class="ted-input" placeholder="CÃ³digo de operaciÃ³n" autocomplete="off" data-kb="num" />
                   
                   <!-- Divisas disponibles (solo para RETIRO) -->
                   <div id="retiro-currencies" class="currency-section" style="display:none">
                     <div class="currency-label">Divisas disponibles</div>
                     <div id="retiro-currency-list" class="currency-list" aria-live="polite">
                     </div>
                   </div>
 
                   <div class="button-group">
                     <button class="gx-btn gx-btn--ghost" type="button" id="btn-tx-cancelar">Cancelar</button>
                     <button class="gx-btn" type="button" id="btn-tx-validar">Validar</button>
                   </div>
                 </div>
               </section>
 
               <!-- VISTA: ConfirmaciÃ³n de monto -->
               <section id="confirm-amount-screen" class="ted-screen-view" aria-live="polite">
                 <div class="view-content view-content--centered">
                   <div class="confirm-title">
@@ -329,51 +309,51 @@
 
 <script>
   // Si querÃ©s limpiar tambiÃ©n cuando cambiÃ¡s de modo u operaciÃ³n:
   function resetCodigo() {
     const $code = document.getElementById("transaction-number");
     if ($code) $code.value = "";
   }
 (() => {
   const qs = (sel, el=document) => el.querySelector(sel);
   const qsa = (sel, el=document) => [...el.querySelectorAll(sel)];
   const FLAGS = {
     USD:'ðŸ‡ºðŸ‡¸', EUR:'ðŸ‡ªðŸ‡º', ARS:'ðŸ‡¦ðŸ‡·', BRL:'ðŸ‡§ðŸ‡·', PYG:'ðŸ‡µðŸ‡¾', CNY:'ðŸ‡¨ðŸ‡³', JPY:'ðŸ‡¯ðŸ‡µ',
     GBP:'ðŸ‡¬ðŸ‡§', UYU:'ðŸ‡ºðŸ‡¾', CLP:'ðŸ‡¨ðŸ‡±', COP:'ðŸ‡¨ðŸ‡´', BOB:'ðŸ‡§ðŸ‡´', PEN:'ðŸ‡µðŸ‡ª', MXN:'ðŸ‡²ðŸ‡½',
     CAD:'ðŸ‡¨ðŸ‡¦', AUD:'ðŸ‡¦ðŸ‡º', CHF:'ðŸ‡¨ðŸ‡­', VES:'ðŸ‡»ðŸ‡ª', VEF:'ðŸ‡»ðŸ‡ª', RUB:'ðŸ‡·ðŸ‡º', ILS:'ðŸ‡®ðŸ‡±',
     CRC:'ðŸ‡¨ðŸ‡·', DOP:'ðŸ‡©ðŸ‡´', NOK:'ðŸ‡³ðŸ‡´', SEK:'ðŸ‡¸ðŸ‡ª', DKK:'ðŸ‡©ðŸ‡°', ZAR:'ðŸ‡¿ðŸ‡¦', HNL:'ðŸ‡­ðŸ‡³',
     GTQ:'ðŸ‡¬ðŸ‡¹', PAB:'ðŸ‡µðŸ‡¦', NIO:'ðŸ‡³ðŸ‡®', TRY:'ðŸ‡¹ðŸ‡·', INR:'ðŸ‡®ðŸ‡³', KRW:'ðŸ‡°ðŸ‡·', SGD:'ðŸ‡¸ðŸ‡¬', HKD:'ðŸ‡­ðŸ‡°'
   };
   const flag = (code) => FLAGS[String(code||'').toUpperCase()] || 'ðŸ³ï¸';
   const formatAmountRaw = (a) => {
     try{ const n = Number(a); if(Number.isFinite(n)) return n.toLocaleString('es-PY',{maximumFractionDigits:0}); }
     catch(e){}
     return String(a);
   };
   const formatAmount = (a, code)=> `${formatAmountRaw(a)} ${code}`;
 
-  const ctx = { modo:null, code:null, ubicacion:null, raw:null, reserva_id:null, ticket_url:null, tx_id:null };
+  const ctx = { modo:null, lastModo:null, code:null, ubicacion:null, raw:null, reserva_id:null, ticket_url:null, tx_id:null };
 
   // === CSRF ===
   function getCookie(name){
     const m = document.cookie.match(new RegExp('(^|; )'+name+'=([^;]+)'));
     return m ? decodeURIComponent(m[2]) : null;
   }
   const CSRF = getCookie('csrftoken');
 
   async function api(url, body){
     const isPost = !!body;
     const res = await fetch(url, {
       method: isPost ? 'POST' : 'GET',
       credentials:'same-origin',
       headers: isPost ? {'Content-Type':'application/json','X-CSRFToken': CSRF || ''} : {}
       , body: isPost ? JSON.stringify(body||{}) : undefined
     });
     const ct = res.headers.get('content-type') || '';
     let payload = null;
     if(ct.includes('application/json')){
       try{ payload = await res.json(); }catch(_){ payload = null; }
     }else{
       const text = await res.text().catch(()=> '');
       payload = { ok:false, error: text };
     }
     const notOk = !res.ok || (payload && payload.ok === false);
@@ -404,101 +384,114 @@
     // Consideramos 2xx/3xx como Ã©xito; no parseamos cuerpo
     if(!res.ok && (res.status<300 || res.status>=400)){
       const t = await res.text().catch(()=> '');
       const e = new Error(t || 'Fallo activando cliente');
       e.status = res.status;
       throw e;
     }
     return true;
   }
 
   const URLS = {
     validar: "{% url 'usuarios:ted_api_validar' %}",
     precontar: "{% url 'usuarios:ted_api_precontar' %}",
     otp_enviar: "{% url 'usuarios:ted_api_otp_enviar' %}",
     otp_verificar: "{% url 'usuarios:ted_api_otp_verificar' %}",
     confirmar: "{% url 'usuarios:ted_api_confirmar' %}",
     ubicaciones: "{% url 'usuarios:ted_api_ubicaciones' %}",
     terminal: "{% url 'usuarios:ted_api_terminal' %}",
     divisas: "{% url 'ted:monedas_disponibles' %}",
     // ðŸ†• endpoint HTML que setea el cliente activo en la sesiÃ³n
     set_cliente: "{% url 'usuarios:seleccionar_cliente' %}"
   };
 
   /* Carga y pinta las divisas disponibles para RETIRO (segÃºn sucursal) */
   async function loadRetiroCurrencies(){
-    try{
-      const cont = qs('#retiro-currencies');
-      const list = qs('#retiro-currency-list');
-      if(!cont || !list) return;
+    const cont = qs('#retiro-currencies');
+    const list = qs('#retiro-currency-list');
+    if(!cont || !list) return;
 
+    if (ctx.modo !== 'retiro' || !ctx.raw) {
+      list.innerHTML = '';
+      cont.style.display = 'none';
+      cont.setAttribute('aria-hidden','true');
+      return;
+    }
+
+    try{
       const data = await api(`${URLS.divisas}?ubicacion=${encodeURIComponent(ctx.ubicacion||'')}`);
       const currencies = (data && (data.currencies || data.monedas)) || [];
 
       if(currencies.length === 0){
         list.innerHTML = '<span style="opacity:.8">Sin stock disponible.</span>';
       }else{
         list.innerHTML = currencies.map(c =>
           `<span class="currency-chip" data-cur="${c}" title="${c}">${flag(c)}</span>`
         ).join('');
       }
-      cont.style.display = (ctx.modo === 'retiro') ? 'block' : 'none';
+      cont.style.display = 'block';
+      cont.setAttribute('aria-hidden','false');
     }catch(_e){
-      const cont = qs('#retiro-currencies');
-      const list = qs('#retiro-currency-list');
-      if(cont && list){
+      if (ctx.modo === 'retiro' && ctx.raw) {
         list.innerHTML = '<span style="opacity:.8">No se pudo cargar el stock.</span>';
-        cont.style.display = (ctx.modo === 'retiro') ? 'block' : 'none';
+        cont.style.display = 'block';
+        cont.setAttribute('aria-hidden','false');
+      } else {
+        list.innerHTML = '';
+        cont.style.display = 'none';
+        cont.setAttribute('aria-hidden','true');
       }
     }
   }
 
   /* show() + control del â€œBienvenidoâ€ SOLO en Inicio */
   const show = (id) => {
     qsa('.ted-screen-view').forEach(el => {
       el.classList.remove('active'); el.setAttribute('aria-hidden','true'); el.style.display='none';
     });
     const el = qs('#'+id);
     if(el){
       el.classList.add('active'); el.setAttribute('aria-hidden','false'); el.style.display='block';
     }
     const header = qs('.ted-header');
     header?.classList.toggle('compact', id !== 'login-screen');
 
     const screen = qs('.ted-screen');
     if(screen){
       screen.classList.toggle('is-home', id === 'login-screen');
     }
     const wb = qs('#welcome-badge');
     if(wb){
       const isHome = (id === 'login-screen');
       wb.classList.toggle('hidden', !isHome);
       if(isHome) wb.style.removeProperty('display');
     }
     const cont = qs('#retiro-currencies');
     if(cont){
-      cont.style.display = (id === 'transaction-screen' && ctx.modo === 'retiro') ? 'block' : 'none';
+      const shouldShow = id === 'transaction-screen' && ctx.modo === 'retiro' && ctx.raw;
+      cont.style.display = shouldShow ? 'block' : 'none';
+      cont.setAttribute('aria-hidden', shouldShow ? 'false' : 'true');
     }
   };
 
   function showError(stage, err){
     let userMsg = 'OcurriÃ³ un error inesperado.';
     let code = `E${err.status||'000'}-DESCONOCIDO`;
     
     // Obtener el mensaje del error de mÃºltiples fuentes posibles
     const rawMsg = (err && (err.message || '')) || 
                    (err && err.payload && (err.payload.error || err.payload.detail || err.payload.message)) || '';
     const raw = String(rawMsg).toLowerCase();
     
     // Debug: ver quÃ© mensaje viene realmente
     console.log('showError debug:', {stage, status: err.status, raw, payload: err.payload});
 
     switch(err.status){
       case 404: {
         if (raw.includes('cliente activo') || raw.includes('no pertenece')) {
           userMsg = 'El cÃ³digo no pertenece al cliente activo seleccionado. CambiÃ¡ el cliente activo y volvÃ© a intentarlo.';
           code = 'E404-CODIGO-CLIENTE';
         } else {
           userMsg = (stage==='validar')
             ? 'CÃ³digo no encontrado. VerificÃ¡ el nÃºmero e intentÃ¡ de nuevo.'
             : (stage==='confirmar' ? 'Reserva no encontrada o expirada. VolvÃ© a validar el cÃ³digo.' : 'Recurso no encontrado.');
           code = (stage==='validar') ? 'E404-CODIGO' : 'E404-RESERVA';
@@ -543,54 +536,63 @@
         else { userMsg = 'No autorizado para continuar.'; code = 'E403-AUT'; }
         break;
       case 410: userMsg = 'La operaciÃ³n expirÃ³. VolvÃ© a intentarlo.'; code = 'E410-EXPIRADO'; break;
       case 400: userMsg = err.message || 'Solicitud invÃ¡lida.'; code = 'E400-VALIDACION'; break;
       default:  userMsg = err.message || userMsg;
     }
     qs('#cancel-sub') && (qs('#cancel-sub').textContent = `${userMsg} (${code})`);
     show('cancel-screen');
   }
 
   // ====== helpers UI para limpiar estado ======
   const codeInput = () => qs('#transaction-number');
   window.addEventListener('pageshow', function (e) {
     if (e.persisted) {
       const el = codeInput();
       if (el) el.value = '';
     }
   });
   const btnTxValidar = () => qs('#btn-tx-validar');
 
   function resetTxUI() {
     const inp = codeInput();
     if (inp) inp.value = '';
     const btn = btnTxValidar();
     if (btn) btn.disabled = true;
-    ctx.code = null; ctx.raw = null; ctx.reserva_id = null; ctx.ticket_url = null; ctx.tx_id = null;
+    ctx.code = null; ctx.raw = null; ctx.reserva_id = null; ctx.ticket_url = null; ctx.tx_id = null; ctx.modo = null;
     const box = qs('#confirm-amount-box');
     if (box) { box.innerHTML = ''; box.style.display = 'none'; }
     qs('#confirm-amount-text')?.classList.remove('hidden');
+    const cont = qs('#retiro-currencies');
+    const list = qs('#retiro-currency-list');
+    if (cont && list) {
+      list.innerHTML = '';
+      cont.style.display = 'none';
+      cont.setAttribute('aria-hidden','true');
+    }
+    qsa('#retiro-currency-list .currency-chip').forEach(ch=> ch.classList.remove('match','dimmed'));
+    qs('#tx-title') && (qs('#tx-title').textContent = 'OperaciÃ³n');
   }
 
   // ---------------- Login (ubicaciÃ³n + terminal) ----------------
   const ubicSel = qs('#select-ubicacion');
   const btnLogin = qs('#btn-login-ingresar');
 
   async function cargarTerminal(){
     try{
       const data = await api(URLS.terminal);
       let serial = (data && data.serial) || null;
       
       // Si el backend devuelve LOCAL-DEV o estÃ¡ vacÃ­o, generar uno basado en ubicaciÃ³n
       if (!serial || serial === 'LOCAL-DEV' || serial === 'â€”') {
         const ubicacion = ctx.ubicacion || ubicSel?.value || '';
         if (ubicacion) {
           // Generar cÃ³digo basado en las primeras 3 letras de la ubicaciÃ³n + hash
           const code = ubicacion.substring(0, 3).toUpperCase();
           const hash = ubicacion.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0) % 1000;
           serial = `TED-${code}${String(hash).padStart(3, '0')}`;
         } else {
           serial = 'TED-001';
         }
       }
       
       qs('#info-serie').textContent = serial;
@@ -610,198 +612,220 @@
       ctx.ubicacion = ubicSel.value || null;
       btnLogin.disabled = !ctx.ubicacion;
       qs('#info-ubicacion').textContent = ctx.ubicacion || 'â€”';
     }catch(e){
       ubicSel.innerHTML = '<option value="">(Sin ubicaciones cargadas)</option>';
       btnLogin.disabled = true;
     }
   }
   ubicSel?.addEventListener('change', ()=>{
     ctx.ubicacion = ubicSel.value || null;
     btnLogin.disabled = !ctx.ubicacion;
     qs('#info-ubicacion').textContent = ctx.ubicacion || 'â€”';
     
     // Actualizar el nÃºmero de serie cuando cambia la ubicaciÃ³n
     if (ctx.ubicacion) {
       const code = ctx.ubicacion.substring(0, 3).toUpperCase();
       const hash = ctx.ubicacion.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0) % 1000;
       qs('#info-serie').textContent = `TED-${code}${String(hash).padStart(3, '0')}`;
     }
     
     try { loadRetiroCurrencies(); } catch(_){}
   });
 
   btnLogin?.addEventListener('click', ()=>{
     resetTxUI();
-    show('menu-screen');
-  });
-
-  // ---------------- MenÃº ----------------
-  qs('#btn-menu-retirar')?.addEventListener('click', ()=>{
-    ctx.modo = 'retiro';
-    resetTxUI();
-    qs('#tx-title').textContent = 'Retiro de Dinero';
     show('transaction-screen');
-    try { loadRetiroCurrencies(); } catch(_){}
-  });
-
-  qs('#btn-menu-deposito')?.addEventListener('click', ()=>{
-    ctx.modo = 'deposito';
-    resetTxUI();
-    qs('#tx-title').textContent = 'DepÃ³sito de Dinero';
-    show('transaction-screen');
-    const cont = qs('#retiro-currencies');
-    const list = qs('#retiro-currency-list');
-    if (cont && list) {
-      list.innerHTML = '';
-      cont.style.display = 'none';
-      cont.setAttribute('aria-hidden','true');
+    const input = codeInput();
+    if (input) {
+      input.focus();
     }
   });
 
-  qs('#btn-menu-salir')?.addEventListener('click', ()=>{
-    ctx.modo = null; resetTxUI(); show('login-screen');
-  });
-
   // ---------------- CÃ³digo + validar ----------------
   qs('#transaction-number')?.addEventListener('input', (e)=>{
     ctx.code = (e.target.value||'').trim();
     qs('#btn-tx-validar').disabled = !ctx.code;
   });
   qs('#btn-tx-cancelar')?.addEventListener('click', ()=>{
     resetTxUI();
-    show('menu-screen');
+    show('login-screen');
   });
 
   qs('#btn-tx-validar')?.addEventListener('click', async ()=>{
     try{
-      if(!ctx.modo) throw new Error('SeleccionÃ¡ primero Retiro o DepÃ³sito.');
-      const info = await api(URLS.validar, { codigo: (ctx.code||'').trim(), modo: ctx.modo });
-      // Validar que el tipo de transacciÃ³n coincida con el modo seleccionado
-      if (info.tipo_operacion && info.tipo_operacion !== ctx.modo) {
-        const tipoReal = info.tipo_operacion === 'retiro' ? 'Retiro' : 'DepÃ³sito';
-        const tipoEsperado = ctx.modo === 'retiro' ? 'Retiro' : 'DepÃ³sito';
-        throw Object.assign(new Error(`Este cÃ³digo es para ${tipoReal}, pero seleccionaste ${tipoEsperado}. VolvÃ© al menÃº y elegÃ­ la operaciÃ³n correcta.`), {status: 400});
+      const code = (ctx.code||'').trim();
+      if(!code) throw new Error('IngresÃ¡ el cÃ³digo de operaciÃ³n.');
+
+      let modos = [];
+      if (ctx.modo) {
+        modos = [ctx.modo];
+      } else if (ctx.lastModo) {
+        modos = ctx.lastModo === 'retiro' ? ['retiro', 'deposito'] : ['deposito', 'retiro'];
+      } else {
+        modos = ['retiro', 'deposito'];
+      }
+      let info = null;
+      let usedMode = ctx.modo || null;
+      let lastError = null;
+
+      for (const modo of modos) {
+        try {
+          const payload = { codigo: code, modo };
+          info = await api(URLS.validar, payload);
+          usedMode = info?.modo || info?.tipo_operacion || modo;
+          break;
+        } catch(err) {
+          lastError = err;
+          if (ctx.modo || modo === 'deposito') throw err;
+        }
+      }
+
+      if (!info) {
+        throw lastError || new Error('No se pudo validar la operaciÃ³n.');
       }
+
+      ctx.modo = (usedMode === 'deposito' || usedMode === 'retiro') ? usedMode : 'retiro';
+      ctx.lastModo = ctx.modo;
       ctx.raw  = info;
-      ctx.code = (info && info.codigo) ? String(info.codigo).trim() : (ctx.code||'').trim();
+      ctx.code = info && info.codigo ? String(info.codigo).trim() : code;
       ctx.tx_id = info && info.tx_id ? String(info.tx_id) : null;
 
+      const title = qs('#tx-title');
+      if (title) {
+        title.textContent = ctx.modo === 'deposito' ? 'DepÃ³sito de Dinero' : 'Retiro de Dinero';
+      }
+
       // ðŸ†• Sincronizar el cliente activo de la sesiÃ³n con el dueÃ±o del cÃ³digo
       //    (la vista `seleccionar_cliente` guarda SESSION_KEY en la sesiÃ³n)
       const clienteId = info && (info.cliente_id || info.cliente || info.owner_id);
       if (clienteId) {
         try { await postForm(URLS.set_cliente + '?next=' + encodeURIComponent(location.pathname), {cliente_id: clienteId}); }
         catch(_e){ /* si falla, continuamos: precontar devolverÃ¡ 404 y lo mostraremos bonito */ }
       }
 
       if (ctx.modo === 'retiro') {
+        await loadRetiroCurrencies();
         qsa('#retiro-currency-list .currency-chip').forEach(ch=>{
           if ((ch.dataset.cur||'').toUpperCase() === String(info.moneda||'').toUpperCase()) {
             ch.classList.add('match'); ch.classList.remove('dimmed');
           } else {
             ch.classList.add('dimmed'); ch.classList.remove('match');
           }
         });
+      } else {
+        const cont = qs('#retiro-currencies');
+        const list = qs('#retiro-currency-list');
+        if (list) list.innerHTML = '';
+        if (cont) {
+          cont.style.display = 'none';
+          cont.setAttribute('aria-hidden','true');
+        }
       }
 
       const box = qs('#confirm-amount-box');
       const textEl = qs('#confirm-amount-text');
       const emoji = flag(info.moneda);
       box.innerHTML = `
         <div class="cb-top">
           <span class="cb-chip"><span class="cb-flag">${emoji}</span><span class="cb-code">${info.moneda}</span></span>
           <div class="cb-mode">${ctx.modo==='deposito'?'DepÃ³sito':'Retiro'}</div>
         </div>
         <div class="cb-value"><span class="cb-number">${formatAmountRaw(info.monto)}</span> <span class="cb-code">${info.moneda}</span></div>
         <div class="cb-sub">TransacciÃ³n <code>${ctx.code}</code></div>
       `;
       box.style.display = 'block';
       textEl?.classList.add('hidden');
       show('confirm-amount-screen');
-    }catch(err){ showError('validar', err); }
+    }catch(err){
+      ctx.modo = null;
+      showError('validar', err);
+    }
   });
 
   // ---------------- Precontar + OTP ----------------
   qs('#btn-amount-cancel')?.addEventListener('click', ()=>{
     resetTxUI();
-    show('menu-screen');
+    show('transaction-screen');
+    const input = codeInput();
+    if (input) input.focus();
   });
   qs('#btn-amount-confirm')?.addEventListener('click', async ()=>{
     try{
+      if (!ctx.modo) throw new Error('ValidÃ¡ una operaciÃ³n antes de continuar.');
       const payload = { codigo: ctx.code, modo: ctx.modo, ubicacion: ctx.ubicacion };
       if (ctx.tx_id) payload.tx_id = ctx.tx_id;
       const data = await api(URLS.precontar, payload);
 
       ctx.reserva_id = data?.reserva_id ?? data?.reserva ?? data?.id ?? ctx.raw?.reserva_id ?? ctx.raw?.reserva ?? null;
 
       const list = qs('#otp-summary');
       if(list){
         if (ctx.modo === 'retiro' && data.breakdown && data.breakdown.length > 0) {
           const billsHTML = data.breakdown.map(b => 
             `<div style="display:inline-flex;align-items:center;gap:6px;padding:4px 10px;margin:3px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.15);border-radius:8px;font-size:14px;font-weight:600;">
               <span style="opacity:.85;">${b.unidades}Ã—</span>
               <span style="color:#10b981;font-weight:800;">${b.valor}</span>
               <span style="font-size:18px;">ðŸ’µ</span>
             </div>`
           ).join('');
           list.innerHTML = `<div style="display:flex;flex-wrap:wrap;justify-content:center;margin:8px 0;">${billsHTML}</div>${data.diff ? `<div style="font-size:13px;opacity:.75;margin-top:6px;">Redondeo: ${formatAmount(data.diff, data.moneda)}</div>` : ''}`;
         } else {
           list.innerHTML = '<div style="padding:10px;opacity:.85;font-size:14px;">ðŸ’° IngresÃ¡ los billetes en la ranura</div>';
         }
       }
 
       await api(URLS.otp_enviar, {reserva_id: ctx.reserva_id});
       show('otp-screen');
     }catch(err){ showError('precontar', err); }
   });
 
   // ---------------- OTP confirmar ----------------
   qs('#btn-otp-back')?.addEventListener('click', ()=> show('confirm-amount-screen'));
   qs('#btn-otp-confirm')?.addEventListener('click', async ()=>{
     try{
       const otp = (qs('#otp-input')?.value || '').trim();
       if(!otp) throw new Error('Ingrese el cÃ³digo OTP.');
       await api(URLS.otp_verificar, {reserva_id: ctx.reserva_id, otp});
       const result = await api(URLS.confirmar, {
         reserva_id: ctx.reserva_id,
         codigo: ctx.code,
         modo: ctx.modo,
         otp
       });
       ctx.ticket_url = result.ticket_url || null;
 
       qs('#success-message') && (qs('#success-message').textContent =
         `${ctx.modo==='deposito'?'DepÃ³sito':'Retiro'} completado para la transacciÃ³n ${ctx.code}.`);
       show('success-screen');
     }catch(err){ showError('confirmar', err); }
   });
 
   // ---------------- Botones de salida/imprimir ----------------
-  qs('#btn-success-exit')?.addEventListener('click', ()=> { resetTxUI(); show('menu-screen'); });
+  qs('#btn-success-exit')?.addEventListener('click', ()=> { resetTxUI(); show('login-screen'); });
   qs('#btn-success-print')?.addEventListener('click', ()=> { if(ctx.ticket_url){ window.open(ctx.ticket_url, 'ticket', 'width=460,height=640'); } });
-  qs('#btn-cancel-exit')?.addEventListener('click', ()=> { resetTxUI(); show('menu-screen'); });
+  qs('#btn-cancel-exit')?.addEventListener('click', ()=> { resetTxUI(); show('login-screen'); });
 
   // ---------------- Teclado virtual (delegaciÃ³n + foco seguro) ----------------
   let active = null;
 
   // Seguimos actualizando active con focus/blur por si hay mÃ¡s inputs con data-kb
   qsa('input[data-kb]').forEach(inp=>{
     inp.addEventListener('focus',()=> active=inp);
     inp.addEventListener('blur',()=> { if(active===inp) active=null; });
   });
 
   // Obtiene el input destino: prioriza el enfocado; si no, usa #transaction-number visible
   function getTargetInput(){
     if (active && document.body.contains(active)) return active;
     const focused = document.activeElement;
     if (focused && focused.matches && focused.matches('input[data-kb]')) return focused;
     const visible = qs('.ted-screen-view.active input[data-kb]') || qs('#transaction-number');
     return visible || null;
   }
 
   // DelegaciÃ³n: un solo listener para todo el teclado
   qs('.ted-pad')?.addEventListener('click', (ev)=>{
     const btn = ev.target.closest('.ted-key');
     if(!btn) return;
 
     const input = getTargetInput();
     