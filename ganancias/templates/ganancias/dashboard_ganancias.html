{% extends "admin_panel/dashboard.html" %}
{% load static %}

{% block title %}Dashboard de Ganancias{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    :root{
        --brand:#7c3aed; --brand-soft:#ede9fe; --brand-hover:#6d28d9;
        --ink:#111827; --muted:#6b7280; --light-gray:#f8f9fa; --line:#e5e7eb;
        --shadow-sm:0 2px 8px rgba(124,58,237,.08);
        --shadow-md:0 4px 12px rgba(124,58,237,.12);
        --shadow-lg:0 20px 40px rgba(124,58,237,.15);
    }

    /* === CONTENEDORES === */
    .container-wide{max-width:1360px;margin:0 auto;padding:0 16px;}

    /* Header */
    .dashboard-header{padding:1rem 0;margin-bottom:1.25rem;}
    .dashboard-header h1{color:#000;font-size:1.75rem;font-weight:700;margin:0;padding-left:clamp(24px,5vw,120px);}

    /* Filtros */
    .filter-section{
        background:#fff;
        border-radius:12px;
        box-shadow:var(--shadow-sm);
        padding:1.25rem;
        /* sin l√≠nea lateral */
        border-left:none;
        }
    .filter-section h3{font-size:1.05rem;font-weight:600;color:var(--muted);margin:0 0 1rem;display:flex;gap:.5rem;align-items:center;}
    .filter-section h3::before{content:"üîç";}
    .filter-row{display:flex;gap:1rem;align-items:flex-end;flex-wrap:wrap}
    .filter-col{flex:1;min-width:220px}
    .filter-form .form-label{font-weight:600;color:var(--muted);font-size:.875rem;margin-bottom:.5rem}
    .filter-form .form-control,.filter-form .form-select{border:1px solid var(--line);border-radius:8px;padding:.625rem .875rem;transition:.2s}
    .filter-form .form-control:focus,.filter-form .form-select:focus{border-color:var(--brand);box-shadow:0 0 0 3px color-mix(in oklab, var(--brand) 20%, transparent);outline:none}
    .btn-primary-custom{background:var(--brand);border:none;color:#fff;padding:.625rem 1.25rem;border-radius:8px;font-weight:600;box-shadow:0 12px 24px -10px rgba(124,58,237,.35);transition:.2s}
    .btn-primary-custom:hover{background:var(--brand-hover);transform:translateY(-1px);box-shadow:0 14px 28px -10px rgba(124,58,237,.45)}
    .btn-secondary-custom{background:#fff;border:2px solid var(--line);color:var(--muted);padding:.625rem 1.25rem;border-radius:8px;font-weight:600;transition:.2s}
    .btn-secondary-custom:hover{border-color:var(--brand);color:var(--brand);background:var(--brand-soft)}

    /* === GRID DE CONTENIDO: main (2.2fr) + aside (1fr) === */
    .content-grid{display:grid;grid-template-columns:2.2fr 1fr;gap:1.5rem;margin-top:1.25rem}

    /* Hero KPI a todo el ancho del grid */
    .metric-hero{grid-column:1 / -1;background:linear-gradient(135deg,var(--brand) 0%,var(--brand-hover) 100%);
        border-radius:20px;padding:2rem 2rem;box-shadow:var(--shadow-lg);position:relative;overflow:hidden;transition:.3s}
    .metric-hero::before{content:"";position:absolute;top:-50%;right:-20%;width:400px;height:400px;
        background:radial-gradient(circle,rgba(255,255,255,.15) 0%,transparent 70%);border-radius:50%}
    .metric-hero::after{content:"";position:absolute;bottom:-30%;left:-10%;width:300px;height:300px;
        background:radial-gradient(circle,rgba(255,255,255,.1) 0%,transparent 70%);border-radius:50%}
    .metric-hero:hover{transform:translateY(-3px);box-shadow:0 25px 50px rgba(124,58,237,.25)}
    .metric-hero-content{text-align:center;position:relative;z-index:1}
    .metric-hero-icon{font-size:2.3rem;margin-bottom:.35rem;display:inline-block;animation:float 3s ease-in-out infinite}
    @keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
    .metric-hero-label{color:rgba(255,255,255,.92);font-size:.95rem;font-weight:700;text-transform:uppercase;letter-spacing:1px;margin-bottom:.35rem}
    .metric-hero-value{color:#fff;font-size:clamp(2rem,4vw,2.8rem);font-weight:900;line-height:1.1;margin-bottom:.25rem;text-shadow:0 4px 12px rgba(0,0,0,.2)}
    .metric-hero-currency{color:rgba(255,255,255,.9);font-weight:800}

    /* Cards y charts */
    .card{background:#fff;border-radius:12px;box-shadow:var(--shadow-sm);padding:1.25rem}
    .card + .card{margin-top:1rem}
    .card-header{display:flex;align-items:center;gap:.6rem;margin-bottom:1rem;padding-bottom:.75rem;border-bottom:2px solid var(--light-gray)}
    .card-header h3{font-size:1.1rem;font-weight:700;color:#333;margin:0}
    .chart-container{position:relative;height:360px}
    .chart-container--compact{height:280px}

    /* KPIs laterales */
    .side-stack{display:flex;flex-direction:column;gap:1rem}
    .metric-card{background:#fff;border-radius:16px;padding:1.25rem;box-shadow:var(--shadow-sm);
        border:1px solid var(--line);display:flex;gap:1rem;align-items:center;position:relative;overflow:hidden}
    .metric-card::before{content:"";position:absolute;inset:0 0 auto 0;height:4px;background:linear-gradient(90deg,var(--brand),var(--brand-hover))}
    .metric-card-icon-wrapper{flex-shrink:0;width:52px;height:52px;background:linear-gradient(135deg,var(--brand-soft),rgba(255,255,255,.6));
        border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:1.4rem;box-shadow:0 4px 12px rgba(124,58,237,.12)}
    .metric-card-label{color:var(--muted);font-size:.8rem;font-weight:700;text-transform:uppercase;letter-spacing:.4px;margin-bottom:.35rem}
    .metric-card-value{color:var(--ink);font-size:1.8rem;font-weight:800;line-height:1;margin-bottom:.1rem}
    .metric-card-suffix{color:var(--brand);font-weight:600;font-size:.85rem}

    /* Tabla */
    .table-custom thead{background:linear-gradient(135deg,var(--brand) 0%,var(--brand-hover) 100%)}
    .table-custom thead th{color:#fff;font-weight:700;text-transform:uppercase;font-size:.8rem;letter-spacing:.5px;border:none;padding:.75rem 1rem}
    .table-custom tbody td{padding:.8rem 1rem;vertical-align:middle;border-bottom:1px solid var(--line)}
    .table-custom tbody tr:hover{background:var(--brand-soft)}
    .currency-badge{display:inline-block;padding:.35rem .6rem;background:var(--brand-soft);color:var(--brand);border-radius:6px;font-weight:700;font-size:.85rem}
    .amount-display{font-weight:700;color:var(--brand);font-size:1.05rem}

    /* Responsivo */
    @media (max-width:1200px){.content-grid{grid-template-columns:1.7fr 1fr}}
    @media (max-width:992px){
        .content-grid{grid-template-columns:1fr}
        .chart-container{height:320px}
    }

    /* Espaciado superior/inferior del encabezado de p√°gina */
    .page-header{
    margin-top: 22px;   /* aire contra el navbar/top */
    margin-bottom: 28px;/* separaci√≥n del bloque de filtros */
    padding-top: 6px;   /* sensaci√≥n de ‚Äúdespegado‚Äù */
    }
    .page-header h1{
    margin: 0 0 6px 0;  /* h1 pegado al subt√≠tulo, sin colisiones */
    }
    .page-header p{
    margin: 0;
    }

    /* Select lila para "Moneda Operada" */
    .filter-form .form-select{
    background-color: var(--brand-soft);  /* lila suave */
    color: var(--ink);                     /* texto legible */
    border-color: var(--brand);            /* borde lila */
    appearance: none;                      /* quita estilo nativo para que aplique el color */
    }

    /* Hover consistente */
    .filter-form .form-select:hover{
    border-color: var(--brand-hover);
    }

    /* Focus accesible y consistente (ya tienes sombra, reforzamos color) */
    .filter-form .form-select:focus{
    background-color: var(--brand-soft);
    border-color: var(--brand-hover);
    box-shadow: 0 0 0 3px color-mix(in oklab, var(--brand) 22%, transparent);
    outline: none;
    }

    /* === Forzar color lila en el item seleccionado del <select> === */
    .filter-form .form-select option:checked{
    background-color: var(--brand) !important; /* lila fuerte */
    color: #fff !important;
    }

    /* Hover lila en el desplegable (cubre m√°s navegadores/estados) */
    .filter-form .form-select option:hover,
    .filter-form .form-select option:focus,
    .filter-form .form-select option:active,
    .filter-form .form-select:focus option:hover{
    background-color: var(--brand) !important; /* lila */
    color: #fff !important;
    }


    /* En algunos navegadores, cuando el select est√° en foco,
    esta regla ayuda a mantener el color del seleccionado */
    .filter-form .form-select:focus option:checked{
    background-color: var(--brand) !important;
    color: #fff !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-wide">

  <header class="page-header flex items-center justify-between">
    <div>
      <h1 class="text-4xl font-extrabold mb-2 text-[var(--ink)]">Dashboard de Ganancias</h1>
      <p class="text-lg leading-relaxed max-w-2xl text-[var(--muted)]">
        Aqu√≠ puedes gestionar todas las cotizaciones registradas en el sistema.
      </p>
    </div>

    <div class="space-x-3 flex">
      <a href="{% url 'admin_panel:dashboard' %}"
         class="px-4 py-2 rounded-lg font-bold bg-[var(--brand-soft)] hover:brightness-95 text-[var(--brand-dark)]">
        ‚¨Ö Volver al Panel
      </a>
    </div>
  </header>

    <!-- Filtros -->
    <div class="filter-section">
        <h3>Filtros de B√∫squeda</h3>
        <form method="GET" action="{% url 'ganancias:dashboard_ganancias' %}" class="filter-form">
            <div class="filter-row">
                <div class="filter-col">
                    <label for="fecha_inicio" class="form-label">üìÖ Fecha Inicio</label>
                    <input type="date" class="form-control" id="fecha_inicio" name="fecha_inicio" value="{{ fecha_inicio_seleccionada }}">
                </div>
                <div class="filter-col">
                    <label for="fecha_fin" class="form-label">üìÖ Fecha Fin</label>
                    <input type="date" class="form-control" id="fecha_fin" name="fecha_fin" value="{{ fecha_fin_seleccionada }}">
                </div>
                <div class="filter-col">
                    <label for="moneda_operada" class="form-label">üí± Moneda Operada</label>
                    <select class="form-select form-control" id="moneda_operada" name="moneda_operada">
                        <option value="">Todas las monedas</option>
                        {% for moneda in todas_las_monedas %}
                            {% if moneda.codigo != "PYG" %}
                                <option value="{{ moneda.id }}" {% if moneda.id|stringformat:"s" == moneda_operada_seleccionada %}selected{% endif %}>
                                    {{ moneda.codigo }} - {{ moneda.nombre }}
                                </option>
                            {% endif %}
                        {% endfor %}
                    </select>
                </div>
                <div class="filter-col">
                    <label for="tipo_operacion" class="form-label">Tipo de Operaci√≥n</label>
                    <select class="form-select form-control" id="tipo_operacion" name="tipo_operacion">
                        <option value="">Ganancias Generales</option>
                        <option value="venta" {% if tipo_operacion_seleccionado == 'venta' %}selected{% endif %}>Ganancias por Venta</option>
                        <option value="compra" {% if tipo_operacion_seleccionado == 'compra' %}selected{% endif %}>Ganancias por Compra</option>
                    </select>
                </div>
                <div class="filter-actions">
                    <button type="submit" class="btn btn-primary-custom">‚úì Aplicar</button>
                    <a href="{% url 'ganancias:dashboard_ganancias' %}" class="btn btn-secondary-custom">‚Ü∫ Limpiar</a>
                </div>
            </div>
        </form>
    </div>

    <!-- GRID DE CONTENIDO -->
    <div class="content-grid">

        <!-- HERO KPI a todo el ancho -->
        <section class="metric-hero">
            <div class="metric-hero-content">
                <div class="metric-hero-icon">üíµ</div>
                <div class="metric-hero-label">Ganancia Total del Per√≠odo</div>
                <div id="hero-total-amount" class="metric-hero-value">{{ ganancia_total_periodo|floatformat:0 }}</div>
                <div class="metric-hero-currency">PYG</div>
            </div>
        </section>

        <!-- COLUMNA PRINCIPAL (IZQUIERDA) -->
        <section class="main-col">
            <!-- 1) Evoluci√≥n diaria -->
            <div class="card">
                <div class="card-header">
                    <span>üìà</span><h3>Evoluci√≥n de Ganancias Diarias</h3>
                </div>
                <div class="chart-container">
                    <canvas id="gananciasDiariasChart"></canvas>
                </div>
            </div>

            <!-- 2) Distribuci√≥n por moneda (debajo de Evoluci√≥n) -->
            <div class="card">
                <div class="card-header">
                    <span>üí∞</span><h3>Distribuci√≥n por Moneda Operada</h3>
                </div>
                <div class="chart-container chart-container--compact">
                    <canvas id="gananciasPorMonedaChart"></canvas>
                </div>
            </div>
        </section>

        <!-- COLUMNA DERECHA (ASIDE) -->
        <aside class="side-col">
            <div class="side-stack">

                <!-- 1) D√≠as Analizados -->
                <div class="metric-card">
                    <div class="metric-card-icon-wrapper">üìä</div>
                    <div>
                        <div class="metric-card-label">D√≠as Analizados</div>
                        <div class="metric-card-value">{{ ganancias_por_dia|length }}</div>
                        <div class="metric-card-suffix">d√≠as con registro</div>
                    </div>
                </div>

                <!-- 2) Monedas Operadas -->
                <div class="metric-card">
                    <div class="metric-card-icon-wrapper">üí±</div>
                    <div>
                        <div class="metric-card-label">Monedas Operadas</div>
                        <div class="metric-card-value">{{ ganancias_por_moneda|length }}</div>
                        <div class="metric-card-suffix">monedas diferentes</div>
                    </div>
                </div>

                <!-- 3) Tabla por moneda -->
                <div class="card">
                    <div class="card-header">
                        <span>üìã</span><h3>Ganancias por Moneda</h3>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-custom">
                            <thead>
                                <tr><th>Moneda</th><th class="text-end">Ganancia Total (PYG)</th></tr>
                            </thead>
                            <tbody>
                            {% for ganancia in ganancias_por_moneda %}
                                <tr>
                                    <td>
                                        <span class="currency-badge">{{ ganancia.moneda_operada__codigo }}</span>
                                        <span class="ms-2">{{ ganancia.moneda_operada__nombre }}</span>
                                    </td>
                                    <td class="text-end"><span class="amount-display">{{ ganancia.total_moneda|floatformat:0 }}</span></td>
                                </tr>
                            {% empty %}
                                <tr><td colspan="2" class="text-muted">Sin datos en el per√≠odo seleccionado.</td></tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>
        </aside>

    </div> <!-- /content-grid -->

</div> <!-- /container-wide -->

{% comment %} Datos a JS {% endcomment %}
{{ fechas_grafico|json_script:"fechas_grafico_data" }}
{{ totales_grafico|json_script:"totales_grafico_data" }}
{{ ganancias_por_moneda|json_script:"ganancias_por_moneda_data" }}

<script>
document.addEventListener('DOMContentLoaded', function(){
    // Datos line chart
    const fechasGrafico = JSON.parse(document.getElementById('fechas_grafico_data').textContent);
    const totalesGrafico = JSON.parse(document.getElementById('totales_grafico_data').textContent);

    // Config global Chart.js
    Chart.defaults.font.family = "'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif";
    Chart.defaults.color = '#6c757d';

    // 1) Evoluci√≥n diaria (l√≠nea)
    const ctxDiarias = document.getElementById('gananciasDiariasChart').getContext('2d');
    new Chart(ctxDiarias,{
        type:'line',
        data:{
            labels:fechasGrafico,
            datasets:[{
                label:'Ganancia Diaria (PYG)',
                data:totalesGrafico,
                backgroundColor:'rgba(124,58,237,0.15)',
                borderColor:'#7c3aed',
                borderWidth:3, fill:true, tension:0.01,
                pointRadius:4, pointHoverRadius:6,
                pointBackgroundColor:'#7c3aed', pointBorderColor:'#fff',
                pointBorderWidth:2
            }]
        },
        options:{
            responsive:true, maintainAspectRatio:false,
            interaction:{intersect:false,mode:'index'},
            plugins:{legend:{display:false},
                tooltip:{backgroundColor:'rgba(0,0,0,.85)',padding:12,titleColor:'#fff',bodyColor:'#fff',
                    borderColor:'#7c3aed',borderWidth:1,displayColors:false,
                    callbacks:{label:(ctx)=>'Ganancia: '+ctx.parsed.y.toLocaleString('es-PY')+' PYG'}
                }
            },
            scales:{
                y:{beginAtZero:true, grid:{color:'rgba(0,0,0,.05)',drawBorder:false},
                    ticks:{callback:(v)=>v.toLocaleString('es-PY')},
                    title:{display:true,text:'Ganancia (PYG)',font:{weight:'600',size:12}}},
                x:{grid:{display:false,drawBorder:false}, title:{display:true,text:'Fecha',font:{weight:'600',size:12}}}
            }
        }
    });

    // Datos bar chart horizontal (2) Distribuci√≥n por Moneda
    const raw = JSON.parse(document.getElementById('ganancias_por_moneda_data').textContent);
    const labelsMoneda = raw.map(g=>g.moneda_operada__codigo);
    const dataMoneda   = raw.map(g=>parseFloat(g.total_moneda));
    const colors = ['#7c3aed','#a78bfa','#c084fc','#e879f9','#f472b6','#fb923c','#fbbf24','#34d399'];
    const bg = colors.map(c=>c+'40');

    const ctxMoneda = document.getElementById('gananciasPorMonedaChart').getContext('2d');
    new Chart(ctxMoneda,{
        type:'bar',
        data:{labels:labelsMoneda,datasets:[{label:'Ganancia Total (PYG)',data:dataMoneda,
            backgroundColor:bg,borderColor:colors,borderWidth:2,borderRadius:8,hoverBackgroundColor:colors}]},
        options:{
            indexAxis:'y',                        // horizontal (recomendado en docs)
            responsive:true, maintainAspectRatio:false,  // layout fluido
            plugins:{legend:{display:false},
                tooltip:{backgroundColor:'rgba(0,0,0,.85)',padding:12,titleColor:'#fff',bodyColor:'#fff',
                    borderColor:'#7c3aed',borderWidth:1,displayColors:false,
                    callbacks:{label:(ctx)=>'Total: '+ctx.parsed.x.toLocaleString('es-PY')+' PYG'}}
            },
            scales:{
                x:{beginAtZero:true, grid:{color:'rgba(0,0,0,.05)',drawBorder:false},
                    ticks:{callback:(v)=>v.toLocaleString('es-PY')}},
                y:{grid:{display:false,drawBorder:false}}
            }
        }
    });
});

/* === Formateo de miles (es-PY) para hero y tabla === */
(function(){
  const fmt = new Intl.NumberFormat('es-PY');

  // HERO (total del per√≠odo)
  const hero = document.getElementById('hero-total-amount');
  if (hero) {
    const raw = hero.textContent.trim();
    // limpia posibles separadores previos y convierte a n√∫mero
    const n = Number(raw.replace(/\./g,'').replace(/,/g,'.'));
    if (!Number.isNaN(n)) hero.textContent = fmt.format(Math.round(n));
  }

  // Tabla "Ganancias por Moneda" (usa la clase existente .amount-display)
  document.querySelectorAll('.amount-display').forEach(el => {
    const raw = el.textContent.trim();
    const n = Number(raw.replace(/\./g,'').replace(/,/g,'.'));
    if (!Number.isNaN(n)) el.textContent = fmt.format(Math.round(n));
  });
})();

</script>
{% endblock %}
