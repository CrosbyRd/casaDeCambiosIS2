{% extends "base.html" %}

{% block extra_head %}
<style>
  .alert{padding:10px 15px;border-radius:4px;margin-bottom:1rem}
  .alert-info{background:#d1ecf1;color:#0c5460;border:1px solid #bee5eb}
  .alert-danger{background:#f8d7da;color:#721c24;border:1px solid #f5c6cb}
  .total-value{font-weight:bold;color:#2c5aa0}
</style>
<script>
  function cargarValoresBase(selectElement){
    const monedaDestinoId=selectElement.value;
    const loading=document.getElementById('loading-indicator');
    const error=document.getElementById('error-message');
    const success=document.getElementById('success-message');
    error.style.display='none'; success.style.display='none';
    if(monedaDestinoId){
      loading.style.display='block';
      fetch(`{% url "cotizaciones:api_valores" %}?moneda_destino_id=${monedaDestinoId}`)
        .then(r=>r.json()).then(data=>{
          loading.style.display='none';
          if(data.success){
            document.getElementById('id_valor_compra').value=data.valor_compra;
            document.getElementById('id_valor_venta').value=data.valor_venta;
            success.textContent=`Valores base cargados para ${data.moneda}. Ahora puede agregar sus comisiones.`;
            success.style.display='block';
            calcularTotales();
          }else{
            error.textContent=data.error; error.style.display='block';
          }
        }).catch(()=>{
          loading.style.display='none';
          error.textContent='Error de conexión. Por favor, ingrese los valores manualmente.';
          error.style.display='block';
        });
    }
  }
  function calcularTotales(){
    const vc=parseFloat(document.getElementById('id_valor_compra').value)||0;
    const cc=parseFloat(document.getElementById('id_comision_compra').value)||0;
    const vv=parseFloat(document.getElementById('id_valor_venta').value)||0;
    const cv=parseFloat(document.getElementById('id_comision_venta').value)||0;
    document.getElementById('total_compra').textContent=(vc+cc).toFixed(4);
    document.getElementById('total_venta').textContent=(vv+cv).toFixed(4);
  }
  document.addEventListener('DOMContentLoaded',function(){
    ['id_valor_compra','id_comision_compra','id_valor_venta','id_comision_venta'].forEach(id=>{
      const el=document.getElementById(id); if(el) el.addEventListener('input',calcularTotales);
    }); calcularTotales();
  });
</script>
{% endblock %}

{% block content %}
<main class="container container--tight max-w-[1200px] mx-auto px-6 py-10">
  <h1 class="h1 h1--sm">
    {% if form.instance.pk %}
      Editar Cotización <span class="subtitle">— PYG a {{ form.instance.moneda_destino.simbolo }}</span>
    {% else %}
      Agregar Nueva Cotización
    {% endif %}
  </h1>

  {% if messages %}
    <ul class="messages">
      {% for message in messages %}
        <li class="{{ message.tags }}">{{ message }}</li>
      {% endfor %}
    </ul>
  {% endif %}

  <section class="box box--tight" style="max-width: 720px; margin: 0 auto;">
    <div id="loading-indicator" style="display:none;margin-bottom:1rem">
      <div class="alert alert-info">Cargando valores desde la API...</div>
    </div>
    <div id="success-message" class="alert alert-info" style="display:none;margin-bottom:1rem"></div>
    <div id="error-message" class="alert alert-danger" style="display:none;margin-bottom:1rem"></div>

    <form method="post" class="form form--compact">
      {% csrf_token %}

      {% if form.non_field_errors %}
        <div class="form-alert">{{ form.non_field_errors }}</div>
      {% endif %}

      <div class="form-group">
        <label for="id_moneda_destino">Moneda Destino:</label>
        {{ form.moneda_destino }}
        {% if not form.instance.pk %}
        <small class="form-text">Seleccione una moneda para cargar los valores base automáticamente</small>
        {% endif %}
      </div>

      <div class="form-group">
        <label for="id_valor_compra">Valor Compra Base (PYG):</label>
        {{ form.valor_compra }}
        <small class="form-text">Tasa base para compra (sin comisión)</small>
      </div>

      <div class="form-group">
        <label for="id_comision_compra">Comisión Compra (PYG):</label>
        {{ form.comision_compra }}
        <small class="form-text">Comisión adicional para compra</small>
      </div>

      <div class="form-group">
        <label>Total Compra:</label>
        <span id="total_compra" class="total-value">0.0000</span> PYG
        <small class="form-text">Valor Base + Comisión</small>
      </div>

      <div class="form-group">
        <label for="id_valor_venta">Valor Venta Base (PYG):</label>
        {{ form.valor_venta }}
        <small class="form-text">Tasa base para venta (sin comisión)</small>
      </div>

      <div class="form-group">
        <label for="id_comision_venta">Comisión Venta (PYG):</label>
        {{ form.comision_venta }}
        <small class="form-text">Comisión adicional para venta</small>
      </div>

      <div class="form-group">
        <label>Total Venta:</label>
        <span id="total_venta" class="total-value">0.0000</span> PYG
        <small class="form-text">Valor Base + Comisión</small>
      </div>

      <div class="actions">
        <button type="submit" class="btn">Guardar</button>
        <a href="{% url 'cotizaciones:cotizacion_list' %}" class="btn-secondary">Cancelar</a>
      </div>
    </form>
  </section>
</main>
{% endblock %}
