{% extends "base.html" %}
{% block title %}Global Exchange - Tipo de Medio{% endblock %}

{% block content %}
<main class="max-w-5xl mx-auto px-6 py-10">
  
  <!-- Encabezado -->
  <header class="flex items-center justify-between mb-8">
    <div>
      <h1 class="text-4xl font-extrabold mb-2 text-[var(--ink)]">
        üè¶ {% if form.instance.pk %}Editar Tipo de Medio{% else %}Crear Nuevo Tipo de Medio{% endif %}
      </h1>
      <p class="text-lg leading-relaxed max-w-2xl text-[var(--muted)]">
        {% if form.instance.pk %}
          Modifica los detalles y campos de este tipo de medio de acreditaci√≥n.
        {% else %}
          Completa la informaci√≥n para registrar un nuevo tipo y sus campos.
        {% endif %}
      </p>
    </div>
    <a href="{% url 'medios_acreditacion:tipos_list' %}"
       class="px-4 py-2 rounded-lg font-bold bg-[var(--brand-soft)] hover:brightness-95"
       style="color:var(--brand-dark)">‚¨Ö Volver</a>
  </header>

  <!-- Formulario principal -->
  <form method="post" novalidate>
    {% csrf_token %}

    <!-- Datos del Tipo -->
    <section class="bg-white border rounded-xl shadow-sm p-6 mb-8" style="border-color:var(--line)">
      <h2 class="text-2xl font-bold mb-4 text-[var(--ink)]">Datos del Tipo</h2>
      <div class="mb-4">
        <label for="id_nombre" class="block font-semibold text-[var(--ink)]">Nombre</label>
        {{ form.nombre }}
      </div>
      <div class="mb-4">
        <label for="id_descripcion" class="block font-semibold text-[var(--ink)]">Descripci√≥n</label>
        {{ form.descripcion }}
      </div>
      <div class="flex items-center gap-2">
        {{ form.activo }} <label for="id_activo" class="text-[var(--ink)]">Activo</label>
      </div>
    </section>


    <!-- Campos del Tipo -->
    <section class="bg-white border rounded-xl shadow-sm p-6" style="border-color:var(--line)">
      <h2 class="text-2xl font-bold mb-4 text-[var(--ink)]">Campos del Tipo</h2>
      {{ formset.management_form }}

      <div class="overflow-x-auto">
        <table id="tabla-campos" class="w-full border-collapse min-w-[720px]">
          <thead class="bg-[var(--brand)] text-white">
            <tr>
              <th class="px-4 py-2 text-left">Nombre del Campo</th>
              <th class="px-4 py-2 text-left">Tipo de Dato</th>
              <th class="px-4 py-2 text-left">Obligatorio</th>
              <th class="px-4 py-2 text-left">Regex</th>
              <th class="px-4 py-2 text-left">Eliminar</th>
            </tr>
          </thead>
          <tbody>
            {% for subform in formset %}
              <tr class="hover:bg-[var(--brand-soft)] campo-row">
                <td class="px-4 py-2">{{ subform.nombre }}</td>
                <td class="px-4 py-2">{{ subform.tipo_dato }}</td>
                <td class="px-4 py-2 text-center">{{ subform.obligatorio }}</td>
                <td class="px-4 py-2">{{ subform.regex }}</td>
                <td class="px-4 py-2 text-center eliminar-cell">{{ subform.DELETE }}</td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="5" class="text-center py-4 text-[var(--muted)]">
                  No hay campos definidos todav√≠a.
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Bot√≥n agregar -->
      <div class="mt-4">
        <button type="button" id="add-campo"
                class="px-4 py-2 rounded-lg font-semibold text-white shadow-sm"
                style="background:var(--brand)">
          ‚ûï Agregar campo
        </button>
      </div>
    </section>



    <!-- Botones -->
    <div class="flex justify-end gap-3 mt-6">
      <a href="{% url 'medios_acreditacion:tipos_list' %}"
         class="px-4 py-2 rounded-lg font-semibold text-white bg-red-600 hover:bg-red-700">
        Cancelar
      </a>
      <button type="submit"
              class="px-6 py-2 rounded-lg font-bold text-white shadow-sm"
              style="background:var(--brand)">
        {% if form.instance.pk %}üíæ Guardar Cambios{% else %}‚ûï Crear{% endif %}
      </button>
    </div>
  </form>
</main>

<style>
  /* Estilo inputs */
  input, select, textarea {
    width: 100%;
    background: #fff;
    border: 1.5px solid var(--line);
    border-radius: 12px;
    padding: 10px 12px;
    font-size: 1rem;
    color: var(--ink);
    box-shadow: 0 1px 2px rgba(0,0,0,.03);
    transition: box-shadow .2s, border-color .2s;
  }
  input:focus, select:focus, textarea:focus {
    outline: none;
    border-color: var(--brand);
    box-shadow: 0 0 0 3px rgba(115,60,255,.15);
  }
</style>


<script>
  document.addEventListener("DOMContentLoaded", () => {
    const addBtn = document.getElementById("add-campo");
    const tabla = document.getElementById("tabla-campos").querySelector("tbody");
    const totalForms = document.getElementById("id_campos-TOTAL_FORMS"); // Django genera este id

    // ‚ûï Agregar nueva fila
    addBtn.addEventListener("click", () => {
      const formIdx = parseInt(totalForms.value);
      const newRow = tabla.querySelector("tr.campo-row").cloneNode(true);

      // limpiar valores
      newRow.querySelectorAll("input, select").forEach(el => {
        if (el.type === "checkbox") {
          el.checked = false;
        } else {
          el.value = "";
        }
        // actualizar nombres/index
        if (el.name) {
          el.name = el.name.replace(/-\d+-/, `-${formIdx}-`);
          el.id = el.id.replace(/-\d+-/, `-${formIdx}-`);
        }
      });

      tabla.appendChild(newRow);
      totalForms.value = formIdx + 1;
    });

    // üîí Deshabilitar "Eliminar" mientras se edita
    tabla.addEventListener("input", (e) => {
      const row = e.target.closest("tr");
      if (row) {
        const delCheckbox = row.querySelector(".eliminar-cell input[type=checkbox]");
        if (delCheckbox) {
          delCheckbox.disabled = true;
          setTimeout(() => { delCheckbox.disabled = false; }, 1500); // se habilita de nuevo luego de 1.5s
        }
      }
    });
  });
</script>


{% endblock %}
