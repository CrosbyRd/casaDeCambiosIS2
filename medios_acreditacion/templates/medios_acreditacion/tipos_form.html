{% extends "base.html" %}
{% block title %}Global Exchange - Tipo de Medio{% endblock %}

{% block content %}
<main class="max-w-5xl mx-auto px-6 py-10">
  
  <!-- Encabezado -->
  <header class="flex items-center justify-between mb-8">
    <div>
      <h1 class="text-4xl font-extrabold mb-2 text-[var(--ink)]">
        üè¶ {% if accion == "editar" %}Editar Tipo de Medio{% else %}Crear Nuevo Tipo de Medio{% endif %}
      </h1>
      <p class="text-lg leading-relaxed max-w-2xl text-[var(--muted)]">
        {% if accion == "editar" %}
          Modifica los detalles y campos de este tipo de medio de acreditaci√≥n.
        {% else %}
          Completa la informaci√≥n para registrar un nuevo tipo y sus campos.
        {% endif %}
      </p>
    </div>
    <a href="{% url 'medios_acreditacion:tipos_list' %}"
       class="px-4 py-2 rounded-lg font-bold bg-[var(--brand-soft)] hover:brightness-95"
       style="color:var(--brand-dark)">‚¨Ö Volver</a>
  </header>

  <!-- Formulario principal -->
  <form method="post" novalidate>
    {% csrf_token %}

    <!-- Datos del Tipo -->
    <section class="bg-white border rounded-xl shadow-sm p-6 mb-8" style="border-color:var(--line)">
      <h2 class="text-2xl font-bold mb-4 text-[var(--ink)]">Datos del Tipo</h2>
      <div class="mb-4">
        <label for="id_nombre" class="block font-semibold text-[var(--ink)]">Nombre</label>
        {{ form.nombre }}
      </div>
      <div class="mb-4">
        <label for="id_descripcion" class="block font-semibold text-[var(--ink)]">Descripci√≥n</label>
        {{ form.descripcion }}
      </div>
      <div class="flex items-center gap-2">
        {{ form.activo }} <label for="id_activo" class="text-[var(--ink)]">Activo</label>
      </div>
    </section>

    <!-- Campos del Tipo -->
    <section class="bg-white border rounded-xl shadow-sm p-6" style="border-color:var(--line)">
      <h2 class="text-2xl font-bold mb-4 text-[var(--ink)]">Campos del Tipo</h2>
      {{ formset.management_form }}

      <div class="overflow-x-auto">
        <table class="w-full border-collapse min-w-[720px]">
          <thead class="bg-[var(--brand)] text-white">
            <tr>
              <th class="px-4 py-2 text-left">Nombre del Campo</th>
              <th class="px-4 py-2 text-left">Tipo de Dato</th>
              <th class="px-4 py-2 text-left">Obligatorio</th>
              <th class="px-4 py-2 text-left">Regex</th>
              <th class="px-4 py-2 text-left">Acciones</th>
            </tr>
          </thead>
          <tbody id="campos-tbody">
            {% for subform in formset %}
              <tr class="hover:bg-[var(--brand-soft)] campo-row">
                {{ subform.id }}
                <td class="px-4 py-2">{{ subform.nombre }}</td>
                <td class="px-4 py-2">{{ subform.tipo_dato }}</td>
                <td class="px-4 py-2 text-center">{{ subform.obligatorio }}</td>
                <td class="px-4 py-2">{{ subform.regex }}</td>
                <td class="px-4 py-2 text-center">
                  {{ subform.DELETE }} <!-- checkbox real -->
                  <button type="button"
                          class="btn-eliminar px-3 py-1 rounded-lg text-white bg-red-600 hover:bg-red-700">
                    Eliminar
                  </button>
                </td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="5" class="text-center py-4 text-[var(--muted)]">
                  No hay campos definidos todav√≠a.
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Plantilla fila vac√≠a -->
      <template id="empty-form-template">
        <tr class="hover:bg-[var(--brand-soft)] campo-row">
          {{ formset.empty_form.id }}
          <td class="px-4 py-2">{{ formset.empty_form.nombre }}</td>
          <td class="px-4 py-2">{{ formset.empty_form.tipo_dato }}</td>
          <td class="px-4 py-2 text-center">{{ formset.empty_form.obligatorio }}</td>
          <td class="px-4 py-2">{{ formset.empty_form.regex }}</td>
          <td class="px-4 py-2 text-center">
            {{ formset.empty_form.DELETE }} <!-- checkbox real -->
            <button type="button"
                    class="btn-eliminar px-3 py-1 rounded-lg text-white bg-red-600 hover:bg-red-700">
              Eliminar
            </button>
          </td>
        </tr>
      </template>

      <!-- Bot√≥n agregar -->
      <div class="mt-4">
        <button type="button" id="add-campo"
                class="px-4 py-2 rounded-lg font-semibold text-white shadow-sm"
                style="background:var(--brand)">
          ‚ûï Agregar campo
        </button>
      </div>
    </section>

    <!-- Botones -->
    <div class="flex justify-end gap-3 mt-6">
      <a href="{% url 'medios_acreditacion:tipos_list' %}"
         class="px-4 py-2 rounded-lg font-semibold text-white bg-red-600 hover:bg-red-700">
        Cancelar
      </a>
      <button type="submit"
              class="px-6 py-2 rounded-lg font-bold text-white shadow-sm"
              style="background:var(--brand)">
        {% if accion == "editar" %}üíæ Guardar Cambios{% else %}‚ûï Crear{% endif %}
      </button>
    </div>
  </form>
</main>

<style>
  input, select, textarea {
    width: 100%;
    background: #fff;
    border: 1.5px solid var(--line);
    border-radius: 12px;
    padding: 10px 12px;
    font-size: 1rem;
    color: var(--ink);
    box-shadow: 0 1px 2px rgba(0,0,0,.03);
    transition: box-shadow .2s, border-color .2s;
  }
  input:focus, select:focus, textarea:focus {
    outline: none;
    border-color: var(--brand);
    box-shadow: 0 0 0 3px rgba(115,60,255,.15);
  }
  /* Ocultar los checkboxes DELETE */
  input[type=checkbox][name$="-DELETE"] {
    display: none;
  }
</style>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const prefix = "{{ formset.prefix }}";
  const totalInput = document.getElementById(`id_${prefix}-TOTAL_FORMS`);
  const initialForms = parseInt(document.getElementById(`id_${prefix}-INITIAL_FORMS`).value, 10);
  const tbody = document.getElementById("campos-tbody");
  const tmpl = document.getElementById("empty-form-template");

  function wireRow(row, index) {
    const delCheckbox = row.querySelector(`input[name^="${prefix}-"][name$="-DELETE"]`);
    const btn = row.querySelector(".btn-eliminar");

    if (btn && delCheckbox) {
      if (index < initialForms) {
        // Campos existentes ‚Üí bot√≥n visible
        btn.style.visibility = "visible";
      } else {
        // Campos nuevos ‚Üí ocultar hasta escribir
        btn.style.visibility = "hidden";
        row.addEventListener("input", () => {
          btn.style.visibility = "visible";
        });
      }

      btn.addEventListener("click", () => {
        delCheckbox.checked = true;  // marcar para borrar
        row.style.display = "none";  // ocultar fila
      });
    }
  }

  // Wirear filas iniciales
  [...tbody.querySelectorAll("tr.campo-row")].forEach((row, idx) => wireRow(row, idx));

  // Agregar nueva fila
  document.getElementById("add-campo").addEventListener("click", () => {
    const idx = parseInt(totalInput.value, 10);
    let html = tmpl.innerHTML.replace(/__prefix__/g, idx);

    const tempWrap = document.createElement("tbody");
    tempWrap.innerHTML = html.trim();
    const newRow = tempWrap.firstElementChild;

    tbody.appendChild(newRow);
    totalInput.value = idx + 1;

    wireRow(newRow, idx);
  });
});
</script>
{% endblock %}
