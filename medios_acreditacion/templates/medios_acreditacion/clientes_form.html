{% extends "base.html" %}
{% block title %}
  {% if request.resolver_match.url_name == 'clientes_update' %}Editar medio{% else %}Agregar medio{% endif %}
{% endblock %}

{% block content %}
<main class="max-w-4xl mx-auto px-6 py-10"
      data-is-edit="{% if request.resolver_match.url_name == 'clientes_update' %}1{% else %}0{% endif %}">

  <header class="flex items-center justify-between mb-6">
    <div>
      <h1 class="text-4xl font-extrabold text-[var(--ink)]">
        {% if request.resolver_match.url_name == 'clientes_update' %}Editar medio{% else %}Agregar medio{% endif %}
      </h1>
      <p class="text-[var(--muted)] mt-1">Completá los datos del medio para acreditaciones.</p>
    </div>
    <a href="{% url 'medios_acreditacion:clientes_list' %}"
       class="px-4 py-2 rounded-xl font-bold bg-[var(--brand-soft)] hover:brightness-95"
       style="color:var(--brand-dark)">⬅ Volver</a>
  </header>


  {% if messages %}
    <div class="mb-6">
      {% for message in messages %}
        <div class="p-3 mb-2 rounded-lg bg-blue-50 text-blue-800 border border-blue-200">{{ message }}</div>
      {% endfor %}
    </div>
  {% endif %}

  <form method="post" novalidate class="bg-white border rounded-2xl shadow-sm overflow-hidden" style="border-color:var(--line)">
    {% csrf_token %}

    {% if form.non_field_errors %}
      <div class="px-6 pt-4 text-red-700">{{ form.non_field_errors }}</div>
    {% endif %}

    <!-- Sección: Tipo -->
    <div class="section-head">Tipo</div>
    <div class="section-body">
      <label class="block font-semibold mb-1">Seleccioná el tipo</label>
      {{ form.tipo }}
      {% for e in form.tipo.errors %}{% ifchanged e %}<p class="field-error">{{ e }}</p>{% endifchanged %}{% endfor %}
      {% if request.resolver_match.url_name == 'clientes_update' %}
        <p class="helper">El tipo no se puede cambiar en edición.</p>
      {% endif %}
    </div>

    <!-- Sección: Alias -->
    {% if form.fields.alias %}
      <div class="section-head">Alias</div>
      <div class="section-body">
        <label class="block font-semibold mb-1">Alias del medio (opcional)</label>
        {{ form.alias }}
        <p class="helper">Ej.: “cuenta sueldo”, “billetera personal”.</p>
        {% for e in form.alias.errors %}{% ifchanged e %}<p class="field-error">{{ e }}</p>{% endifchanged %}{% endfor %}
      </div>
    {% endif %}

    <!-- Sección: Datos del medio -->
    <div class="section-head">Datos del medio</div>
    <div class="section-body">
      {% for field in form.visible_fields %}
        {% if field.name != "tipo" and field.name != "alias" and field.name != "activo" and field.name != "predeterminado" %}
          <div class="mb-4">
            <label class="block font-semibold mb-1">{{ field.label }}</label>
            {{ field }}
            {% for e in field.errors %}{% ifchanged e %}<p class="field-error">{{ e }}</p>{% endifchanged %}{% endfor %}
          </div>
        {% endif %}
      {% endfor %}
    </div>

    <!-- Sección: Estado -->
    <div class="section-head">Estado</div>
    <div class="section-body">
      <div class="flex items-center gap-4 flex-wrap">
        <!-- ACTIVO -->
        <label class="pill-switch">
          {{ form.activo }}
          <span class="pill pill-active" aria-hidden="true">✓ ACTIVO</span>
        </label>

        <!-- PREDETERMINADO -->
        <label class="pill-switch">
          {{ form.predeterminado }}
          <span class="pill pill-default" aria-hidden="true">Predeterminado</span>
        </label>
      </div>
      {% for e in form.predeterminado.errors %}{% ifchanged e %}<p class="field-error">{{ e }}</p>{% endifchanged %}{% endfor %}
      <p class="helper mt-2">Solo los medios activos pueden ser predeterminados.</p>
    </div>

    <!-- Acciones -->
    <div class="px-6 py-5 flex justify-end gap-3">
      <a href="{% url 'medios_acreditacion:clientes_list' %}"
         class="px-4 py-2 rounded-xl font-semibold text-white bg-red-600 hover:bg-red-700">
        Cancelar
      </a>
      <button type="submit"
              class="px-6 py-2 rounded-xl font-bold text-white shadow-sm"
              style="background:var(--brand)">
        {% if request.resolver_match.url_name == 'clientes_update' %}Guardar{% else %}Crear{% endif %}
      </button>
    </div>

  </form>
</main>

<style>
  .section-head{ background:var(--brand); color:#fff; font-weight:800; padding:.75rem 1rem; border-top:1px solid var(--brand) }
  .section-body{ padding:1rem }

  input, select, textarea{
    width:100%; background:#fff; border:1.5px solid var(--line);
    border-radius:12px; padding:10px 12px; font-size:1rem; color:var(--ink)
  }
  input:focus, select:focus, textarea:focus{
    outline:none; border-color:var(--brand); box-shadow:0 0 0 3px rgba(115,60,255,.15)
  }

  /* Bloqueo visual del select (solo en edición) sin deshabilitar envío */
  .locked-select{
    pointer-events:none;
    background:#f6f6fb !important;
    color:#6b6b6b !important;
  }

  .pill-switch{ position:relative; display:inline-flex; align-items:center; gap:.5rem; cursor:pointer; user-select:none }
  .pill-switch input[type="checkbox"]{ position:absolute; opacity:0; width:1px; height:1px; overflow:hidden; clip:rect(0 0 0 0); clip-path:inset(50%); white-space:nowrap }
  .pill{ display:inline-flex; align-items:center; gap:.45rem; padding:.4rem .75rem; border-radius:12px; font-weight:800; letter-spacing:.2px; transition:all .15s ease; border:1px solid transparent }
  .pill-active{ background:#6b7280; color:#fff }
  .pill-switch input[type="checkbox"]:checked + .pill-active{ background:#16a34a; color:#fff }
  .pill-default{ background:#6b7280; color:#fff }
  .pill-switch input[type="checkbox"]:checked + .pill-default{ background:var(--brand); color:#fff }
  .pill-switch input[type="checkbox"]:focus + .pill{ box-shadow:0 0 0 3px rgba(115,60,255,.25); border-color:var(--brand) }

  .helper{ font-size:.85rem; color:var(--muted); margin-top:.25rem }
  .field-error{ font-size:.875rem; color:#b91c1c; margin-top:.25rem }
</style>

<script>
  (function () {
    const main = document.querySelector('main[data-is-edit]');
    const IS_EDIT = main && main.dataset.isEdit === '1';

    const sel = document.getElementById('id_tipo');
    if (sel && IS_EDIT) {
      sel.classList.add('locked-select');
      sel.setAttribute('aria-readonly', 'true');
      sel.setAttribute('tabindex', '-1');
    }

    // En creación, permitir cambiar tipo y recargar con ?tipo=...
    if (sel && !IS_EDIT) {
      sel.addEventListener('change', () => {
        const v = sel.value;
        const base = window.location.pathname; // /medios-acreditacion/clientes/crear/
        const qs = v ? ('?tipo=' + encodeURIComponent(v)) : '';
        window.location.href = base + qs;
      });
    }
  })();
</script>

{% endblock %}
