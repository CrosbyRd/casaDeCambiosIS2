{% extends "base.html" %}

{% block title %}Tipos de Medios de Acreditación - Global Exchange{% endblock %}

{% block content %}
<main class="max-w-5xl mx-auto px-6 py-10">
  <header class="mb-6">
    <h1 class="text-4xl md:text-5xl font-extrabold mb-2 text-[var(--ink)]">
      Tipos de Medios de Acreditación
    </h1>
    <p class="text-lg leading-relaxed max-w-2xl text-[var(--muted)]">
      Administra los tipos de medios que los clientes pueden usar para acreditar y recibir fondos.
    </p>
  </header>

  <!-- Crear -->
  <div class="flex justify-end mb-4">
    <a href="{% url 'medios_acreditacion:tipos_create' %}"
       class="btn btn-brand">
      Crear nuevo tipo
    </a>
  </div>

  <!-- Tabla -->
  <section class="bg-white border rounded-xl shadow-sm overflow-hidden" style="border-color:var(--line)">
    <table class="w-full text-left border-collapse">
      <thead class="bg-[var(--brand)] text-white">
        <tr>
          <th class="p-3 text-lg">Nombre</th>
          <th class="p-3 text-lg">Descripción</th>
          <th class="p-3 text-lg">Estado</th>
          <th class="p-3 text-lg text-center">Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for tipo in tipos %}
          {% with refs=tipo.medios_cliente.all %}
          {% with refs_count=refs|length %}
          <tr class="hover:bg-[var(--brand-soft)] transition">
            <!-- Nombre + En uso -->
            <td class="p-3 font-semibold text-[var(--ink)]">
              <div class="flex items-center gap-2">
                <span>{{ tipo.nombre }}</span>
                {% if refs_count %}
                  <span class="badge badge-warn" title="Este tipo está siendo utilizado por clientes">En uso</span>
                {% endif %}
              </div>
            </td>

            <!-- Descripción -->
            <td class="p-3 text-[var(--muted)]">{{ tipo.descripcion|default:"—" }}</td>

            <!-- Estado -->
            <td class="p-3">
              {% if tipo.activo %}
                <span class="badge badge-ok">Activo</span>
              {% else %}
                <span class="badge badge-bad">Inactivo</span>
              {% endif %}
            </td>

            <!-- Acciones -->
            <td class="p-3">
              <div class="flex justify-center gap-2">
                <a href="{% url 'medios_acreditacion:tipos_update' tipo.id_tipo %}" class="btn btn-soft">
                  Editar
                </a>

                {% if refs_count %}
                  <!-- Bloqueado por uso: muestra modal en lugar de ir al DeleteView -->
                  <button type="button"
                          class="btn btn-danger btn-disabled"
                          data-locked="1"
                          data-tipo="{{ tipo.nombre }}">
                    Eliminar
                  </button>
                {% else %}
                  <a href="{% url 'medios_acreditacion:tipos_delete' tipo.id_tipo %}" class="btn btn-danger">
                    Eliminar
                  </a>
                {% endif %}
              </div>
            </td>
          </tr>
          {% endwith %}
          {% endwith %}
        {% empty %}
        <tr>
          <td colspan="4" class="p-6 text-center text-[var(--muted)]">
            No hay tipos de medios de acreditación creados todavía.
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </section>
</main>

<!-- Modal: no se puede eliminar por referencias -->
<div id="gx-lock-modal" class="fixed inset-0 z-[60] hidden items-center justify-center bg-black/40 p-4">
  <div class="w-full max-w-lg rounded-2xl overflow-hidden border shadow-xl bg-white" style="border-color:var(--line)">
    <!-- Barra lila -->
    <div class="px-4 py-3 font-extrabold text-white" style="background:var(--brand);">
      No se puede eliminar este tipo
    </div>

    <div class="p-5 space-y-3">
      <p class="text-[var(--ink)] font-semibold">
        El tipo <span id="gx-lock-nombre" class="font-extrabold"></span> está siendo utilizado por uno o más clientes.
      </p>
      <p class="text-[var(--muted)]">
        Para eliminarlo, primero quitá o cambiá los medios de acreditación de esos clientes que dependen de este tipo.
        También podés mantenerlo y desactivar sus campos desde la edición.
      </p>

      <div class="flex items-center gap-2 pt-1 justify-end">
        <button type="button" class="btn btn-ghost" data-close>Cerrar</button>
      </div>
    </div>
  </div>
</div>

<style>
  /* === Botones (alineados a “Medios de Pago”) === */
  .btn{
    display:inline-block; border-radius:10px; padding:8px 12px; font-weight:700; line-height:1;
    border:1.5px solid transparent;
  }
  .btn-brand{ background:var(--brand); color:#fff; box-shadow:0 2px 8px color-mix(in oklab, var(--brand) 30%, transparent); }
  .btn-soft{ background:var(--brand-soft); color:var(--brand-dark); }
  .btn-ghost{ background:#fff; color:var(--ink); border-color:var(--line); }
  .btn-danger{ background:#dc2626; color:#fff; }
  .btn-danger:hover{ background:#b91c1c; }
  .btn-soft:hover{ filter:brightness(0.95); }
  .btn-ghost:hover{ background:var(--brand-soft); }
  .btn-disabled{ opacity:.6; cursor:not-allowed; }

  /* === Badges (igual formato que Activo/Inactivo en Medios de Pago) === */
  .badge{
    display:inline-block; padding:4px 8px; border-radius:8px; font-weight:700; font-size:.875rem;
  }
  .badge-ok{ background:#dcfce7; color:#166534; }     /* verde */
  .badge-bad{ background:#fee2e2; color:#991b1b; }    /* rojo  */
  .badge-warn{ background:#fef3c7; color:#92400e; }   /* ámbar */

  /* Hover fila tabla */
  tbody tr:hover td{ transition:background .15s; }
</style>

<script>
  // Si el tipo está en uso, el "Eliminar" abre el modal explicativo
  document.addEventListener('click', function (e) {
    var btn = e.target.closest('button[data-locked="1"]');
    if (!btn) return;
    e.preventDefault();
    var modal = document.getElementById('gx-lock-modal');
    var nameOut = document.getElementById('gx-lock-nombre');
    if (nameOut) nameOut.textContent = btn.getAttribute('data-tipo') || '';
    if (modal) modal.classList.remove('hidden');
  });

  // Cerrar modal
  (function () {
    var modal = document.getElementById('gx-lock-modal');
    if (!modal) return;
    modal.addEventListener('click', function (e) {
      if (e.target.hasAttribute('data-close') || e.target === modal) {
        modal.classList.add('hidden');
      }
    });
  })();
</script>
{% endblock %}
