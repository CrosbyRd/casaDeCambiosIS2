{% extends 'base.html' %}

{% block title %}Documentos Electrónicos{% endblock %}

{% block content %}
<main class="max-w-[1200px] mx-auto px-6 py-8 space-y-6">
    <section class="space-y-6">
        <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-4">
            <div>
                <h1 class="text-4xl md:text-5xl font-extrabold leading-tight">Documentos Electrónicos</h1>
                <p class="text-lg leading-relaxed max-w-xl" style="color:var(--muted)">
                    Visualizar y gestionar los documentos electrónicos generados por los emisores registrados.
                </p>
            </div>
            <div class="flex items-center gap-2">
                <a href="{% url 'facturacion_electronica:panel_facturacion' %}"
                   class="px-4 py-2 rounded-lg font-bold bg-[var(--brand-soft)] hover:brightness-95 text-[var(--brand-dark)]">
                    ⬅ Volver al Panel
                </a>
            </div>
        </div>

        {% if documentos %}
        <!-- Card sin padding interno para que el header lila llene todo -->
        <div class="rounded-2xl border border-neutral-200 bg-white shadow-sm overflow-hidden">
            <div class="table-responsive">
                <table class="min-w-full divide-y divide-neutral-200">
                    <thead class="gx-thead">
                        <tr>
                            <th scope="col" class="px-4 py-3">Emisor</th>
                            <th scope="col" class="px-4 py-3">Tipo</th>
                            <th scope="col" class="px-4 py-3">Número Documento</th>
                            <th scope="col" class="px-4 py-3">Estado SIFEN</th>
                            <th scope="col" class="px-4 py-3">Fecha Emisión</th>
                            <th scope="col" class="px-4 py-3">Transacción Asociada</th>
                            <th scope="col" class="px-4 py-3">Acciones</th>
                            <th scope="col" class="px-4 py-3">Eliminar</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-[var(--line)]">
                        {% for doc in documentos %}
                        <tr class="hover:bg-purple-50/40">
                            <td class="px-4 py-3">
                                {{ doc.emisor.nombre }}
                            </td>
                            <td class="px-4 py-3">{{ doc.get_tipo_de_display }}</td>
                            <td class="px-4 py-3">
                                {{ doc.emisor.establecimiento }}-{{ doc.emisor.punto_expedicion }}-{{ doc.numero_documento }}
                            </td>
                            <td class="px-4 py-3">
                                {% if doc.estado_sifen == 'aprobado' %}
                                    <span class="badge bg-success">{{ doc.get_estado_sifen_display }}</span>
                                {% elif doc.estado_sifen == 'rechazado' or doc.estado_sifen == 'error_api' or doc.estado_sifen == 'error_sifen' %}
                                    <span class="badge bg-danger">{{ doc.get_estado_sifen_display }}</span>
                                {% elif doc.estado_sifen == 'cancelado' or doc.estado_sifen == 'inutilizado' %}
                                    <span class="badge bg-warning">{{ doc.get_estado_sifen_display }}</span>
                                {% elif doc.estado_sifen == 'simulado' %}
                                    <span class="badge bg-info">{{ doc.get_estado_sifen_display }}</span>
                                {% else %}
                                    <span class="badge bg-secondary">{{ doc.get_estado_sifen_display }}</span>
                                {% endif %}
                            </td>
                            <td class="px-4 py-3">
                                {{ doc.fecha_emision|date:"d/m/Y H:i" }}
                            </td>
                            <td class="px-4 py-3">
                                {% if doc.transaccion_asociada %}
                                    <a href="{% url 'transacciones:resultado_pago' transaccion_id=doc.transaccion_asociada.pk %}">
                                        {{ doc.transaccion_asociada.id|truncatechars:8 }}
                                    </a>
                                {% else %}
                                    N/A
                                {% endif %}
                            </td>
                            <td class="px-4 py-3">
                                <a href="{% url 'facturacion_electronica:documento_detail' pk=doc.pk %}"
                                   class="btn btn-info btn-sm">
                                    Ver
                                </a>
                            </td>
                            <td class="px-4 py-3">
                                {# FORMULARIO DE ELIMINACIÓN: sin confirm() nativo, usamos modal #}
                                <form action="{% url 'facturacion_electronica:documento_delete' pk=doc.pk %}"
                                      method="post"
                                      class="delete-de-form">
                                    {% csrf_token %}
                                    <button type="button"
                                            class="btn btn-danger btn-sm js-open-delete"
                                            data-doc-label="{{ doc.emisor.establecimiento }}-{{ doc.emisor.punto_expedicion }}-{{ doc.numero_documento }}">
                                        Eliminar
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        {% if is_paginated %}
        <nav aria-label="Page navigation" class="flex justify-center mt-4">
            <ul class="pagination flex items-center space-x-2">
                {% if page_obj.has_previous %}
                    <li class="page-item">
                        <a class="px-3 py-2 leading-tight text-white bg-[var(--brand)] border border-[var(--brand)] rounded-lg hover:bg-[var(--brand-hover)] hover:border-[var(--brand-hover)]"
                           href="?page={{ page_obj.previous_page_number }}">
                            Anterior
                        </a>
                    </li>
                {% endif %}
                <li class="page-item active">
                    <span class="px-3 py-2 leading-tight text-white bg-[var(--brand)] border border-[var(--brand)] rounded-lg">
                        {{ page_obj.number }} de {{ page_obj.num_pages }}
                    </span>
                </li>
                {% if page_obj.has_next %}
                    <li class="page-item">
                        <a class="px-3 py-2 leading-tight text-white bg-[var(--brand)] border border-[var(--brand)] rounded-lg hover:bg-[var(--brand-hover)] hover:border-[var(--brand-hover)]"
                           href="?page={{ page_obj.next_page_number }}">
                            Siguiente
                        </a>
                    </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}

        {% else %}
        <p class="text-neutral-500">No hay documentos electrónicos registrados.</p>
        {% endif %}
    </section>
</main>

{# MODAL PERSONALIZADO DE CONFIRMACIÓN #}
<div id="delete-modal"
     class="fixed inset-0 z-50 flex items-center justify-center bg-black/40 hidden">
  <div class="bg-white rounded-2xl shadow-lg max-w-md w-full mx-4 overflow-hidden">
    <!-- HEADER LILA -->
    <div class="delete-modal-header px-6 py-3">
      <h2 class="text-lg font-bold m-0">
        Eliminar documento
      </h2>
    </div>

    <!-- CUERPO DEL MODAL -->
    <div class="p-6">
      <p class="text-sm text-[var(--muted)] mb-4" id="delete-modal-text">
        ¿Estás seguro de que quieres eliminar este documento electrónico? Esta acción es irreversible.
      </p>
      <div class="flex justify-end gap-3">
        <button type="button"
                id="delete-cancel-btn"
                class="px-4 py-2 rounded-lg text-sm font-semibold border border-[var(--line)] text-[var(--muted)] bg-white hover:bg-[var(--surface-2)]">
          Cancelar
        </button>
        <button type="button"
                id="delete-confirm-btn"
                class="px-4 py-2 rounded-lg text-sm font-semibold bg-[#ef4444] text-white hover:bg-[#dc2626]">
          Sí, eliminar
        </button>
      </div>
    </div>
  </div>
</div>


<style>
  .gx-thead{
    background: var(--brand);
  }
  .gx-thead tr{
    background: var(--brand);
  }
  .gx-thead th{
    color: #fff;
    font-weight: 800;
  }

  .btn-danger{
    background-color: #ef4444;
    border-color: #ef4444;
    color: #ffffff;
  }
  .btn-danger:hover{
    background-color: #dc2626;
    border-color: #dc2626;
    color: #ffffff;
  }


  /* Header lila del modal, igual que la tabla */
.delete-modal-header{
    background: var(--brand);
    color: #ffffff;
}

    /* Nos aseguramos de que el título sea blanco y sin margen extra */
#delete-modal h2{
    color: #ffffff;
}

</style>

<script>
  (function () {
    const modal = document.getElementById('delete-modal');
    if (!modal) return;

    const textEl = document.getElementById('delete-modal-text');
    const cancelBtn = document.getElementById('delete-cancel-btn');
    const confirmBtn = document.getElementById('delete-confirm-btn');
    let formToSubmit = null;

    document.querySelectorAll('form.delete-de-form .js-open-delete').forEach(function (btn) {
      btn.addEventListener('click', function (e) {
        e.preventDefault();
        formToSubmit = this.closest('form');

        const label = this.getAttribute('data-doc-label');
        if (label && textEl) {
          textEl.textContent =
            "¿Estás seguro de que quieres eliminar el documento " +
            label +
            "? Esta acción es irreversible.";
        }

        modal.classList.remove('hidden');
      });
    });

    function closeModal() {
      modal.classList.add('hidden');
      formToSubmit = null;
    }

    cancelBtn.addEventListener('click', function () {
      closeModal();
    });

    confirmBtn.addEventListener('click', function () {
      if (formToSubmit) {
        formToSubmit.submit();
      }
      closeModal();
    });

    // cerrar al hacer click fuera del cuadro
    modal.addEventListener('click', function (e) {
      if (e.target === modal) {
        closeModal();
      }
    });
  })();
</script>
{% endblock %}
