{% extends 'base.html' %}

{% block title %}Detalle del Documento Electrónico{% endblock %}

{% block content %}
<div class="container py-4">

  <!-- Encabezado -->
  <div class="card shadow-sm border-0 rounded-3 mb-4">
    <div class="card-body d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3">
      <div>
        <div class="text-muted small">Documento</div>
        <h3 class="m-0">
          {{ documento.emisor.establecimiento }}-{{ documento.emisor.punto_expedicion }}-{{ documento.numero_documento }}
        </h3>
        <div class="mt-2">
          {% if documento.estado_sifen == 'aprobado' %}
            <span class="badge bg-success px-3 py-2">{{ documento.get_estado_sifen_display }}</span>
          {% elif documento.estado_sifen == 'rechazado' or documento.estado_sifen == 'error_api' or documento.estado_sifen == 'error_sifen' %}
            <span class="badge bg-danger px-3 py-2">{{ documento.get_estado_sifen_display }}</span>
          {% elif documento.estado_sifen == 'cancelado' or documento.estado_sifen == 'inutilizado' %}
            <span class="badge bg-warning px-3 py-2">{{ documento.get_estado_sifen_display }}</span>
          {% elif documento.estado_sifen == 'simulado' %}
            <span class="badge bg-info px-3 py-2">{{ documento.get_estado_sifen_display }}</span>
          {% else %}
            <span class="badge bg-secondary px-3 py-2">{{ documento.get_estado_sifen_display }}</span>
          {% endif %}
          {% if documento.descripcion_estado %}<small class="text-muted ms-2">({{ documento.descripcion_estado }})</small>{% endif %}
        </div>
      </div>

      <div class="text-md-end">
        <div class="small text-muted mb-1">CDC</div>
        <div class="d-flex align-items-center gap-2">
          <code class="text-break">{{ documento.cdc|default:"N/A" }}</code>
          {% if documento.cdc %}
          <button type="button" class="btn btn-outline-secondary btn-sm" onclick="navigator.clipboard.writeText('{{ documento.cdc }}')">Copiar</button>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Info general -->
  <div class="card shadow-sm border-0 rounded-3 mb-4">
    <div class="card-header bg-white border-0 fw-semibold">Información General</div>
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-6">
          <div class="p-3 bg-light rounded-3 h-100">
            <div class="small text-muted">ID</div>
            <div class="d-flex align-items-center gap-2">
              <code class="text-break">{{ documento.id }}</code>
              <button type="button" class="btn btn-outline-secondary btn-sm" onclick="navigator.clipboard.writeText('{{ documento.id }}')">Copiar</button>
            </div>
          </div>
        </div>

        <div class="col-md-6">
          <div class="p-3 bg-light rounded-3 h-100">
            <div class="small text-muted">Emisor</div>
            <div>
              <a class="text-decoration-none" href="{% url 'facturacion_electronica:emisor_detail' pk=documento.emisor.pk %}">
                {{ documento.emisor.nombre }}
              </a>
            </div>
          </div>
        </div>

        <div class="col-md-4">
          <div class="p-3 bg-light rounded-3 h-100">
            <div class="small text-muted">Tipo</div>
            <div>{{ documento.get_tipo_de_display }}</div>
          </div>
        </div>

        <div class="col-md-4">
          <div class="p-3 bg-light rounded-3 h-100">
            <div class="small text-muted">Timbrado</div>
            <div>{{ documento.numero_timbrado|default:"N/A" }}</div>
          </div>
        </div>

        <div class="col-md-4">
          <div class="p-3 bg-light rounded-3 h-100">
            <div class="small text-muted">Fecha de emisión</div>
            <div>{{ documento.fecha_emision|date:"d/m/Y H:i:s" }}</div>
          </div>
        </div>

        <div class="col-md-12">
          <div class="p-3 bg-light rounded-3 h-100">
            <div class="small text-muted">Transacción asociada</div>
            {% if documento.transaccion_asociada %}
              <a class="text-decoration-none" href="{% url 'transacciones:resultado_pago' transaccion_id=documento.transaccion_asociada.pk %}">
                {{ documento.transaccion_asociada.id }}
              </a>
            {% else %}
              <span class="text-muted">N/A</span>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Ítems -->
  <div class="card shadow-sm border-0 rounded-3 mb-4">
    <div class="card-header bg-white border-0 fw-semibold">Ítems del Documento</div>
    <div class="card-body">
      {% if documento.items.count %}
      <div class="table-responsive">
        <table class="table table-striped table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th>Código</th>
              <th>Descripción</th>
              <th class="text-end">Cantidad</th>
              <th class="text-end">P. Unitario</th>
              <th class="text-end">Descuento</th>
              <th class="text-center">IVA</th>
              <th class="text-end">Tasa IVA</th>
            </tr>
          </thead>
          <tbody class="font-monospace">
            {% for item in documento.items.all %}
            <tr>
              <td class="text-nowrap">{{ item.codigo_interno|default:"N/A" }}</td>
              <td>{{ item.descripcion_producto_servicio }}</td>
              <td class="text-end">{{ item.cantidad }}</td>
              <td class="text-end">{{ item.precio_unitario }}</td>
              <td class="text-end">{{ item.descuento_item }}</td>
              <td class="text-center">{{ item.afectacion_iva }}</td>
              <td class="text-end">{{ item.tasa_iva }}%</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
        <div class="text-muted">No hay ítems asociados a este documento.</div>
      {% endif %}
    </div>
  </div>

  <!-- Acciones -->
  <div class="card shadow-sm border-0 rounded-3 mb-4">
    <div class="card-header bg-white border-0 fw-semibold">Acciones</div>
    <div class="card-body">
      <div class="d-flex flex-wrap gap-2">
        <form action="{% url 'facturacion_electronica:consultar_estado' documento.id %}" method="post">
          {% csrf_token %}
          <button type="submit" class="btn btn-primary btn-sm">Consultar Estado SIFEN</button>
        </form>

        <form action="{% url 'facturacion_electronica:solicitar_cancelacion' documento.id %}" method="post">
          {% csrf_token %}
          <button type="submit" class="btn btn-warning btn-sm"
            {% if documento.estado_sifen != 'aprobado' and documento.estado_sifen != 'aprobado_obs' %}disabled{% endif %}>
            Solicitar Cancelación
          </button>
        </form>

        <form action="{% url 'facturacion_electronica:solicitar_inutilizacion' documento.id %}" method="post">
          {% csrf_token %}
          <button type="submit" class="btn btn-danger btn-sm"
            {% if documento.estado_sifen == 'aprobado' or documento.estado_sifen == 'cancelado' or documento.estado_sifen == 'inutilizado' %}disabled{% endif %}>
            Solicitar Inutilización
          </button>
        </form>

        <a href="{% url 'facturacion_electronica:descargar_kude' documento.id %}" class="btn btn-outline-secondary btn-sm"
           {% if not documento.cdc %}aria-disabled="true" tabindex="-1" class="disabled btn btn-outline-secondary btn-sm"{% endif %}>
          Descargar KuDE
        </a>

        <a href="{% url 'facturacion_electronica:descargar_xml' documento.id %}" class="btn btn-outline-secondary btn-sm"
           {% if not documento.cdc %}aria-disabled="true" tabindex="-1" class="disabled btn btn-outline-secondary btn-sm"{% endif %}>
          Descargar XML
        </a>
      </div>
    </div>
  </div>

  <!-- JSONs -->
  <div class="row g-4">
    <div class="col-12 col-lg-6">
      <div class="card shadow-sm border-0 rounded-3 h-100">
        <div class="card-header bg-white border-0 fw-semibold">JSON Enviado a API</div>
        <div class="card-body">
          {% if json_enviado_pretty %}
            <pre class="bg-light p-3 rounded-3 small">{{ json_enviado_pretty }}</pre>
          {% else %}
            <span class="text-muted">No hay JSON enviado registrado.</span>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-6">
      <div class="card shadow-sm border-0 rounded-3 h-100">
        <div class="card-header bg-white border-0 fw-semibold">JSON Respuesta de API</div>
        <div class="card-body">
          {% if json_respuesta_pretty %}
            <pre class="bg-light p-3 rounded-3 small">{{ json_respuesta_pretty }}</pre>
          {% else %}
            <span class="text-muted">No hay JSON de respuesta registrado.</span>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Volver -->
  <div class="mt-4">
    <a href="{% url 'facturacion_electronica:documento_list' %}" class="btn btn-light border">Volver a la Lista de Documentos</a>
  </div>
</div>
{% endblock %}
